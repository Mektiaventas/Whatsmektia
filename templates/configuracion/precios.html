{% extends 'base.html' %}
{% block title %}Configuraci√≥n ‚Äì Productos y Precios{% endblock %}

{% block content %}
<div class="config-header">
    <h2>Configuraci√≥n: Productos y Precios</h2>
    {% if guardado %}
    <div class="alert success">¬°Guardado correctamente!</div>
    {% endif %}
</div>

<!-- Navegaci√≥n de subpesta√±as -->
<ul class="tabs">
    {% for tab in tabs %}
    <li class="{% if tab == active %}active{% endif %}">
        {% if tab == 'precios' %}
        <a href="{{ url_for('configuracion_precios') }}">{{ tab|capitalize }}</a>
        {% else %}
        <a href="{{ url_for('configuracion_tab', tab=tab) }}">{{ tab|capitalize }}</a>
        {% endif %}
    </li>
    {% endfor %}
</ul>

<!-- Secci√≥n de subida de PDF -->
<div class="card mb-6">
    <div class="card-header bg-success text-white">
        <h3>üìÑ Importar Productos desde PDF/Excel</h3>
    </div>
    <div class="card-body">
        <div class="grid grid-cols-2 gap-6">
            <div>
                <form action="{{ url_for('subir_pdf_servicios') }}" method="POST" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="pdf_file" class="block text-sm font-medium mb-2">Subir cat√°logo en PDF/Excel:</label>
                        <input type="file" name="pdf_file" id="pdf_file"
                               accept=".pdf,.xlsx,.xls,.csv,.docx,.txt" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <small class="text-muted">Formatos aceptados: PDF, XLSX, XLS, CSV, DOCX, TXT. M√°x. 50MB</small>
                    </div>
                    <button type="submit" class="btn btn-success mt-3">
                        üöÄ Procesar Cat√°logo Autom√°ticamente
                    </button>
                </form>
            </div>

            <div class="bg-blue-50 p-4 rounded-lg">
                <h4 class="font-semibold mb-2">üí° ¬øC√≥mo funciona?</h4>
                <ul class="text-sm space-y-1">
                    <li>‚Ä¢ Sube tu cat√°logo de productos en PDF/Excel</li>
                    <li>‚Ä¢ La IA analizar√° y extraer√° autom√°ticamente</li>
                    <li>‚Ä¢ Los productos se guardar√°n en la base de datos</li>
                    <li>‚Ä¢ La IA los usar√° para responder consultas</li>
                </ul>

                <h4 class="font-semibold mt-3 mb-2">üìã Para mejores resultados:</h4>
                <ul class="text-sm space-y-1">
                    <li>‚Ä¢ Archivo con SKU, categor√≠as y precios claros</li>
                    <li>‚Ä¢ Estructura clara de productos y categor√≠as</li>
                    <li>‚Ä¢ Precios de mayoreo y menudeo identificados</li>
                    <li>‚Ä¢ Informaci√≥n completa de medidas y modelos</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Secci√≥n de estructura din√°mica -->
<div class="card mt-6">
    <div class="card-header bg-info text-white">
        <h3>üèóÔ∏è Estructura de la Tabla de Productos</h3>
    </div>
    <div class="card-body">
        <div class="grid grid-cols-2 gap-4">
            <div>
                <h4 class="font-semibold mb-2">Columnas Base (Fijas):</h4>
                <ul class="text-sm space-y-1">
                    <li>‚Ä¢ id (Primary Key)</li>
                    <li>‚Ä¢ sku (Unique)</li>
                    <li>‚Ä¢ servicio ‚Üí producto</li>
                    <li>‚Ä¢ descripcion</li>
                    <li>‚Ä¢ precio ‚Üí costo</li>
                    <li>‚Ä¢ precio_mayoreo</li>
                    <li>‚Ä¢ precio_menudeo</li>
                    <li>‚Ä¢ moneda</li>
                </ul>
            </div>
            <div>
                <h4 class="font-semibold mb-2">Nuevas Columnas:</h4>
                <div id="columnas-dinamicas">
                    <ul class="text-sm space-y-1">
                        <li>‚Ä¢ categoria</li>
                        <li>‚Ä¢ subcategoria</li>
                        <li>‚Ä¢ linea</li>
                        <li>‚Ä¢ modelo</li>
                        <li>‚Ä¢ medidas</li>
                        <li>‚Ä¢ imagen</li>
                        <li>‚Ä¢ status_ws</li>
                        <li>‚Ä¢ catalogo</li>
                        <li>‚Ä¢ catalogo2</li>
                        <li>‚Ä¢ catalogo3</li>
                    </ul>
                </div>
                <button type="button" onclick="cargarEstructura()" class="btn small primary mt-2">
                    üîÑ Actualizar Estructura
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Tarjeta: Formulario colapsable para agregar/editar producto -->
<div class="card mb-4">
    <div class="card-header cursor-pointer" id="formulario-header" onclick="toggleFormulario()">
        <h3 class="flex justify-between items-center">
            <span>{{ precio_edit and '‚úèÔ∏è Editar Producto' or '‚ûï Agregar Producto' }}</span>
            <span id="formulario-icon">‚ñº</span>
        </h3>
    </div>
    <div class="card-body hidden" id="formulario-body">
        <form action="{{ url_for('configuracion_precio_guardar') }}" method="post" enctype="multipart/form-data">
            {% if precio_edit %}
            <input type="hidden" name="id" value="{{ precio_edit.id }}">
            {% endif %}

            <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                    <label for="sku">SKU *</label>
                    <input type="text" id="sku" name="sku" class="input" required
                           value="{{ precio_edit.sku if precio_edit else '' }}"
                           placeholder="Ej: PROD-001">
                </div>

                <div class="form-group">
                    <label for="servicio">Producto *</label>
                    <input type="text" id="servicio" name="servicio" class="input" required
                           value="{{ precio_edit.servicio if precio_edit else '' }}"
                           placeholder="Ej: Laptop Gaming">
                </div>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div class="form-group">
                    <label for="categoria">Categor√≠a</label>
                    <input type="text" id="categoria" name="categoria" class="input"
                           value="{{ precio_edit.categoria if precio_edit else '' }}"
                           placeholder="Ej: Electr√≥nicos">
                </div>

                <div class="form-group">
                    <label for="subcategoria">Subcategor√≠a</label>
                    <input type="text" id="subcategoria" name="subcategoria" class="input"
                           value="{{ precio_edit.subcategoria if precio_edit else '' }}"
                           placeholder="Ej: Computadoras">
                </div>

                <div class="form-group">
                    <label for="linea">L√≠nea</label>
                    <input type="text" id="linea" name="linea" class="input"
                           value="{{ precio_edit.linea if precio_edit else '' }}"
                           placeholder="Ej: Gaming">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                    <label for="modelo">Modelo</label>
                    <input type="text" id="modelo" name="modelo" class="input"
                           value="{{ precio_edit.modelo if precio_edit else '' }}"
                           placeholder="Ej: XPS-15">
                </div>

                <div class="form-group">
                    <label for="medidas">Medidas</label>
                    <input type="text" id="medidas" name="medidas" class="input"
                           value="{{ precio_edit.medidas if precio_edit else '' }}"
                           placeholder="Ej: 15.6 pulgadas">
                </div>
            </div>

            <div class="form-group">
                <label for="descripcion">Descripci√≥n</label>
                <textarea id="descripcion" name="descripcion" class="textarea" rows="2"
                          placeholder="Ej: Laptop para gaming con RTX 4060, 16GB RAM, 1TB SSD">{{ precio_edit.descripcion if precio_edit else '' }}</textarea>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div class="form-group">
                    <label for="precio">Costo *</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-600">$</span>
                        <input type="number" step="0.01" min="0" id="precio" name="precio" class="input pl-8" required
                               value="{{ precio_edit.precio if precio_edit else '' }}"
                               placeholder="0.00">
                    </div>
                </div>

                <div class="form-group">
                    <label for="precio_mayoreo">Precio Mayoreo</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-600">$</span>
                        <input type="number" step="0.01" min="0" id="precio_mayoreo" name="precio_mayoreo" class="input pl-8"
                               value="{{ precio_edit.precio_mayoreo if precio_edit else '' }}"
                               placeholder="0.00">
                    </div>
                </div>

                <div class="form-group">
                    <label for="precio_menudeo">Precio Menudeo</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-600">$</span>
                        <input type="number" step="0.01" min="0" id="precio_menudeo" name="precio_menudeo" class="input pl-8"
                               value="{{ precio_edit.precio_menudeo if precio_edit else '' }}"
                               placeholder="0.00">
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                    <label for="moneda">Moneda *</label>
                    <select id="moneda" name="moneda" class="select" required>
                        {% for m in ['MXN','USD','EUR'] %}
                        <option value="{{ m }}" {% if precio_edit and precio_edit.moneda==m %}selected{% endif %}>
                            {{ m }} - {{ 'Peso Mexicano' if m == 'MXN' else 'D√≥lar Americano' if m == 'USD' else 'Euro' }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="imagen">Imagen</label>
                    <input type="file" id="imagen" name="imagen" class="input"
                           accept="image/*">
                    {% if precio_edit and precio_edit.imagen %}
                    <small class="text-muted">Imagen actual: {{ precio_edit.imagen }}</small>
                    {% endif %}
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                    <label for="status_ws">Status WS</label>
                    <input type="text" id="status_ws" name="status_ws" class="input"
                           value="{{ precio_edit.status_ws if precio_edit else '' }}"
                           placeholder="Ej: activo">
                </div>
                <div class="form-group">
                    <label for="catalogo">Cat√°logo</label>
                    <input type="text" id="catalogo" name="catalogo" class="input"
                           value="{{ precio_edit.catalogo if precio_edit else '' }}"
                           placeholder="Ej: Cat√°logo 1">
                </div>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <div class="form-group">
                    <label for="catalogo2">Cat√°logo 2</label>
                    <input type="text" id="catalogo2" name="catalogo2" class="input"
                           value="{{ precio_edit.catalogo2 if precio_edit else '' }}"
                           placeholder="Ej: Cat√°logo 2">
                </div>
                <div class="form-group">
                    <label for="catalogo3">Cat√°logo 3</label>
                    <input type="text" id="catalogo3" name="catalogo3" class="input"
                           value="{{ precio_edit.catalogo3 if precio_edit else '' }}"
                           placeholder="Ej: Cat√°logo 3">
                </div>
                <div class="form-group">
                    <label for="proveedor">Proveedor</label>
                    <input type="text" id="proveedor" name="proveedor" class="input"
                           value="{{ precio_edit.proveedor if precio_edit else '' }}"
                           placeholder="Ej: Proveedor S.A.">
                </div>
            </div>
            <div class="form-actions flex justify-end gap-2">
                <button type="submit" class="btn primary">
                    {{ precio_edit and 'üíæ Actualizar' or 'üíæ Guardar' }}
                </button>
                <a href="{{ url_for('configuracion_precios') }}" class="btn secondary">
                    ‚Ü©Ô∏è Cancelar
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Tarjeta: Lista de productos (Vista Cliente) -->
<div class="card mb-4">
    <div class="card-header bg-gray-100" id="productos-cliente-header">
        <h3 class="flex justify-between items-center">
            <span>üìã Productos (Vista Cliente) ({{ precios|length }} registros)</span>
            <button type="button" onclick="toggleCliente()" class="btn-toggle px-3 py-1 rounded bg-white">
                <span id="productos-cliente-icon">‚ñº</span>
            </button>
        </h3>
    </div>
    <div class="card-body hidden" id="productos-cliente-body">
        {% if precios %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>Producto</th>
                        <th>Categor√≠a</th>
                        <th>Descripci√≥n</th>
                        <th>Imagen</th>
                        <th>Mayoreo</th>
                        <th>Menudeo</th>
                        <th>Moneda</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for precio in precios %}
                    <tr>
                        <td><span class="bg-gray-100 px-2 py-1 rounded text-xs">{{ precio.sku or '-' }}</span></td>
                        <td class="font-medium">{{ precio.servicio }}</td>
                        <td>{{ precio.categoria or '-' }}{% if precio.subcategoria %} / {{ precio.subcategoria }}{% endif %}</td>
                        <td>{{ precio.descripcion|default('-')|truncate(30) }}</td>
                        <td>
                            {% if precio.imagen %}
                            <img src="/uploads/{{ precio.imagen }}" alt="Imagen" class="w-12 h-12 object-cover rounded">
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td class="text-right text-green-600">${{ "{:,.2f}".format(precio.precio_mayoreo) if precio.precio_mayoreo else '-' }}</td>
                        <td class="text-right text-blue-600">${{ "{:,.2f}".format(precio.precio_menudeo) if precio.precio_menudeo else '-' }}</td>
                        <td>{{ precio.moneda }}</td>
                        <td>
                            <a href="{{ url_for('configuracion_precio_editar', pid=precio.id) }}"
                               class="btn small primary">Editar</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-8">
            <div class="text-gray-500 text-lg mb-2">üìù No hay productos registrados</div>
            <p class="text-sm text-gray-400">Usa el formulario de arriba para agregar productos manualmente.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Tarjeta: Lista de productos completa (Vista Admin) -->
<div class="card">
    <div class="card-header bg-blue-100" id="productos-admin-header">
        <h3 class="flex justify-between items-center">
            <span>üîí Productos y Precios (Vista Completa Admin) ({{ precios|length }} registros)</span>
            <button type="button" onclick="toggleAdmin()" class="btn-toggle px-3 py-1 rounded bg-white">
                <span id="productos-admin-icon">‚ñº</span>
            </button>
        </h3>
    </div>
    <div class="card-body hidden" id="productos-admin-body">
        {% if precios %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>Producto</th>
                        <th>Categor√≠a</th>
                        <th>Costo</th>
                        <th>Mayoreo</th>
                        <th>Menudeo</th>
                        <th>Imagen</th>
                        <th>Moneda</th>
                        <th>Proveedor</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for precio in precios %}
                    <tr>
                        <td><span class="bg-gray-100 px-2 py-1 rounded text-xs">{{ precio.sku or '-' }}</span></td>
                        <td class="font-medium">{{ precio.servicio }}</td>
                        <td>{{ precio.categoria or '-' }}{% if precio.subcategoria %} / {{ precio.subcategoria }}{% endif %}</td>
                        <td class="text-right text-red-600">${{ "{:,.2f}".format(precio.costo) if precio.costo else "{:,.2f}".format(precio.precio) }}</td>
                        <td class="text-right text-green-600">${{ "{:,.2f}".format(precio.precio_mayoreo) if precio.precio_mayoreo else '-' }}</td>
                        <td class="text-right text-blue-600">${{ "{:,.2f}".format(precio.precio_menudeo) if precio.precio_menudeo else '-' }}</td>
                        <td>
                            {% if precio.imagen %}
                            <img src="/uploads/{{ precio.imagen }}" alt="Imagen" class="w-12 h-12 object-cover rounded">
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>{{ precio.moneda }}</td>
                        <td>{{ precio.proveedor or '-' }}</td>
                        <td>
                            <div class="flex space-x-2">
                                <a href="{{ url_for('configuracion_precio_editar', pid=precio.id) }}"
                                   class="btn small primary">Editar</a>
                                <form action="{{ url_for('configuracion_precio_borrar', pid=precio.id) }}"
                                      method="post" class="inline-form">
                                    <button type="submit"
                                            class="btn small danger"
                                            onclick="return confirm('¬øEliminar {{ precio.servicio }}?');">
                                        Borrar
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-8">
            <div class="text-gray-500 text-lg mb-2">üìù No hay productos registrados</div>
            <p class="text-sm text-gray-400">Usa el formulario de arriba para agregar productos manualmente.</p>
        </div>
        {% endif %}
    </div>
</div>
<!-- Mensajes Flash -->
<div class="mt-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert {{ 'success' if category == 'success' else 'error' if category == 'error' else 'warning' }}">
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}
</div>
{% endblock %}

<style>
    .alert {
        padding: 12px 16px;
        border-radius: 6px;
        margin: 10px 0;
        font-weight: 500;
    }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

    .btn-success {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
    }

        .btn-success:hover {
            background: #218838;
        }

    .bg-success {
        background: #28a745 !important;
    }

    .bg-blue-50 {
        background: #eff6ff;
    }

    .bg-info {
        background: #17a2b8 !important;
    }

    .text-green-600 {
        color: #059669;
    }

    .text-blue-600 {
        color: #2563eb;
    }

    /* Estilos para el formulario colapsable */
    .cursor-pointer {
        cursor: pointer;
    }

    .hidden {
        display: none;
    }

    .card-header {
        transition: background-color 0.2s;
    }

        .card-header:hover {
            background-color: #f8f9fa;
        }

    /* Asegurar que la tabla ocupe todo el ancho */
    .table-responsive {
        width: 100%;
        overflow-x: auto;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
    }

        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .table th {
            background-color: #f8fafc;
            font-weight: 600;
        }
</style>

<script>
        function toggleFormulario() {
        const formularioBody = document.getElementById('formulario-body');
        const formularioIcon = document.getElementById('formulario-icon');

        if (formularioBody.classList.contains('hidden')) {
            formularioBody.classList.remove('hidden');
        formularioIcon.textContent = '‚ñ≤';
        } else {
            formularioBody.classList.add('hidden');
        formularioIcon.textContent = '‚ñº';
        }
    }

        function toggleCliente() {
            console.log("Toggle Cliente clicked");
        const productosBody = document.getElementById('productos-cliente-body');
        const productosIcon = document.getElementById('productos-cliente-icon');

        if (productosBody.classList.contains('hidden')) {
            productosBody.classList.remove('hidden');
        productosIcon.textContent = '‚ñ≤';
        } else {
            productosBody.classList.add('hidden');
        productosIcon.textContent = '‚ñº';
        }
    }

        function toggleAdmin() {
            console.log("Toggle Admin clicked");
        const productosBody = document.getElementById('productos-admin-body');
        const productosIcon = document.getElementById('productos-admin-icon');

        if (productosBody.classList.contains('hidden')) {
            productosBody.classList.remove('hidden');
        productosIcon.textContent = '‚ñ≤';
        } else {
            productosBody.classList.add('hidden');
        productosIcon.textContent = '‚ñº';
        }
    }

        document.addEventListener('DOMContentLoaded', function() {
            {% if precio_edit %}
        toggleFormulario();
        {% endif %}

        cargarEstructura();
    });

        function cargarEstructura() {
            fetch('/configuracion/precios/estructura')
                .then(response => response.json())
                .then(data => {
                    const contenedor = document.getElementById('columnas-dinamicas');
                    if (!contenedor) return;

                    const columnasBase = ['id', 'sku', 'servicio', 'descripcion', 'precio', 'precio_mayoreo', 'precio_menudeo', 'moneda'];
                    const columnasDinamicas = data.estructura.filter(col =>
                        !columnasBase.includes(col.Field)
                    );

                    if (columnasDinamicas.length > 0) {
                        let html = '<ul class="text-sm space-y-1">';
                        columnasDinamicas.forEach(col => {
                            html += `<li>‚Ä¢ ${col.Field} (${col.Type})</li>`;
                        });
                        html += '</ul>';
                        contenedor.innerHTML = html;
                    } else {
                        contenedor.innerHTML = '<p class="text-sm text-gray-600">No hay columnas din√°micas adicionales.</p>';
                    }
                })
                .catch(error => console.error("Error cargando estructura:", error));
    }

</script>