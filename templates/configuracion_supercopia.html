{% extends 'base.html' %}
{% block title %}Configuración – {{ active|capitalize }}{% endblock %}
{% block content %}
<link rel="stylesheet" href="C:\Users\jedua\OneDrive\Documents\GitHub\Whatsmektia\static\css\styles.css">
<style>
    .form-text text-muted {
        color: white;
    }

    .asesores-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .asesor-card {
        padding: 12px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        background: #fff;
    }

    .longitud_desc {
        /* use flex so the textarea expands inside the row */
        flex: 1;
        min-width: 360px;
        max-width: 100%;
        padding: 8px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        height: auto;
        resize: vertical; /* user can expand vertically */
        font-size: 14px;
        line-height: 1.4;
    }

    @media (max-width: 900px) {
        .longitud_desc {
            min-width: 140px;
        }
    }

    .PDF {
        color: black;
    }
</style>
<div class="config-header">
    <h2>Configuración: {{ active|capitalize }}</h2>
    {% if guardado %}
    <div class="alert success">¡Guardado correctamente!</div>
    {% endif %}
</div>

<!-- Pestañas -->
<ul class="tabs">
    {% for tab in tabs %}
    <li class="tab-{{ tab }} {{ 'active' if tab == active else '' }}">
        <a href="{{ url_for('configuracion_tab', tab=tab) }}">{{ tab|capitalize }}</a>
    </li>
    {% endfor %}
</ul>

<!-- Contenido de la subpestaña -->
{% if active == 'negocio' %}
<!-- En la sección de integración con Google Calendar -->
<div class="form-group" style="color: white;">
    <label>Integración con Google Calendar</label>
    <div>
        {% if 'laporfirianna' in request.host %}
        <a href="{{ url_for('autorizar_porfirianna') }}" class="btn btn-primary">
            Autorizar con Google Calendar
        </a>
        {% else %}
        <a href="{{ url_for('autorizar_manual') }}" class="btn btn-primary">
            Autorizar con Google Calendar
        </a>
        {% endif %}
        <small class="form-text text-muted">
            Permite agendar citas automáticamente en tu calendario
        </small>
    </div>
</div>

<form class="config-form" method="POST" enctype="multipart/form-data">
    <!-- AÑADE EL CAMPO AQUÍ AL INICIO DEL FORMULARIO -->
    <!--<div class="form-card">
         <label>Correo para notificaciones de Calendar</label>
         <input type="email" name="calendar_email" value="{{ datos.calendar_email or '' }}"
                placeholder="ejemplo@gmail.com">
         <small class="form-text text-muted">
             Este correo recibirá notificaciones cuando se agende una cita en Google Calendar
         </small>
     </div>-->
    <div class="form-row">
        <div class="form-card" style="width: 30%;">
            <label>Nombre de tu IA personalizada</label>
            <input type="text" name="ia_nombre" value="{{ datos.ia_nombre or '' }}" required>
            <small class="form-text text-muted">
                Este nombre se mostrará en el sidebar y título de la página
            </small>
        </div>
        <div class="form-card" style="width: 30%;">
            <label>Nombre de tu Negocio</label>
            <input type="text" name="negocio_nombre" value="{{ datos.negocio_nombre or '' }}" required>
        </div>
        <div class="form-card" style="width: 30%;">
            <label>URL del Negocio</label>
            <input type="url" name="url" value="{{ datos.url or '' }}">
        </div>
    </div>
    <div class="form-card" style="width: 93%;">
        <label>Descripción del Negocio</label>
        <textarea name="descripcion" rows="4" required>{{ datos.descripcion or '' }}</textarea>
    </div>
    <div class="form-row">

        <div class="form-card" style="width: 30%;">
            <label>Dirección</label>
            <input type="text" name="direccion" value="{{ datos.direccion or '' }}">
        </div>
        <div class="form-card" style="width: 30%;">
            <label>Teléfono</label>
            <input type="tel" name="telefono" value="{{ datos.telefono or '' }}">
        </div>
        <div class="form-card" style="width: 30%;">
            <label>Logo de la Aplicación</label>
            <input type="file" name="app_logo" accept="image/png, image/jpeg, image/svg+xml">
            <small class="form-text text-muted">
                Formatos: PNG, JPG, SVG (Tamaño recomendado: 200x50px)
            </small>
            {% if datos.app_logo %}
            <div style="margin-top: 8px; padding: 5px; background: #f8f9fa; border-radius: 4px; display: inline-block;">
                <img src="{{ datos.app_logo }}?v={{ range(1000, 9999) | random }}" alt="Logo actual" style="max-height: 40px;">
                <input type="hidden" name="app_logo_actual" value="{{ datos.app_logo }}">
            </div>
            {% endif %}
        </div>
    </div>

    <div class="form-row">

        <div class="form-card" style="width: 20%;">
            <label>Correo de contacto</label>
            <input type="email" name="correo" value="{{ datos.correo or '' }}">
        </div>
        <div class="form-card" style="width: 20%;">
            <label>Banco</label>
            <input type="text" name="transferencia_banco" value="{{ datos.transferencia_banco or '' }}"
                   placeholder="BBVA">
        </div>
        <div class="form-card" style="width: 20%;">
            <label>Nombre en la cuenta</label>
            <input type="text" name="transferencia_nombre" value="{{ datos.transferencia_nombre or '' }}"
                   placeholder="Jonas">
        </div>
        <div class="form-card" style="width: 28%;">
            <label>Datos para transferencia - Número de cuenta</label>
            <input type="text" name="transferencia_numero" value="{{ datos.transferencia_numero or '' }}"
                   placeholder="1123 3454 2344 2343">
            <small class="form-text text-muted">Número de cuenta o CLABE (según corresponda).</small>
        </div>
    </div>
    <div class="form-card" style="width: 93%;">
        <label>¿Qué quieres que haga tu IA?</label>
        <textarea name="que_hace" rows="7" required>{{ datos.que_hace or '' }}</textarea>
    </div>
    <div class="form-card" style="width: 93%;">
        <label>Leads, temas a los que avisar a un asesor</label>
        <textarea name="contexto_adicional" rows="6" placeholder="Escribe aquí información extra que la IA deba saber: horarios de vacaciones, historia de la empresa, políticas específicas de garantía, promociones temporales, etc.">{{ datos.contexto_adicional or '' }}</textarea>
        <small class="form-text text-muted">
            Esta información se inyectará directamente en el "cerebro" de la IA para todas las respuestas.
        </small>
    </div>
            <button type="submit" class="btn-primary" style="width:93%">Guardar Negocio</button>
</form>
<div class="form-row" style="margin-top: 30px;">
    <form action="{{ url_for('publicar_pdf_configuracion') }}" method="POST" enctype="multipart/form-data" style="margin-bottom:16px; width:93%">
        <div class="form-card" style="width: 100%;">
            <label>Publicar PDF (Catálogo / Documento)</label>
            <div style="display:flex;align-items:flex-start;gap:8px;flex-wrap:wrap;">
                <input type="file" name="public_pdf" accept=".pdf,image/*,video/*,.mp4,.mov,.webm,.avi,.mkv" required aria-label="Seleccionar archivo PDF o " style="flex:0 0 auto;">
                <textarea name="public_pdf_descripcion" class="longitud_desc" rows="4" placeholder="Descripción (opcional). Añade palabras claves para que la IA seleccione el catálogo más relevante."></textarea>
                <div style="flex:0 0 auto; display:flex; align-items:center;">
                    <button type="submit" class="btn-success">📄 Publicar PDF</button>
                </div>
            </div>
            <small class="form-text text-muted">El PDF se guardará en el servidor y se registrará en la base de datos. Añade una descripción útil (palabras clave, categorías, usos).</small>
        </div>
    </form>
    <div class="form-card" style="width:93%">
        <h4>📚 Catálogos publicados</h4>
        {% if documents_publicos and documents_publicos|length > 0 %}
        <div class="table-responsive">
            <table class="table" style="font-size:13px;">
                <thead>
                    <tr>
                        <th style="color:black;">Archivo</th>
                        <th style="color:black;">Descripción</th>
                        <th style="color:black;">Publicado</th>
                        <th style="color:black;">Acciones</th>
                    </tr>
                </thead>
                <tbody class="PDF">
                    {% for doc in documents_publicos %}
                    <tr>
                        <td style="color:black;">
                            <a href="{{ url_for('serve_public_docs', relpath=(doc.get('tenant_slug') ~ '/' ~ doc.filename) if doc.get('tenant_slug') else doc.filename) }}" target="_blank" rel="noopener">
                                {{ doc.filename }}
                            </a>
                        </td>
                        <td style="color:black;">{{ doc.descripcion or '-' }}</td>
                        <td style="color:black;">{{ doc.created_at.strftime('%d/%m/%Y %H:%M') if doc.created_at else '-' }}</td>
                        <td style="color:black;">
                            <div style="display:flex; gap:8px; align-items:center;">
                                <a class="btn small" href="{{ url_for('serve_public_docs', relpath=(doc.get('tenant_slug') ~ '/' ~ doc.filename) if doc.get('tenant_slug') else doc.filename) }}" target="_blank">Ver / Descargar</a>
                                <form action="{{ url_for('borrar_pdf_configuracion', doc_id=doc.id) }}" method="post" onsubmit="return confirm('¿Eliminar {{ doc.filename }}? Esta acción no se puede deshacer.');" style="display:inline;">
                                    <button type="submit" class="btn danger small">🗑️ Eliminar</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-muted">No hay catálogos publicados.</div>
        {% endif %}
    </div>
</div>
{% elif active == 'leads' %}
<form class="config-form" method="POST">
    <div class="form-card">
        <h3>Mensajes de Seguimiento Automático</h3>
        <p class="text-muted" style="margin-bottom: 15px; color: #666;">
            Configura qué mensaje enviará la IA automáticamente cuando detecte que un chat ha cambiado de estado.
            Si dejas el campo vacío, la IA generará un mensaje creativo basado en el contexto de la charla.
        </p>

        <div style="margin-bottom: 20px; padding: 15px; background: #fff3e0; border-radius: 8px; border: 1px solid #ffe0b2;">
            <label style="color: #e65100; font-weight: bold;">🌡 Leads Tibios (Seguimiento Corto)</label>
            <p style="font-size: 0.85rem; margin-bottom: 8px; color: #555;">
                Se usa para usuarios que mostraron interés pero han dejado de contestar entre <strong>30 minutos y 5 horas</strong>.
            </p>
            <textarea name="mensaje_tibio" rows="3" class="longitud_desc"
                      placeholder="Ej: Hola, ¿tuviste oportunidad de revisar la información? Quedo pendiente de tus dudas.">{{ datos.mensaje_tibio or '' }}</textarea>
        </div>

        <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border: 1px solid #bbdefb;">
            <label style="color: #1565c0; font-weight: bold;">❄ Leads Fríos (Re-contacto)</label>
            <p style="font-size: 0.85rem; margin-bottom: 8px; color: #555;">
                Se usa cuando han pasado entre <strong>5 y 20 horas</strong> sin respuesta, o si el usuario interactuó muy poco (solo un mensaje).
            </p>
            <textarea name="mensaje_frio" rows="3" class="longitud_desc"
                      placeholder="Ej: Hola, vi que te interesaste en nuestros servicios. ¿Te gustaría que te comparta nuestras promociones vigentes?">{{ datos.mensaje_frio or '' }}</textarea>
        </div>

        <div style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px; border: 1px solid #e0e0e0;">
            <label style="color: #616161; font-weight: bold;">😴 Leads Dormidos (Recuperación)</label>
            <p style="font-size: 0.85rem; margin-bottom: 8px; color: #555;">
                Se envía cuando han pasado <strong>más de 20 horas</strong> sin actividad. Es el último intento para recuperar la conversación.
            </p>
            <textarea name="mensaje_dormido" rows="3" class="longitud_desc"
                      placeholder="Ej: ¡Hola! Hace tiempo que no platicamos. ¿Sigues interesado en continuar con tu proyecto?">{{ datos.mensaje_dormido or '' }}</textarea>
        </div>
    </div>

    <button type="submit" class="btn-primary">Guardar Mensajes de Leads</button>

    <h2 style="margin-top: 30px; margin-bottom: 15px; color: aliceblue;">Configuración de Leads</h2>

    <style>
        .leads-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 12px;
        }

        .lead-card {
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #fff;
        }

        .form-check-input {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
    </style>

    <div class="leads-grid">
        {# Definir una lista de leads de ejemplo si no tienes una en el contexto de Flask #}
        {% set leads_a_configurar = ['Nuevo', 'Frio', 'Caliente', 'Cerrado'] %}

        {# Asumimos que leads_map contiene las configuraciones actuales, ej: leads_map = {'nuevo': {'dias_a_caliente': 5, 'usar_ia': True, ...}} #}
        {% set leads_map = leads_config_list if leads_config_list is defined and leads_config_list is mapping else {} %}

        {% for lead_name in leads_a_configurar %}
        {% set lead_key = lead_name|lower|replace(' ', '_') %}
        {% set lead_config = leads_map.get(lead_key, {}) %}

        <div class="lead-card">
            <h4 style="margin-top: 0; color:black">Lead: **{{ lead_name|capitalize }}**</h4>

            {% if lead_key != 'caliente' %}
            <label for="{{ lead_key }}_a_caliente_dias">Días para cambiar a **Caliente**:</label>
            <input type="number" id="{{ lead_key }}_a_caliente_dias" name="{{ lead_key }}_a_caliente_dias"
                   class="input" min="1" value="{{ lead_config.get('dias_a_caliente', 7) }}"
                   placeholder="Ej: 7" required>
            {% endif %}
            <div style="margin-top: 15px;">
                <label for="{{ lead_key }}_criterio_ia">Criterio para Clasificar a Caliente (por IA):</label>
                <textarea id="{{ lead_key }}_criterio_ia" name="{{ lead_key }}_criterio_ia"
                          class="longitud_desc" rows="3"
                          placeholder="Ej: El cliente preguntó por los 'servicios de consultoría financiera' o 'planes premium'."
                          style="width: 100%;">{{ lead_config.get('criterio_ia', '') }}</textarea>
                <small style="display: block; margin-top: 5px; color: #666;">
                    Define la condición que la IA debe verificar en el chat.
                </small>
            </div>
            <div style="margin-top: 15px; display: flex; align-items: center;">
                <label for="{{ lead_key }}_usar_ia" style="flex: 1; margin-right: 10px;">Usar **IA** para clasificación:</label>
                {# Un campo hidden para asegurar que el valor 'off' se envía si el checkbox no está marcado #}
                <input type="hidden" name="{{ lead_key }}_usar_ia" value="off">
                <input type="checkbox" id="{{ lead_key }}_usar_ia" name="{{ lead_key }}_usar_ia"
                       class="form-check-input" value="on"
                       {{ 'checked' if lead_config.get('usar_ia') == True else '' }}>
            </div>

            <label for="{{ lead_key }}_tiempo_siguiente_minutos" style="margin-top: 15px;">Tiempo (**minutos**) sin mensaje para cambio:</label>
            <input type="number" id="{{ lead_key }}_tiempo_siguiente_minutos" name="{{ lead_key }}_tiempo_siguiente_minutos"
                   class="input" min="1" value="{{ lead_config.get('tiempo_siguiente_minutos', 1440) }}"
                   placeholder="Ej: 1440 (24 horas)" required>

            <div style="margin-top: 15px; display: flex; align-items: center;">
                <label for="{{ lead_key }}_tipo" style="flex: 1; margin-right: 10px;">Tipo **Estático** (no cambia después):</label>
                {# Un campo hidden para enviar 'dinamico' si no está marcado #}
                <input type="hidden" name="{{ lead_key }}_tipo" value="dinamico">
                <input type="checkbox" id="{{ lead_key }}_tipo" name="{{ lead_key }}_tipo"
                       class="form-check-input" value="estatico"
                       {{ 'checked' if lead_config.get('tipo') == 'estatico' else '' }}>
            </div>
        </div>
        {% endfor %}
    </div>
</form>
{% elif active == 'personalizacion' %}
<form class="config-form" method="POST">
    <div class="form-card">
        <label>Tono de la IA</label>
        <input type="text" name="tono" value="{{ datos.tono or '' }}" required>
    </div>
    <div class="form-card">
        <label>Lenguaje preferido</label>
        <input type="text" name="lenguaje" value="{{ datos.lenguaje or '' }}" required>
    </div>
    <button type="submit" class="btn-primary">Guardar Personalización</button>
    
</form>

{% elif active == 'precios' %}
<!-- El contenido de precios se maneja en otra ruta -->
<p>La configuración de precios se maneja en una página separada.</p>
<a href="{{ url_for('configuracion_precios') }}" class="btn btn-primary">Gestionar Precios</a>

{% elif active == 'restricciones' %}
<form class="config-form" method="POST">
    <div class="form-card">
        <label>Restricciones del Bot (Una por línea)</label>
        <textarea name="restricciones" rows="8" placeholder="Ejemplo:
- No agendar citas sin confirmación previa
- No proporcionar precios exactos
- No prometer fechas de entrega específicas
- No aceptar pedidos fuera del horario laboral
- No compartir información confidencial">{{ datos.restricciones or '' }}</textarea>
        <small class="form-text text-muted">
            Lista de cosas que el bot NO debe hacer. Cada restricción en una línea nueva.
        </small>
    </div>

    <div class="form-card">
        <label>Palabras clave prohibidas</label>
        <textarea name="palabras_prohibidas" rows="4" placeholder="Ejemplo:
gratis, inmediato, garantizado, prometo, seguro">{{ datos.palabras_prohibidas or '' }}</textarea>
        <small class="form-text text-muted">
            Palabras que el bot debe evitar usar en sus respuestas.
        </small>
    </div>

    <div class="form-card">
        <label>Límites de la IA</label>
        <div class="form-row">
            <div class="form-group">
                <label>Máximo de mensajes por conversación:</label>
                <input type="number" name="max_mensajes" value="{{ datos.max_mensajes or '10' }}" min="1" max="1000">
            </div>
            <div class="form-group">
                <label>Tiempo máximo de respuesta (segundos):</label>
                <input type="number" name="tiempo_max_respuesta" value="{{ datos.tiempo_max_respuesta or '30' }}" min="5" max="120">
            </div>
        </div>
    </div>

    <button type="submit" class="btn-primary">Guardar Restricciones</button>
</form>
{% elif active == 'asesores' %}
<form class="config-form" method="POST">
    <div class="form-card">
        <h3>Asesores de Ventas</h3>
        {# Normalize and clamp asesor_count to a sensible integer so template shows exactly that many fields #}
        {% set max_asesores = asesor_count|default(2)|int %}
        {% if max_asesores < 1 %}
        {% set max_asesores = 1 %}
        {% elif max_asesores > 50 %}
        {% set max_asesores = 50 %}
        {% endif %}
        <p>Agrega hasta {{ max_asesores }} asesor(es) (según tu plan). Estos datos se usarán para notificaciones y contactos internos.</p>
    </div>

    <div class="asesores-grid">
        {% for i in range(1, max_asesores + 1) %}
        {% set idx = i - 1 %}
        {% set nombre = '' %}
        {% set telefono_val = '' %}
        {% set email_val = '' %}
        {% if asesores_list and idx < asesores_list|length %}
        {% set advisor = asesores_list[idx] %}
        {% if advisor is mapping %}
        {% set nombre = advisor.get('nombre', '') %}
        {% set telefono_val = advisor.get('telefono', '') %}
        {% set email_val = advisor.get('email', '') %}
        {% endif %}
        {% endif %}
        <div class="asesor-card">
            <label for="asesor{{ i }}_nombre">Asesor {{ i }} - Nombre</label>
            <input type="text" id="asesor{{ i }}_nombre" name="asesor{{ i }}_nombre" class="input"
                   value="{{ nombre }}" placeholder="Ej: Juan Pérez">
            <label for="asesor{{ i }}_telefono" style="margin-top:8px;">Asesor {{ i }} - Teléfono</label>
            <input type="tel" id="asesor{{ i }}_telefono" name="asesor{{ i }}_telefono" class="input"
                   value="{{ telefono_val }}" placeholder="Ej: 521449XXXXXXX">
            <label for="asesor{{ i }}_email" style="margin-top:8px;">Asesor {{ i }} - Correo electrónico</label>
            <input type="email" id="asesor{{ i }}_email" name="asesor{{ i }}_email" class="input"
                   value="{{ email_val if (email_val is defined) else '' }}" placeholder="ejemplo@dominio.com">
        </div>
        {% endfor %}
    </div>

    <div style="margin-top:12px;">
        <button type="submit" class="btn-primary">Guardar Asesores</button>
    </div>
</form>
{% endif %}
{% endblock %}