{% extends 'base.html' %}
{% block title %}Configuraci√≥n ‚Äì {{ active|capitalize }}{% endblock %}
{% block content %}
<style>
    .form-text text-muted {
        color: white;
    }

    .asesores-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .asesor-card {
        padding: 12px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        background: #fff;
    }

    .longitud_desc {
        /* use flex so the textarea expands inside the row */
        flex: 1;
        min-width: 360px;
        max-width: 100%;
        padding: 8px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        height: auto;
        resize: vertical; /* user can expand vertically */
        font-size: 14px;
        line-height: 1.4;
    }

    @media (max-width: 900px) {
        .longitud_desc {
            min-width: 140px;
        }
    }

    .PDF {
        color: black;
    }
</style>
<div class="config-header">
    <h2>Configuraci√≥n: {{ active|capitalize }}</h2>
    {% if guardado %}
    <div class="alert success">¬°Guardado correctamente!</div>
    {% endif %}
</div>

<!-- Pesta√±as -->
<ul class="tabs">
    {% for tab in tabs %}
    <li class="tab-{{ tab }} {{ 'active' if tab == active else '' }}">
        <a href="{{ url_for('configuracion_tab', tab=tab) }}">{{ tab|capitalize }}</a>
    </li>
    {% endfor %}
</ul>

<!-- Contenido de la subpesta√±a -->
{% if active == 'negocio' %}
<!-- En la secci√≥n de integraci√≥n con Google Calendar -->
<div class="form-group">
    <label>Integraci√≥n con Google Calendar</label>
    <div>
        {% if 'laporfirianna' in request.host %}
        <a href="{{ url_for('autorizar_porfirianna') }}" class="btn btn-primary">
            Autorizar con Google Calendar
        </a>
        {% else %}
        <a href="{{ url_for('autorizar_manual') }}" class="btn btn-primary">
            Autorizar con Google Calendar
        </a>
        {% endif %}
        <small class="form-text text-muted">
            Permite agendar citas autom√°ticamente en tu calendario
        </small>
    </div>
</div>

<form class="config-form" method="POST" enctype="multipart/form-data">
    <!-- A√ëADE EL CAMPO AQU√ç AL INICIO DEL FORMULARIO -->
    <div class="form-card">
        <label>Correo para notificaciones de Calendar</label>
        <input type="email" name="calendar_email" value="{{ datos.calendar_email or '' }}"
               placeholder="ejemplo@gmail.com">
        <small class="form-text text-muted">
            Este correo recibir√° notificaciones cuando se agende una cita en Google Calendar
        </small>
    </div>

    <div class="form-card">
        <label>Nombre de tu IA personalizada</label>
        <input type="text" name="ia_nombre" value="{{ datos.ia_nombre or '' }}" required>
        <small class="form-text text-muted">
            Este nombre se mostrar√° en el sidebar y t√≠tulo de la p√°gina
        </small>
    </div>
    <div class="form-card">
        <label>Nombre de tu Negocio</label>
        <input type="text" name="negocio_nombre" value="{{ datos.negocio_nombre or '' }}" required>
    </div>
    <div class="form-card">
        <label>Descripci√≥n del Negocio</label>
        <textarea name="descripcion" rows="4" required>{{ datos.descripcion or '' }}</textarea>
    </div>
    <div class="form-row">
        <div class="form-card">
            <label>URL del Negocio</label>
            <input type="url" name="url" value="{{ datos.url or '' }}">
        </div>
        <div class="form-card">
            <label>Direcci√≥n</label>
            <input type="text" name="direccion" value="{{ datos.direccion or '' }}">
        </div>
    </div>

    <div class="form-row">
        <div class="form-card">
            <label>Logo de la Aplicaci√≥n</label>
            <input type="file" name="app_logo" accept="image/png, image/jpeg, image/svg+xml">
            <small class="form-text text-muted">
                Formatos: PNG, JPG, SVG (Tama√±o recomendado: 200x50px)
            </small>
            {% if datos.app_logo %}
            <div style="margin-top: 8px; padding: 5px; background: #f8f9fa; border-radius: 4px; display: inline-block;">
                <img src="{{ datos.app_logo }}?v={{ range(1000, 9999) | random }}" alt="Logo actual" style="max-height: 40px;">
                <input type="hidden" name="app_logo_actual" value="{{ datos.app_logo }}">
            </div>
            {% endif %}
        </div>
        <div class="form-card">
            <label>Tel√©fono</label>
            <input type="tel" name="telefono" value="{{ datos.telefono or '' }}">
        </div>
    </div>
    <div class="form-row">
        <div class="form-card">
            <label>Correo de contacto</label>
            <input type="email" name="correo" value="{{ datos.correo or '' }}">
        </div>
    </div>
    <div class="form-row">
        <div class="form-card">
            <label>Datos para transferencia - N√∫mero de cuenta</label>
            <input type="text" name="transferencia_numero" value="{{ datos.transferencia_numero or '' }}"
                   placeholder="1123 3454 2344 2343">
            <small class="form-text text-muted">N√∫mero de cuenta o CLABE (seg√∫n corresponda).</small>
        </div>
        <div class="form-card">
            <label>Nombre en la cuenta</label>
            <input type="text" name="transferencia_nombre" value="{{ datos.transferencia_nombre or '' }}"
                   placeholder="Jonas">
        </div>
        <div class="form-card">
            <label>Banco</label>
            <input type="text" name="transferencia_banco" value="{{ datos.transferencia_banco or '' }}"
                   placeholder="BBVA">
        </div>
    </div>
    <div class="form-card">
        <label>¬øQu√© quieres que haga tu IA?</label>
        <textarea name="que_hace" rows="4" required>{{ datos.que_hace or '' }}</textarea>
    </div>
    <button type="submit" class="btn-primary">Guardar Negocio</button>
</form>
<form action="{{ url_for('publicar_pdf_configuracion') }}" method="POST" enctype="multipart/form-data" style="margin-bottom:16px;">
    <div class="form-card">
        <label>Publicar PDF (Cat√°logo / Documento)</label>
        <div style="display:flex;align-items:flex-start;gap:8px;flex-wrap:wrap;">
            <input type="file" name="public_pdf" accept=".pdf,image/*,video/*,.mp4,.mov,.webm,.avi,.mkv" required aria-label="Seleccionar archivo PDF o " style="flex:0 0 auto;">
            <textarea name="public_pdf_descripcion" class="longitud_desc" rows="4" placeholder="Descripci√≥n (opcional). A√±ade palabras claves para que la IA seleccione el cat√°logo m√°s relevante."></textarea>
            <div style="flex:0 0 auto; display:flex; align-items:center;">
                <button type="submit" class="btn-success">üìÑ Publicar PDF</button>
            </div>
        </div>
        <small class="form-text text-muted">El PDF se guardar√° en el servidor y se registrar√° en la base de datos. A√±ade una descripci√≥n √∫til (palabras clave, categor√≠as, usos).</small>
    </div>
</form>
<div class="form-card" style="margin-top:12px;">
    <h4>üìö Cat√°logos publicados</h4>
    {% if documents_publicos and documents_publicos|length > 0 %}
    <div class="table-responsive">
        <table class="table" style="font-size:13px;">
            <thead>
                <tr>
                    <th style="color:black;">Archivo</th>
                    <th style="color:black;">Descripci√≥n</th>
                    <th style="color:black;">Publicado</th>
                    <th style="color:black;">Acciones</th>
                </tr>
            </thead>
            <tbody class="PDF">
                {% for doc in documents_publicos %}
                <tr>
                    <td style="color:black;">
                        <a href="{{ url_for('serve_public_docs', relpath=(doc.get('tenant_slug') ~ '/' ~ doc.filename) if doc.get('tenant_slug') else doc.filename) }}" target="_blank" rel="noopener">
                            {{ doc.filename }}
                        </a>
                    </td>
                    <td style="color:black;">{{ doc.descripcion or '-' }}</td>
                    <td style="color:black;">{{ doc.created_at.strftime('%d/%m/%Y %H:%M') if doc.created_at else '-' }}</td>
                    <td style="color:black;">
                        <div style="display:flex; gap:8px; align-items:center;">
                            <a class="btn small" href="{{ url_for('serve_public_docs', relpath=(doc.get('tenant_slug') ~ '/' ~ doc.filename) if doc.get('tenant_slug') else doc.filename) }}" target="_blank">Ver / Descargar</a>
                            <form action="{{ url_for('borrar_pdf_configuracion', doc_id=doc.id) }}" method="post" onsubmit="return confirm('¬øEliminar {{ doc.filename }}? Esta acci√≥n no se puede deshacer.');" style="display:inline;">
                                <button type="submit" class="btn danger small">üóëÔ∏è Eliminar</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-muted">No hay cat√°logos publicados.</div>
    {% endif %}
</div>
{% elif active == 'personalizacion' %}
<form class="config-form" method="POST">
    <div class="form-card">
        <label>Tono de la IA</label>
        <input type="text" name="tono" value="{{ datos.tono or '' }}" required>
    </div>
    <div class="form-card">
        <label>Lenguaje preferido</label>
        <input type="text" name="lenguaje" value="{{ datos.lenguaje or '' }}" required>
    </div>
    <button type="submit" class="btn-primary">Guardar Personalizaci√≥n</button>
</form>

{% elif active == 'precios' %}
<!-- El contenido de precios se maneja en otra ruta -->
<p>La configuraci√≥n de precios se maneja en una p√°gina separada.</p>
<a href="{{ url_for('configuracion_precios') }}" class="btn btn-primary">Gestionar Precios</a>

{% elif active == 'restricciones' %}
<form class="config-form" method="POST">
    <div class="form-card">
        <label>Restricciones del Bot (Una por l√≠nea)</label>
        <textarea name="restricciones" rows="8" placeholder="Ejemplo:
- No agendar citas sin confirmaci√≥n previa
- No proporcionar precios exactos
- No prometer fechas de entrega espec√≠ficas
- No aceptar pedidos fuera del horario laboral
- No compartir informaci√≥n confidencial">{{ datos.restricciones or '' }}</textarea>
        <small class="form-text text-muted">
            Lista de cosas que el bot NO debe hacer. Cada restricci√≥n en una l√≠nea nueva.
        </small>
    </div>

    <div class="form-card">
        <label>Palabras clave prohibidas</label>
        <textarea name="palabras_prohibidas" rows="4" placeholder="Ejemplo:
gratis, inmediato, garantizado, prometo, seguro">{{ datos.palabras_prohibidas or '' }}</textarea>
        <small class="form-text text-muted">
            Palabras que el bot debe evitar usar en sus respuestas.
        </small>
    </div>

    <div class="form-card">
        <label>L√≠mites de la IA</label>
        <div class="form-row">
            <div class="form-group">
                <label>M√°ximo de mensajes por conversaci√≥n:</label>
                <input type="number" name="max_mensajes" value="{{ datos.max_mensajes or '10' }}" min="1" max="1000">
            </div>
            <div class="form-group">
                <label>Tiempo m√°ximo de respuesta (segundos):</label>
                <input type="number" name="tiempo_max_respuesta" value="{{ datos.tiempo_max_respuesta or '30' }}" min="5" max="120">
            </div>
        </div>
    </div>

    <button type="submit" class="btn-primary">Guardar Restricciones</button>
</form>
{% elif active == 'asesores' %}
<form class="config-form" method="POST">
    <div class="form-card">
        <h3>Asesores de Ventas</h3>
        {# Normalize and clamp asesor_count to a sensible integer so template shows exactly that many fields #}
        {% set max_asesores = asesor_count|default(2)|int %}
        {% if max_asesores < 1 %}
        {% set max_asesores = 1 %}
        {% elif max_asesores > 50 %}
        {% set max_asesores = 50 %}
        {% endif %}
        <p>Agrega hasta {{ max_asesores }} asesor(es) (seg√∫n tu plan). Estos datos se usar√°n para notificaciones y contactos internos.</p>
    </div>

    <div class="asesores-grid">
        {% for i in range(1, max_asesores + 1) %}
        {% set idx = i - 1 %}
        {% set nombre = '' %}
        {% set telefono_val = '' %}
        {% if asesores_list and idx < asesores_list|length %}
        {% set advisor = asesores_list[idx] %}
        {% if advisor is mapping %}
        {% set nombre = advisor.get('nombre', '') %}
        {% set telefono_val = advisor.get('telefono', '') %}
        {% endif %}
        {% endif %}
        <div class="asesor-card">
            <label for="asesor{{ i }}_nombre">Asesor {{ i }} - Nombre</label>
            <input type="text" id="asesor{{ i }}_nombre" name="asesor{{ i }}_nombre" class="input"
                   value="{{ nombre }}" placeholder="Ej: Juan P√©rez">
            <label for="asesor{{ i }}_telefono" style="margin-top:8px;">Asesor {{ i }} - Tel√©fono</label>
            <input type="tel" id="asesor{{ i }}_telefono" name="asesor{{ i }}_telefono" class="input"
                   value="{{ telefono_val }}" placeholder="Ej: 521449XXXXXXX">
        </div>
        {% endfor %}
    </div>

    <div style="margin-top:12px;">
        <button type="submit" class="btn-primary">Guardar Asesores</button>
    </div>
</form>
{% endif %}
{% endblock %}