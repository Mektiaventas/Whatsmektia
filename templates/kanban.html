{% extends "base.html" %}
{% block title %}Tablero Kanban{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/kanban.css') }}">

<div id="kanban-board" class="kanban-board">
  {% for col in columnas %}  <!-- ¬°ESTE LOOP FALTABA! -->
  <div class="kanban-column" data-col-id="{{ col.id }}">
    <div class="column-header">
      <img src="{{ col.icono }}" class="col-icon" alt="">
      <h3 contenteditable="true" data-col-id="{{ col.id }}" class="col-name">{{ col.nombre }}</h3>
      <button class="add-chat-btn" title="Agregar aqu√≠">+</button>
    </div>
    <div class="column-list">
      {% for chat in chats if chat.columna_id == col.id %}
      <a href="/chats/{{ chat.numero }}" class="kanban-card kanban-chat-link" data-chat-num="{{ chat.numero }}" style="text-decoration: none; color: inherit; display: block;">
        <div class="card-avatar-section">
          <img 
            src="{{ chat.avatar or url_for('static', filename='icons/default-avatar.png') }}" 
            class="card-avatar" alt="Avatar"
            onerror="this.onerror=null;this.src='{{ url_for('static', filename='icons/default-avatar.png') }}';"
          >
        </div>
        <div class="card-content">
          <div class="card-title-row">
            {% set bandera = chat.numero | bandera %}
            {% if bandera %}
              <img src="{{ bandera }}" class="card-flag" alt="Pa√≠s" title="Pa√≠s">
            {% endif %}
            <span class="alias-view" data-num="{{ chat.numero }}">
              {{ chat.nombre_mostrado }}
            </span>
            <span class="alias-edit" style="display:none;">
              <input type="text" value="{{ chat.alias or chat.nombre or chat.numero }}" data-num="{{ chat.numero }}" maxlength="100" style="width: 110px;">
            </span>
            <button type="button" class="edit-alias-btn" data-num="{{ chat.numero }}" title="Editar nombre">
              ‚úèÔ∏è
            </button>
          </div>
          <div class="card-meta-row">
            <span class="card-num">{{ chat.numero }}</span>
            <span class="card-time">
              {% if chat.ultima_fecha %}
                {{ chat.ultima_fecha.strftime('%d/%m %H:%M') }}
              {% endif %}
            </span>
          </div>
          <div class="card-msg">{{ chat.ultimo_mensaje or "&nbsp;" }}</div>
        </div>
        {% if chat.sin_leer > 0 %}
          <span class="card-unread">{{ chat.sin_leer }}</span>
        {% endif %}
      </a>
      {% endfor %}
    </div>
  </div>
  {% endfor %}  <!-- CIERRE DEL LOOP DE COLUMNAS -->
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
// Funci√≥n para scroll al final de los mensajes
function scrollToBottom() {
  const msgsContainer = document.getElementById('msgs');
  if (msgsContainer) {
    setTimeout(() => {
      msgsContainer.scrollTop = msgsContainer.scrollHeight;
    }, 100);
  }
}

// Manejar clicks desde Kanban
function handleKanbanClick(e) {
  // Solo si es un click izquierdo (evitar que se ejecute con botones de edici√≥n)
  if (e.button === 0) {
    sessionStorage.setItem('fromKanban', 'true');
    // Permitir que el navegaci√≥n continue normalmente
    return true;
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // Configurar todos los enlaces del Kanban
  const kanbanLinks = document.querySelectorAll('.kanban-chat-link');
  kanbanLinks.forEach(link => {
    link.addEventListener('click', handleKanbanClick);
    link.addEventListener('auxclick', handleKanbanClick); // Para click medio tambi√©n
  });

  // Verificar si venimos desde Kanban y hacer scroll
  if (sessionStorage.getItem('fromKanban') === 'true') {
    // Peque√±o delay para esperar a que cargue la conversaci√≥n
    setTimeout(() => {
      scrollToBottom();
      sessionStorage.removeItem('fromKanban');
    }, 800);
  }

  // Tambi√©n scroll autom√°tico para nuevas cargas
  setTimeout(scrollToBottom, 300);

  // Inicializa Sortable en cada lista de columnas
  document.querySelectorAll('.column-list').forEach(list => {
    Sortable.create(list, {
      group: 'kanban',
      animation: 150,
      ghostClass: 'sortable-ghost',
      scroll: true,
      scrollSensitivity: 60,
      scrollSpeed: 10,
      onEnd: evt => {
        const numero = evt.item.dataset.chatNum;
        const nuevaCol = evt.to.closest('.kanban-column').dataset.colId;
        fetch('/kanban/mover', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ numero, columna_id: nuevaCol })
        });
      }
    });
  });

  // Alias inline editing (igual que en chats)
  document.querySelectorAll('.edit-alias-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const parent = this.parentNode;
      parent.querySelector('.alias-view').style.display = 'none';
      parent.querySelector('.alias-edit').style.display = '';
      const input = parent.querySelector('input[type=text]');
      input.focus();
      input.select();

      function terminarEdicion() {
        fetch(`/contactos/${input.dataset.num}/alias`, {
          method: 'POST',
          body: new URLSearchParams({alias: input.value}),
          headers: {'Content-Type':'application/x-www-form-urlencoded'}
        }).then(() => {
          parent.querySelector('.alias-edit').style.display = 'none';
          parent.querySelector('.alias-view').textContent = input.value || input.dataset.num;
          parent.querySelector('.alias-view').style.display = '';
        });
      }

      input.onblur = terminarEdicion;
      input.onkeydown = function(e) {
        if (e.key === 'Enter') { 
          e.preventDefault();
          terminarEdicion(); 
        }
        if (e.key === 'Escape') {
          parent.querySelector('.alias-edit').style.display = 'none';
          parent.querySelector('.alias-view').style.display = '';
        }
      };
    });
  });

  // Eliminar el modal flotante (conflictivo con los enlaces)
  // porque ahora las tarjetas son enlaces directos
});
</script>
<!-- Al final de kanban.html, antes de cerrar el body -->
<script>
// ‚Äî‚Äî‚Äî AUTO-ACTUALIZACI√ìN DEL KANBAN CADA 5 SEGUNDOS ‚Äî‚Äî‚Äî
document.addEventListener('DOMContentLoaded', function() {
    let kanbanAutoRefresh = true;
    let refreshInterval = 5000; // 5 segundos
    
    console.log('üîÑ Iniciando auto-actualizaci√≥n del Kanban cada 5 segundos');
    
    // Funci√≥n para actualizar el Kanban
    function actualizarKanban() {
        if (!kanbanAutoRefresh) return;
        
        fetch('/kanban/data', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
            cache: 'no-cache'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }
            return response.json();
        })
        .then(data => {
            // Actualizar la interfaz con los nuevos datos
            actualizarInterfazKanban(data);
            console.log('‚úÖ Kanban actualizado:', new Date().toLocaleTimeString());
        })
        .catch(error => {
            console.error('‚ùå Error actualizando Kanban:', error);
        });
    }
    
    // Funci√≥n para actualizar la interfaz (debes adaptarla a tu estructura)
    function actualizarInterfazKanban(data) {
        // Aqu√≠ va la l√≥gica para actualizar el HTML con los nuevos datos
        // Esto depende de c√≥mo tengas estructurado tu Kanban
        
        // Ejemplo b√°sico:
        data.chats.forEach(chat => {
            const chatElement = document.querySelector(`[data-numero="${chat.numero}"]`);
            if (chatElement) {
                // Actualizar informaci√≥n del chat
                const fechaElement = chatElement.querySelector('.ultima-fecha');
                const mensajeElement = chatElement.querySelector('.ultimo-mensaje');
                
                if (fechaElement) {
                    fechaElement.textContent = new Date(chat.ultima_fecha).toLocaleString();
                }
                if (mensajeElement) {
                    mensajeElement.textContent = chat.ultimo_mensaje || 'Sin mensajes';
                }
                
                // Mover entre columnas si es necesario
                const columnaActual = chatElement.closest('.kanban-columna');
                if (columnaActual && columnaActual.dataset.columnaId != chat.columna_id) {
                    const nuevaColumna = document.querySelector(`[data-columna-id="${chat.columna_id}"] .kanban-chats`);
                    if (nuevaColumna) {
                        nuevaColumna.appendChild(chatElement);
                    }
                }
            }
        });
    }
    
    // Iniciar el intervalo
    let intervalo = setInterval(actualizarKanban, refreshInterval);
    
    // Opcional: Pausar actualizaci√≥n cuando la pesta√±a no est√° visible
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            kanbanAutoRefresh = false;
            console.log('‚è∏Ô∏è Auto-actualizaci√≥n pausada (pesta√±a oculta)');
        } else {
            kanbanAutoRefresh = true;
            console.log('‚ñ∂Ô∏è Auto-actualizaci√≥n reanudada');
        }
    });
    
    // Tambi√©n actualizar al hacer foco en la ventana
    window.addEventListener('focus', function() {
        kanbanAutoRefresh = true;
        actualizarKanban(); // Actualizar inmediatamente
    });
    
    window.addEventListener('blur', function() {
        kanbanAutoRefresh = false;
    });
    
    // Forzar primera actualizaci√≥n
    setTimeout(actualizarKanban, 1000);
});
</script>
{% endblock %}