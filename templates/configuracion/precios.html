{% extends 'base.html' %}
{% block title %}Configuraci√≥n ‚Äì Productos y Precios{% endblock %}

{% block content %}
<div class="config-header">
    <h2>Configuraci√≥n: Productos y Precios</h2>
    {% if guardado %}
    <div class="alert success">¬°Guardado correctamente!</div>
    {% endif %}
</div>

<!-- Navegaci√≥n de subpesta√±as -->
<ul class="tabs">
    {% for tab in tabs %}
    <li class="{% if tab == active %}active{% endif %}">
        {% if tab == 'precios' %}
        <a href="{{ url_for('configuracion_precios') }}">{{ tab|capitalize }}</a>
        {% else %}
        <a href="{{ url_for('configuracion_tab', tab=tab) }}">{{ tab|capitalize }}</a>
        {% endif %}
    </li>
    {% endfor %}
</ul>

<!-- NUEVO: Men√∫ de navegaci√≥n persistente -->
<div class="tab-navigation mb-6">
    <div class="tab-buttons">
        <button class="btn btn-primary mt-3" id="btn-user-list" onclick="showSection('user-list')">
            <div class="tab-icon">üë•</div>
            <div>
                <span class="tab-title">Precios vista cliente</span>
            </div>
        </button>

        {% if is_admin %}
        <button class="btn btn-primary mt-3" id="btn-admin-list" onclick="showSection('admin-list')">
            <div class="tab-icon">üîí</div>
            <div>
                <span class="tab-title">Precios vista Admin</span>
            </div>
        </button>
        {% endif %}
        <div class="spacer" aria-hidden="true"></div>
        <button class="btn btn-primary mt-3" id="btn-batch-upload" onclick="showSection('batch-upload')">
            <div class="tab-icon">üìä</div>
            <div>
                <span class="tab-title">Carga Template</span>
            </div>
        </button>
        <button class="btn btn-primary mt-3" id="btn-manual-upload" onclick="showSection('manual-upload')">
            <div class="tab-icon">‚úèÔ∏è</div>
            <div>
                <span class="tab-title">Carga manual</span>

            </div>
        </button>

        <button class="btn btn-primary mt-3" id="btn-pdf-upload" onclick="showSection('pdf-upload')">
            <div class="tab-icon">üìÑ</div>
            <div>
                <span class="tab-title">Carga con IA</span>
            </div>
        </button>
        <!-- Modal (floating) to list hidden columns and allow un-hiding -->
        <div id="hidden-columns-modal" class="hidden floating-tooltip" role="dialog" aria-modal="true" aria-hidden="true" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <strong>Columnas ocultas</strong>
                <button onclick="closeHiddenColumnsModal()" class="btn small">Cerrar</button>
            </div>
            <div id="hidden-columns-list">
                <!-- dynamically populated -->
            </div>
            <div style="margin-top:10px; text-align:right;">
                <button class="btn small" onclick="unhideAllColumns()">Mostrar todas</button>
            </div>
        </div>
    </div>
</div>
<br />
<br />
<!-- Secci√≥n: Carga desde PDF -->
<div class="section" id="pdf-upload" style="display:none;">
    <div class="section-header">
        <h3 class="flex justify-between items-center">
            <span>üìÑ Importar Productos desde PDF/Excel</span>
        </h3>
    </div>

    <div class="card mb-6">
        <div class="card-header bg-success text-white">
            <h3>üìÑ Importar Productos desde PDF/Excel</h3>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <form action="{{ url_for('subir_pdf_servicios') }}" method="POST" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="pdf_file" class="block text-sm font-medium mb-2">Subir cat√°logo en PDF/Excel:</label>
                            <input type="file" name="pdf_file" id="pdf_file"
                                   accept=".pdf,.xlsx,.xls,.csv,.docx,.txt" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <small class="text-muted">Formatos aceptados: PDF, XLSX, XLS, CSV, DOCX, TXT. M√°x. 50MB</small>
                        </div>
                        <button type="submit" class="btn btn-success mt-3">
                            üöÄ Procesar Cat√°logo Autom√°ticamente
                        </button>
                    </form>
                </div>

                <div>
                    <h4 class="font-semibold mb-2">üí° ¬øC√≥mo funciona?</h4>
                    <ul class="text-sm space-y-1">
                        <li>‚Ä¢ Sube tu cat√°logo de productos en PDF/Excel</li>
                        <li>‚Ä¢ La IA analizar√° y extraer√° autom√°ticamente</li>
                        <li>‚Ä¢ Los productos se guardar√°n en la base de datos</li>
                        <li>‚Ä¢ La IA los usar√° para responder consultas</li>
                    </ul>

                    <h4 class="font-semibold mt-3 mb-2">üìã Para mejores resultados:</h4>
                    <ul class="text-sm space-y-1">
                        <li>‚Ä¢ Archivo con SKU, categor√≠as y precios claros</li>
                        <li>‚Ä¢ Estructura clara de productos y categor√≠as</li>
                        <li>‚Ä¢ Precios de mayoreo y menudeo identificados</li>
                        <li>‚Ä¢ Informaci√≥n completa de medidas y modelos</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Secci√≥n: Carga Batch -->
<div class="section" id="batch-upload" style="display:none;">
    <div class="section-header">
        <h3 class="flex justify-between items-center">
            <span>üìä Importar Directamente desde Excel</span>
        </h3>
    </div>

    <div class="card mb-6">
        <div class="card-header bg-primary text-white">
            <h3>üìä Importar Directamente desde Excel</h3>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <form action="{{ url_for('importar_excel_directo') }}" method="POST" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="excel_file" class="block text-sm font-medium mb-2">Subir Excel con estructura predefinida:</label>
                            <input type="file" name="excel_file" id="excel_file"
                                   accept=".xlsx,.xls,.csv" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <small class="text-muted">Las columnas deben coincidir con la base de datos. Formatos: XLSX, XLS, CSV</small>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">
                            üì• Importar Excel Directamente
                        </button>
                    </form>
                </div>

                <div>
                    <h4 class="font-semibold mb-2">üí° Estructura Requerida</h4>
                    <ul class="text-sm space-y-1">
                        <li>‚Ä¢ sku</li>
                        <li>‚Ä¢ categoria</li>
                        <li>‚Ä¢ subcategoria</li>
                        <li>‚Ä¢ linea</li>
                        <li>‚Ä¢ modelo</li>
                        <li>‚Ä¢ descripcion</li>
                        <li>‚Ä¢ medidas</li>
                        <li>‚Ä¢ costo</li>
                        <li>‚Ä¢ precio_mayoreo</li>
                        <li>‚Ä¢ precio_menudeo</li>
                        <li>‚Ä¢ imagen (opcional)</li>
                        <li>‚Ä¢ etc.</li>
                    </ul>
                    <p class="text-xs mt-3">Los encabezados deben coincidir exactamente con los nombres de columna en la base de datos.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Secci√≥n: Carga Manual -->
<div class="section" id="manual-upload" style="display:none;">
    <div class="section-header">
        <h3 class="flex justify-between items-center">
            <span>‚úèÔ∏è {{ precio_edit and 'Editar Producto' or 'Agregar Producto Manualmente' }}</span>
        </h3>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <form action="{{ url_for('configuracion_precio_guardar') }}" method="post" enctype="multipart/form-data">
                {% if precio_edit %}
                <input type="hidden" name="id" value="{{ precio_edit.id }}">
                {% endif %}

                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="sku">SKU *</label>
                        <input type="text" id="sku" name="sku" class="input" required
                               value="{{ precio_edit.sku if precio_edit else '' }}"
                               placeholder="Ej: PROD-001">
                    </div>

                    <div class="form-group">
                        <label for="servicio">Producto *</label>
                        <input type="text" id="servicio" name="servicio" class="input" required
                               value="{{ precio_edit.servicio if precio_edit else '' }}"
                               placeholder="Ej: Laptop Gaming">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div class="form-group">
                        <label for="categoria">Categor√≠a</label>
                        <input type="text" id="categoria" name="categoria" class="input"
                               value="{{ precio_edit.categoria if precio_edit else '' }}"
                               placeholder="Ej: Electr√≥nicos">
                    </div>

                    <div class="form-group">
                        <label for="subcategoria">Subcategor√≠a</label>
                        <input type="text" id="subcategoria" name="subcategoria" class="input"
                               value="{{ precio_edit.subcategoria if precio_edit else '' }}"
                               placeholder="Ej: Computadoras">
                    </div>

                    <div class="form-group">
                        <label for="linea">L√≠nea</label>
                        <input type="text" id="linea" name="linea" class="input"
                               value="{{ precio_edit.linea if precio_edit else '' }}"
                               placeholder="Ej: Gaming">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="modelo">Modelo</label>
                        <input type="text" id="modelo" name="modelo" class="input"
                               value="{{ precio_edit.modelo if precio_edit else '' }}"
                               placeholder="Ej: XPS-15">
                    </div>

                    <div class="form-group">
                        <label for="medidas">Medidas</label>
                        <input type="text" id="medidas" name="medidas" class="input"
                               value="{{ precio_edit.medidas if precio_edit else '' }}"
                               placeholder="Ej: 15.6 pulgadas">
                    </div>
                </div>

                <div class="form-group">
                    <label for="descripcion">Descripci√≥n</label>
                    <textarea id="descripcion" name="descripcion" class="textarea" rows="2"
                              placeholder="Ej: Laptop para gaming con RTX 4060, 16GB RAM, 1TB SSD">{{ precio_edit.descripcion if precio_edit else '' }}</textarea>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div class="form-group">
                        <label for="costo">Costo *</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-600">$</span>
                            <input type="number" step="0.01" min="0" id="costo" name="costo" class="input pl-8"
                                   value="{{ precio_edit.costo if precio_edit else '' }}"
                                   placeholder="0.00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inscripcion">Inscripci√≥n</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-600">$</span>
                            <input type="number" step="0.01" min="0" id="inscripcion" name="inscripcion" class="input pl-8"
                                   value="{{ precio_edit.inscripcion if precio_edit else '' }}"
                                   placeholder="0.00">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="mensualidad">Mensualidad</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-600">$</span>
                            <input type="number" step="0.01" min="0" id="mensualidad" name="mensualidad" class="input pl-8"
                                   value="{{ precio_edit.mensualidad if precio_edit else '' }}"
                                   placeholder="0.00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="precio_mayoreo">Precio Mayoreo</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-600">$</span>
                            <input type="number" step="0.01" min="0" id="precio_mayoreo" name="precio_mayoreo" class="input pl-8"
                                   value="{{ precio_edit.precio_mayoreo if precio_edit else '' }}"
                                   placeholder="0.00">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="precio_menudeo">Precio Menudeo</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-600">$</span>
                            <input type="number" step="0.01" min="0" id="precio_menudeo" name="precio_menudeo" class="input pl-8"
                                   value="{{ precio_edit.precio_menudeo if precio_edit else '' }}"
                                   placeholder="0.00">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">


                    <div class="form-group">
                        <label for="imagen">Imagen</label>
                        <div class="mb-2">
                            <select id="imagen-tipo" class="select mb-2" onchange="toggleImagenInput()">
                                <option value="archivo">Subir archivo</option>
                                <option value="url">Usar URL de internet</option>
                            </select>
                        </div>

                        <div id="imagen-archivo-container">
                            <input type="file" id="imagen" name="imagen" class="input"
                                   accept="image/*">
                            <small class="text-muted block mt-1">Sube una imagen desde tu dispositivo</small>
                        </div>

                        <div id="imagen-url-container" class="hidden">
                            <input type="text" id="imagen_url" name="imagen_url" class="input"
                                   placeholder="https://ejemplo.com/imagen.jpg">
                            <small class="text-muted block mt-1">Ingresa la URL completa de una imagen en internet</small>
                        </div>

                        {% if precio_edit and precio_edit.imagen %}
                        <div class="mt-2">
                            <small class="text-muted">Imagen actual: {{ precio_edit.imagen }}</small>
                            {% if precio_edit.imagen and precio_edit.imagen.startswith('http') %}
                            <img src="{{ precio_edit.imagen }}" class="mt-1 h-16 w-auto object-contain border rounded" alt="Vista previa">
                            {% elif precio_edit.imagen %}
                            <img src="/uploads/{{ precio_edit.imagen }}" class="mt-1 h-16 w-auto object-contain border rounded" alt="Vista previa">
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="status_ws">Status WS</label>
                        <input type="text" id="status_ws" name="status_ws" class="input"
                               value="{{ precio_edit.status_ws if precio_edit else '' }}"
                               placeholder="Ej: activo">
                    </div>
                    <div class="form-group">
                        <label for="catalogo">Cat√°logo</label>
                        <input type="text" id="catalogo" name="catalogo" class="input"
                               value="{{ precio_edit.catalogo if precio_edit else '' }}"
                               placeholder="Ej: Cat√°logo 1">
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div class="form-group">
                        <label for="catalogo2">Cat√°logo 2</label>
                        <input type="text" id="catalogo2" name="catalogo2" class="input"
                               value="{{ precio_edit.catalogo2 if precio_edit else '' }}"
                               placeholder="Ej: Cat√°logo 2">
                    </div>
                    <div class="form-group">
                        <label for="catalogo3">Cat√°logo 3</label>
                        <input type="text" id="catalogo3" name="catalogo3" class="input"
                               value="{{ precio_edit.catalogo3 if precio_edit else '' }}"
                               placeholder="Ej: Cat√°logo 3">
                    </div>
                    <div class="form-group">
                        <label for="proveedor">Proveedor</label>
                        <input type="text" id="proveedor" name="proveedor" class="input"
                               value="{{ precio_edit.proveedor if precio_edit else '' }}"
                               placeholder="Ej: Proveedor S.A.">
                    </div>
                </div>
                <div class="form-actions flex justify-end gap-2">
                    <button type="submit" class="btn primary">
                        {{ precio_edit and 'üíæ Actualizar' or 'üíæ Guardar' }}
                    </button>
                    <a href="{{ url_for('configuracion_precios') }}" class="btn secondary">
                        ‚Ü©Ô∏è Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Secci√≥n: Lista Usuario -->
<div class="section" id="user-list" style="display:none;">
    <div class="card mb-4">
        <div class="card-header bg-gray-100">
            <h3>üìã Productos (Vista Cliente) ({{ precios|length }} registros)</h3>
            <div style="float:right;">
                <button class="btn small" onclick="openHiddenColumnsModal('user')">Ver columnas ocultas</button>
            </div>
        </div>
        <div class="card-body">
            {% if precios %}
            <div class="table-responsive">
                <div class="table-scroll table-scroll-client">
                    <table class="table" data-table="user">
                        <thead>
                            <tr>
                                <th>
                                    <span>SKU</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="headerToggleColumn(this)">
                                        ‚ùé
                                    </button>
                                </th>
                                <th>
                                    <span>Categor√≠a</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="headerToggleColumn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>Subcategor√≠a</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="headerToggleColumn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>L√≠nea</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="headerToggleColumn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>Modelo</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="headerToggleColumn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>Descripci√≥n</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="headerToggleColumn(this)">‚ùé</button>
                                </th>
                                <!--<th>Medidas</th>-->
                                <th>
                                    <span>Imagen</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="headerToggleColumn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>Menudeo</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="headerToggleColumn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>Inscripcion</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="headerToggleColumn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>Mensualidad</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="headerToggleColumn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>Acciones</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for precio in precios %}
                            <tr>
                                <td>{{ precio.sku or '-' }}</td>
                                <td>{{ precio.categoria or '-' }}</td>
                                <td>{{ precio.subcategoria or '-' }}</td>
                                <td>{{ precio.linea or '-' }}</td>
                                <td>{{ precio.modelo or '-' }}</td>
                                <td class="desc-cell" data-desc="{{ precio.descripcion|default('')|e }}">
                                    {{ precio.descripcion|default('-')|truncate(300) }}
                                </td>
                                <!--<td>{{ precio.medidas or '-' }}</td>-->
                                <td>
                                    {% if precio.imagen %}
                                    {% if precio.imagen.startswith('http') %}
                                    <img class="imagen_tabla" src="/uploads/productos/{{ precio.imagen }}" ...>
                                    {% else %}
                                    <img class="imagen_tabla" src="/uploads/productos/{{ precio.imagen }}" ...>
                                    {% endif %}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td class="text-right text-blue-600">${{ "{:,.2f}".format(precio.precio_menudeo) if precio.precio_menudeo else '-' }}</td>
                                <td>{{precio.inscripcion}}</td>
                                <td>{{precio.mensualidad}}</td>
                                <td>
                                    {% if es_admin %}
                                    <a href="{{ url_for('configuracion_precio_editar', pid=precio.id) }}"
                                       class="btn small primary">Editar</a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% else %}
            <div class="text-center py-8">
                <div class="text-gray-500 text-lg mb-2">üìù No hay productos registrados</div>
                <p class="text-sm text-gray-400">Usa el formulario de arriba para agregar productos manualmente.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Secci√≥n: Lista Admin -->
<div class="section" id="admin-list" style="display:none;">
    <div class="card">
        <div class="card-header bg-blue-100">
            <h3>üîí Productos y Precios (Vista Completa Admin) ({{ precios|length}} registros)</h3>
            <div style="float:right;">
                <button class="btn small" onclick="openHiddenColumnsModal('admin')">Ver columnas ocultas</button>
            </div>
        </div>
        <div class="card-body">
            {% if precios %}
            <div class="table-responsive">
                <div class="table-scroll table-scroll-admin">
                    <table class="table" data-table="admin">
                        <thead>
                            <tr>
                                <th><span>SKU</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="headerToggleColumn(this)">‚ùé</button></th>
                                <th><span>Categor√≠a</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="headerToggleColumn(this)">‚ùé</button></th>
                                <th><span>Subcategor√≠a</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="headerToggleColumn(this)">‚ùé</button></th>
                                <th><span>L√≠nea</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="headerToggleColumn(this)">‚ùé</button></th>
                                <th><span>Modelo</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="headerToggleColumn(this)">‚ùé</button></th>
                                <th><span>Descripci√≥n</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="headerToggleColumn(this)">‚ùé</button></th>
                                <th><span>Costo</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="headerToggleColumn(this)">‚ùé</button></th>
                                <th><span>Menudeo</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="headerToggleColumn(this)">‚ùé</button></th>
                                <th><span>Inscripcion</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="headerToggleColumn(this)">‚ùé</button></th>
                                <th><span>Mensualidad</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="headerToggleColumn(this)">‚ùé</button></th>
                                <th><span>Imagen</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="headerToggleColumn(this)">‚ùé</button></th>
                                <th><span>Acciones</span></th>
                            </tr>
                        </thead>
                        <tbody class="cuerpo_tabla">
                            {% for precio in precios %}
                            <tr>
                                <td>{{ precio.sku or '-' }}</td>
                                <td>{{ precio.categoria or '-' }}</td>
                                <td>{{ precio.subcategoria or '-' }}</td>
                                <td>{{ precio.linea or '-' }}</td>
                                <td>{{ precio.modelo or '-' }}</td>
                                <td class="desc-cell" data-desc="{{ precio.descripcion|default('')|e }}">
                                    {{ precio.descripcion|default('-')|truncate(300) }}
                                </td>
                                <td class="text-right text-red-600">${{ "{:,.2f}".format(precio.costo) if precio.costo else '-' }}</td>
                                <td class="text-right text-blue-600">${{ "{:,.2f}".format(precio.precio_menudeo) if precio.precio_menudeo else '-' }}</td>
                                <td>{{precio.inscripcion}}</td>
                                <td>{{precio.mensualidad}}</td>
                                <td>
                                    {% if precio.imagen %}
                                    {% if precio.imagen.startswith('http') %}
                                    <img class="imagen_tabla" src="/uploads/productos/{{ precio.imagen }}" ...>
                                    {% else %}
                                    <img class="imagen_tabla" src="/uploads/productos/{{ precio.imagen }}" ...>
                                    {% endif %}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="flex space-x-2">
                                        <a href="{{ url_for('configuracion_precio_editar', pid=precio.id) }}"
                                           class="btn small primary">Editar</a>
                                        <form action="{{ url_for('configuracion_precio_borrar', pid=precio.id) }}"
                                              method="post" class="inline-form">
                                            <button type="submit"
                                                    class="btn small danger"
                                                    onclick="return confirm('¬øEliminar {{ precio.descripcion[:30] if precio.descripcion else precio.sku }}?');">
                                                Borrar
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% else %}
            <div class="text-center py-8">
                <div class="text-gray-500 text-lg mb-2">üìù No hay productos registrados</div>
                <p class="text-sm text-gray-400">Usa el formulario de arriba para agregar productos manualmente.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>


<!-- Mensajes Flash -->
<div class="mt-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert {{ 'success' if category == 'success' else 'error' if category == 'error' else 'warning' }}">
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}
</div>

<style>
    .imagen_tabla {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .alert {
        padding: 12px 16px;
        border-radius: 6px;
        margin: 10px 0;
        font-weight: 500;
    }

    /* (estilos anteriores retenidos sin cambios) */
    .col-toggle {
        background: transparent;
        border: 1px solid rgba(0,0,0,0.06);
        padding: 2px 6px;
        margin-left: 6px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        line-height: 1;
    }

        .col-toggle[aria-pressed="true"] {
            background: #111827;
            color: #fff;
        }

    .hidden {
        display: none !important;
    }

    .floating-tooltip {
        position: fixed;
        right: 20px;
        top: 80px;
        width: 320px;
        max-height: 70vh;
        overflow-y: auto;
    }
</style>

<script>
    // Server-backed hidden columns persistence endpoints
    const HIDDEN_COLUMNS_API = "{{ url_for('get_precios_hidden_columns') }}";

    async function fetchHiddenMap() {
        try {
            const res = await fetch(HIDDEN_COLUMNS_API, { credentials: 'same-origin' });
            if (!res.ok) return {};
            const data = await res.json();
            return data.hidden || {};
        } catch (e) {
            console.warn('Error fetching hidden map:', e);
            return {};
        }
    }

    async function saveHiddenMap(map) {
        try {
            const res = await fetch(HIDDEN_COLUMNS_API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ hidden: map })
            });
            if (!res.ok) console.warn('Save hidden map failed', await res.text());
        } catch (e) {
            console.warn('Error saving hidden map:', e);
        }
    }

    // UI: header button handler (keeps names distinct and simple)
    function headerToggleColumn(btn) {
        const th = btn.closest('th');
        if (!th) return;
        const table = th.closest('table');
        if (!table) return;
        const headerCells = th.parentNode.children;
        let index = Array.prototype.indexOf.call(headerCells, th); // 0-based
        toggleColumn(table, index);
        const pressed = btn.getAttribute('aria-pressed') === 'true';
        btn.setAttribute('aria-pressed', (!pressed).toString());

        const tableId = table.getAttribute('data-table') || 'table';
        const nowHidden = !pressed;
        persistHiddenColumnServer(tableId, index, nowHidden);
    }

    // Toggle column visually
    function toggleColumn(table, colIndex) {
        const rows = table.querySelectorAll('thead tr, tbody tr');
        // detect current from first body row if exists
        const firstBodyRow = table.querySelector('tbody tr');
        const isHidden = firstBodyRow && firstBodyRow.children[colIndex] && (firstBodyRow.children[colIndex].style.display === 'none');
        const newDisplay = isHidden ? '' : 'none';
        rows.forEach(row => {
            const c = row.children[colIndex];
            if (c) c.style.display = newDisplay;
        });
    }

    // Persist change to server (merge map)
    async function persistHiddenColumnServer(tableId, colIndex, hidden) {
        try {
            const map = await fetchHiddenMap();
            map[tableId] = map[tableId] || {};
            if (hidden) map[tableId][colIndex] = true;
            else if (map[tableId] && map[tableId][colIndex]) delete map[tableId][colIndex];
            await saveHiddenMap(map);
        } catch (e) {
            console.warn('persistHiddenColumnServer error:', e);
        }
    }

    // Apply stored hidden columns (server-backed). If server empty, no-op.
    async function applyStoredHiddenColumns() {
        try {
            const map = await fetchHiddenMap();
            // Backwards compatibility: if no server map, try localStorage fallback
            const hasServer = map && Object.keys(map).length > 0;
            const tables = document.querySelectorAll('table[data-table]');
            tables.forEach(table => {
                const tableId = table.getAttribute('data-table');
                const hiddenForTable = hasServer ? (map[tableId] || {}) : (JSON.parse(localStorage.getItem(`precios_hidden_cols_${tableId}`) || '{}'));
                Object.keys(hiddenForTable).forEach(idxStr => {
                    const idx = parseInt(idxStr, 10);
                    if (isNaN(idx)) return;
                    const rows = table.querySelectorAll('thead tr, tbody tr');
                    rows.forEach(row => {
                        const c = row.children[idx];
                        if (c) c.style.display = 'none';
                    });
                    const headerCell = table.querySelector('thead tr').children[idx];
                    if (headerCell) {
                        const btn = headerCell.querySelector('.col-toggle');
                        if (btn) btn.setAttribute('aria-pressed', 'true');
                    }
                });
            });
        } catch (e) {
            console.warn('Error applying stored hidden columns:', e);
        }
    }

    // Modal control: list hidden columns and allow unhide
    async function openHiddenColumnsModal(tableId) {
        const map = await fetchHiddenMap();
        const hiddenForTable = map[tableId] || {};
        const modal = document.getElementById('hidden-columns-modal');
        const list = document.getElementById('hidden-columns-list');
        list.innerHTML = '';

        const table = document.querySelector(`table[data-table="${tableId}"]`);
        if (!table) {
            list.innerHTML = '<div>No table found</div>';
            modal.style.display = 'block'; modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false');
            return;
        }
        const headerCells = Array.from(table.querySelectorAll('thead tr th'));

        const indices = Object.keys(hiddenForTable).map(i => parseInt(i, 10)).filter(n => !isNaN(n)).sort((a,b)=>a-b);
        if (!indices.length) {
            list.innerHTML = '<div>No hay columnas ocultas para esta tabla.</div>';
        } else {
            indices.forEach(idx => {
                const th = headerCells[idx];
                const title = th ? (th.querySelector('span') ? th.querySelector('span').innerText.trim() : th.innerText.trim()) : (`Columna ${idx+1}`);
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.justifyContent = 'space-between';
                row.style.alignItems = 'center';
                row.style.padding = '6px 0';
                row.innerHTML = `<div>${title}</div><div><button class="btn small" data-idx="${idx}" onclick="unhideColumnFromModal('${tableId}', ${idx})">Mostrar</button></div>`;
                list.appendChild(row);
            });
        }

        modal.style.display = 'block'; modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false');
    }

    function closeHiddenColumnsModal() {
        const modal = document.getElementById('hidden-columns-modal');
        modal.style.display = 'none'; modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true');
    }

    async function unhideColumnFromModal(tableId, idx) {
        const table = document.querySelector(`table[data-table="${tableId}"]`);
        if (!table) return;
        const rows = table.querySelectorAll('thead tr, tbody tr');
        rows.forEach(row => {
            const c = row.children[idx];
            if (c) c.style.display = '';
        });
        const headerCell = table.querySelector('thead tr').children[idx];
        if (headerCell) {
            const btn = headerCell.querySelector('.col-toggle');
            if (btn) btn.setAttribute('aria-pressed','false');
        }
        const map = await fetchHiddenMap();
        if (map[tableId]) {
            delete map[tableId][idx];
            await saveHiddenMap(map);
        }
        openHiddenColumnsModal(tableId);
    }

    async function unhideAllColumns() {
        const visibleTable = document.querySelector('table[data-table]:not([style*="display: none"])') || document.querySelector('table[data-table]');
        if (!visibleTable) return;
        const tableId = visibleTable.getAttribute('data-table');
        const headers = visibleTable.querySelectorAll('thead tr th');
        const map = await fetchHiddenMap();
        if (map[tableId]) {
            delete map[tableId];
            await saveHiddenMap(map);
        }
        headers.forEach((th, idx) => {
            const rows = visibleTable.querySelectorAll('thead tr, tbody tr');
            rows.forEach(row => {
                const c = row.children[idx];
                if (c) c.style.display = '';
            });
            const btn = th.querySelector('.col-toggle');
            if (btn) btn.setAttribute('aria-pressed', 'false');
        });
        openHiddenColumnsModal(tableId);
    }

    // UI helpers
    function showSection(sectionId) {
        const sections = document.querySelectorAll('.section');
        sections.forEach(section => section.style.display = 'none');

        const buttons = document.querySelectorAll('.btn, .btn-primario, .btn-primary');
        buttons.forEach(button => button.classList.remove('active'));

        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
            targetSection.style.display = 'block';
            try {
                window.scrollTo({
                    top: document.querySelector('.tab-navigation').offsetTop + 60,
                    behavior: 'smooth'
                });
            } catch (e) { /* ignore if not available */ }
        }

        const activeButton = document.getElementById(`btn-${sectionId}`);
        if (activeButton) activeButton.classList.add('active');
    }

    function toggleImagenInput() {
        const tipo = document.getElementById('imagen-tipo').value;
        const archivoContainer = document.getElementById('imagen-archivo-container');
        const urlContainer = document.getElementById('imagen-url-container');

        if (tipo === 'archivo') {
            archivoContainer.style.display = 'block';
            urlContainer.style.display = 'none';
            const urlInput = document.getElementById('imagen_url'); if (urlInput) urlInput.value = '';
        } else {
            archivoContainer.style.display = 'none';
            urlContainer.style.display = 'block';
            const fileInput = document.getElementById('imagen'); if (fileInput) fileInput.value = '';
        }
    }

    // DOM ready: show section and apply hidden columns
    document.addEventListener('DOMContentLoaded', async function () {
        console.log("DOM loaded - precios config");

        let initialSection = 'user-list';
        {% if precio_edit %}
        initialSection = 'manual-upload';
        {% endif %}

        const urlParams = new URLSearchParams(window.location.search);
        const section = urlParams.get('section');
        if (section) initialSection = section;

        showSection(initialSection);
        // apply persisted hidden columns
        await applyStoredHiddenColumns();
    });
</script>
{% endblock %}