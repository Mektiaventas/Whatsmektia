{% extends "base.html" %}
{% block title %}Conversaciones{% endblock %}

{% block content %}
{% set es_porfirianna = tenant_config.dominio == 'laporfirianna.mektia.com' %}
{% set negocio_nombre = 'La Porfirianna' if es_porfirianna else 'Mektia' %}

<div class="chat-list-header">
    <h2>Conversaciones - {{ negocio_nombre }}</h2>
    <span class="tenant-badge {% if es_porfirianna %}porfirianna-badge{% else %}mektia-badge{% endif %}">
        {{ negocio_nombre }}
    </span>
    <span style="font-size: 12px; color: #ffffff; margin-left: 15px;">
        (Base de datos: {{ tenant_config.db_name }})
    </span>
</div>
<div class="chat-layout-v2">
    <!-- Lado izquierdo: Lista -->
    <aside class="chat-list-v2">
        <div class="chat-list-tools">
            <button class="add-contact-btn">+ Agregar Contacto</button>
            <input type="text" placeholder="Buscar chats..." class="search-input">
        </div>

        <div class="chat-items">
            {% for chat in chats %}
            <a href="/chats/{{ chat.numero }}" class="chat-item {% if selected == chat.numero %}selected{% endif %}" data-chat-num="{{ chat.numero }}">
                <div class="card-content">
                    <div class="card-title-row">
                        <div class="card-avatar-section">
                            <img src="{{ chat.imagen_url or url_for('static', filename='icons/default-avatar.png') }}"
                                 class="card-avatar" alt="Avatar"
                                 onerror="this.onerror=null;this.src='{{ url_for('static', filename='icons/default-avatar.png') }}';">
                        </div>
                        {% set bandera = chat.numero | bandera %}
                        {% if bandera %}
                        <img src="{{ bandera }}" class="card-flag" alt="Pa√≠s" title="Pa√≠s">
                        {% endif %}
                        <span class="alias-view" data-num="{{ chat.numero }}">
                            {{ chat.nombre_mostrado }}
                        </span>
                        <span class="alias-edit" style="display:none;">
                            <input type="text" value="{{ chat.alias or chat.nombre or '' }}" data-num="{{ chat.numero }}" maxlength="100" style="width: 110px;">
                        </span>
                        <button type="button" class="edit-alias-btn" data-num="{{ chat.numero }}" title="Editar nombre">
                            ‚úèÔ∏è
                        </button>
                    </div>
                    <div class="card-meta-row">
                        <span class="card-num">{{ chat.numero }}</span>
                        <span class="card-time">
                            {% if chat.ultima_fecha %}
                            {{ chat.ultima_fecha.strftime('%-d-%b ').lower() }} {{ chat.ultima_fecha.strftime('%H:%M') }}
                            {% endif %}
                        </span>
                    </div>
                    <div class="card-msg">
                        {% if chat.ultimo_mensaje %}
                        {% if chat.tipo_mensaje == 'imagen' %}
                        üì∑ Imagen
                        {% else %}
                        {{ chat.ultimo_mensaje[:35] }}{% if chat.ultimo_mensaje|length > 35 %}...{% endif %}
                        {% endif %}
                        {% else %}
                        Sin mensajes
                        {% endif %}
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </aside>

    <!-- Centro: Mensajes -->
    <section class="chat-panel-v2">
        {% if selected %}
        <div class="chat-panel-header" data-num="{{ selected }}">
            <div class="chat-header-info">
                <div class="chat-title">
                    <span class="alias-view">
                        {{ (chats | selectattr("numero", "equalto", selected) | first).nombre_mostrado if (chats | selectattr("numero", "equalto", selected) | first) else selected }}
                    </span>
                    <span class="alias-edit" style="display:none;">
                        {% set chat_info_edit = chats | selectattr("numero", "equalto", selected) | first %}
                        <input type="text" value="{{ chat_info_edit.alias if chat_info_edit and chat_info_edit.alias else (chat_info_edit.nombre if chat_info_edit and chat_info_edit.nombre else '') }}"
                               data-num="{{ selected }}" maxlength="100">
                    </span>
                    <button type="button" class="edit-alias-btn" data-num="{{ selected }}" title="Editar nombre">
                        ‚úèÔ∏è
                    </button>
                </div>
                <span class="chat-number">{{ selected }}</span>
            </div>

            <div class="chat-controls">
                <!-- BADGE DE ESTADO IA/MANUAL -->
                <span class="badge {% if IA_ESTADOS.get(selected, {}).get('activa', True) %}bg-success{% else %}bg-warning{% endif %}">
                    {% if IA_ESTADOS.get(selected, {}).get('activa', True) %}
                    ü§ñ IA ACTIVADA
                    {% else %}
                    üë§ MODO MANUAL
                    {% endif %}
                </span>

                <!-- Bot√≥n toggle IA -->
                <form action="/toggle_ai/{{ selected }}" method="POST">
                    <button type="submit" class="toggle-btn {{ 'on' if IA_ESTADOS.get(selected, {}).get('activa', True) else 'off' }}">
                        IA {{ 'ON' if IA_ESTADOS.get(selected, {}).get('activa', True) else 'OFF' }}
                    </button>
                </form>
            </div>
        </div>
        {% else %}
        <div class="chat-panel-header">
            <span>Selecciona un chat</span>
        </div>
        {% endif %}
        <div class="msgs-wrap-v2" id="msgs">
            {% if mensajes %}
            {% for msg in mensajes %}
            <!-- Mensaje del usuario (con imagen a la izquierda) -->
            {% if msg.mensaje and msg.mensaje != '[Mensaje manual desde web]' %}
            <div class="msg-box msg-user">
                <div class="message-content">
                    {% if msg.es_imagen and msg.imagen_url %}
                    <div class="image-message">
                        <img src="{{ msg.imagen_url }}" alt="Imagen" class="whatsapp-image">
                        {% if msg.mensaje and msg.mensaje != 'Analiza esta imagen' %}
                        <div class="image-caption">
                            {{ msg.mensaje }}
                        </div>
                        {% endif %}
                    </div>
                    {% elif msg.tipo_mensaje == 'audio' and msg.contenido_extra %}
                    <!-- Mostrar audio con reproductor funcional -->
                    <div class="audio-player">
                        <!-- Reproductor nativo (oculto pero funcional) -->
                        <audio id="audio-{{ loop.index }}" class="whatsapp-audio">
                            <source src="{{ msg.contenido_extra }}" type="audio/ogg">
                            <source src="{{ msg.contenido_extra }}" type="audio/mpeg">
                            Tu navegador no soporta el elemento de audio.
                        </audio>

                        <!-- Controles personalizados -->
                        <div class="audio-controls">
                            <button class="audio-play-btn" onclick="toggleAudio('audio-{{ loop.index }}', this)">
                                ‚ñ∂Ô∏è
                            </button>
                            <div class="audio-progress" onclick="seekAudio('audio-{{ loop.index }}', this, event)">
                                <div class="audio-progress-bar"></div>
                            </div>
                            <span class="audio-duration" id="duration-{{ loop.index }}">0:00</span>
                            <a href="{{ msg.contenido_extra }}" download="audio-mensaje.ogg" class="audio-download-btn" title="Descargar audio">
                                ‚¨áÔ∏è
                            </a>
                        </div>

                        <!-- Transcripci√≥n -->
                        {% if msg.transcripcion_audio %}
                        <div class="audio-transcription">
                            <strong>Transcripci√≥n:</strong> {{ msg.transcripcion_audio }}
                        </div>
                        {% elif msg.mensaje and msg.mensaje != '[Mensaje manual desde web]' %}
                        <div class="audio-transcription">
                            <strong>Mensaje:</strong> {{ msg.mensaje }}
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <!-- Mostrar texto normal -->
                    <div class="text-message">
                        {{ msg.mensaje }}
                    </div>
                    {% endif %}
                </div>
                <div class="msg-meta">{{ msg.timestamp.strftime('%H:%M') }}</div>
            </div>
            {% endif %}

            <!-- Mensaje manual desde web -->
            {% if msg.mensaje and msg.mensaje == '[Mensaje manual desde web]' and msg.respuesta %}
            <div class="msg-box msg-manual">
                <div class="message-content">
                    <div class="manual-indicator">üì§ Mensaje enviado:</div>
                    <div class="text-message">
                        {{ msg.respuesta }}
                    </div>
                </div>
                <div class="msg-meta">{{ msg.timestamp.strftime('%H:%M') }}</div>
            </div>
            {% endif %}

            <!-- Respuesta de la IA (a la derecha) -->
            {% if msg.respuesta and msg.respuesta != '[Respuesta vac√≠a]' and msg.mensaje != '[Mensaje manual desde web]' %}
            <div class="msg-box msg-ai">
                <div class="message-content">
                    <div class="text-message">
                        {{ msg.respuesta }}
                    </div>
                </div>
                <div class="msg-meta">{{ msg.timestamp.strftime('%H:%M') }}</div>
            </div>
            {% endif %}
            {% endfor %}
            {% else %}
            <div class="no-chat-selected">
                <p>Selecciona un chat para ver mensajes.</p>
            </div>
            {% endif %}
        </div>

        <!-- FORMULARIO DE MENSAJE MANUAL -->
        {% if selected %}
        {% if not IA_ESTADOS.get(selected, {}).get('activa', True) %}
        <form method="POST" action="/send-manual" class="reply-form">
            <input type="hidden" name="numero" value="{{ selected }}">
            <div class="input-group">
                <button type="button" id="emoji-button" class="emoji-btn">üòä</button>
                <input type="text" name="texto" id="mensaje-texto" placeholder="Escribe un mensaje manual..." class="reply-input-line" autocomplete="off" required />
                <button type="submit" class="send-btn">Enviar</button>
            </div>
        </form>
        {% else %}
        <!-- Replace the existing toggle button in the ia-active-message div with this -->
        <div class="ia-active-message">
            <div class="ia-indicator">
                <span class="ia-icon">{{ 'ü§ñ' if IA_ESTADOS.get(selected, {}).get('activa', True) else 'üë§' }}</span>
                <span>{{ 'La IA est√° respondiendo autom√°ticamente' if IA_ESTADOS.get(selected, {}).get('activa', True) else 'Modo manual activado' }}</span>
            </div>
            <form action="/toggle_ai/{{ selected }}" method="POST">
                {% if IA_ESTADOS.get(selected, {}).get('activa', True) %}
                <!-- AI is active, show 'Desactivar IA' -->
                <button type="submit" class="toggle-btn off">Desactivar IA</button>
                {% else %}
                <!-- AI is inactive, show 'Activar IA' -->
                <button type="submit" class="toggle-btn on">Activar IA</button>
                {% endif %}
            </form>
        </div>
        {% endif %}
        {% endif %}
    </section>

    <!-- Lado derecho - Info del chat -->
    <aside class="sidebar-right">
        {% if selected %}
        <div class="sidebar-section">
            <h3>Acciones</h3>
            <form action="/chats/{{ selected }}/eliminar" method="POST" onsubmit="return confirm('¬øEst√°s seguro de eliminar este chat? Se borrar√° todo el historial.');">
                <button type="submit" class="delete-btn">
                    üóëÔ∏è Eliminar Chat
                </button>
            </form>
        </div>

        <div class="sidebar-section">
            <h3>Informaci√≥n</h3>
            <div class="chat-info-stats">
                <div class="stat-item">
                    <span class="stat-label">Total mensajes:</span>
                    <span class="stat-value">{{ mensajes|length if mensajes else 0 }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">√öltima actividad:</span>
                    <span class="stat-value">
                        {% if mensajes and mensajes[-1].timestamp %}
                        {{ mensajes[-1].timestamp.strftime('%d/%m/%Y %H:%M') }}
                        {% else %}
                        N/A
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
        {% endif %}
    </aside>
</div>

<!-- Bot√≥n m√≥vil para mostrar/ocultar lista de chats -->
<button class="mobile-chat-toggle" onclick="toggleChatList()">üí¨</button>

<style>
    /* Solo reemplaza o a√±ade estos estilos para mejorar la legibilidad */

    .chat-item {
        display: block;
        background-color: white;
        border-radius: 8px;
        margin-bottom: 10px;
        padding: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        transition: all 0.2s ease;
        text-decoration: none;
        color: inherit;
    }

        .chat-item:hover {
            background-color: #f0f5ff;
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }

        .chat-item.selected {
            background-color: #e0f0ff;
            border-left: 3px solid #1a73e8;
        }

    .card-title-row {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }

    .card-avatar-section {
        margin-right: 10px;
    }

    .alias-view {
        font-weight: 600;
        flex-grow: 1;
        color: #333; /* M√°s oscuro para el nombre */
        font-size: 14px; /* Ligeramente m√°s grande */
    }

    .card-meta-row {
        display: flex;
        justify-content: space-between;
        font-size: 12px; /* Aumentado de 11px */
        color: #555; /* M√°s oscuro que antes */
        margin-bottom: 6px;
    }

    .card-num {
        color: #444;
        font-size: 12px;
    }

    .card-time {
        font-size: 12px;
        color: #444;
        font-weight: 500;
    }

    .card-msg {
        color: #222; /* Mucho m√°s oscuro para mejor legibilidad */
        font-size: 13.5px; /* Ligeramente m√°s grande */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.4;
    }

    .edit-alias-btn {
        border: none;
        background: none;
        cursor: pointer;
        font-size: 14px;
        padding: 2px 5px;
        margin-left: 5px;
        opacity: 0.8;
    }

        .edit-alias-btn:hover {
            opacity: 1;
        }

    /* Ajustes a la animaci√≥n de resaltado */
    @keyframes highlightChat {
        0% {
            background-color: inherit;
        }

        30% {
            background-color: #d6e8ff;
        }
        /* Azul m√°s claro y m√°s visible */
        100% {
            background-color: inherit;
        }
    }

    .chat-item.new-message {
        animation: highlightChat 2.5s ease-in-out;
    }
</style>
<script>
// Auto-refresh functionality for chat list
let chatAutoRefresh = true;
let refreshInterval = 500; // Half a second
let selectedChatId = "{{ selected }}";
let lastUpdateTimestamp = new Date().getTime();

function startChatRefresh() {
  console.log("üîÑ Starting chat list auto-refresh");
  setInterval(actualizarListaChats, refreshInterval);
}

function actualizarListaChats() {
  if (!chatAutoRefresh) return;

  fetch('/chats/data')
    .then(response => {
      if (!response.ok) {
        throw new Error('Error fetching chat data');
      }
      return response.json();
    })
    .then(data => {
      if (data.timestamp <= lastUpdateTimestamp) {
        return; // No new data
      }

      lastUpdateTimestamp = data.timestamp;
      actualizarListaChatsIncremental(data.chats);
      console.log("‚úÖ Chat list updated:", new Date().toLocaleTimeString());
    })
    .catch(error => {
      console.error("‚ùå Error updating chat list:", error);
    });
}

    // Modificar la funci√≥n actualizarListaChats para preservar la posici√≥n del scroll
function actualizarChatExistente(elemento, chat) {
  // Update chat preview (last message)
  const previewElement = elemento.querySelector('.chat-preview');
  if (previewElement && chat.ultimo_mensaje) {
    const nuevoTexto = chat.tipo_mensaje === 'imagen' ?
      'üì∑ Imagen' :
      `${chat.ultimo_mensaje.substring(0, 35)}${chat.ultimo_mensaje.length > 35 ? '...' : ''}`;

    if (previewElement.textContent.trim() !== nuevoTexto.trim()) {
      previewElement.textContent = nuevoTexto;
      elemento.classList.add('new-message'); // Add highlight class
      setTimeout(() => {
        elemento.classList.remove('new-message');
      }, 2500);
    }
  }

  // Update time
  const timeElement = elemento.querySelector('.chat-time');
  if (timeElement && chat.ultima_fecha) {
    const fecha = new Date(chat.ultima_fecha);
    timeElement.textContent = fecha.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  // Update date
  const dateElement = elemento.querySelector('.chat-date');
  if (dateElement && chat.ultima_fecha) {
    const fecha = new Date(chat.ultima_fecha);
    dateElement.textContent = fecha.toLocaleDateString([], { day: '2-digit', month: '2-digit' });
  }
}

function crearNuevoChatHTML(chat) {
  const isSelected = chat.numero === selectedChatId;
  const avatarUrl = chat.imagen_url || '/static/icons/default-avatar.png';
  const nombreMostrado = chat.nombre_mostrado || chat.numero;
  const ultimoMensaje = chat.tipo_mensaje === 'imagen' ?
    'üì∑ Imagen' :
    (chat.ultimo_mensaje ?
      `${chat.ultimo_mensaje.substring(0, 35)}${chat.ultimo_mensaje.length > 35 ? '...' : ''}` :
      'Sin mensajes');

  return `
<a href="/chats/${chat.numero}" class="chat-item ${isSelected ? 'selected' : ''}">
    <div class="chat-avatar">
        <img src="${avatarUrl}"
             alt="Avatar"
             onerror="this.onerror=null;this.src='/static/icons/default-avatar.png';"
             width="40" height="40">
    </div>
    <div class="chat-info">
        <div class="chat-name" style="display:flex;align-items:center;" data-num="${chat.numero}">
            <span class="alias-view">
                ${nombreMostrado}
            </span>
            <span class="alias-edit" style="display:none;">
                <input type="text" value="${chat.alias || chat.nombre || ''}" data-num="${chat.numero}" maxlength="100" style="width: 110px;">
            </span>
            <button type="button" class="edit-alias-btn" data-num="${chat.numero}" title="Editar nombre" style="border:none;background:none;cursor:pointer;">
                ‚úèÔ∏è
            </button>
        </div>
        ${(chat.alias || chat.nombre) ?
        `<div class="chat-num" style="font-size:11px;color:#888;">
            ${chat.numero}
        </div>` : ''}
        <div class="chat-preview">
            ${ultimoMensaje}
        </div>
    </div>
    <div class="chat-meta">
        ${chat.ultima_fecha ?
        `<div class="chat-date">${new Date(chat.ultima_fecha).toLocaleDateString([], {day: '2-digit', month: '2-digit'})}</div>
        <div class="chat-time">${new Date(chat.ultima_fecha).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</div>` : ''}
    </div>
</a>
  `;
}

// Add highlight animation style
const style = document.createElement('style');
style.textContent = `
  @keyframes highlightChat {
    0% { background-color: inherit; }
    30% { background-color: #e7f3ff; }
    100% { background-color: inherit; }
  }

  .chat-item.new-message {
    animation: highlightChat 2s ease-in-out;
  }
`;
document.head.appendChild(style);

// Pause refresh when tab is not visible to save resources
document.addEventListener('visibilitychange', function() {
  chatAutoRefresh = !document.hidden;
});

// Start the refresh cycle when page loads
document.addEventListener('DOMContentLoaded', function() {
  if (document.querySelector('.chat-items')) {
    startChatRefresh();
  }
});
  // Funci√≥n para scroll al final de los mensajes
  function scrollToBottom() {
    const msgsContainer = document.getElementById('msgs');
    if (msgsContainer) {
      msgsContainer.scrollTop = msgsContainer.scrollHeight;
    }
  }

  // Funci√≥n para activar edici√≥n de alias
  function activarEdicionAlias(parent) {
    parent.querySelector('.alias-view').style.display = 'none';
    parent.querySelector('.alias-edit').style.display = 'flex';
    const input = parent.querySelector('input[type=text]');
    input.focus();
    input.select();

    function terminarEdicion() {
      fetch(`/contactos/${input.dataset.num}/alias`, {
        method: 'POST',
        body: new URLSearchParams({alias: input.value}),
        headers: {'Content-Type': 'application/x-www-form-urlencoded'}
      }).then(() => {
        parent.querySelector('.alias-edit').style.display = 'none';
        parent.querySelector('.alias-view').textContent = input.value || input.dataset.num;
        parent.querySelector('.alias-view').style.display = '';

        // Actualizar en lista tambi√©n
        document.querySelectorAll('.chat-name').forEach(function(chatName) {
          if (chatName.dataset.num === input.dataset.num) {
            chatName.querySelector('.alias-view').textContent = input.value || input.dataset.num;
          }
        });
      });
    }

    input.onblur = terminarEdicion;
    input.onkeydown = function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        terminarEdicion();
      }
      if (e.key === 'Escape') {
        parent.querySelector('.alias-edit').style.display = 'none';
        parent.querySelector('.alias-view').style.display = '';
      }
    };
  }

  // Controlador de audio
  function toggleAudio(audioId, button) {
    const audioPlayer = document.getElementById(audioId);
    const progressBar = button.closest('.audio-player').querySelector('.audio-progress-bar');
    const durationSpan = button.closest('.audio-player').querySelector('.audio-duration');

    if (audioPlayer.paused) {
      audioPlayer.play().then(() => {
        button.textContent = '‚è∏Ô∏è';
        audioPlayer.ontimeupdate = function() {
          if (audioPlayer.duration && isFinite(audioPlayer.duration)) {
            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progressBar.style.width = progress + '%';
            const minutes = Math.floor(audioPlayer.currentTime / 60);
            const seconds = Math.floor(audioPlayer.currentTime % 60);
            durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          }
        };
      }).catch(error => console.error('Error al reproducir audio:', error));
    } else {
      audioPlayer.pause();
      button.textContent = '‚ñ∂Ô∏è';
    }
  }

  // Funci√≥n para buscar en el audio
  function seekAudio(audioId, progressBar, event) {
    const audioPlayer = document.getElementById(audioId);
    const progressBarInner = progressBar.querySelector('.audio-progress-bar');
    const rect = progressBar.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const width = rect.width;

    if (audioPlayer.duration && isFinite(audioPlayer.duration)) {
      const clickTime = (clickX / width) * audioPlayer.duration;
      audioPlayer.currentTime = clickTime;
      progressBarInner.style.width = (clickX / width) * 100 + '%';
      const minutes = Math.floor(audioPlayer.currentTime / 60);
      const seconds = Math.floor(audioPlayer.currentTime % 60);
      const durationSpan = progressBar.closest('.audio-player').querySelector('.audio-duration');
      durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
  }

  // Inicializar todos los audios al cargar la p√°gina
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.audio-player audio').forEach(audio => {
      audio.addEventListener('loadedmetadata', function() {
        const durationSpan = this.closest('.audio-player').querySelector('.audio-duration');
        if (this.duration && isFinite(this.duration)) {
          const minutes = Math.floor(this.duration / 60);
          const seconds = Math.floor(this.duration % 60);
          durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
      });
      if (audio.readyState < 1) audio.load();
      audio.addEventListener('canplay', function() {
        const durationSpan = this.closest('.audio-player').querySelector('.audio-duration');
        if (this.duration && isFinite(this.duration)) {
          const minutes = Math.floor(this.duration / 60);
          const seconds = Math.floor(this.duration % 60);
          durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
      });
      audio.addEventListener('ended', function() {
        const button = this.closest('.audio-player').querySelector('.audio-play-btn');
        if (button) button.textContent = '‚ñ∂Ô∏è';
        const progressBar = this.closest('.audio-player').querySelector('.audio-progress-bar');
        if (progressBar) progressBar.style.width = '0%';
      });
    });

    document.querySelectorAll('.edit-alias-btn').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const parent = btn.closest('.chat-title, .chat-name');
        activarEdicionAlias(parent);
      });
    });

    scrollToBottom();

    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        const isAudioChange = mutation.target.closest('.audio-player') ||
                             mutation.target.classList.contains('audio-progress-bar');
        if (mutation.addedNodes.length > 0 && !isAudioChange) {
          let shouldScroll = true;
          mutation.addedNodes.forEach(node => {
            if (node.classList && (node.classList.contains('audio-player') || node.closest('.audio-player'))) {
              shouldScroll = false;
            }
          });
          if (shouldScroll) setTimeout(scrollToBottom, 100);
        }
      });
    });
    const msgsContainer = document.getElementById('msgs');
    if (msgsContainer) observer.observe(msgsContainer, { childList: true, subtree: true });
  });

  // Toggle lista de chats en m√≥vil
  function toggleChatList() {
    const chatList = document.querySelector('.chat-list-v2');
      chatList.classList.toggle('mobile-visible');

    }
    if (window.location.pathname === '/kanban') {
        actualizarKanban();
    }

    // Funci√≥n para el selector de emojis
    document.addEventListener('DOMContentLoaded', function () {
        // Lista de emojis comunes
        const commonEmojis = [
            'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ', 'üôÇ', 'üòä',
            'üòá', 'ü•∞', 'üòç', 'ü§©', 'üòò', 'üòó', '‚ò∫Ô∏è', 'üòö', 'üòô',
            'üòã', 'üòõ', 'üòú', 'ü§™', 'üòù', 'ü§ë', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î',
            'üëç', 'üëé', '‚ù§Ô∏è', 'üî•', 'üéâ', 'üéÇ', 'üéÅ', 'üëè', 'üôè', 'üëã',
            'üíØ', '‚≠ê', '‚ú®', '‚ö°', 'üåü', 'üåà', '‚òÄÔ∏è', '‚òÅÔ∏è', 'üåßÔ∏è', '‚ùÑÔ∏è',
            'üçï', 'üçî', 'üçü', 'üåÆ', 'üç∞', 'üç©', '‚òï', 'üç∑', 'ü•Ç', 'üç∫'
        ];

        const emojiButton = document.getElementById('emoji-button');
        if (emojiButton) {
            // Crear el selector de emojis
            const emojiPicker = document.createElement('div');
            emojiPicker.className = 'emoji-picker';

            // Crear la cuadr√≠cula de emojis
            const emojiGrid = document.createElement('div');
            emojiGrid.className = 'emoji-grid';

            // Agregar los emojis a la cuadr√≠cula
            commonEmojis.forEach(emoji => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'emoji-item';
                emojiItem.textContent = emoji;

                // Agregar emoji al campo de texto cuando se hace clic
                emojiItem.addEventListener('click', function () {
                    const mensajeInput = document.getElementById('mensaje-texto');
                    if (mensajeInput) {
                        // Insertar emoji en la posici√≥n del cursor
                        const cursorPos = mensajeInput.selectionStart;
                        const textBefore = mensajeInput.value.substring(0, cursorPos);
                        const textAfter = mensajeInput.value.substring(cursorPos);

                        mensajeInput.value = textBefore + emoji + textAfter;

                        // Actualizar posici√≥n del cursor
                        const newCursorPos = cursorPos + emoji.length;
                        mensajeInput.setSelectionRange(newCursorPos, newCursorPos);
                        mensajeInput.focus();
                    }

                    // Cerrar el selector despu√©s de elegir
                    emojiPicker.classList.remove('active');
                });

                emojiGrid.appendChild(emojiItem);
            });

            emojiPicker.appendChild(emojiGrid);

            // Agregar el selector al DOM
            const replyForm = document.querySelector('.reply-form');
            if (replyForm) {
                replyForm.appendChild(emojiPicker);

                // Mostrar/ocultar el selector al hacer clic en el bot√≥n
                emojiButton.addEventListener('click', function (e) {
                    e.preventDefault();
                    emojiPicker.classList.toggle('active');
                });

                // Cerrar el selector al hacer clic fuera
                document.addEventListener('click', function (e) {
                    if (!emojiButton.contains(e.target) && !emojiPicker.contains(e.target)) {
                        emojiPicker.classList.remove('active');
                    }
                });
            }
        }
    });

   

</script>
{% endblock %}