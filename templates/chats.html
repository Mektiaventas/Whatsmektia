{% extends "base.html" %}
{% block title %}Conversaciones{% endblock %}

{% block content %}
{% set es_porfirianna = tenant_config.dominio == 'laporfirianna.mektia.com' %}
{% set negocio_nombre = 'La Porfirianna' if es_porfirianna else 'Mektia' %}

<div class="chat-list-header">
    <h2>Conversaciones - {{ negocio_nombre }}</h2>
    <span class="tenant-badge {% if es_porfirianna %}porfirianna-badge{% else %}mektia-badge{% endif %}">
        {{ negocio_nombre }}
    </span>
    <span style="font-size: 12px; color: #ffffff; margin-left: 15px;">
        (Base de datos: {{ tenant_config.db_name }})
    </span>
</div>
<div class="chat-layout-v2">
    <!-- Lado izquierdo: Lista -->
    <aside class="chat-list-v2">
        <div class="chat-list-tools">
            <button class="add-contact-btn">+ Agregar Contacto</button>
            <input type="text" placeholder="Buscar chats..." class="search-input">
        </div>

        <div class="chat-items">
            {% for chat in chats %}
            <a href="/chats/{{ chat.numero }}" class="chat-item {% if selected == chat.numero %}selected{% endif %}" data-chat-num="{{ chat.numero }}">
                <div class="card-content">
                    <div class="card-title-row">
                        <div class="card-avatar-section">
                            <img src="{{ chat.imagen_url or url_for('static', filename='icons/default-avatar.png') }}"
                                 class="card-avatar" alt="Avatar"
                                 onerror="this.onerror=null;this.src='{{ url_for('static', filename='icons/default-avatar.png') }}';">
                        </div>
                        {% set bandera = chat.numero | bandera %}
                        {% if bandera %}
                        <img src="{{ bandera }}" class="card-flag" alt="Pa√≠s" title="Pa√≠s">
                        {% endif %}
                        <span class="alias-view" data-num="{{ chat.numero }}">
                            {{ chat.nombre_mostrado }}
                        </span>
                        <span class="alias-edit" style="display:none;">
                            <input type="text" value="{{ chat.alias or chat.nombre or '' }}" data-num="{{ chat.numero }}" maxlength="100" style="width: 110px;">
                        </span>
                        <button type="button" class="edit-alias-btn" data-num="{{ chat.numero }}" title="Editar nombre">
                            ‚úèÔ∏è
                        </button>
                    </div>
                    <div class="card-meta-row">
                        <span class="card-num">{{ chat.numero }}</span>
                        <span class="card-time">
                            {% if chat.ultima_fecha %}
                            {{ chat.ultima_fecha|format_time_24h }}
                            {% endif %}
                        </span>
                    </div>
                    <div class="card-msg">
                        {% if chat.ultimo_mensaje %}
                        {% if chat.tipo_mensaje == 'imagen' %}
                        üì∑ Imagen
                        {% else %}
                        {{ chat.ultimo_mensaje[:35] }}{% if chat.ultimo_mensaje|length > 35 %}...{% endif %}
                        {% endif %}
                        {% else %}
                        Sin mensajes
                        {% endif %}
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </aside>

    <!-- Centro: Mensajes -->
    <section class="chat-panel-v2">
        {% if selected %}
        <div class="chat-panel-header" data-num="{{ selected }}">
            <div class="chat-header-info">
                <div class="chat-title">
                    <span class="alias-view">
                        {{ (chats | selectattr("numero", "equalto", selected) | first).nombre_mostrado if (chats | selectattr("numero", "equalto", selected) | first) else selected }}
                    </span>
                    <span class="alias-edit" style="display:none;">
                        {% set chat_info_edit = chats | selectattr("numero", "equalto", selected) | first %}
                        <input type="text" value="{{ chat_info_edit.alias if chat_info_edit and chat_info_edit.alias else (chat_info_edit.nombre if chat_info_edit and chat_info_edit.nombre else '') }}"
                               data-num="{{ selected }}" maxlength="100">
                    </span>
                    <button type="button" class="edit-alias-btn" data-num="{{ selected }}" title="Editar nombre">
                        ‚úèÔ∏è
                    </button>
                </div>
                <span class="chat-number">{{ selected }}</span>
            </div>

            <div class="chat-controls">
                <span class="badge {% if IA_ESTADOS.get(selected, {}).get('activa', True) %}bg-success{% else %}bg-warning{% endif %}">
                    {% if IA_ESTADOS.get(selected, {}).get('activa', True) %}
                    ü§ñ IA ACTIVADA
                    {% else %}
                    üë§ MODO MANUAL
                    {% endif %}
                </span>
                <form action="/toggle_ai/{{ selected }}" method="POST">
                    <button type="submit" class="toggle-btn {{ 'on' if IA_ESTADOS.get(selected, {}).get('activa', True) else 'off' }}">
                        IA {{ 'ON' if IA_ESTADOS.get(selected, {}).get('activa', True) else 'OFF' }}
                    </button>
                </form>
            </div>
        </div>
        {% else %}
        <div class="chat-panel-header">
            <span>Selecciona un chat</span>
        </div>
        {% endif %}
        <div class="msgs-wrap-v2" id="msgs">
            {% if mensajes %}
            {% for msg in mensajes %}
            {% if msg.mensaje and msg.mensaje != '[Mensaje manual desde web]' %}
            <div class="msg-box msg-user">
                <div class="message-content">
                    {% if msg.es_imagen and msg.imagen_url %}
                    <div class="image-message">
                        <img src="{{ msg.imagen_url }}" alt="Imagen" class="whatsapp-image">
                        {% if msg.mensaje and msg.mensaje != 'Analiza esta imagen' %}
                        <div class="image-caption">
                            {{ msg.mensaje }}
                        </div>
                        {% endif %}
                    </div>
                    {% elif msg.tipo_mensaje == 'audio' and msg.contenido_extra %}
                    <div class="audio-player">
                        <audio id="audio-{{ loop.index }}" class="whatsapp-audio">
                            <source src="{{ msg.contenido_extra }}" type="audio/ogg">
                            <source src="{{ msg.contenido_extra }}" type="audio/mpeg">
                            Tu navegador no soporta el elemento de audio.
                        </audio>
                        <div class="audio-controls">
                            <button class="audio-play-btn" onclick="toggleAudio('audio-{{ loop.index }}', this)">
                                ‚ñ∂Ô∏è
                            </button>
                            <div class="audio-progress" onclick="seekAudio('audio-{{ loop.index }}', this, event)">
                                <div class="audio-progress-bar"></div>
                            </div>
                            <span class="audio-duration" id="duration-{{ loop.index }}">0:00</span>
                            <a href="{{ msg.contenido_extra }}" download="audio-mensaje.ogg" class="audio-download-btn" title="Descargar audio">
                                ‚¨áÔ∏è
                            </a>
                        </div>
                        {% if msg.transcripcion_audio %}
                        <div class="audio-transcription">
                            <strong>Transcripci√≥n:</strong> {{ msg.transcripcion_audio }}
                        </div>
                        {% elif msg.mensaje and msg.mensaje != '[Mensaje manual desde web]' %}
                        <div class="audio-transcription">
                            <strong>Mensaje:</strong> {{ msg.mensaje }}
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-message">
                        {{ msg.mensaje }}
                    </div>
                    {% endif %}
                </div>
                <div class="msg-meta">{{ msg.timestamp|format_time_24h }}</div>
            </div>
            {% endif %}

            {% if msg.mensaje == '[Mensaje manual desde web]' and msg.respuesta %}
            <div class="msg-box msg-manual">
                <div class="message-content">
                    <div class="manual-indicator">üì§ Mensaje enviado:</div>
                    <div class="text-message">
                        {{ msg.respuesta }}
                    </div>
                </div>
                <div class="msg-meta">{{ msg.timestamp|format_time_24h }}</div>
            </div>
            {% endif %}

            {% if msg.respuesta and msg.respuesta != '[Respuesta vac√≠a]' and msg.mensaje != '[Mensaje manual desde web]' %}
            <div class="msg-box msg-ai">
                <div class="message-content">
                    <div class="text-message">
                        {{ msg.respuesta }}
                    </div>
                </div>
                <div class="msg-meta">{{ msg.timestamp|format_time_24h }}</div>
            </div>
            {% endif %}
            {% endfor %}
            {% else %}
            <div class="no-chat-selected">
                <p>Selecciona un chat para ver mensajes.</p>
            </div>
            {% endif %}
        </div>

        {% if selected %}
        {% if not IA_ESTADOS.get(selected, {}).get('activa', True) %}
        <form method="POST" action="/send-manual" class="reply-form">
            <input type="hidden" name="numero" value="{{ selected }}">
            <div class="input-group">

                <button type="button" id="emoji-pick-btn" class="emoji-btn">üòä</button>
                <!-- Emoji Picker Container (hidden by default) -->
                <div id="emoji-picker-list" class="emoji-picker-list" style="display:none; position:absolute; z-index:1000; background:white; border:1px solid #ccc; border-radius:8px; padding:8px;">
                    <!-- Los emojis se llenan por JS -->
                </div>
                <input type="text" name="texto" id="mensaje-texto" placeholder="Escribe un mensaje manual..." class="reply-input-line" autocomplete="off" required />
                <button type="submit" class="send-btn">Enviar</button>
            </div>
        </form>
        {% else %}
        <div class="ia-active-message">
            <div class="ia-indicator">
                <span class="ia-icon">{{ 'ü§ñ' if IA_ESTADOS.get(selected, {}).get('activa', True) else 'üë§' }}</span>
                <span>{{ 'La IA est√° respondiendo autom√°ticamente' if IA_ESTADOS.get(selected, {}).get('activa', True) else 'Modo manual activado' }}</span>
            </div>
            <form action="/toggle_ai/{{ selected }}" method="POST">
                {% if IA_ESTADOS.get(selected, {}).get('activa', True) %}
                <button type="submit" class="toggle-btn off">Desactivar IA</button>
                {% else %}
                <button type="submit" class="toggle-btn on">Activar IA</button>
                {% endif %}
            </form>
        </div>
        {% endif %}
        {% endif %}
    </section>

    <aside class="sidebar-right">
        {% if selected %}
        <div class="sidebar-section">
            <h3>Acciones</h3>
            <form action="/chats/{{ selected }}/eliminar" method="POST" onsubmit="return confirm('¬øEst√°s seguro de eliminar este chat? Se borrar√° todo el historial.');">
                <button type="submit" class="delete-btn">
                    üóëÔ∏è Eliminar Chat
                </button>
            </form>
        </div>

        <div class="sidebar-section">
            <h3>Informaci√≥n</h3>
            <div class="chat-info-stats">
                <div class="stat-item">
                    <span class="stat-label">Total mensajes:</span>
                    <span class="stat-value">{{ mensajes|length if mensajes else 0 }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">√öltima actividad:</span>
                    <span class="stat-value">
                        {% if mensajes and mensajes[-1].timestamp %}
                        {{ mensajes[-1].timestamp|format_time_24h }}
                        {% else %}
                        N/A
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
        {% endif %}
    </aside>
</div>

<button class="mobile-chat-toggle" onclick="toggleChatList()">üí¨</button>
<style>

    .card-avatar {
        width: 8%;
        height: 8%;
    }
    .card-content {
        color: white;
    }
    .emoji-picker-list {
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        min-width: 220px;
        max-width: 320px;
        max-height: 180px;
        overflow-y: auto;
        padding: 8px;
        display: none;
    }

    .emoji-pick-btn {
        font-size: 22px;
        margin: 2px;
        background: none;
        border: none;
        cursor: pointer;
    }
    .input-group {
        position: relative;
    }
    .msg-manual {
        left: 15%
    }
</style>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        const emojiBtn = document.getElementById('emoji-pick-btn');
        const emojiPickerList = document.getElementById('emoji-picker-list');
        const input = document.getElementById('mensaje-texto');
        const emojis = ['üòä', 'üòÇ', 'üòç', 'üëç', 'üôè', 'üòé', 'ü•≥', 'üò¢', 'üò°', 'üéâ', 'üí¨', '‚ù§Ô∏è', 'üî•', 'ü§î', 'üôå', 'üòÖ', 'üòâ', 'üòá', 'üòú', 'ü§ñ'];

        if (!emojiBtn || !emojiPickerList || !input) return; // Prevent errors if not present

        // Fill the picker
        emojiPickerList.innerHTML = emojis.map(e => `<button type="button" class="emoji-pick-btn">${e}</button>`).join('');

        // Show the picker above the button
        emojiBtn.addEventListener('click', function (e) {
            e.preventDefault();
            const rect = emojiBtn.getBoundingClientRect();
            const parentRect = emojiBtn.parentElement.getBoundingClientRect();
            // Calculate the position above the button
            emojiPickerList.style.left = (rect.left - parentRect.left) + 'px';
            emojiPickerList.style.top = (rect.top - parentRect.top - emojiPickerList.offsetHeight - 70) + 'px';
            emojiPickerList.style.display = 'block';
        });

        // Insert emoji at cursor position
        emojiPickerList.addEventListener('click', function (e) {
            if (e.target.classList.contains('emoji-pick-btn')) {
                const emoji = e.target.textContent;
                const start = input.selectionStart;
                const end = input.selectionEnd;
                const text = input.value;
                input.value = text.slice(0, start) + emoji + text.slice(end);
                input.selectionStart = input.selectionEnd = start + emoji.length;
                emojiPickerList.style.display = 'none';
                input.focus();
            }
        });

        // Hide picker when clicking outside
        document.addEventListener('click', function (e) {
            if (!emojiPickerList.contains(e.target) && e.target !== emojiBtn) {
                emojiPickerList.style.display = 'none';
            }
        });
    });
function ajustarHoraMexico(fechaUTC) {
    const fecha = new Date(fechaUTC);
    fecha.setHours(fecha.getHours() + 6);
    return fecha.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

let chatAutoRefresh = true;
let refreshInterval = 500;
let selectedChatId = "{{ selected }}";
let lastUpdateTimestamp = new Date().getTime();

function startChatRefresh() {
    setInterval(actualizarListaChats, refreshInterval);
}

function actualizarListaChats() {
    if (!chatAutoRefresh) return;
    fetch('/chats/data')
        .then(r => r.json())
        .then(data => {
            if (data.timestamp <= lastUpdateTimestamp) return;
            lastUpdateTimestamp = data.timestamp;
            actualizarElementosChat(data.chats);
        })
        .catch(err => console.error(err));
}

// FIXED FUNCTION
function actualizarChatExistente(elemento, chat) {
    const previewElement = elemento.querySelector('.card-msg');
    if (previewElement && chat.ultimo_mensaje) {
        const nuevoTexto = chat.tipo_mensaje === 'imagen'
            ? 'üì∑ Imagen'
            : `${chat.ultimo_mensaje.substring(0, 35)}${chat.ultimo_mensaje.length > 35 ? '...' : ''}`;
        if (previewElement.textContent.trim() !== nuevoTexto.trim()) {
            previewElement.textContent = nuevoTexto;
            elemento.classList.add('new-message');
            setTimeout(() => elemento.classList.remove('new-message'), 2000);
        }
    }
    const timeEl = elemento.querySelector('.card-time');
    if (timeEl && chat.ultima_fecha) {
        timeEl.textContent = ajustarHoraMexico(chat.ultima_fecha);
    }
}

function crearNuevoChatHTML(chat) {
    const isSelected = chat.numero === selectedChatId;
    const avatarUrl = chat.imagen_url || '/static/icons/default-avatar.png';
    const nombreMostrado = chat.nombre_mostrado || chat.numero;
    const ultimoMensaje = chat.tipo_mensaje === 'imagen'
        ? 'üì∑ Imagen'
        : (chat.ultimo_mensaje
            ? `${chat.ultimo_mensaje.substring(0, 35)}${chat.ultimo_mensaje.length > 35 ? '...' : ''}`
            : 'Sin mensajes');
    return `
<a href="/chats/${chat.numero}" class="chat-item ${isSelected ? 'selected' : ''}" data-chat-num="${chat.numero}">
  <div class="chat-content">
    <div class="card-title-row">
      <div class="card-avatar-section">
        <img src="${avatarUrl}" class="card-avatar" alt="Avatar"
             onerror="this.onerror=null;this.src='/static/icons/default-avatar.png';">
      </div>
      <span class="alias-view" data-num="${chat.numero}">${nombreMostrado}</span>
      <span class="alias-edit" style="display:none;">
        <input type="text" value="${chat.alias || chat.nombre || ''}" data-num="${chat.numero}" maxlength="100" style="width:110px;">
      </span>
      <button type="button" class="edit-alias-btn" data-num="${chat.numero}" title="Editar nombre">‚úèÔ∏è</button>
    </div>
    <div class="card-meta-row">
      <span class="card-num">${chat.numero}</span>
      <span class="card-time">
        ${chat.ultima_fecha ? ajustarHoraMexico(chat.ultima_fecha) : ''}
      </span>
    </div>
    <div class="card-msg">${ultimoMensaje}</div>
  </div>
</a>`;
}

document.addEventListener('visibilitychange', () => chatAutoRefresh = !document.hidden);

function activarEdicionAlias(parent) {
    const viewElement = parent.querySelector('.alias-view');
    const editElement = parent.querySelector('.alias-edit');
    if (!viewElement || !editElement) return;
    viewElement.style.display = 'none';
    editElement.style.display = 'flex';
    const input = editElement.querySelector('input[type=text]');
    if (!input) return;
    input.focus(); input.select();
    function terminar() {
        fetch(`/contactos/${input.dataset.num}/alias`, {
            method: 'POST',
            body: new URLSearchParams({ alias: input.value }),
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
        }).finally(() => {
            editElement.style.display = 'none';
            viewElement.textContent = input.value || input.dataset.num;
            viewElement.style.display = '';
        });
    }
    input.onblur = terminar;
    input.onkeydown = e => {
        if (e.key === 'Enter') { e.preventDefault(); terminar(); }
        if (e.key === 'Escape') { editElement.style.display = 'none'; viewElement.style.display = ''; }
    };
}

function toggleAudio(id, btn) {
    const audio = document.getElementById(id);
    const bar = btn.closest('.audio-player').querySelector('.audio-progress-bar');
    const durSpan = btn.closest('.audio-player').querySelector('.audio-duration');
    if (audio.paused) {
        audio.play().then(() => {
            btn.textContent = '‚è∏Ô∏è';
            audio.ontimeupdate = () => {
                if (audio.duration) {
                    bar.style.width = (audio.currentTime / audio.duration) * 100 + '%';
                    const m = Math.floor(audio.currentTime / 60);
                    const s = Math.floor(audio.currentTime % 60).toString().padStart(2,'0');
                    durSpan.textContent = `${m}:${s}`;
                }
            };
        }).catch(console.error);
    } else {
        audio.pause();
        btn.textContent = '‚ñ∂Ô∏è';
    }
}

function seekAudio(id, progressBar, evt) {
    const audio = document.getElementById(id);
    const inner = progressBar.querySelector('.audio-progress-bar');
    const rect = progressBar.getBoundingClientRect();
    const clickX = evt.clientX - rect.left;
    if (audio.duration) {
        audio.currentTime = (clickX / rect.width) * audio.duration;
        inner.style.width = (clickX / rect.width) * 100 + '%';
    }
}

function scrollToBottom() {
    const c = document.getElementById('msgs');
    if (c) c.scrollTop = c.scrollHeight;
}

function ensureScrollBottom() {
    [0,60,120,240,400].forEach(d => setTimeout(scrollToBottom, d));
}

document.addEventListener('DOMContentLoaded', () => {
    ensureScrollBottom();
    document.querySelectorAll('#msgs img').forEach(img => {
        if (!img.complete) img.addEventListener('load', ensureScrollBottom);
    });
    window.addEventListener('load', ensureScrollBottom);
});

function toggleChatList() {
    document.querySelector('.chat-list-v2')?.classList.toggle('mobile-visible');
}

function actualizarElementosChat(chats) {
    const container = document.querySelector('.chat-items');
    if (!container) return;
    chats.forEach(chat => {
        let node = container.querySelector(`.chat-item[data-chat-num="${chat.numero}"]`);
        if (node) {
            actualizarChatExistente(node, chat);
        } else if (chat.ultimo_mensaje) {
            const tmp = document.createElement('div');
            tmp.innerHTML = crearNuevoChatHTML(chat);
            const el = tmp.firstElementChild;
            container.insertBefore(el, container.firstChild);
            el.classList.add('new-message');
            setTimeout(() => el.classList.remove('new-message'), 2000);
            const editBtn = el.querySelector('.edit-alias-btn');
            if (editBtn) {
                editBtn.addEventListener('click', e => {
                    e.preventDefault(); e.stopPropagation();
                    const parent = editBtn.closest('.card-title-row');
                    activarEdicionAlias(parent);
                });
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.edit-alias-btn').forEach(btn => {
        btn.addEventListener('click', e => {
            e.preventDefault(); e.stopPropagation();
            const parent = btn.closest('.chat-title, .card-title-row, .chat-name');
            activarEdicionAlias(parent);
        });
    });
    if (document.querySelector('.chat-items')) {
        refreshInterval = 500;
        actualizarListaChats();
        startChatRefresh();
    }
});
</script>
{% endblock %}