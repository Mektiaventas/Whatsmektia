{% extends "base.html" %}
{% block title %}Conversaciones{% endblock %}

{% block content %}
{% set host = request.host.split(':')[0] %}
{% set parts = host.split('.') %}
{% set subdomain = '' %}
{% if parts|length > 2 %}
    {% set first = parts[0].lower() %}
    {% if first.startswith('www') %}
        {% set subdomain = parts[1] %}
    {% else %}
        {% set subdomain = parts[0] %}
    {% endif %}
{% elif parts|length == 2 %}
    {% set first = parts[0].lower() %}
    {% if not first.startswith('www') %}
        {% set subdomain = parts[0] %}
    {% endif %}
{% else %}
    {% set subdomain = '' %}
{% endif %}
{% set negocio_nombre = subdomain|capitalize if subdomain else (tenant_config.negocio_nombre or 'Mektia') %}

<div class="chat-list-header">
    <h2>Conversaciones - {{ negocio_nombre }}</h2>
</div>
<div class="chat-layout-v2">
    <!-- Lado izquierdo: Lista -->
    <aside class="chat-list-v2">
        <div class="chat-list-tools">
            <button class="add-contact-btn">+ Agregar Contacto</button>
            <input type="text" placeholder="Buscar chats..." class="search-input">
        </div>

        <div class="chat-items">
            {% for chat in chats %}
            <a href="/chats/{{ chat.numero }}" class="chat-item kanban-card {% if selected == chat.numero %}selected{% endif %}" data-chat-num="{{ chat.numero }}" style="text-decoration:none;color:inherit;display:block;">
                <div class="card-content">
                    <div class="card-title-row">
                        {% set avatar_src = '/static/icons/whatsapp-icon.png' %}
                        {% if chat.numero.startswith('tg_') or chat.canal == 'Telegram' %}
                        {% set avatar_src = '/static/icons/telegram-icon-dos.png' %}
                        {% endif %}

                        <img src="{{ avatar_src }}"
                             class="card-avatar" alt="Avatar"
                             onerror="this.onerror=null;this.src='/static/icons/default-avatar.png';">

                        <!-- BANDERA A√ëADIDA AQU√ç -->
                        {% set bandera = chat.numero | bandera %}
                        {% if bandera %}
                        <img src="{{ bandera }}" class="card-flag" alt="Pa√≠s" title="Pa√≠s">
                        {% endif %}

                        <span class="alias-view" data-num="{{ chat.numero }}" data-nombre="{{ chat.nombre or '' }}" data-alias="{{ chat.alias or '' }}">{{ chat.nombre_mostrado }}</span>

                        {% if is_admin %}
                        <span class="alias-edit" style="display:none;">
                            <input type="text" value="{{ chat.alias or chat.nombre or chat.numero }}" data-num="{{ chat.numero }}" data-alias="{{ chat.alias or '' }}" data-nombre="{{ chat.nombre or '' }}" maxlength="100" style="width:110px;">
                        </span>
                        <button type="button" class="edit-alias-btn" data-num="{{ chat.numero }}" title="Editar nombre">‚úèÔ∏è</button>
                        {% endif %}

                        <span class="card-time">
                            {% if chat.ultima_fecha %}
                            {{ chat.ultima_fecha|format_time_24h }}
                            {% endif %}
                        </span>
                    </div>

                    <div class="card-meta-row">
                        {% if chat.sin_leer and chat.sin_leer > 0 %}
                        <span class="card-unread">{{ chat.sin_leer }}</span>
                        {% endif %}
                    </div>

                    <div class="card-msg">
                        {% if chat.ultimo_mensaje %}
                        {% if chat.tipo_mensaje == 'imagen' %}
                        üì∑ Imagen
                        {% else %}
                        {{ chat.ultimo_mensaje[:35] }}{% if chat.ultimo_mensaje|length > 35 %}...{% endif %}
                        {% endif %}
                        {% else %}
                        &nbsp;
                        {% endif %}
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </aside>

    <!-- Centro: Mensajes -->
    <section class="chat-panel-v2">
        {% if selected %}
        <div class="chat-panel-header" data-num="{{ selected }}">
            <div class="chat-header-info">
                <div class="chat-title">
                    {% set selected_chat = (chats | selectattr("numero", "equalto", selected) | first) %}
                    {% set avatar_src_header = '/static/icons/whatsapp-icon.png' %}
                    {% if selected and (selected.startswith('tg_') or (selected_chat and selected_chat.canal == 'Telegram')) %}
                    {% set avatar_src_header = '/static/icons/telegram-icon-dos.png' %}
                    {% endif %}

                    <img src="{{ avatar_src_header }}" class="card-avatar" alt="Avatar"
                         style="width: 24px; height: 24px; border-radius: 4px; margin-right: 6px;">

                    <!-- BANDERA EN EL HEADER DEL CHAT SELECCIONADO -->
                    {% set bandera_header = selected | bandera %}
                    {% if bandera_header %}
                    <img src="{{ bandera_header }}" class="card-flag" alt="Pa√≠s" title="Pa√≠s" style="width: 20px; height: 14px; border-radius: 2px; margin-right: 6px;">
                    {% endif %}

                    <span class="alias-view" data-num="{{ selected }}">
                        {{ selected_chat.nombre_mostrado if selected_chat else selected }}
                    </span>

                    {% if is_admin %}
                    <span class="alias-edit" style="display:none;">
                        {% set chat_info = (chats | selectattr('numero', 'equalto', selected) | first) %}
                        <input type="text"
                               value="{{ chat_info.alias if chat_info and chat_info.alias else (chat_info.nombre if chat_info and chat_info.nombre else selected) }}"
                               data-num="{{ selected }}"
                               maxlength="100"
                               style="width:110px;">
                    </span>
                    <button type="button" class="edit-alias-btn" data-num="{{ selected }}" title="Editar nombre">‚úèÔ∏è</button>
                    {% endif %}
                </div>
                <span class="chat-number">{{ selected }}</span>
            </div>

            <div class="chat-controls">
                <span class="badge {% if IA_ESTADOS.get(selected, {}).get('activa', True) %}bg-success{% else %}bg-warning{% endif %}">
                    {% if IA_ESTADOS.get(selected, {}).get('activa', True) %}
                    ü§ñ IA ACTIVADA
                    {% else %}
                    üë§ MODO MANUAL
                    {% endif %}
                </span>
                <form action="/toggle_ai/{{ selected }}" method="POST">
                    <button type="submit" class="toggle-btn {{ 'on' if IA_ESTADOS.get(selected, {}).get('activa', True) else 'off' }}">
                        IA {{ 'ON' if IA_ESTADOS.get(selected, {}).get('activa', True) else 'OFF' }}
                    </button>
                </form>
            </div>
        </div>
        {% else %}
        <div class="chat-panel-header">
            <span>Selecciona un chat</span>
        </div>
        {% endif %}
        <div class="msgs-wrap-v2" id="msgs">
            {% if mensajes %}
            {% for msg in mensajes %}
            {% if msg.mensaje and msg.mensaje != '[Mensaje manual desde web]' %}
            <div class="msg-box msg-user" data-msg-id="{{ msg.id if msg.id else '' }}">
                <div class="message-content">
                    {% if msg.es_imagen and msg.imagen_url %}
                    <div class="image-message">
                        <img src="{{ msg.imagen_url | public_img }}" alt="Imagen" class="whatsapp-image">
                        {% if msg.mensaje and msg.mensaje != 'Analiza esta imagen' %}
                        <div class="image-caption">
                            {{ msg.mensaje }}
                        </div>
                        {% endif %}
                    </div>
                    {% elif msg.tipo_mensaje == 'audio' and msg.contenido_extra %}
                    <div class="audio-player">
                        <audio id="audio-{{ loop.index }}" class="whatsapp-audio">
                            <source src="{{ msg.contenido_extra }}" type="audio/ogg">
                            <source src="{{ msg.contenido_extra }}" type="audio/mpeg">
                            Tu navegador no soporta el elemento de audio.
                        </audio>
                        <div class="audio-controls">
                            <button class="audio-play-btn" onclick="toggleAudio('audio-{{ loop.index }}', this)">
                                ‚ñ∂Ô∏è
                            </button>
                            <div class="audio-progress" onclick="seekAudio('audio-{{ loop.index }}', this, event)">
                                <div class="audio-progress-bar"></div>
                            </div>
                            <span class="audio-duration" id="duration-{{ loop.index }}">0:00</span>
                            <a href="{{ msg.contenido_extra }}" download="audio-mensaje.ogg" class="audio-download-btn" title="Descargar audio">
                                ‚¨áÔ∏è
                            </a>
                        </div>
                        {% if msg.transcripcion_audio %}
                        <div class="audio-transcription">
                            <strong>Transcripci√≥n:</strong> {{ msg.transcripcion_audio }}
                        </div>
                        {% elif msg.mensaje and msg.mensaje != '[Mensaje manual desde web]' %}
                        <div class="audio-transcription">
                            <strong>Mensaje:</strong> {{ msg.mensaje }}
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-message">
                        {{ msg.mensaje }}
                    </div>
                    {% endif %}
                </div>
                <div class="msg-meta">{{ msg.timestamp|format_time_24h }}</div>
            </div>
            {% endif %}

            {% if msg.mensaje == '[Mensaje manual desde web]' and msg.respuesta %}
            <div class="msg-box msg-manual">
                <div class="message-content">
                    <div class="manual-indicator">üì§ Mensaje enviado:</div>
                    <div class="text-message">
                        {{ msg.respuesta }}
                    </div>
                </div>
                <div class="msg-meta">{{ msg.timestamp|format_time_24h }}</div>
            </div>
            {% endif %}

            {% if msg.respuesta and msg.respuesta != '[Respuesta vac√≠a]' and msg.mensaje != '[Mensaje manual desde web]' %}
            <div class="msg-box msg-ai" data-msg-id="{{ msg.id if msg.id else '' }}">
                <div class="message-content">

                    {% if msg.respuesta_tipo_mensaje == 'imagen' and msg.respuesta_contenido_extra %}
                    <div class="image-message">
                        <img src="{{ msg.respuesta_contenido_extra | public_img }}" alt="Imagen IA" class="whatsapp-image">
                        {% if msg.respuesta and msg.respuesta != 'Analiza esta imagen' and msg.respuesta != 'El usuario envi√≥ una imagen' %}
                        <div class="image-caption">
                            {{ msg.respuesta }}
                        </div>
                        {% endif %}
                    </div>
                    {% elif msg.respuesta_tipo_mensaje == 'audio' and msg.respuesta_contenido_extra %}
                    <div class="audio-player">
                        <audio id="audio-bot-{{ loop.index }}" class="whatsapp-audio">
                            <source src="{{ msg.respuesta_contenido_extra }}" type="audio/mpeg">
                            <source src="{{ msg.respuesta_contenido_extra }}" type="audio/ogg">
                            Tu navegador no soporta el elemento de audio.
                        </audio>
                        <div class="audio-controls">
                            <button class="audio-play-btn" onclick="toggleAudio('audio-bot-{{ loop.index }}', this)">
                                ‚ñ∂Ô∏è
                            </button>
                            <div class="audio-progress" onclick="seekAudio('audio-bot-{{ loop.index }}', this, event)">
                                <div class="audio-progress-bar"></div>
                            </div>
                            <span class="audio-duration" id="duration-bot-{{ loop.index }}">0:00</span>
                            <a href="{{ msg.respuesta_contenido_extra }}" download="audio-respuesta.mp3" class="audio-download-btn" title="Descargar audio">
                                ‚¨áÔ∏è
                            </a>
                        </div>
                        {% if msg.respuesta %}
                        <div class="audio-transcription">
                            <strong>Respuesta:</strong> {{ msg.respuesta }}
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-message">
                        {{ msg.respuesta }}
                    </div>
                    {% endif %}

                </div>
                <div class="msg-meta">{{ msg.timestamp|format_time_24h }}</div>
            </div>
            {% endif %}
            {% endfor %}
            {% else %}
            <div class="no-chat-selected">
                <p>Selecciona un chat para ver mensajes.</p>
            </div>
            {% endif %}
        </div>

        {% if selected %}
        {% if not IA_ESTADOS.get(selected, {}).get('activa', True) %}
        <form method="POST" action="/send-manual" class="reply-form">
            <input type="hidden" name="numero" value="{{ selected }}">
            <div class="input-group">

                <!-- bot√≥n de emoji: a√±adir clase coherente con CSS y mantener el id -->
                <button type="button" id="emoji-pick-btn" class="emoji-pick-btn emoji-btn">üòä</button>

                <!-- Emoji Picker Container (hidden by default) -->
                <div id="emoji-picker-list" class="emoji-picker-list" style="display:none; position:absolute; z-index:1000; background:white; border:1px solid #ccc; border-radius:8px; padding:8px;">
                    <!-- Los emojis se llenan por JS -->
                </div>
                <input type="text" name="texto" id="mensaje-texto" placeholder="Escribe un mensaje manual..." class="reply-input-line" autocomplete="off" required />
                <button type="submit" class="send-btn">Enviar</button>
            </div>
        </form>
        {% else %}
        <div class="ia-active-message">
            <div class="ia-indicator">
                <span class="ia-icon">{{ 'ü§ñ' if IA_ESTADOS.get(selected, {}).get('activa', True) else 'üë§' }}</span>
                <span>{{ 'La IA est√° respondiendo autom√°ticamente' if IA_ESTADOS.get(selected, {}).get('activa', True) else 'Modo manual activado' }}</span>
            </div>
            <form action="/toggle_ai/{{ selected }}" method="POST">
                {% if IA_ESTADOS.get(selected, {}).get('activa', True) %}
                <button type="submit" class="toggle-btn off">Desactivar IA</button>
                {% else %}
                <button type="submit" class="toggle-btn on">Activar IA</button>
                {% endif %}
            </form>
        </div>
        {% endif %}
        {% endif %}
    </section>

    <aside class="sidebar-right" style="color: white;text-align: center;padding: inherit;border-top: blue;border-start-start-radius: revert-layer;">
        {% if selected %}
        <div class="sidebar-section">
            <h3>Acciones</h3>
            {% if is_admin %}
            <form action="/chats/{{ selected }}/eliminar" method="POST" onsubmit="return confirm('¬øEst√°s seguro de eliminar este chat? Se borrar√° todo el historial.');">
                <button type="submit" class="delete-btn">
                    üóëÔ∏è Eliminar Chat
                </button>
            </form>
            {% endif %}
        </div>

        <div class="sidebar-section">
            <h3>Informaci√≥n</h3>
            <div class="chat-info-stats">
                <div class="stat-item">
                    <span class="stat-label">Total mensajes:</span>
                    <span class="stat-value">{{ mensajes|length if mensajes else 0 }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">√öltima actividad:</span>
                    <span class="stat-value">
                        {% if mensajes and mensajes[-1].timestamp %}
                        {{ mensajes[-1].timestamp|format_time_24h }}
                        {% else %}
                        N/A
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
        {% endif %}
    </aside>
</div>

<button class="mobile-chat-toggle" onclick="toggleChatList()">üí¨</button>
<style>
    :root {
        --left-width: 340px;
        --right-width: 320px;
        --gap: 16px;
        --bg-card: #1f2937;
        --text-light: #ffffff;
    }

    /* Layout base */
    .chat-layout-v2 {
        display: flex;
        gap: var(--gap);
        align-items: stretch;
        height: calc(100vh - 120px); /* leave room for header/footer */
        padding: 12px;
        box-sizing: border-box;
    }

    .chat-list-v2 {
        width: var(--left-width);
        min-width: 220px;
        max-width: 420px;
        border-radius: 8px;
        background: var(--bg-card);
        padding: 8px;
        box-sizing: border-box;
        overflow-y: auto;
        transition: transform 240ms ease, box-shadow 200ms ease;
        position: relative;
        z-index: 30;
    }

    .chat-panel-v2 {
        flex: 1 1 auto;
        min-width: 0;
        display: flex;
        flex-direction: column;
        background: transparent;
        overflow: hidden;
    }

    .sidebar-right {
        width: var(--right-width);
        min-width: 220px;
        max-width: 420px;
        border-radius: 8px;
        background: var(--bg-card);
        padding: 8px;
        box-sizing: border-box;
        overflow-y: auto;
    }

    /* Chat items & messages */
    .chat-items {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .chat-item {
        display: block;
        color: inherit;
        text-decoration: none;
    }

    .card-content {
        padding: 8px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        color: var(--text-light);
    }

    .card-title-row {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .card-avatar-section {
        width: 44px;
        height: 44px;
        flex: 0 0 44px;
    }

    .card-avatar {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
    }

    .card-flag {
        width: 20px;
        height: 14px;
        object-fit: cover;
        border-radius: 2px;
    }

    .alias-view {
        font-weight: 600;
        font-size: 14px;
        color: var(--text-light);
        display: inline-block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 160px;
    }

    .card-time {
        margin-left: auto;
        font-size: 12px;
        opacity: 0.85;
        color: #d1d5db;
    }

    .card-msg {
        font-size: 13px;
        color: #d1d5db;
        opacity: 0.95;
    }

    /* Messages panel */
    .msgs-wrap-v2 {
        flex: 1 1 auto;
        overflow-y: auto;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
        border-radius: 8px;
    }

    .msg-box {
        max-width: 85%;
        padding: 8px;
        border-radius: 8px;
        box-sizing: border-box;
    }

    .msg-user {
        align-self: flex-end;
        background: #0b78d1;
        color: white;
    }

    .msg-ai {
        align-self: flex-start;
        background: #111827;
        color: #e5e7eb;
    }

    .msg-manual {
        align-self: end;
        background: #0ea5a4;
        color: white;
    }

    .msg-meta {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 6px;
    }

    /* Mobile toggle button */
    .mobile-chat-toggle {
        display: none;
        position: fixed;
        right: 18px;
        bottom: 18px;
        z-index: 1200;
        background: #0b78d1;
        color: white;
        border: none;
        padding: 10px 14px;
        border-radius: 999px;
        box-shadow: 0 6px 18px rgba(2,6,23,0.35);
        cursor: pointer;
        font-size: 18px;
    }

    /* New: mobile overlay behaviour for left panel */
    @media (max-width: 900px) {
        :root {
            --left-width: 320px;
            --right-width: 0px;
        }

        .chat-layout-v2 {
            gap: 8px;
            height: calc(100vh - 100px);
        }

        /* hide right sidebar on medium screens */
        .sidebar-right {
            display: none;
        }

        /* make list a fixed overlay off-canvas by default */
        .chat-list-v2 {
            position: fixed;
            left: 0;
            top: 64px;
            bottom: 0;
            width: min(86vw, 380px);
            transform: translateX(-110%);
            box-shadow: 0 10px 30px rgba(2,6,23,0.6);
            transition: transform 240ms ease;
            border-radius: 0 8px 8px 0;
            overflow-y: auto;
        }

            .chat-list-v2.mobile-visible {
                transform: translateX(0);
            }

        .chat-panel-v2 {
            margin-left: 0;
            padding-right: 8px;
        }

        .mobile-chat-toggle {
            display: block;
        }
    }

    /* Small phones: full screen single panel */
    @media (max-width: 480px) {
        .chat-layout-v2 {
            padding: 8px;
        }

        .chat-list-v2 {
            width: 92vw;
        }

        .alias-view {
            max-width: 120px;
            font-size: 13px;
        }

        .card-avatar-section {
            width: 40px;
            height: 40px;
        }

        .card-time {
            font-size: 11px;
        }

        .chat-panel-v2 {
            padding-left: 6px;
            padding-right: 6px;
        }

        .msgs-wrap-v2 {
            padding: 8px;
        }
    }

    /* Accessibility / minor aesthetics */
    .chat-item.selected {
        outline: 2px solid rgba(59,130,246,0.2);
    }

    .new-message {
        box-shadow: 0 6px 18px rgba(2,6,23,0.25);
        transform: translateY(-2px);
    }

    .emoji-picker-list {
        z-index: 1400 !important;
    }


    /* ===== ESTILOS COMPACTOS PARA CHATS (IGUAL QUE KANBAN) ===== */
    .chat-list-v2 .card-avatar {
        width: 24px !important;
        height: 24px !important;
        border-radius: 4px !important;
        margin-right: 0px !important;
        flex: 0 0 auto !important;
        object-fit: cover !important;
    }

    .chat-list-v2 .card-title-row {
        display: flex !important;
        align-items: center !important;
        gap: 6px !important;
        min-width: 0 !important;
        flex: 1 1 auto !important;
    }

        .chat-list-v2 .card-title-row .alias-view {
            font-size: 0.82rem !important;
            font-weight: 600 !important;
            line-height: 1 !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            max-width: calc(100% - 90px) !important;
        }

    .chat-list-v2 .card-meta-row {
        display: flex !important;
        align-items: center !important;
        gap: 6px !important;
        flex: 0 0 auto !important;
        margin-left: 6px !important;
    }

        .chat-list-v2 .card-meta-row span {
            font-size: 0.62rem !important;
            color: rgba(255,255,255,0.9) !important;
            line-height: 1 !important;
        }

    .chat-list-v2 .edit-alias-btn {
        font-size: 11px !important;
        padding: 1px 3px !important;
        margin-left: 6px !important;
    }

    .chat-list-v2 .card-msg {
        font-size: 0.75rem !important;
        color: #e2e5ed !important;
        display: -webkit-box !important;
        -webkit-line-clamp: 2 !important;
        -webkit-box-orient: vertical !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: normal !important;
        min-height: 1rem !important;
        font-weight: 400 !important;
        max-width: 70% !important;
        letter-spacing: 0.01rem !important;
        margin-top: 2px !important;
    }

    .chat-list-v2 .card-unread {
        position: absolute !important;
        top: 8px !important;
        right: 8px !important;
        background: #00E091 !important;
        color: #fff !important;
        border-radius: 10px !important;
        padding: 0.5px 8px !important;
        font-size: 0.89em !important;
        font-weight: 600 !important;
        min-width: 14px !important;
        text-align: center !important;
        box-shadow: 0 0 5px #00e09144 !important;
        z-index: 2 !important;
    }

    /* Estilos para el header del chat seleccionado */
    .chat-title {
        display: flex;
        align-items: center;
        gap: 6px;
    }

        .chat-title .alias-view {
            font-size: 1rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .chat-title .edit-alias-btn {
            font-size: 12px;
            padding: 2px 4px;
        }
</style>
<script>
/* Small helpers */
function coalesce(...args) {
    for (let i = 0; i < args.length; i++) {
        const v = args[i];
        if (v !== undefined && v !== null) return v;
    }
    return null;
}

function normalizeText(s) {
    if (!s) return '';
    return String(s).replace(/\s+/g, ' ').trim().toLowerCase();
}

function escapeHtml(unsafe) {
    if (unsafe === null || unsafe === undefined) return '';
    return String(unsafe)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
}

function truncate(str, n) {
    if (!str) return '';
    return str.length > n ? str.substring(0, n) + '...' : str;
}

function formatClientTime(serverTs) {
    let d = typeof serverTs === 'number' ? new Date(serverTs) : new Date(Number(serverTs) || serverTs);
    if (isNaN(d.getTime())) d = new Date();
    const day = d.getDate();
    const month = d.toLocaleString('es-MX', { month: 'short' });
    const time = d.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', hour12: false });
    return `${day}-${month} ${time}`;
}

// Funci√≥n para obtener bandera (igual que en kanban)
function getCountryFlag(numero) {
    if (!numero) return null;
    const prefijos = { '52': 'mx', '1': 'us', '54': 'ar', '57': 'co', '55': 'br', '34': 'es', '51': 'pe', '56': 'cl', '58': 've', '593': 'ec' };
    const numStr = numero.toString().replace('+', '');
    for (let i = 3; i > 0; i--) {
        const pref = numStr.substring(0, i);
        if (prefijos[pref]) return `https://flagcdn.com/24x18/${prefijos[pref]}.png`;
    }
    return null;
}

/* State */
let chatAutoRefresh = true;
let refreshIntervalMs = 500;
let messagePollIntervalMs = 1200;
let selectedChatId = {{ selected|tojson }};
let lastChatsTimestamp = 0;
let lastMessageTimestamp = {{ (mensajes[-1].timestamp.timestamp() * 1000) if mensajes else 0 }};
let isEditingAlias = false;
let aliasTimers = new Map();
let chatsIntervalHandle = null;
let messagesIntervalHandle = null;

/* Deduplication set (initialized from DOM on poll init) */
let seenMessageKeys = new Set();

/* ===================== CHAT-LIST ===================== */

function actualizarListaChats() {
    if (!chatAutoRefresh) return;
    fetch('/chats/data', { cache: 'no-store' })
        .then(r => r.json())
        .then(data => {
            if (!data || !data.chats) return;
            const ts = Number(data.timestamp) || Date.now();
            if (ts <= lastChatsTimestamp) return;
            lastChatsTimestamp = ts;
            actualizarIncrementalChats(data.chats);
        })
        .catch(err => console.error('Error actualizando lista de chats:', err));
}

const IS_ADMIN = {{ 'true' if is_admin else 'false' }};

function crearNuevoChatHTML(chat) {
        const num = String(coalesce(chat.numero, chat.number, chat.id || ''));
        const nombre = escapeHtml(coalesce(chat.nombre_mostrado, chat.alias, chat.nombre, num));

        // === ICONOS CORRECTOS (WhatsApp/Telegram) ===
        let imagen = '/static/icons/whatsapp-icon.png';
        if (num.startsWith('tg_') || chat.canal === 'Telegram') {
            imagen = '/static/icons/telegram-icon-dos.png';
        }
        // === FIN ICONOS ===
    const banderaUrl = getCountryFlag(num) || '';
    const ultima = coalesce(chat.ultima_fecha, chat.last_activity, '');
    const sin_leer = Number(coalesce(chat.sin_leer, chat.unread, 0));
    const tipo_mensaje = coalesce(chat.tipo_mensaje, chat.last_type, '');
    const ultimo = escapeHtml(coalesce(chat.ultimo_mensaje, chat.last_message, ''));
    const preview = tipo_mensaje === 'imagen' ? 'üì∑ Imagen' : (ultimo ? truncate(ultimo, 35) : '&nbsp;');
    const selectedClass = (selectedChatId && String(selectedChatId) === String(num)) ? 'selected' : '';

    return `
    <a href="/chats/${num}" class="chat-item kanban-card ${selectedClass}" data-chat-num="${num}" style="text-decoration:none;color:inherit;display:block;">
        <div class="card-content">
            <div class="card-title-row">
                <div class="card-avatar-section">
                    <img src="${imagen}" class="card-avatar" alt="Avatar" onerror="this.onerror=null;this.src='/static/icons/default-avatar.png';">
                </div>
                ${banderaUrl ? `<img src="${banderaUrl}" class="card-flag" alt="Pa√≠s" title="Pa√≠s">` : ''}
                <span class="alias-view" data-num="${num}">${nombre}</span>
                <span class="card-time">${ultima ? formatClientTime(ultima) : ''}</span>
                <span class="alias-edit" style="display:none;">
                    <input type="text" value="${escapeHtml(coalesce(chat.alias, chat.nombre, num))}" data-num="${num}" maxlength="100" style="width:110px;">
                </span>
                ${IS_ADMIN ? `<button type="button" class="edit-alias-btn" data-num="${num}" title="Editar nombre">‚úèÔ∏è</button>` : ''}
            </div>
            <div class="card-meta-row">
                ${sin_leer > 0 ? `<span class="card-unread">${sin_leer}</span>` : ''}
            </div>
            <div class="card-msg">${preview}</div>
        </div>
    </a>`.trim();
}

function actualizarIncrementalChats(chats) {
    const container = document.querySelector('.chat-items');
    if (!container) return;
    const existing = new Map();
    container.querySelectorAll('.chat-item').forEach(node => existing.set(node.dataset.chatNum, node));

    for (let i = chats.length - 1; i >= 0; i--) {
        const chat = chats[i];
        const num = chat.numero;
        const node = existing.get(num);
        if (node) {
            actualizarChatExistente(node, chat);
            existing.delete(num);
            if (container.firstElementChild && container.firstElementChild.dataset.chatNum !== num) {
                container.insertBefore(node, container.firstElementChild);
            }
        } else {
            const tmp = document.createElement('div');
            const hasBuilder = typeof crearNuevoChatHTML === 'function';
            tmp.innerHTML = hasBuilder
                ? crearNuevoChatHTML(chat)
                : `
            <a href="/chats/${chat.numero}" class="chat-item" data-chat-num="${chat.numero}">
                <div class="card-content">
                    <div class="card-title-row">
                        <div class="card-avatar-section">
                            <img src="${chat.imagen_url || '/static/icons/default-avatar.png'}" class="card-avatar" alt="Avatar">
                        </div>
                        <span class="alias-view">${chat.nombre_mostrado||chat.numero}</span>
                    </div>
                    <div class="card-meta-row">
                        <span class="card-time">${chat.ultima_fecha||''}</span>
                        ${(chat.sin_leer||0)>0?`<span class="card-unread">${chat.sin_leer}</span>`:''}
                    </div>
                    <div class="card-msg">${chat.ultimo_mensaje||''}</div>
                </div>
            </a>`;
            const newNode = tmp.firstElementChild;
            container.insertBefore(newNode, container.firstElementChild);
        }
    }
    for (const [num, node] of existing) {
        if (node) node.remove();
    }
}

function actualizarChatExistente(node, chat) {
    const num = chat.numero;
    const nombre = escapeHtml(coalesce(chat.nombre_mostrado, chat.alias, chat.nombre, num));
    const ultima = coalesce(chat.ultima_fecha, chat.last_activity, '');
    const sin_leer = Number(coalesce(chat.sin_leer, chat.unread, 0));
    const tipo_mensaje = coalesce(chat.tipo_mensaje, chat.last_type, '');
    const ultimo = escapeHtml(coalesce(chat.ultimo_mensaje, chat.last_message, ''));
    const preview = tipo_mensaje === 'imagen' ? 'üì∑ Imagen' : (ultimo ? truncate(ultimo, 35) : '&nbsp;');

    // Update alias view
    const aliasView = node.querySelector('.alias-view');
    if (aliasView && aliasView.textContent !== nombre) aliasView.textContent = nombre;

    // Update time
    const timeNode = node.querySelector('.card-time');
    if (timeNode) timeNode.textContent = ultima ? formatClientTime(ultima) : '';

    // Update unread
    const unreadNode = node.querySelector('.card-unread');
    if (sin_leer > 0) {
        if (!unreadNode) {
            const metaRow = node.querySelector('.card-meta-row');
            if (metaRow) {
                const span = document.createElement('span');
                span.className = 'card-unread';
                span.textContent = sin_leer;
                metaRow.appendChild(span);
            }
        } else {
            unreadNode.textContent = sin_leer;
        }
    } else if (unreadNode) {
        unreadNode.remove();
    }

    // Update message preview
    const msgNode = node.querySelector('.card-msg');
    if (msgNode) msgNode.innerHTML = preview;

    // Update selected class
    if (selectedChatId && String(selectedChatId) === String(num)) {
        node.classList.add('selected');
    } else {
        node.classList.remove('selected');
    }
}

/* ===================== MESSAGES ===================== */

function actualizarMensajes() {
    if (!selectedChatId || !chatAutoRefresh) return;
    fetch(`/chats/${selectedChatId}/mensajes/data?since=${lastMessageTimestamp}`, { cache: 'no-store' })
        .then(r => r.json())
        .then(data => {
            if (!data || !data.messages) return;
            const ts = Number(data.timestamp) || Date.now();
            if (ts <= lastMessageTimestamp) return;
            lastMessageTimestamp = ts;
            actualizarIncrementalMensajes(data.messages);
        })
        .catch(err => console.error('Error actualizando mensajes:', err));
}

function actualizarIncrementalMensajes(messages) {
    const container = document.getElementById('msgs');
    if (!container) return;
    const existing = new Map();
    container.querySelectorAll('.msg-box').forEach(node => {
        const id = node.dataset.msgId;
        if (id) existing.set(id, node);
    });

    for (const msg of messages) {
        const id = msg.id;
        if (seenMessageKeys.has(id)) continue;
        seenMessageKeys.add(id);
        if (existing.has(id)) continue;

        const tmp = document.createElement('div');
        const html = crearMensajeHTML(msg);
        tmp.innerHTML = html;
        const newNode = tmp.firstElementChild;
        container.appendChild(newNode);
    }
    container.scrollTop = container.scrollHeight;
}

function crearMensajeHTML(msg) {
    const isUser = msg.direccion === 'in';
    const isManual = msg.mensaje === '[Mensaje manual desde web]' && msg.respuesta;
    const isAI = !isUser && msg.respuesta && msg.respuesta !== '[Respuesta vac√≠a]' && msg.mensaje !== '[Mensaje manual desde web]';
    const timestamp = msg.timestamp ? formatClientTime(msg.timestamp) : '';
    let content = '';

    if (isManual) {
        content = `
        <div class="manual-indicator">üì§ Mensaje enviado:</div>
        <div class="text-message">${escapeHtml(msg.respuesta)}</div>`;
    } else if (isAI) {
        if (msg.respuesta_tipo_mensaje === 'imagen' && msg.respuesta_contenido_extra) {
            content = `
            <div class="image-message">
                <img src="${msg.respuesta_contenido_extra}" alt="Imagen IA" class="whatsapp-image">
                ${msg.respuesta && msg.respuesta !== 'Analiza esta imagen' && msg.respuesta !== 'El usuario envi√≥ una imagen' ? `<div class="image-caption">${escapeHtml(msg.respuesta)}</div>` : ''}
            </div>`;
        } else if (msg.respuesta_tipo_mensaje === 'audio' && msg.respuesta_contenido_extra) {
            content = `
            <div class="audio-player">
                <audio id="audio-new-${Date.now()}" class="whatsapp-audio">
                    <source src="${msg.respuesta_contenido_extra}" type="audio/mpeg">
                    <source src="${msg.respuesta_contenido_extra}" type="audio/ogg">
                </audio>
                <div class="audio-controls">
                    <button class="audio-play-btn" onclick="toggleAudio('audio-new-${Date.now()}', this)">‚ñ∂Ô∏è</button>
                    <div class="audio-progress" onclick="seekAudio('audio-new-${Date.now()}', this, event)"><div class="audio-progress-bar"></div></div>
                    <span class="audio-duration" id="duration-new-${Date.now()}">0:00</span>
                    <a href="${msg.respuesta_contenido_extra}" download="audio-respuesta.mp3" class="audio-download-btn">‚¨áÔ∏è</a>
                </div>
                ${msg.respuesta ? `<div class="audio-transcription"><strong>Respuesta:</strong> ${escapeHtml(msg.respuesta)}</div>` : ''}
            </div>`;
        } else {
            content = `<div class="text-message">${escapeHtml(msg.respuesta)}</div>`;
        }
    } else {
        if (msg.es_imagen && msg.imagen_url) {
            content = `
            <div class="image-message">
                <img src="${msg.imagen_url}" alt="Imagen" class="whatsapp-image">
                ${msg.mensaje && msg.mensaje !== 'Analiza esta imagen' ? `<div class="image-caption">${escapeHtml(msg.mensaje)}</div>` : ''}
            </div>`;
        } else if (msg.tipo_mensaje === 'audio' && msg.contenido_extra) {
            content = `
            <div class="audio-player">
                <audio id="audio-new-${Date.now()}" class="whatsapp-audio">
                    <source src="${msg.contenido_extra}" type="audio/ogg">
                    <source src="${msg.contenido_extra}" type="audio/mpeg">
                </audio>
                <div class="audio-controls">
                    <button class="audio-play-btn" onclick="toggleAudio('audio-new-${Date.now()}', this)">‚ñ∂Ô∏è</button>
                    <div class="audio-progress" onclick="seekAudio('audio-new-${Date.now()}', this, event)"><div class="audio-progress-bar"></div></div>
                    <span class="audio-duration" id="duration-new-${Date.now()}">0:00</span>
                    <a href="${msg.contenido_extra}" download="audio-mensaje.ogg" class="audio-download-btn">‚¨áÔ∏è</a>
                </div>
                ${msg.transcripcion_audio ? `<div class="audio-transcription"><strong>Transcripci√≥n:</strong> ${escapeHtml(msg.transcripcion_audio)}</div>` : (msg.mensaje && msg.mensaje !== '[Mensaje manual desde web]' ? `<div class="audio-transcription"><strong>Mensaje:</strong> ${escapeHtml(msg.mensaje)}</div>` : '')}
            </div>`;
        } else {
            content = `<div class="text-message">${escapeHtml(msg.mensaje)}</div>`;
        }
    }

    const msgClass = isManual ? 'msg-manual' : (isAI ? 'msg-ai' : 'msg-user');
    return `
    <div class="msg-box ${msgClass}" data-msg-id="${msg.id || ''}">
        <div class="message-content">${content}</div>
        <div class="msg-meta">${timestamp}</div>
    </div>`.trim();
}

/* ===================== ALIAS EDIT ===================== */

function setupAliasEdit() {
    document.addEventListener('click', e => {
        const btn = e.target.closest('.edit-alias-btn');
        if (!btn) return;
        e.preventDefault();
        const num = btn.dataset.num;
        if (!num) return;
        toggleAliasEdit(num);
    });

    document.addEventListener('input', e => {
        const input = e.target;
        if (!input.matches('.alias-edit input')) return;
        const num = input.dataset.num;
        if (!num) return;
        if (aliasTimers.has(num)) clearTimeout(aliasTimers.get(num));
        aliasTimers.set(num, setTimeout(() => guardarAlias(num, input.value), 800));
    });

    document.addEventListener('keydown', e => {
        const input = e.target;
        if (!input.matches('.alias-edit input')) return;
        if (e.key === 'Enter') {
            e.preventDefault();
            const num = input.dataset.num;
            if (!num) return;
            guardarAlias(num, input.value);
            toggleAliasEdit(num, false);
        } else if (e.key === 'Escape') {
            e.preventDefault();
            const num = input.dataset.num;
            if (!num) return;
            toggleAliasEdit(num, false);
        }
    });

    document.addEventListener('focusout', e => {
        const input = e.target;
        if (!input.matches('.alias-edit input')) return;
        const num = input.dataset.num;
        if (!num) return;
        setTimeout(() => {
            if (!document.activeElement || document.activeElement !== input) {
                guardarAlias(num, input.value);
                toggleAliasEdit(num, false);
            }
        }, 200);
    });
}

function toggleAliasEdit(num, forceState = null) {
    if (isEditingAlias && isEditingAlias !== num) {
        toggleAliasEdit(isEditingAlias, false);
    }
    const container = document.querySelector(`[data-chat-num="${num}"]`);
    const headerContainer = document.querySelector(`.chat-panel-header[data-num="${num}"]`);
    if (!container && !headerContainer) return;

    const view = container?.querySelector('.alias-view');
    const edit = container?.querySelector('.alias-edit');
    const input = container?.querySelector('.alias-edit input');
    const headerView = headerContainer?.querySelector('.alias-view');
    const headerEdit = headerContainer?.querySelector('.alias-edit');
    const headerInput = headerContainer?.querySelector('.alias-edit input');

    const newState = forceState !== null ? forceState : (view?.style.display !== 'none');
    if (newState) {
        isEditingAlias = num;
        if (view) view.style.display = 'none';
        if (edit) edit.style.display = 'inline';
        if (input) { input.focus(); input.select(); }
        if (headerView) headerView.style.display = 'none';
        if (headerEdit) headerEdit.style.display = 'inline';
        if (headerInput) { headerInput.focus(); headerInput.select(); }
    } else {
        isEditingAlias = false;
        if (view) view.style.display = 'inline';
        if (edit) edit.style.display = 'none';
        if (headerView) headerView.style.display = 'inline';
        if (headerEdit) headerEdit.style.display = 'none';
    }
}

function guardarAlias(num, nuevoAlias) {
    if (!num) return;
    const payload = { alias: nuevoAlias.trim() || null };
    fetch(`/chats/${num}/alias`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const view = document.querySelector(`[data-chat-num="${num}"] .alias-view`);
            const headerView = document.querySelector(`.chat-panel-header[data-num="${num}"] .alias-view`);
            if (view) view.textContent = data.nombre_mostrado || num;
            if (headerView) headerView.textContent = data.nombre_mostrado || num;
        } else {
            console.error('Error guardando alias:', data.error);
        }
    })
    .catch(err => console.error('Error guardando alias:', err));
}

/* ===================== EMOJI PICKER ===================== */

function setupEmojiPicker() {
    const btn = document.getElementById('emoji-pick-btn');
    const picker = document.getElementById('emoji-picker-list');
    const input = document.getElementById('mensaje-texto');
    if (!btn || !picker || !input) return;

    const emojis = ['üòÄ','üòÇ','üòç','ü§î','üòé','üò¢','üò°','üëç','üëé','‚ù§Ô∏è','üî•','üéâ','ü§ñ','‚≠ê','üíØ','üëã','üôè','‚úåÔ∏è','ü§ù','üí™','üëÄ','üëÅÔ∏è','üß†','üíî','üí•','üí´','üí¶','üí®','üê∂','üê±','ü¶Å','üêØ','ü¶í','ü¶ä','üêª','üêº','üê®','üêµ','ü¶Ñ','ü¶ì','üê¥','ü¶å','üêÆ','üê∑','üê≠','üêπ','üê∞','üêª','üêî','üêß','üê¶','üê§','ü¶Ü','ü¶Ö','ü¶â','ü¶á','üê∫','üêó','üêù','üêõ','ü¶ã','üêå','üêû','üêú','ü¶ó','üï∑Ô∏è','ü¶Ç','üê¢','üêç','ü¶é','ü¶ñ','ü¶ï','üêô','ü¶ë','ü¶ê','ü¶û','ü¶Ä','üê°','üê†','üêü','üê¨','üê≥','üêã','ü¶à','üêä','üêÖ','üêÜ','ü¶ì','ü¶ç','ü¶ß','üêò','ü¶õ','ü¶è','üê™','üê´','ü¶í','ü¶ò','üêÉ','üêÇ','üêÑ','üêé','üêñ','üêè','üêë','üêê','ü¶ô','üêï','üê©','üêà','üêì','ü¶É','ü¶ö','ü¶ú','ü¶¢','ü¶©','üêá','ü¶ù','ü¶®','ü¶°','ü¶¶','ü¶•','üêÅ','üêÄ','üêøÔ∏è','ü¶î','üåµ','üéÑ','üå≤','üå≥','üå¥','üå±','üåø','‚òòÔ∏è','üçÄ','üéç','üéã','üçÉ','üçÇ','üçÅ','üçÑ','üêö','üåæ','üíê','üå∑','üåπ','ü•Ä','üå∫','üå∏','üåº','üåª','üåû','üåù','üåõ','üåú','üåö','üåï','üåñ','üåó','üåò','üåë','üåí','üåì','üåî','üåô','üåé','üåç','üåè','ü™ê','üí´','‚≠ê','üåü','‚ú®','‚ö°','‚òÑÔ∏è','üí•','üî•','üåà','‚òÄÔ∏è','üå§Ô∏è','‚õÖ','üå•Ô∏è','‚òÅÔ∏è','üå¶Ô∏è','üåßÔ∏è','‚õàÔ∏è','üå©Ô∏è','üå®Ô∏è','‚ùÑÔ∏è','‚òÉÔ∏è','‚õÑ','üí®','üíß','üí¶','‚òî','‚òÇÔ∏è','üåä','üéÇ','üç∞','üßÅ','ü•ß','üç¶','üç®','üç©','üç™','üéÇ','üç´','üç¨','üç≠','üçÆ','üçØ','üçº','ü•õ','‚òï','üçµ','üßÉ','ü•§','üç∂','üç∫','üçª','ü•Ç','üç∑','ü•É','üç∏','üçπ','üßâ','üçæ','üßä','ü•Ñ','üç¥','üçΩÔ∏è','ü•£','ü•°','ü•¢','üßÇ','‚öΩ','üèÄ','üèà','‚öæ','ü•é','üéæ','üèê','üèâ','ü•è','üé±','ü™Ä','üèì','üè∏','üèí','üèë','ü•ç','üèè','üéø','‚õ∑Ô∏è','üèÇ','ü™Ç','üèãÔ∏è','ü§º','ü§∏','‚õπÔ∏è','ü§æ','üö¥','üèá','üßò','üèÑ','üèä','ü§Ω','üö£','üßó','üöµ','üéØ','üéÆ','üé≤','üé∞','üé≥'];

    picker.innerHTML = emojis.map(e => `<span class="emoji-option">${e}</span>`).join('');
    picker.querySelectorAll('.emoji-option').forEach(span => {
        span.addEventListener('click', () => {
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            input.value = text.substring(0, start) + span.textContent + text.substring(end);
            input.focus();
            input.selectionStart = input.selectionEnd = start + span.textContent.length;
            picker.style.display = 'none';
        });
    });

    btn.addEventListener('click', () => {
        picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
    });

    document.addEventListener('click', e => {
        if (!picker.contains(e.target) && e.target !== btn) {
            picker.style.display = 'none';
        }
    });
}

/* ===================== AUDIO PLAYER ===================== */

function toggleAudio(audioId, btn) {
    const audio = document.getElementById(audioId);
    if (!audio) return;
    const progressBar = btn.closest('.audio-controls').querySelector('.audio-progress-bar');
    const durationSpan = btn.closest('.audio-controls').querySelector('.audio-duration');

    if (audio.paused) {
        audio.play().then(() => {
            btn.textContent = '‚è∏Ô∏è';
            updateAudioProgress(audio, progressBar, durationSpan);
        }).catch(err => console.error('Error playing audio:', err));
    } else {
        audio.pause();
        btn.textContent = '‚ñ∂Ô∏è';
    }
}

function updateAudioProgress(audio, progressBar, durationSpan) {
    if (!audio.duration) {
        setTimeout(() => updateAudioProgress(audio, progressBar, durationSpan), 100);
        return;
    }
    const update = () => {
        if (audio.paused) return;
        const percent = (audio.currentTime / audio.duration) * 100;
        progressBar.style.width = percent + '%';
        durationSpan.textContent = formatTime(audio.currentTime) + ' / ' + formatTime(audio.duration);
        requestAnimationFrame(update);
    };
    update();
}

function seekAudio(audioId, progressBar, event) {
    const audio = document.getElementById(audioId);
    if (!audio || !audio.duration) return;
    const rect = progressBar.getBoundingClientRect();
    const percent = (event.clientX - rect.left) / rect.width;
    audio.currentTime = percent * audio.duration;
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
}

/* ===================== MOBILE CHAT LIST TOGGLE ===================== */

function toggleChatList() {
    const list = document.querySelector('.chat-list-v2');
    if (list) list.classList.toggle('mobile-visible');
}

/* ===================== INIT ===================== */

document.addEventListener('DOMContentLoaded', () => {
    setupAliasEdit();
    setupEmojiPicker();

    // Initialize seen messages from DOM
    document.querySelectorAll('.msg-box[data-msg-id]').forEach(node => {
        const id = node.dataset.msgId;
        if (id) seenMessageKeys.add(id);
    });

    // Start polling
    chatsIntervalHandle = setInterval(actualizarListaChats, refreshIntervalMs);
    if (selectedChatId) {
        messagesIntervalHandle = setInterval(actualizarMensajes, messagePollIntervalMs);
    }

    // Auto-scroll messages to bottom
    const msgsWrap = document.getElementById('msgs');
    if (msgsWrap) msgsWrap.scrollTop = msgsWrap.scrollHeight;
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (chatsIntervalHandle) clearInterval(chatsIntervalHandle);
    if (messagesIntervalHandle) clearInterval(messagesIntervalHandle);
});
</script>
{% endblock %} 