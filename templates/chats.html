{% extends "base.html" %}
{% block title %}Conversaciones{% endblock %}

{% block content %}
{% set es_porfirianna = tenant_config.dominio == 'laporfirianna.mektia.com' %}
{% set negocio_nombre = 'La Porfirianna' if es_porfirianna else 'Mektia' %}

<div class="chat-list-header">
  <h2>Conversaciones - {{ negocio_nombre }}</h2>
  <span class="tenant-badge {% if es_porfirianna %}porfirianna-badge{% else %}mektia-badge{% endif %}">
    {{ negocio_nombre }}
  </span>
  <span style="font-size: 12px; color: #666; margin-left: 15px;">
    (Base de datos: {{ tenant_config.db_name }})
  </span>
</div>

<div class="chat-layout-v2">
  <!-- Lado izquierdo: Lista -->
  <aside class="chat-list-v2">
    <div class="chat-list-tools">
      <button class="add-contact-btn">+ Agregar Contacto</button>
      <input type="text" placeholder="Buscar chats..." class="search-input">
    </div>

    <div class="chat-items">
      {% for chat in chats %}
      <a href="/chats/{{ chat.numero }}" class="chat-item {% if selected == chat.numero %}selected{% endif %}">
        <div class="chat-avatar">
          <img 
            src="{{ chat.imagen_url or url_for('static', filename='icons/default-avatar.png') }}" 
            alt="Avatar"
            onerror="this.onerror=null;this.src='{{ url_for('static', filename='icons/default-avatar.png') }}';"
            width="40" height="40">
        </div>
        <div class="chat-info">
          <div class="chat-name" data-num="{{ chat.numero }}">
            <span class="alias-view">
              {{ chat.nombre_mostrado }}
            </span>
            {% if chat.alias or chat.nombre %}
              <div class="chat-num" style="font-size:11px;color:#888;">
                {{ chat.numero }}
              </div>
            {% endif %}
          </div>
          <div class="chat-preview">
            {% if chat.ultimo_mensaje %}
              {{ chat.ultimo_mensaje[:35] }}{% if chat.ultimo_mensaje|length > 35 %}...{% endif %}
            {% else %}
              Sin mensajes
            {% endif %}
          </div>
        </div>
        <div class="chat-meta">
          {% if chat.ultima_fecha %}
            <div class="chat-date">{{ chat.ultima_fecha.strftime("%d/%m") }}</div>
            <div class="chat-time">{{ chat.ultima_fecha.strftime("%H:%M") }}</div>
          {% endif %}
        </div>
      </a>
      {% endfor %}
    </div>
  </aside>

  <!-- Centro: Mensajes -->
  <section class="chat-panel-v2">
    {% if selected %}
    <div class="chat-panel-header" data-num="{{ selected }}">
      <div class="chat-header-info">
        <div class="chat-title">
          <span class="alias-view">
            {{ (chats | selectattr("numero", "equalto", selected) | first).nombre_mostrado if (chats | selectattr("numero", "equalto", selected) | first) else selected }}
          </span>
          <button type="button" class="edit-alias-btn" data-num="{{ selected }}" title="Editar nombre">
            ‚úèÔ∏è
          </button>
        </div>
        <span class="chat-number">{{ selected }}</span>
      </div>
      
      <div class="chat-controls">
        <span class="badge {% if IA_ESTADOS.get(selected, True) %}bg-success{% else %}bg-warning{% endif %}">
            {% if IA_ESTADOS.get(selected, True) %}
                ü§ñ IA ACTIVADA
            {% else %}
                üë§ MODO MANUAL
            {% endif %}
        </span>
        
        <form action="/toggle_ai/{{ selected }}" method="POST">
          <button type="submit" class="toggle-btn {{ 'on' if IA_ESTADOS.get(selected, True) else 'off' }}">
            IA {{ 'ON' if IA_ESTADOS.get(selected, True) else 'OFF' }}
          </button>
        </form>
      </div>
    </div>
    {% else %}
    <div class="chat-panel-header">
      <span>Selecciona un chat</span>
    </div>
    {% endif %}
    
    <div class="msgs-wrap-v2" id="msgs">
      {% if mensajes %}
        {% for msg in mensajes %}
          <!-- Mensaje del usuario -->
          {% if msg.mensaje and msg.mensaje != '[Mensaje manual desde web]' %}
            <div class="msg-box msg-user">
              <div class="message-content">
                {% if msg.es_imagen and msg.imagen_url %}
                  <div class="image-message">
                    <img src="{{ msg.imagen_url }}" alt="Imagen" class="whatsapp-image">
                    {% if msg.mensaje and msg.mensaje != 'Analiza esta imagen' %}
                      <div class="image-caption">{{ msg.mensaje }}</div>
                    {% endif %}
                  </div>
                {% else %}
                  <div class="text-message">{{ msg.mensaje }}</div>
                {% endif %}
              </div>
              <div class="msg-meta">{{ msg.timestamp.strftime('%H:%M') }}</div>
            </div>
          {% endif %}

          <!-- Respuesta de la IA -->
          {% if msg.respuesta and msg.respuesta != '[Respuesta vac√≠a]' and msg.mensaje != '[Mensaje manual desde web]' %}
            <div class="msg-box msg-ai">
              <div class="message-content">
                <div class="text-message">{{ msg.respuesta }}</div>
              </div>
              <div class="msg-meta">{{ msg.timestamp.strftime('%H:%M') }}</div>
            </div>
          {% endif %}

          <!-- Mensaje manual desde web -->
          {% if msg.mensaje and msg.mensaje == '[Mensaje manual desde web]' and msg.respuesta %}
            <div class="msg-box msg-manual">
              <div class="message-content">
                <div class="manual-indicator">üì§ Mensaje enviado:</div>
                <div class="text-message">{{ msg.respuesta }}</div>
              </div>
              <div class="msg-meta">{{ msg.timestamp.strftime('%H:%M') }}</div>
            </div>
          {% endif %}
        {% endfor %}
      {% else %}
        <div class="no-chat-selected">
          <p>Selecciona un chat para ver mensajes.</p>
        </div>
      {% endif %}
    </div>

    {% if selected %}
      {% if not IA_ESTADOS.get(selected, True) %}
        <form method="POST" action="/send-manual" class="reply-form">
          <input type="hidden" name="numero" value="{{ selected }}">
          <div class="input-group">
            <input type="text" name="texto" placeholder="Escribe un mensaje manual..." required>
            <button type="submit" class="send-btn">Enviar</button>
          </div>
        </form>
      {% else %}
        <div class="ia-active-message">
          <div class="ia-indicator">
            <span class="ia-icon">ü§ñ</span>
            <span>La IA est√° respondiendo autom√°ticamente</span>
          </div>
          <form action="/toggle_ai/{{ selected }}" method="POST">
            <button type="submit" class="toggle-btn off">Desactivar IA</button>
          </form>
        </div>
      {% endif %}
    {% endif %}
  </section>

  <!-- Lado derecho - Info del chat -->
  <aside class="sidebar-right">
    {% if selected %}
      <div class="sidebar-section">
        <h3>Acciones</h3>
        <form action="/chats/{{ selected }}/eliminar" method="POST" onsubmit="return confirm('¬øEst√°s seguro de eliminar este chat? Se borrar√° todo el historial.');">
          <button type="submit" class="delete-btn">üóëÔ∏è Eliminar Chat</button>
        </form>
      </div>
      
      <div class="sidebar-section">
        <h3>Informaci√≥n</h3>
        <div class="chat-info-stats">
          <div class="stat-item">
            <span class="stat-label">Total mensajes:</span>
            <span class="stat-value">{{ mensajes|length if mensajes else 0 }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">√öltima actividad:</span>
            <span class="stat-value">
              {% if mensajes and mensajes[-1].timestamp %}
                {{ mensajes[-1].timestamp.strftime('%d/%m/%Y %H:%M') }}
              {% else %}
                N/A
              {% endif %}
            </span>
          </div>
        </div>
      </div>
    {% endif %}
  </aside>
</div>

<!-- Mover todo el CSS a un archivo externo ser√≠a lo ideal -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/chats.css') }}">

<script>
// JavaScript simplificado - el resto deber√≠a ir en archivo externo
document.addEventListener('DOMContentLoaded', function() {
  // Scroll al final de los mensajes
  const msgsContainer = document.getElementById('msgs');
  if (msgsContainer) {
    msgsContainer.scrollTop = msgsContainer.scrollHeight;
  }

  // Manejo de edici√≥n de alias
  document.querySelectorAll('.edit-alias-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const numero = this.dataset.num;
      const nuevoAlias = prompt('Ingresa el nuevo alias:', '');
      if (nuevoAlias !== null) {
        fetch(`/contactos/${numero}/alias`, {
          method: 'POST',
          body: new URLSearchParams({alias: nuevoAlias}),
          headers: {'Content-Type': 'application/x-www-form-urlencoded'}
        }).then(() => {
          location.reload(); // Recargar para ver cambios
        });
      }
    });
  });
});
</script>
{% endblock %}