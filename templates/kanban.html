<script>
// ‚Äî‚Äî‚Äî AUTO-ACTUALIZACI√ìN DEL KANBAN CADA 5 SEGUNDOS ‚Äî‚Äî‚Äî
document.addEventListener('DOMContentLoaded', function() {
    let kanbanAutoRefresh = true;
    let refreshInterval = 5000; // 5 segundos
    
    console.log('üîÑ Iniciando auto-actualizaci√≥n del Kanban cada 5 segundos');
    
    // Funci√≥n para actualizar el Kanban
    function actualizarKanban() {
        if (!kanbanAutoRefresh) return;
        
        fetch('/kanban/data')
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }
            return response.json();
        })
        .then(data => {
            // Actualizar toda la interfaz del Kanban
            actualizarInterfazCompleta(data);
            console.log('‚úÖ Kanban actualizado:', new Date().toLocaleTimeString());
        })
        .catch(error => {
            console.error('‚ùå Error actualizando Kanban:', error);
        });
    }
    
    // Funci√≥n para actualizar toda la interfaz
    function actualizarInterfazCompleta(data) {
        const kanbanBoard = document.getElementById('kanban-board');
        if (!kanbanBoard) return;
        
        // Reconstruir todo el Kanban con los nuevos datos
        let nuevoHTML = '';
        
        data.columnas.forEach(col => {
            nuevoHTML += `
            <div class="kanban-column" data-col-id="${col.id}">
                <div class="column-header">
                    <img src="${col.icono}" class="col-icon" alt="">
                    <h3 contenteditable="true" data-col-id="${col.id}" class="col-name">${col.nombre}</h3>
                    <button class="add-chat-btn" title="Agregar aqu√≠">+</button>
                </div>
                <div class="column-list">`;
            
            data.chats.filter(chat => chat.columna_id == col.id).forEach(chat => {
                const bandera = getCountryFlag(chat.numero);
                nuevoHTML += `
                <a href="/chats/${chat.numero}" class="kanban-card kanban-chat-link" data-chat-num="${chat.numero}" style="text-decoration: none; color: inherit; display: block;">
                    <div class="card-avatar-section">
                        <img src="${chat.avatar || '/static/icons/default-avatar.png'}" 
                             class="card-avatar" alt="Avatar"
                             onerror="this.onerror=null;this.src='/static/icons/default-avatar.png';">
                    </div>
                    <div class="card-content">
                        <div class="card-title-row">
                            ${bandera ? `<img src="${bandera}" class="card-flag" alt="Pa√≠s" title="Pa√≠s">` : ''}
                            <span class="alias-view" data-num="${chat.numero}">
                                ${chat.nombre_mostrado}
                            </span>
                        </div>
                        <div class="card-meta-row">
                            <span class="card-num">${chat.numero}</span>
                            <span class="card-time">
                                ${chat.ultima_fecha ? new Date(chat.ultima_fecha).toLocaleString() : ''}
                            </span>
                        </div>
                        <div class="card-msg">${chat.ultimo_mensaje || '&nbsp;'}</div>
                    </div>
                    ${chat.sin_leer > 0 ? `<span class="card-unread">${chat.sin_leer}</span>` : ''}
                </a>`;
            });
            
            nuevoHTML += `</div></div>`;
        });
        
        kanbanBoard.innerHTML = nuevoHTML;
        
        // Reinicializar Sortable.js despu√©s de actualizar
        inicializarSortable();
    }
    
    // Funci√≥n auxiliar para banderas (simplificada)
    function getCountryFlag(numero) {
        if (!numero) return null;
        const prefijos = {
            '52': 'mx', '1': 'us', '54': 'ar', '57': 'co', '55': 'br',
            '34': 'es', '51': 'pe', '56': 'cl', '58': 've', '593': 'ec'
        };
        
        const numStr = numero.toString().replace('+', '');
        for (let i = 3; i > 0; i--) {
            const prefijo = numStr.substring(0, i);
            if (prefijos[prefijo]) {
                return `https://flagcdn.com/24x18/${prefijos[prefijo]}.png`;
            }
        }
        return null;
    }
    
    // Inicializar Sortable.js
    function inicializarSortable() {
        document.querySelectorAll('.column-list').forEach(list => {
            new Sortable(list, {
                group: 'kanban',
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: evt => {
                    const numero = evt.item.dataset.chatNum;
                    const nuevaCol = evt.to.closest('.kanban-column').dataset.colId;
                    fetch('/kanban/mover', {
                        method: 'POST',
                        headers: { 'Content-Type':'application/json' },
                        body: JSON.stringify({ numero, columna_id: nuevaCol })
                    });
                }
            });
        });
    }
    
    // Iniciar el intervalo
    setInterval(actualizarKanban, refreshInterval);
    
    // Controlar actualizaci√≥n cuando la pesta√±a no est√° visible
    document.addEventListener('visibilitychange', function() {
        kanbanAutoRefresh = !document.hidden;
    });
    
    // Forzar primera actualizaci√≥n
    setTimeout(actualizarKanban, 1000);
});
</script>