{% extends "base.html" %}
{% block title %}Conversaciones{% endblock %}

{% block content %}
<style>
        /* Quick visual clean-up overrides for chats page -------------------------------------------------
       Goals: improve spacing, readable contrast, larger avatars, cleaner bubbles, centered layout.
       These overrides are minimal and non-destructive (they target main classes used in the template).
    -----------------------------------------------------------------------------------------------*/

        /* Layout center and max width */
        .chat-layout-v2 {
            max-width: 1200px;
            margin: 18px auto;
            height: calc(100vh - 120px);
            border-radius: 12px;
            overflow: hidden;
        }

        /* Slightly wider chat list for readability */
        .chat-list-v2 {
            width: 300px !important;
            padding: 16px !important;
            gap: 8px;
        }

        /* Main panel wider */
        .chat-panel-v2 {
            width: calc(100% - 300px - 200px) !important; /* center column remaining space */
            min-width: 540px;
            display: flex;
            flex-direction: column;
        }

        /* Right sidebar fixed width */
        .sidebar-right {
            width: 200px !important;
        }

        /* Avatars */
        .card-avatar, .chat-avatar img {
            width: 48px !important;
            height: 48px !important;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.08);
        }

        /* Chat item improved */
        .chat-item {
            background: rgba(255,255,255,0.06) !important;
            color: #fff !important;
            padding: 10px !important;
            align-items: center;
        }

        /* Chat title: single line and ellipsis */
        .alias-view, .chat-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: calc(100% - 120px);
        }

        /* Preview text */
        .card-msg, .chat-preview {
            color: rgba(255,255,255,0.85) !important;
            font-size: 0.95rem;
            margin-top: 4px;
        }

        /* Timestamps */
        .card-time, .chat-meta {
            color: rgba(255,255,255,0.65) !important;
            font-size: 0.8rem;
        }

        /* Message bubbles: increased radius and subtle shadows */
        .msg-box {
            max-width: 75% !important;
            border-radius: 14px !important;
            padding: 12px 16px !important;
            box-shadow: 0 6px 18px rgba(2,6,23,0.12) !important;
            color: #0f1720 !important;
            background: rgba(255,255,255,0.96) !important;
        }

            /* User vs AI alignment */
            .msg-box.msg-user {
                align-self: flex-start !important;
                background: rgba(230,247,255,0.95) !important;
                border: 1px solid rgba(120,190,255,0.35) !important;
            }

            .msg-box.msg-ai {
                align-self: flex-end !important;
                background: rgba(255,247,230,0.96) !important;
                border: 1px solid rgba(255,205,120,0.45) !important;
            }

        /* Image previews */
        .whatsapp-image {
            max-width: 420px !important;
            border-radius: 12px !important;
            cursor: zoom-in;
            display: block;
            margin-bottom: 6px;
        }

        /* Reply form cleaner */
        .reply-form {
            padding: 12px 16px !important;
            gap: 8px;
            align-items: center;
            background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
            border-top: 1px solid rgba(255,255,255,0.04);
        }

        .reply-input-line {
            padding: 12px 14px !important;
            border-radius: 999px !important;
            background: rgba(255,255,255,0.06) !important;
            color: #fff !important;
            border: 1px solid rgba(255,255,255,0.06);
        }

        .send-btn {
            border-radius: 999px !important;
            padding: 10px 18px !important;
            background: linear-gradient(90deg,#0078D4,#00A3FF) !important;
            color: white !important;
            box-shadow: 0 6px 14px rgba(0,120,212,0.18);
        }

        /* Reduce heavy shadows on chat items */
        .chat-item, .msg-box {
            box-shadow: none !important;
        }

        /* Improve mobile: make center column full width below 900px */
        @media (max-width: 900px) {
            .chat-layout-v2 {
                height: auto;
                padding-bottom: 60px;
            }

            .chat-list-v2 {
                width: 100% !important;
                max-height: 260px;
            }

            .chat-panel-v2 {
                width: 100% !important;
                min-width: 0;
            }

            .sidebar-right {
                display: none !important;
            }
        }

        /* Make badges subtle */
        .badge {
            font-weight: 600;
            padding: 6px 10px;
            border-radius: 999px;
        }

        /* Small helpers */
        .card-content {
            color: inherit !important;
        }

        .image-caption {
            color: rgba(0,0,0,0.6);
            font-size: 0.95rem;
            margin-top: 6px;
        }
</style>

{% set host = request.host.split(':')[0] %}
{% set parts = host.split('.') %}
{% set subdomain = '' %}
{% if parts|length > 2 %}
    {% set first = parts[0].lower() %}
    {% if first.startswith('www') %}
        {% set subdomain = parts[1] %}
    {% else %}
        {% set subdomain = parts[0] %}
    {% endif %}
{% elif parts|length == 2 %}
    {% set first = parts[0].lower() %}
    {% if not first.startswith('www') %}
        {% set subdomain = parts[0] %}
    {% endif %}
{% else %}
    {% set subdomain = '' %}
{% endif %}
{% set negocio_nombre = subdomain|capitalize if subdomain else (tenant_config.negocio_nombre or 'Mektia') %}

<div class="chat-list-header">
    <h2>Conversaciones - {{ negocio_nombre }}</h2>
</div>
<div class="chat-layout-v2">
    <!-- Lado izquierdo: Lista -->
    <aside class="chat-list-v2">
        <div class="chat-list-tools">
            <button class="add-contact-btn">+ Agregar Contacto</button>
            <input type="text" placeholder="Buscar chats..." class="search-input">
        </div>

        <div class="chat-items">
            {% for chat in chats %}
            <a href="/chats/{{ chat.numero }}" class="chat-item {% if selected == chat.numero %}selected{% endif %}" data-chat-num="{{ chat.numero }}">
                <div class="card-content">
                    <div class="card-title-row">
                        <div class="card-avatar-section">
                            <img src="{{ chat.imagen_url or url_for('static', filename='icons/default-avatar.png') }}"
                                 class="card-avatar" alt="Avatar"
                                 onerror="this.onerror=null;this.src='{{ url_for('static', filename='icons/default-avatar.png') }}';">
                        </div>
                        {% set bandera = chat.numero | bandera %}
                        {% if bandera %}
                        <img src="{{ bandera }}" class="card-flag" alt="Pa√≠s" title="Pa√≠s">
                        {% endif %}
                        <span class="alias-view" data-num="{{ chat.numero }}">
                            {{ chat.nombre_mostrado }}
                        </span>
                        <span class="alias-edit" style="display:none;">
                            <input type="text" value="{{ chat.alias or chat.nombre or '' }}" data-num="{{ chat.numero }}" maxlength="100" style="width: 110px;">
                        </span>
                        {% if is_admin%}
                        <button type="button" class="edit-alias-btn" data-num="{{ chat.numero }}" title="Editar nombre">
                            ‚úèÔ∏è
                        </button>
                        {% endif %}
                    </div>
                    <div class="card-meta-row">
                        <span class="card-num">{{ chat.numero }}</span>
                        <span class="card-time">
                            {% if chat.ultima_fecha %}
                            {{ chat.ultima_fecha|format_time_24h }}
                            {% endif %}
                        </span>
                    </div>
                    <div class="card-msg">
                        {% if chat.ultimo_mensaje %}
                        {% if chat.tipo_mensaje == 'imagen' %}
                        üì∑ Imagen
                        {% else %}
                        {{ chat.ultimo_mensaje[:35] }}{% if chat.ultimo_mensaje|length > 35 %}...{% endif %}
                        {% endif %}
                        {% else %}
                        Sin mensajes
                        {% endif %}
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </aside>

    <!-- Centro: Mensajes -->
    <section class="chat-panel-v2">
        {% if selected %}
        <div class="chat-panel-header" data-num="{{ selected }}">
            <div class="chat-header-info">
                <div class="chat-title">
                    <span class="alias-view">
                        {{ (chats | selectattr("numero", "equalto", selected) | first).nombre_mostrado if (chats | selectattr("numero", "equalto", selected) | first) else selected }}
                    </span>
                    <span class="alias-edit" style="display:none;">
                        {% set chat_info_edit = chats | selectattr("numero", "equalto", selected) | first %}
                        <input type="text" value="{{ chat_info_edit.alias if chat_info_edit and chat_info_edit.alias else (chat_info_edit.nombre if chat_info_edit and chat_info_edit.nombre else '') }}"
                               data-num="{{ selected }}" maxlength="100">
                    </span>
                    {% if is_admin %}
                    <button type="button" class="edit-alias-btn" data-num="{{ selected }}" title="Editar nombre">
                        ‚úèÔ∏è
                    </button>
                    {% endif %}
                </div>
                <span class="chat-number">{{ selected }}</span>
            </div>

            <div class="chat-controls">
                <span class="badge {% if IA_ESTADOS.get(selected, {}).get('activa', True) %}bg-success{% else %}bg-warning{% endif %}">
                    {% if IA_ESTADOS.get(selected, {}).get('activa', True) %}
                    ü§ñ IA ACTIVADA
                    {% else %}
                    üë§ MODO MANUAL
                    {% endif %}
                </span>
                <form action="/toggle_ai/{{ selected }}" method="POST">
                    <button type="submit" class="toggle-btn {{ 'on' if IA_ESTADOS.get(selected, {}).get('activa', True) else 'off' }}">
                        IA {{ 'ON' if IA_ESTADOS.get(selected, {}).get('activa', True) else 'OFF' }}
                    </button>
                </form>
            </div>
        </div>
        {% else %}
        <div class="chat-panel-header">
            <span>Selecciona un chat</span>
        </div>
        {% endif %}
        <div class="msgs-wrap-v2" id="msgs">
            {% if mensajes %}
            {% for msg in mensajes %}
            {% if msg.mensaje and msg.mensaje != '[Mensaje manual desde web]' %}
            <div class="msg-box msg-user" data-msg-id="{{ msg.id if msg.id else '' }}">
                <div class="message-content">
                    {% if msg.es_imagen and msg.imagen_url %}
                    <div class="image-message">
                        <img src="{{ msg.imagen_url }}" alt="Imagen" class="whatsapp-image" onclick="window.open(this.src, '_blank')" />
                        {% if msg.mensaje and msg.mensaje != 'Analiza esta imagen' %}
                        <div class="image-caption">
                            {{ msg.mensaje }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% elif msg.tipo_mensaje == 'audio' and msg.contenido_extra %}
                <div class="audio-player">
                    <audio id="audio-{{ loop.index }}" class="whatsapp-audio">
                        <source src="{{ msg.contenido_extra }}" type="audio/ogg">
                        <source src="{{ msg.contenido_extra }}" type="audio/mpeg">
                        Tu navegador no soporta el elemento de audio.
                    </audio>
                    <div class="audio-controls">
                        <button class="audio-play-btn" onclick="toggleAudio('audio-{{ loop.index }}', this)">
                            ‚ñ∂Ô∏è
                        </button>
                        <div class="audio-progress" onclick="seekAudio('audio-{{ loop.index }}', this, event)">
                            <div class="audio-progress-bar"></div>
                        </div>
                        <span class="audio-duration" id="duration-{{ loop.index }}">0:00</span>
                        <a href="{{ msg.contenido_extra }}" download="audio-mensaje.ogg" class="audio-download-btn" title="Descargar audio">
                            ‚¨áÔ∏è
                        </a>
                    </div>
                    {% if msg.transcripcion_audio %}
                    <div class="audio-transcription">
                        <strong>Transcripci√≥n:</strong> {{ msg.transcripcion_audio }}
                    </div>
                    {% elif msg.mensaje and msg.mensaje != '[Mensaje manual desde web]' %}
                    <div class="audio-transcription">
                        <strong>Mensaje:</strong> {{ msg.mensaje }}
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="text-message">
                    {{ msg.mensaje }}
                </div>
                {% endif %}
            </div>
            <div class="msg-meta">{{ msg.timestamp|format_time_24h }}</div>
        </div>
        {% endif %}

        {% if msg.mensaje == '[Mensaje manual desde web]' and msg.respuesta %}
        <div class="msg-box msg-manual">
            <div class="message-content">
                <div class="manual-indicator">üì§ Mensaje enviado:</div>
                <div class="text-message">
                    {{ msg.respuesta }}
                </div>
            </div>
            <div class="msg-meta">{{ msg.timestamp|format_time_24h }}</div>
        </div>
        {% endif %}

        {% if msg.respuesta and msg.respuesta != '[Respuesta vac√≠a]' and msg.mensaje != '[Mensaje manual desde web]' %}
        <div class="msg-box msg-ai">
            <div class="message-content">
                <div class="text-message">
                    {{ msg.respuesta }}
                </div>
            </div>
            <div class="msg-meta">{{ msg.timestamp|format_time_24h }}</div>
        </div>
        {% endif %}
        {% endfor %}
        {% else %}
        <div class="no-chat-selected">
            <p>Selecciona un chat para ver mensajes.</p>
        </div>
        {% endif %}
</div>

        {% if selected %}
        {% if not IA_ESTADOS.get(selected, {}).get('activa', True) %}
<form method="POST" action="/send-manual" class="reply-form">
    <input type="hidden" name="numero" value="{{ selected }}">
    <div class="input-group">

        <button type="button" id="emoji-pick-btn" class="emoji-btn">üòä</button>
        <!-- Emoji Picker Container (hidden by default) -->
        <div id="emoji-picker-list" class="emoji-picker-list" style="display:none; position:absolute; z-index:1000; background:white; border:1px solid #ccc; border-radius:8px; padding:8px;">
            <!-- Los emojis se llenan por JS -->
        </div>
        <input type="text" name="texto" id="mensaje-texto" placeholder="Escribe un mensaje manual..." class="reply-input-line" autocomplete="off" required />
        <button type="submit" class="send-btn">Enviar</button>
    </div>
</form>
        {% else %}
<div class="ia-active-message">
    <div class="ia-indicator">
        <span class="ia-icon">{{ 'ü§ñ' if IA_ESTADOS.get(selected, {}).get('activa', True) else 'üë§' }}</span>
        <span>{{ 'La IA est√° respondiendo autom√°ticamente' if IA_ESTADOS.get(selected, {}).get('activa', True) else 'Modo manual activado' }}</span>
    </div>
    <form action="/toggle_ai/{{ selected }}" method="POST">
        {% if IA_ESTADOS.get(selected, {}).get('activa', True) %}
        <button type="submit" class="toggle-btn off">Desactivar IA</button>
        {% else %}
        <button type="submit" class="toggle-btn on">Activar IA</button>
        {% endif %}
    </form>
</div>
        {% endif %}
        {% endif %}
    </section>

<aside class="sidebar-right">
    {% if selected %}
    <div class="sidebar-section">
        <h3>Acciones</h3>
        {% if is_admin %}
        <form action="/chats/{{ selected }}/eliminar" method="POST" onsubmit="return confirm('¬øEst√°s seguro de eliminar este chat? Se borrar√° todo el historial.');">
            <button type="submit" class="delete-btn">
                üóëÔ∏è Eliminar Chat
            </button>
        </form>
        {% endif %}
    </div>

    <div class="sidebar-section">
        <h3>Informaci√≥n</h3>
        <div class="chat-info-stats">
            <div class="stat-item">
                <span class="stat-label">Total mensajes:</span>
                <span class="stat-value">{{ mensajes|length if mensajes else 0 }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">√öltima actividad:</span>
                <span class="stat-value">
                    {% if mensajes and mensajes[-1].timestamp %}
                    {{ mensajes[-1].timestamp|format_time_24h }}
                    {% else %}
                    N/A
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
    {% endif %}
</aside>
</div>

<button class="mobile-chat-toggle" onclick="toggleChatList()">üí¨</button>
<style>

    .card-avatar {
        width: 8%;
        height: 8%;
    }

    .card-content {
        color: white;
    }

    .emoji-picker-list {
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        min-width: 220px;
        max-width: 320px;
        max-height: 180px;
        overflow-y: auto;
        padding: 8px;
        display: none;
    }

    .emoji-pick-btn {
        font-size: 22px;
        margin: 2px;
        background: none;
        border: none;
        cursor: pointer;
    }

    .whatsapp-image {
        max-width: 360px;
        max-height: 480px;
        border-radius: 8px;
        display: block;
        cursor: pointer;
        margin-bottom: 6px;
        object-fit: cover;
        box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }

    .input-group {
        position: relative;
    }

    .msg-manual {
        left: 20%
    }
</style>


<script>
/*
  Auto-update & incremental diff for chats (inspired by kanban.html).
  - lista de chats: /chats/data  (retorna chats + timestamp)
  - mensajes del chat seleccionado: /chat/<telefono>/messages?after=<id>
*/

let chatAutoRefresh = true;
let refreshIntervalMs = 800; // ajustable
let selectedChatId = "{{ selected }}";
let lastChatsTimestamp = 0;
let lastMessageIdForSelected = 0;
let isEditingAlias = false;
let aliasTimers = new Map();

document.addEventListener('DOMContentLoaded', () => {
    enhanceAliasButtons();
    setupEmojiPicker();
    // start refreshing only if container exists
    if (document.querySelector('.chat-items')) {
        actualizarListaChats(); // initial load
        setInterval(() => { if (!document.hidden) actualizarListaChats(); }, refreshIntervalMs);
    }
    // start polling messages for selected chat
    if (selectedChatId) {
        initSelectedMessagesPolling();
    }
    document.addEventListener('visibilitychange', () => chatAutoRefresh = !document.hidden);
});

/* ===================== CHATS LIST: incremental update ===================== */

function actualizarListaChats() {
    if (!chatAutoRefresh) return;
    fetch('/chats/data')
        .then(r => r.json())
        .then(data => {
            if (!data || !data.chats) return;
            // timestamp from server in seconds or ms -> normalize to ms
            const ts = Number(data.timestamp) || Date.now();
            if (ts <= lastChatsTimestamp) return;
            lastChatsTimestamp = ts;
            actualizarIncrementalChats(data.chats);
        })
        .catch(err => console.error('Error actualizando lista de chats:', err));
}

function actualizarIncrementalChats(chats) {
    const container = document.querySelector('.chat-items');
    if (!container) return;

    // Build map of existing nodes
    const existing = new Map();
    container.querySelectorAll('.chat-item').forEach(node => {
        existing.set(node.dataset.chatNum, node);
    });

    // Iterate new list ordering (server provides ordered list)
    chats.forEach(chat => {
        const num = chat.numero;
        const node = existing.get(num);
        if (node) {
            // update in-place
            actualizarChatExistente(node, chat);
            existing.delete(num);
            // move to correct position (ensure newest on top)
            if (container.firstElementChild && container.firstElementChild.dataset.chatNum !== num) {
                container.insertBefore(node, container.firstElementChild);
            }
        } else {
            // create new node and prepend
            const tmp = document.createElement('div');
            tmp.innerHTML = crearNuevoChatHTML(chat);
            const el = tmp.firstElementChild;
            container.insertBefore(el, container.firstElementChild);
            // add handlers for alias edit button
            const editBtn = el.querySelector('.edit-alias-btn');
            if (editBtn) editBtn.addEventListener('click', onEditAliasClick);
            // highlight briefly
            el.classList.add('new-message');
            setTimeout(() => el.classList.remove('new-message'), 1800);
        }
    });

    // Remove nodes that are not in server list
    existing.forEach((node, numero) => {
        node.remove();
    });
}

function actualizarChatExistente(elemento, chat) {
    // alias/nombre
    const aliasView = elemento.querySelector('.alias-view');
    if (aliasView && aliasView.textContent.trim() !== chat.nombre_mostrado) {
        aliasView.textContent = chat.nombre_mostrado;
    }
    // time
    const timeEl = elemento.querySelector('.card-time');
    if (timeEl && chat.ultima_fecha) {
        timeEl.textContent = formatClientTime(chat.ultima_fecha);
    }
    // preview
    const msgEl = elemento.querySelector('.card-msg');
    const previewText = chat.tipo_mensaje === 'imagen' ? 'üì∑ Imagen' : (chat.ultimo_mensaje ? truncate(chat.ultimo_mensaje, 35) : 'Sin mensajes');
    if (msgEl && msgEl.textContent.trim() !== previewText) {
        msgEl.textContent = previewText;
        elemento.classList.add('new-message');
        setTimeout(() => elemento.classList.remove('new-message'), 1600);
    }
}

function crearNuevoChatHTML(chat) {
    const isSelected = chat.numero === selectedChatId;
    const avatarUrl = chat.imagen_url || '/static/icons/default-avatar.png';
    const nombreMostrado = chat.nombre_mostrado || chat.numero;
    const ultimoMensaje = chat.tipo_mensaje === 'imagen' ? 'üì∑ Imagen' : (chat.ultimo_mensaje ? truncate(chat.ultimo_mensaje, 35) : 'Sin mensajes');
    return `
<a href="/chats/${chat.numero}" class="chat-item ${isSelected ? 'selected' : ''}" data-chat-num="${chat.numero}">
  <div class="card-content">
    <div class="card-title-row">
      <div class="card-avatar-section">
        <img src="${avatarUrl}" class="card-avatar" alt="Avatar"
             onerror="this.onerror=null;this.src='/static/icons/default-avatar.png';">
      </div>
      <span class="alias-view" data-num="${chat.numero}">${escapeHtml(nombreMostrado)}</span>
      <span class="alias-edit" style="display:none;">
        <input type="text" value="${chat.alias || chat.nombre || ''}" data-num="${chat.numero}" maxlength="100" style="width:110px;">
      </span>
      ${'{{ is_admin and "" }}'}
     </div>
    <div class="card-meta-row">
      <span class="card-num">${chat.numero}</span>
      <span class="card-time">
        ${chat.ultima_fecha ? formatClientTime(chat.ultima_fecha) : ''}
      </span>
    </div>
    <div class="card-msg">${escapeHtml(ultimoMensaje)}</div>
  </div>
</a>`;
}

/* ===================== MESSAGES FOR SELECTED CHAT: incremental polling ===================== */

function initSelectedMessagesPolling() {
    // initialize lastMessageId from DOM if available
    const lastDom = document.querySelector('#msgs .msg-box[data-msg-id]:last-child');
    if (lastDom && lastDom.dataset.msgId) lastMessageIdForSelected = Number(lastDom.dataset.msgId) || 0;
    // poll every 800ms
    setInterval(() => {
        if (!selectedChatId || document.hidden) return;
        pollSelectedMessages();
    }, 700);
}

function pollSelectedMessages() {
    const after = lastMessageIdForSelected || 0;
    fetch(`/chat/${encodeURIComponent(selectedChatId)}/messages?after=${after}`)
        .then(r => r.json())
        .then(data => {
            if (!data || !Array.isArray(data.messages)) return;
            if (data.messages.length === 0) return;
            appendMessagesToPanel(data.messages);
        })
        .catch(err => console.error('Error polling messages:', err));
}

function appendMessagesToPanel(messages) {
    const container = document.getElementById('msgs');
    if (!container) return;
    messages.forEach(m => {
        // m: { id, content, timestamp, direction } where direction may be 'in' or 'out' depending on your table mapping
        const id = m.id || 0;
        const content = m.content || '';
        const ts = m.timestamp ? Number(m.timestamp) : Date.now();
        // Avoid duplicates
        if (container.querySelector(`.msg-box[data-msg-id="${id}"]`)) {
            lastMessageIdForSelected = Math.max(lastMessageIdForSelected, id);
            return;
        }
        // Build a simple message bubble. You can extend for images/audio as needed.
        const div = document.createElement('div');
        div.className = 'msg-box msg-user';
        div.dataset.msgId = id;
        div.innerHTML = `<div class="message-content"><div class="text-message">${escapeHtml(content)}</div></div><div class="msg-meta">${formatClientTime(ts)}</div>`;
        container.appendChild(div);
        lastMessageIdForSelected = Math.max(lastMessageIdForSelected, id);
        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
    });
}

/* ===================== HELPERS ===================== */

function formatClientTime(serverTs) {
    // serverTs may be ms int or ISO string. Try to normalize.
    let d = typeof serverTs === 'number' ? new Date(serverTs) : new Date(Number(serverTs) || serverTs);
    // If invalid, fallback to now
    if (isNaN(d.getTime())) d = new Date();
    // Use local formatting similar to server: dd/mm HH:MM
    const day = d.getDate();
    const month = d.toLocaleString('es-MX', { month: 'short' });
    const time = d.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', hour12: false });
    return `${day}-${month} ${time}`;
}

function truncate(str, n) {
    if (!str) return '';
    return str.length > n ? str.substring(0, n) + '...' : str;
}

function escapeHtml(unsafe) {
    if (unsafe === null || unsafe === undefined) return '';
    return String(unsafe)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
}

/* ===================== Alias editing (preserve behavior) ===================== */

function enhanceAliasButtons() {
    document.querySelectorAll('.edit-alias-btn').forEach(btn => {
        btn.removeEventListener('click', onEditAliasClick);
        btn.addEventListener('click', onEditAliasClick);
    });
}

function onEditAliasClick(e) {
    e.preventDefault(); e.stopPropagation();
    const btn = e.currentTarget;
    const parent = btn.closest('.card-title-row') || btn.closest('.chat-content') || btn.closest('.card-content');
    activarEdicionAlias(parent);
}

function activarEdicionAlias(parent) {
    if (!parent) return;
    const view = parent.querySelector('.alias-view');
    const edit = parent.querySelector('.alias-edit');
    if (!view || !edit) return;
    const input = edit.querySelector('input[type=text]');
    if (!input) return;

    view.style.display = 'none';
    edit.style.display = 'flex';
    input.focus();
    input.select();
    isEditingAlias = true;

    const finish = () => {
        const nuevo = (input.value || '').trim();
        edit.style.display = 'none';
        view.style.display = '';
        if (!nuevo) return;
        view.textContent = nuevo;
        // post
        fetch(`/contactos/${input.dataset.num}/alias`, {
            method: 'POST',
            body: new URLSearchParams({ alias: nuevo }),
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
        }).catch(err => console.warn('Error guardando alias:', err))
          .finally(() => { isEditingAlias = false; });
    };

    input.onblur = () => setTimeout(finish, 0);
    input.onkeydown = (ev) => {
        if (ev.key === 'Enter') { ev.preventDefault(); finish(); }
        if (ev.key === 'Escape') { edit.style.display = 'none'; view.style.display = ''; isEditingAlias = false; }
    };
}

/* ===================== Emoji picker (kept) ===================== */

function setupEmojiPicker() {
    const emojiBtn = document.getElementById('emoji-pick-btn');
    const emojiPickerList = document.getElementById('emoji-picker-list');
    const input = document.getElementById('mensaje-texto');
    const emojis = ['üòä', 'üòÇ', 'üòç', 'üëç', 'üôè', 'üòé', 'ü•≥', 'üò¢', 'üò°', 'üéâ', 'üí¨', '‚ù§Ô∏è', 'üî•', 'ü§î', 'üôå', 'üòÖ', 'üòâ', 'üòá', 'üòú', 'ü§ñ'];

    if (!emojiBtn || !emojiPickerList || !input) return;

    emojiPickerList.innerHTML = emojis.map(e => `<button type="button" class="emoji-pick-btn">${e}</button>`).join('');

    emojiBtn.addEventListener('click', function (e) {
        e.preventDefault();
        const rect = emojiBtn.getBoundingClientRect();
        const parentRect = emojiBtn.parentElement.getBoundingClientRect();
        emojiPickerList.style.left = (rect.left - parentRect.left) + 'px';
        emojiPickerList.style.top = (rect.top - parentRect.top - emojiPickerList.offsetHeight - 70) + 'px';
        emojiPickerList.style.display = 'block';
    });

    emojiPickerList.addEventListener('click', function (e) {
        if (e.target.classList.contains('emoji-pick-btn')) {
            const emoji = e.target.textContent;
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            input.value = text.slice(0, start) + emoji + text.slice(end);
            input.selectionStart = input.selectionEnd = start + emoji.length;
            emojiPickerList.style.display = 'none';
            input.focus();
        }
    });

    document.addEventListener('click', function (e) {
        if (!emojiPickerList.contains(e.target) && e.target !== emojiBtn) {
            emojiPickerList.style.display = 'none';
        }
    });
}

/* ===================== Utilities used by old code ===================== */

function toggleChatList() {
    document.querySelector('.chat-list-v2')?.classList.toggle('mobile-visible');
}

/* Keep existing audio controls helpers if present in page */
function toggleAudio(id, btn) {
    const audio = document.getElementById(id);
    const bar = btn.closest('.audio-player')?.querySelector('.audio-progress-bar');
    const durSpan = btn.closest('.audio-player')?.querySelector('.audio-duration');
    if (!audio) return;
    if (audio.paused) {
        audio.play().then(() => {
            btn.textContent = '‚è∏Ô∏è';
            audio.ontimeupdate = () => {
                if (audio.duration) {
                    if (bar) bar.style.width = (audio.currentTime / audio.duration) * 100 + '%';
                    if (durSpan) {
                        const m = Math.floor(audio.currentTime / 60);
                        const s = Math.floor(audio.currentTime % 60).toString().padStart(2,'0');
                        durSpan.textContent = `${m}:${s}`;
                    }
                }
            };
        }).catch(console.error);
    } else {
        audio.pause();
        btn.textContent = '‚ñ∂Ô∏è';
    }
}
function seekAudio(id, progressBar, evt) {
    const audio = document.getElementById(id);
    const inner = progressBar.querySelector('.audio-progress-bar');
    const rect = progressBar.getBoundingClientRect();
    const clickX = evt.clientX - rect.left;
    if (audio && audio.duration) {
        audio.currentTime = (clickX / rect.width) * audio.duration;
        if (inner) inner.style.width = (clickX / rect.width) * 100 + '%';
    }
}

</script>
{% endblock %}