{# Agrego la visualizaci√≥n del plan en la parte superior del dashboard #}
{% extends "base.html" %}
{% block title %}Dashboard General{% endblock %}

{% block content %}
<style>
    /* Layout tweaks: reduce vertical spacing to "subir" todo un poco */
    .header-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 0.5rem; /* reduced from 1rem */
        color: white;
    }

        .header-row h1 {
            color: white;
            margin: 0;
            font-size: 1.5rem;
            /* allow title to take available space but not force plan box off */
            flex: 1 1 auto;
            min-width: 0; /* ensure truncation if needed */
        }

    .plan-box {
        background: rgba(255,255,255,0.06);
        padding: 8px 10px;
        border-radius: 8px;
        color: #fff;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
        max-width: 420px;
        font-size: 0.9rem;
        line-height: 1.2;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

        .plan-box .plan-details {
            display: inline-flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

    .plan-metric {
        display: inline-block;
        margin-right: 8px;
        white-space: nowrap;
    }

    .tabs {
        margin-bottom: 0.3rem; /* bring tabs a bit closer */
    }

        .tabs a {
            padding: 8px 8px; /* slightly slimmer buttons */
            text-decoration: none;
            border-radius: 20px;
            border: 2px solid #1f4e79;
            color: #1f4e79;
            margin-right: 10px;
            display: inline-block;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 0.95rem;
        }

            .tabs a.active {
                background-color: #1f4e79;
                color: white;
            }

    /* Stats container: make it more compact and cards sized close to plan-box */
    .stats {
        margin-top: 6px; /* small lift */
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
        align-items: flex-start;
        justify-content: flex-start;
    }

    /* Adjusted: make stat cards nearly the width of plan-box (half each) so they match visually */
    .stat-card {
        background: rgba(255, 255, 255, 0.95);
        /* reduced internal vertical padding and extra horizontal padding for compactness */
        padding: 4px 8px;
        border-radius: 8px;
        border-left: 6px solid #1f4e79;
        width: auto;
        /* fixed: valid calc syntax with spaces around the minus */
        flex: 1 1 calc(50% - 0.6rem); /* ~half of plan-box max-width (420px) so two cards align closely with plan-box width */
        display: flex;
        flex-direction: column;
        /* remove gap between title and value so they sit tighter */
        gap: 0;
        font-size: 0.78rem;
        align-items: center;
        justify-content: center;
        text-align: center;
        box-sizing: border-box;
        /* keep min-height small to allow compact layout */
        min-height: 30px;
    }

        /* make the numeric value stand out and allow full height */
        .stat-card > div {
            font-size: 1.05rem;
            font-weight: 600;
            color: #222;
            line-height: 1.1;
            display: flex;
            align-items: center;
            justify-content: center;
            /* use full width so the inner element doesn't artificially constrain the card */
            width: 100%;
            box-sizing: border-box;
            /* remove extra padding so value sits closer to the title */
            padding: 0;
            margin-top: 2px;
            overflow: visible; /* allow full number to show */
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .stat-card strong {
            display: block;
            font-size: 0.78rem;
            font-weight: 300;
            color: #333;
            /* minimal spacing between title and value */
            margin-bottom: 2px;
            line-height: 1;
        }

    .chart-container {
        margin-top: 1rem; /* slightly less gap above charts */
        width: 100%;
        position: relative;
        height: 400px;
    }
    /* Responsive */
    @media (max-width: 768px) {
        .header-row {
            flex-direction: column;
            align-items: stretch;
        }

        .plan-box {
            justify-content: flex-start;
            white-space: normal;
            overflow: visible;
            max-width: 100%;
            padding: 10px;
            font-size: 0.95rem;
        }

        .stats {
            flex-direction: column;
            gap: 0.5rem;
        }

        /* reduce min-height for narrow screens but keep enough space */
        .stat-card {
            min-height: 20px;
        }

            .stat-card > div {
                font-size: 1.1rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

        .tabs a {
            padding: 8px 12px;
            font-size: 0.9rem;
        }
    }

    /* Hidden by default for tab panes */
    .tab-pane {
        display: none;
    }

        .tab-pane.active {
            display: block;
        }
</style>

<div style="max-width: 1200px; margin: 0 auto; padding: 0.6rem 1rem;">
    <!-- reduced top padding to lift content -->
    <div class="header-row">
        <h1>Dashboard General</h1>

        {# Mostrar informaci√≥n del plan si est√° disponible #}
        {% if plan_info %}
        <div class="plan-box" title="{{ plan_info.plan_name or ('Plan ID: ' ~ (plan_info.plan_id or 'N/A')) }}">
            <strong style="margin-right:6px;">Plan Info:</strong>
            <div class="plan-details">
                <span class="plan-metric"><strong>Plan:</strong> {{ plan_info.plan_name or ('ID: ' ~ (plan_info.plan_id or 'N/A')) }}</strong></span>
                <span class="plan-metric"><strong>Incluye:</strong> {{ plan_info.mensajes_incluidos or 0 }}</span>
                <span class="plan-metric"><strong>Consumidos:</strong> {{ plan_info.mensajes_consumidos or 0 }}</span>
                <span class="plan-metric"><strong>Disponibles:</strong> {{ plan_info.mensajes_disponibles if plan_info.mensajes_disponibles is not none else 'N/A' }}</span>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="tabs" style="margin-bottom: 0.3rem;">
        <div class="tabs" style="margin-bottom: 0.3rem;">
            <a id="tab-conversaciones" data-tab="conversaciones" class="{{ 'active' if request.args.get('tab') == 'conversaciones' or not request.args.get('tab') else '' }}">Conversaciones</a>
            <a data-tab="overview" data-period="year" class="{{ 'active' if period == 'year' and request.args.get('tab') == 'overview' else '' }}" href="?tab=overview&period=year">√öltimo a√±o (mensual)</a>
            <a data-tab="overview" data-period="month" class="{{ 'active' if period == 'month' and request.args.get('tab') == 'overview' else '' }}" href="?tab=overview&period=month">√öltimos 30 d√≠as</a>
        </div>
    </div>

    {# Removed global stats (Chats distintos / Respuestas enviadas) per request.
    Only conversation-related metrics live inside the Conversaciones pane. #}

    <!-- Overview pane (shown only when tab=overview) -->
    <div id="pane-overview" class="tab-pane {% if request.args.get('tab') == 'overview' %}active{% endif %}">
        <div class="chart-container">
            <canvas id="barChart" style="display: block; box-sizing: border-box; height: 400px; width: 1168px;" width="1460" height="500"></canvas>
        </div>
    </div>

    <!-- Conversaciones pane (default when no tab param) -->
    <div id="pane-conversaciones" class="tab-pane {% if request.args.get('tab') == 'conversaciones' or not request.args.get('tab') %}active{% endif %}">
        <div class="stats" style="margin-top:0;">
            <div class="stat-card" style="min-height:64px;height:64px;">
                <strong>Conversaciones disponibles (plan):</strong>
                <div id="planDisponibles">‚Äî</div>
            </div>
            <div class="stat-card" style="min-height:64px;height:64px;">
                <strong>Conversaciones consumidas (plan):</strong>
                <div id="planConsumidos">‚Äî</div>
            </div>
        </div>

        <div class="chart-container" style="height:300px;">
            <canvas id="remainingChart"></canvas>
        </div>

        <div class="chart-container" style="height:400px;">
            <canvas id="dailyChart"></canvas>
        </div>
    </div>
    <div id="pane-plataformas" class="tab-pane {% if request.args.get('tab') == 'plataformas' %}active{% endif %}">
        <div class="stats" style="margin-top:0;">
            <div class="stat-card" style="min-height:64px;height:64px;">
                <strong>Conversaciones por WhatsApp:</strong>
                <div id="whatsappConversations">‚Äî</div>
            </div>
            <div class="stat-card" style="min-height:64px;height:64px;">
                <strong>Conversaciones por Telegram:</strong>
                <div id="telegramConversations">‚Äî</div>
            </div>
        </div>

        <div style="display:flex; gap:16px; margin-top: 1rem;">
            <div class="chart-container" style="flex: 1; height:350px; background: rgba(255,255,255,0.9); padding: 12px; border-radius: 8px;">
                <h4 style="text-align: center; color: #333;">Conversaciones por Plataforma</h4>
                <canvas id="platformConversationsChart"></canvas>
            </div>
            <div class="chart-container" style="flex: 1; height:350px; background: rgba(255,255,255,0.9); padding: 12px; border-radius: 8px;">
                <h4 style="text-align: center; color: #333;">Contactos por Plataforma</h4>
                <canvas id="platformContactsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js y plugin datalabels -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
  // Variables globales para charts
let overviewChart = null;
let remainingChart = null;
let dailyChart = null;
let platformConversationsChart = null;
let platformContactsChart = null;
  // expose current period to JS (server value on load)
  const CURRENT_PERIOD = '{{ period }}';
async function loadPlatformData() {
    try {
        const res = await fetch(`/dashboard/platform-data`);
        const json = await res.json();
        if (json.error) {
            console.error('Error fetching platform data', json.error);
            return;
        }

        const convData = json.conversations;
        const contactData = json.contacts;

        // Actualizar tarjetas r√°pidas
        // Si no existe la plataforma, el valor es 0
        const whatsappConv = convData.values[convData.labels.indexOf('WhatsApp')] || 0;
        const telegramConv = convData.values[convData.labels.indexOf('Telegram')] || 0;
        document.getElementById('whatsappConversations').innerText = whatsappConv;
        document.getElementById('telegramConversations').innerText = telegramConv;

        // Renderizar Conversaciones (Chart 1: Doughnut)
        const convCtx = document.getElementById('platformConversationsChart').getContext('2d');
        if (platformConversationsChart) platformConversationsChart.destroy();
        platformConversationsChart = new Chart(convCtx, {
            type: 'doughnut',
            data: {
                labels: convData.labels,
                datasets: [{
                    data: convData.values,
                    backgroundColor: ['#25D366', '#0088CC', '#34B7F1', '#ccc'], // Colores para WhatsApp, Telegram, etc.
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#333' } },
                    datalabels: { color: 'white', formatter: (v) => v }
                }
            },
            plugins: [ChartDataLabels]
        });

        // Renderizar Contactos (Chart 2: Bar)
        const contactCtx = document.getElementById('platformContactsChart').getContext('2d');
        if (platformContactsChart) platformContactsChart.destroy();
        platformContactsChart = new Chart(contactCtx, {
            type: 'bar',
            data: {
                labels: contactData.labels,
                datasets: [{
                    label: 'Contactos',
                    data: contactData.values,
                    backgroundColor: contactData.labels.map(l => {
                        if (l === 'WhatsApp') return '#25D366';
                        if (l === 'Telegram') return '#0088CC';
                        return '#1f4e79';
                    }),
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    datalabels: { anchor: 'end', align: 'end', color: '#000', font: { weight: 'bold', size: 14 } }
                }
            },
            plugins: [ChartDataLabels]
        });

    } catch (err) {
        console.error('Failed to load platform data', err);
    }
}
  // --- Overview bar chart (existente) ---
  (function renderOverview(){
      const ctx = document.getElementById('barChart') && document.getElementById('barChart').getContext('2d');
      if (!ctx) return;
      const rawValues = {{ values| tojson }};
      const maxValor = rawValues.length ? Math.max(...rawValues) : 0;
      const maxAuto = Math.ceil((maxValor * 1.1) / 5) * 5;
      const data = {
            labels: {{ labels| tojson }},
        datasets: [{
            label: 'Mensajes por n√∫mero',
            data: rawValues,
            backgroundColor: '#1f4e79'
        }]
      };
      if (overviewChart) overviewChart.destroy();
      overviewChart = new Chart(ctx, {
        type: 'bar',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: { duration: 0 },
          plugins: {
            legend: { display: false },
            datalabels: { anchor: 'end', align: 'end', color: '#fff', font: { weight: 'bold', size: 14 } }
          },
          scales: {
            y: { beginAtZero: true, suggestedMax: maxAuto, ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
            x: { ticks: { maxRotation: 45, minRotation: 45, color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
          }
        },
        plugins: [ChartDataLabels]
      });
  })();

  // --- Tab handling ---
    // --- Modificar la Funci√≥n showTab (alrededor de la l√≠nea 360) ---
    function showTab(tab) {
        // ... (c√≥digo que remueve/a√±ade active classes) ...

        // show/hide panes
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
        const pane = document.getElementById('pane-' + tab);
        if (pane) pane.classList.add('active');

        // üö® MODIFICACI√ìN AQU√ç
        if (tab === 'conversaciones') loadConversacionesData();
        if (tab === 'plataformas') loadPlatformData();

        // resize charts
        setTimeout(() => {
            if (overviewChart) overviewChart.resize();
            if (remainingChart) remainingChart.resize();
            if (dailyChart) dailyChart.resize();
            if (platformConversationsChart) platformConversationsChart.resize(); // <--- RESIZE GR√ÅFICAS NUEVAS
            if (platformContactsChart) platformContactsChart.resize();           // <--- RESIZE GR√ÅFICAS NUEVAS
        }, 200);
    }


  document.querySelectorAll('.tabs a').forEach(a => {
      a.addEventListener('click', function(e){
          const tab = this.getAttribute('data-tab') || 'overview';
          const dp = this.getAttribute('data-period'); // period attribute, if any
          const url = new URL(window.location);

          // Always prevent default: we control navigation explicitly to avoid races
          e.preventDefault();

          // update tab param in url
          if (tab === 'conversaciones') {
              url.searchParams.set('tab', 'conversaciones');
          } else {
              url.searchParams.set('tab', 'overview');
          }

          // If this is a period button, do a full navigation so server re-renders page with new data
          if (dp) {
              url.searchParams.set('period', dp);
              // Use full href navigation (reliable)
              window.location.href = url.toString();
              return;
          }

          // For tabs handled client-side, update history and show tab
          window.history.replaceState({}, '', url);
          showTab(tab);
      });
  });


  // --- Load data and render conversations charts ---
    async function loadConversacionesData() {
        try {
            // For the dailyChart we now want the last 3 months aggregated by month:
            const period = '3months';

            const res = await fetch(`/dashboard/conversaciones-data?period=${period}`);
            const json = await res.json();
            if (json.error) {
                console.error('Error fetching conversaciones data', json.error);
                return;
            }

            // compute plan-related metrics
            const consumed = (json.plan_info && json.plan_info.mensajes_consumidos) ? json.plan_info.mensajes_consumidos : 0;
            const included = (json.plan_info && json.plan_info.mensajes_incluidos) ? json.plan_info.mensajes_incluidos : null;
            const available = (included !== null) ? Math.max(0, included - consumed) : (json.plan_info && json.plan_info.mensajes_disponibles !== undefined ? json.plan_info.mensajes_disponibles : 'N/A');

            // actualizar m√©tricas superiores (only disponibles y consumidos)
            const disponibles = (included !== null) ? available : (json.plan_info && json.plan_info.mensajes_disponibles !== undefined ? json.plan_info.mensajes_disponibles : 'N/A');
            const elDisponibles = document.getElementById('planDisponibles');
            const elConsumidos = document.getElementById('planConsumidos');
            if (elDisponibles) elDisponibles.innerText = disponibles;
            if (elConsumidos) elConsumidos.innerText = consumed;

            // Chart: Remaining / Consumed (pie-like)
            const remCtx = document.getElementById('remainingChart').getContext('2d');
            const pieLabels = included !== null ? ['Consumidos', 'Disponibles'] : ['Conversaciones activas', 'Resto'];
            const pieData = included !== null ? [consumed, Math.max(0, included - consumed)] : [json.active_count || 0, 0];

            if (remainingChart) remainingChart.destroy();
            remainingChart = new Chart(remCtx, {
                type: 'doughnut',
                data: {
                    labels: pieLabels,
                    datasets: [{
                        data: pieData,
                        backgroundColor: ['#e74c3c', '#2ecc71']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: 'white' } },
                        datalabels: { color: 'white', formatter: (v) => v }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // Chart: Monthly conversations (last 3 months)
            const dailyCtx = document.getElementById('dailyChart').getContext('2d');
            const dailyLabels = json.labels || [];
            const dailyValues = json.values || [];

            if (dailyChart) dailyChart.destroy();
            dailyChart = new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: dailyLabels,
                    datasets: [{

                                    label: 'Conversaciones nuevas (√∫ltimos 90 d√≠as)',
                                    data: dailyValues,
                                    borderColor: '#1f4e79',
                                    backgroundColor: 'rgba(31,78,121,0.15)',
                                    fill: true,
                                    tension: 0.2,
                                    pointRadius: 4
                                }]
                        },
                            options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false }, datalabels: { display: false } },
                            scales: {
                                y: { beginAtZero: true, ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.08)' } },
                                x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.06)' } }
                            }
                        }
                        });

        } catch (err) {
            console.error('Failed to load conversaciones data', err);
        }
    }

  // Si la pesta√±a inicial solicitada en URL es conversaciones, cargar datos.
  // Ahora conversaciones es la pesta√±a por defecto cuando no hay ?tab=
    (function initTabFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const tabFromUrl = params.get('tab');

        // üö® MODIFICACI√ìN AQU√ç
        if (tabFromUrl === 'overview' || tabFromUrl === 'conversaciones' || tabFromUrl === 'plataformas') {
            showTab(tabFromUrl);
        } else {
            // default to conversaciones
            showTab('conversaciones');
        }
    })();

  // Resize handlers
  window.addEventListener('resize', () => {
      if (overviewChart) overviewChart.resize();
      if (remainingChart) remainingChart.resize();
      if (dailyChart) dailyChart.resize();
  });
</script>
{% endblock %}