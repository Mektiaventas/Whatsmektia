{% extends "base.html" %}
{% block title %}Tablero Kanban{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/kanban.css') }}">

<style>
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes highlightPulse {
        0% {
            background-color: rgba(255,255,255,0.1);
        }

        50% {
            background-color: rgba(255,224,130,0.4);
        }

        100% {
            background-color: rgba(255,255,255,0.1);
        }
    }

    @keyframes gentleShake {
        0%,100% {
            transform: translateX(0);
        }

        25% {
            transform: translateX(-3px);
        }

        75% {
            transform: translateX(3px);
        }
    }

    .kanban-card.new-message {
        animation: fadeIn .5s ease-out, highlightPulse 2s ease-in-out, gentleShake .5s ease-in-out;
    }

    .kanban-card {
        transition: all .3s ease;
    }

    .add-chat-btn {
        background: #2196f3;
        border: none;
        color: #fff;
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
    }

        .add-chat-btn:hover {
            background: #1976d2;
        }

    /* Icono de columna y selector */
    .col-icon {
        width: 32px;
        height: 32px;
        margin-right: 6px;
        cursor: pointer;
        border-radius: 4px;
        object-fit: contain;
        background: #ffffff22;
        padding: 2px;
    }

    .card-time {
        font-size: small;
    }

    .icon-picker {
        position: absolute;
        background: #1f2630;
        border: 1px solid #2e3a46;
        border-radius: 4px;
        padding: 3px;
        display: none;
        z-index: 9999;
        box-shadow: 0 10px 24px -12px rgba(0,0,0,.5);
    }

        .icon-picker button {
            width: 32px;
            height: 32px;
            margin: 2px;
            font-size: 18px;
            border: none;
            cursor: pointer;
            background: transparent;
            border-radius: 6px;
        }

            .icon-picker button:hover {
                background: #2b3440;
            }

    /* =========================
       COMPACT/OVERRIDES FOR KANBAN
       ========================= */
    /* smaller overall typography for kanban area */
    .kanban-board,
    .kanban-column,
    .kanban-card,
    .card-content {
        font-size: 1px; /* slightly smaller base */
    }

    /* make column icon about half size (override previous) */
    .col-icon {
        width: 40px !important;
        height: 40px !important;
        margin-right: 6px;
        padding: 0 !important;
        background: transparent !important;
    }

    /* avatar inside card: reduce to ~50% of typical size */
    .card-avatar {
        width: 24px !important;
        height: 24px !important;
        border-radius: 1px !important;
        margin-right: 0px;
        flex: 0 0 auto;
        object-fit: cover !important;
    }

    .card-title-row {
        display: flex;
        align-items: center;
        gap: 1px;
        min-width: 0;
        flex: 1 1 auto;
    }

        .card-title-row .alias-view {
            font-size: 0.82rem;
            font-weight: 600;
            line-height: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: calc(100% - 90px);
        }

    .card-meta-row {
        display: flex;
        align-items: center;
        gap: 6px;
        flex: 0 0 auto;
        margin-left: 6px;
    }

        .card-meta-row span {
            font-size: 0.62rem;
            color: rgba(255,255,255,0.9);
            line-height: 1;
        }

    /* ensure edit button smaller */
    .edit-alias-btn {
        font-size: 11px;
        padding: 1px 3px;
        margin-left: 6px;
    }

    /* message: single line only, ellipsis ‚Äî enforced for all browsers */
    .card-msg {
        font-size: 0.6rem;
        color: rgba(255,255,255,0.95);
        margin-left: 0px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
        line-height: 1;
    }

    .card-msg {
        color: #e2e5ed;
        font-size: 0.6rem;
        display: -webkit-box;
        -webkit-line-clamp: 2; /* Muestra m√°ximo 2 l√≠neas */
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: normal; /* Permite saltos de l√≠nea */
        min-height: 1rem;
        font-size: 0.75rem;
        font-weight: 400;
        max-width: 70%;
        letter-spacing: 0.01rem;
        margin-top: 2px;
    }

    .card-content {
        display: flex;
        align-items: flex-start;
        gap: 0px;
        padding: 0px 0px;
    }

    .card-title-row {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* shrink unread badge */
    .card-unread {
        font-size: 0.65rem;
        padding: 1px 4px;
        border-radius: 999px;
    }

    /* tweak delete button size */
    .delete-col-btn {
        font-size: 16px;
        line-height: 1;
        padding: 0 6px;
    }

    .card-unread {
        position: absolute;
        top: 19px;
        right: 20px;
        background: #00E091;
        color: #fff;
        border-radius: 10px;
        padding: 0.5px 8px;
        font-size: 0.89em;
        font-weight: 600;
        min-width: 14px;
        text-align: center;
        box-shadow: 0 0 5px #00e09144;
        z-index: 2;
    }
    /* make kanban cards slightly more compact vertically */
    .kanban-card {
        display: block;
        padding: 0 6px;
        margin-bottom: 6px;
        border-radius: 15px;
        min-height: 28px; /* very compact */
        line-height: 1;
        overflow: hidden;
    }

    /* reduce spacing inside the meta row to compact further */
    .card-meta-row {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* responsive: keep compactness on small screens */
    @media (max-width: 768px) {
        .col-icon {
            width: 20px !important;
            height: 20px !important;
        }

        .card-avatar {
            width: 10px !important;
            height: 10px !important;
            margin-right: 6px;
        }

        .card-msg {
            font-size: 0.68rem;
        }

        .card-title-row .alias-view {
            font-size: 0.80rem;
            max-width: calc(100% - 80px);
        }

        .kanban-card {
            min-height: 26px;
            margin-bottom: 4px;
        }
    }
</style>

<div id="kanban-board" class="kanban-board">
    {% for col in columnas %}
    <div class="kanban-column" data-col-id="{{ col.id }}" data-orden="{{ col.orden }}">
        <div class="column-header" style="--col-color: {{ col.color or '#37474f' }}">
            <img src="{{ col.icono or '/static/icons/default-avatar.png' }}"
                 class="col-icon" alt="icono" title="Cambiar icono"
                 data-col-id="{{ col.id }}"
                 onerror="this.onerror=null;this.src='/static/icons/default-avatar.png';">
            <h3 contenteditable="true" data-col-id="{{ col.id }}" class="col-name">{{ col.nombre }}</h3>
            <button class="add-chat-btn" data-after="{{ col.id }}" title="Agregar columna a la derecha">+</button>
            <button class="delete-col-btn" data-col-id="{{ col.id }}" title="Eliminar columna"
                    style="color:#c00;font-weight:bold;background:none;border:none;font-size:18px;cursor:pointer;">
                √ó
            </button>
        </div>
        <div class="column-list" data-col-id="{{ col.id }}">
            {% for chat in chats if chat.columna_id == col.id %}
            <a href="/chats/{{ chat.numero }}" class="kanban-card kanban-chat-link" data-chat-num="{{ chat.numero }}" style="text-decoration:none;color:inherit;display:block;">
                <div class="card-content">
                    <div class="card-title-row">
                        <div class="card-avatar-section">
                            {% set avatar_src = '/static/icons/whatsapp-icon.png' %}
                            {% if chat.numero.startswith('tg_') or chat.canal == 'Telegram' %}
                            {% set avatar_src = '/static/icons/telegram-icon-dos.png' %}
                            {% endif %}

                            <img src="{{ avatar_src }}"
                                 class="card-avatar" alt="Avatar"
                                 onerror="this.onerror=null;this.src='/static/icons/default-avatar.png';">
                        </div>
                        {% set bandera = chat.numero | bandera %}
                        {% if bandera %}
                        <img src="{{ bandera }}" class="card-flag" alt="Pa√≠s" title="Pa√≠s">
                        <span class="alias-view" data-num="{{ chat.numero }}" data-nombre="{{ chat.nombre or '' }}" data-alias="{{ chat.alias or '' }}">{{ chat.nombre_mostrado }}</span>
                        <span class="alias-edit" style="display:none;">
                            <input type="text" value="{{ chat.alias or chat.nombre or chat.numero }}" data-num="{{ chat.numero }}" data-alias="{{ chat.alias or '' }}" data-nombre="{{ chat.nombre or '' }}" maxlength="100" style="width:110px;">
                        </span>
                        <span class="card-time">
                            {% if chat.ultima_fecha %}
                            {{ chat.ultima_fecha.strftime('%-d-%b   ').lower() }} {{ chat.ultima_fecha.strftime('%H:%M') }}
                            {% endif %}
                        </span>
                        <button type="button" class="edit-alias-btn" data-num="{{ chat.numero }}" title="Editar nombre">‚úèÔ∏è</button>
                    </div>
                    <div class="card-meta-row">
                        {% endif %}

                        {% if chat.sin_leer > 0 %}
                        <span class="card-unread">{{ chat.sin_leer }}</span>
                        {% endif %}
                    </div>
                    <div class="card-msg">{{ chat.ultimo_mensaje or "&nbsp;" }}</div>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<div id="iconPicker" class="icon-picker" role="menu" aria-hidden="true"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
  // Variables globales para charts
  let overviewChart = null;
  let remainingChart = null;
  let dailyChart = null;
  let platformChart = null; // üÜï NUEVA VARIABLE GLOBAL

  // expose current period to JS (server value on load)
  const CURRENT_PERIOD = '{{ period }}';

  // --- Overview bar chart (existente) ---
  (function renderOverview(){
      const ctx = document.getElementById('barChart') && document.getElementById('barChart').getContext('2d');
      if (!ctx) return;
      const rawValues = {{ values| tojson }};
      const maxValor = rawValues.length ? Math.max(...rawValues) : 0;
      const maxAuto = Math.ceil((maxValor * 1.1) / 5) * 5;
      const data = {
            labels: {{ labels| tojson }},
        datasets: [{
            label: 'Mensajes por n√∫mero',
            data: rawValues,
            backgroundColor: '#1f4e79'
        }]
      };
      if (overviewChart) overviewChart.destroy();
      overviewChart = new Chart(ctx, {
        type: 'bar',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: { duration: 0 },
          plugins: {
            legend: { display: false },
            datalabels: { anchor: 'end', align: 'end', color: '#fff', font: { weight: 'bold', size: 14 } }
          },
          scales: {
            y: { beginAtZero: true, suggestedMax: maxAuto, ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
            x: { ticks: { maxRotation: 45, minRotation: 45, color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
          }
        },
        plugins: [ChartDataLabels]
      });
  })();

  // --- Tab handling ---
  function showTab(tab) {
      // remove active from all tab anchors
      document.querySelectorAll('.tabs a').forEach(a => a.classList.remove('active'));

      if (tab === 'overview') {
          // For overview, activate only the period button matching CURRENT_PERIOD
          let el = document.querySelector(`.tabs a[data-period="${CURRENT_PERIOD}"]`);
          if (!el) {
              // fallback: first overview anchor
              el = document.querySelector('.tabs a[data-tab="overview"]');
          }
          if (el) el.classList.add('active');
      } else {
          // mark anchors that match the tab (normally only the conversation tab)
          document.querySelectorAll(`.tabs a[data-tab="${tab}"]`).forEach(a => a.classList.add('active'));
      }

      // show/hide panes
      document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
      const pane = document.getElementById('pane-' + tab);
      if (pane) pane.classList.add('active');

      if (tab === 'conversaciones') loadConversacionesData();
      // resize charts
      setTimeout(() => {
          if (overviewChart) overviewChart.resize();
          if (remainingChart) remainingChart.resize();
          if (dailyChart) dailyChart.resize();
          if (platformChart) platformChart.resize(); // üÜï Nuevo resize
      }, 200);
  }


  document.querySelectorAll('.tabs a').forEach(a => {
      a.addEventListener('click', function(e){
          const tab = this.getAttribute('data-tab') || 'overview';
          const dp = this.getAttribute('data-period'); // period attribute, if any
          const url = new URL(window.location);

          // Always prevent default: we control navigation explicitly to avoid races
          e.preventDefault();

          // update tab param in url
          if (tab === 'conversaciones') {
              url.searchParams.set('tab', 'conversaciones');
          } else {
              url.searchParams.set('tab', 'overview');
          }

          // If this is a period button, do a full navigation so server re-renders page with new data
          if (dp) {
              url.searchParams.set('period', dp);
              // Use full href navigation (reliable)
              window.location.href = url.toString();
              return;
          }

          // For tabs handled client-side, update history and show tab
          window.history.replaceState({}, '', url);
          showTab(tab);
      });
  });


  // --- Load data and render conversations charts ---
    async function loadConversacionesData() {
        try {
            // Para el dailyChart ahora queremos los √∫ltimos 3 meses agregados por mes:
            const period = '3months';

            // üéØ Llama a la API de Plataformas (el endpoint ya existe en app.py)
            const platformRes = await fetch(`/dashboard/platform-data`);
            const platformJson = await platformRes.json();

            const res = await fetch(`/dashboard/conversaciones-data?period=${period}`);
            const json = await res.json();

            if (json.error) {
                console.error('Error fetching conversaciones data', json.error);
                return;
            }

            // compute plan-related metrics
            const consumed = (json.plan_info && json.plan_info.mensajes_consumidos) ? json.plan_info.mensajes_consumidos : 0;
            const included = (json.plan_info && json.plan_info.mensajes_incluidos) ? json.plan_info.mensajes_incluidos : null;
            const available = (included !== null) ? Math.max(0, included - consumed) : (json.plan_info && json.plan_info.mensajes_disponibles !== undefined ? json.plan_info.mensajes_disponibles : 'N/A');

            // actualizar m√©tricas superiores (only disponibles y consumidos)
            const disponibles = (included !== null) ? available : (json.plan_info && json.plan_info.mensajes_disponibles !== undefined ? json.plan_info.mensajes_disponibles : 'N/A');
            const elDisponibles = document.getElementById('planDisponibles');
            const elConsumidos = document.getElementById('planConsumidos');
            if (elDisponibles) elDisponibles.innerText = disponibles;
            if (elConsumidos) elConsumidos.innerText = consumed;

            // Chart: Remaining / Consumed (pie-like)
            const remCtx = document.getElementById('remainingChart').getContext('2d');
            const pieLabels = included !== null ? ['Consumidos', 'Disponibles'] : ['Conversaciones activas', 'Resto'];
            const pieData = included !== null ? [consumed, Math.max(0, included - consumed)] : [json.active_count || 0, 0];

            if (remainingChart) remainingChart.destroy();
            remainingChart = new Chart(remCtx, {
                type: 'doughnut',
                data: {
                    labels: pieLabels,
                    datasets: [{
                        data: pieData,
                        backgroundColor: ['#e74c3c', '#2ecc71']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: 'white' } },
                        datalabels: { color: 'white', formatter: (v) => v }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // Chart: Monthly conversations (last 3 months)
            const dailyCtx = document.getElementById('dailyChart').getContext('2d');
            const dailyLabels = json.labels || [];
            const dailyValues = json.values || [];

            if (dailyChart) dailyChart.destroy();
            dailyChart = new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: dailyLabels,
                    datasets: [{

                                    label: 'Conversaciones nuevas (√∫ltimos 90 d√≠as)',
                                    data: dailyValues,
                                    borderColor: '#1f4e79',
                                    backgroundColor: 'rgba(31,78,121,0.15)',
                                    fill: true,
                                    tension: 0.2,
                                    pointRadius: 4
                                }]
                        },
                            options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false }, datalabels: { display: false } },
                            scales: {
                                y: { beginAtZero: true, ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.08)' } },
                                x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.06)' } }
                            }
                        }
                        });

            // üÜï Chart: Platform Distribution (Doughnut)
            const platformCtx = document.getElementById('platformChart').getContext('2d');
            const platformData = platformJson.conversations;

            // Definir los colores y mapeo de iconos
            const platformColors = ['#25D366', '#0088CC', '#1f4e79', '#3f80b5', '#60a3cc', '#81c6e3', '#a2e9fa'];
            const iconMap = {
                'WhatsApp': '/static/icons/whatsapp-icon.png',
                'Telegram': '/static/icons/telegram-icon.png',
                // A√±ade m√°s plataformas si es necesario
            };

            if (platformChart) platformChart.destroy();
            platformChart = new Chart(platformCtx, {
                type: 'doughnut',
                data: {
                    labels: platformData.labels,
                    datasets: [{
                        label: 'Conversaciones por Plataforma',
                        data: platformData.values,
                        backgroundColor: platformColors,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'white',
                                // üí• Implementaci√≥n de la funci√≥n customizadora para usar iconos
                                generateLabels: (chart) => {
                                    const data = chart.data.datasets[0];
                                    return data.data.map((value, i) => {
                                        const label = chart.data.labels[i];
                                        const iconUrl = iconMap[label]; // Obtener URL del icono

                                        // Crear una etiqueta HTML personalizada si hay URL de icono
                                        if (iconUrl) {
                                            return {
                                                // Usamos un peque√±o hack HTML para inyectar la imagen en el texto de la leyenda
                                                text: `<img src="${iconUrl}" style="height:16px; margin-right:6px; vertical-align:middle;"> ${label}`,
                                                fillStyle: data.backgroundColor[i],
                                                strokeStyle: data.borderColor,
                                                lineWidth: data.borderWidth,
                                                // Se usa index y hidden para que Chart.js pueda controlar la visibilidad al hacer clic
                                                hidden: chart.getDatasetMeta(0).data[i].hidden,
                                                index: i
                                            };
                                        }

                                        // Retornar etiqueta est√°ndar si no hay icono mapeado
                                        return {
                                            text: label,
                                            fillStyle: data.backgroundColor[i],
                                            strokeStyle: data.borderColor,
                                            lineWidth: data.borderWidth,
                                            hidden: chart.getDatasetMeta(0).data[i].hidden,
                                            index: i
                                        };
                                    });
                                }
                            }
                        },
                        datalabels: {
                            color: 'white',
                            formatter: (value, context) => {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100) + '%';
                                return percentage;
                            }
                        },
                        title: {
                            display: true,
                            text: 'Conversaciones por Plataforma (Clientes Distintos)',
                            color: 'white',
                            font: { size: 16 }
                        }
                    }
                },
                plugins: [
                    ChartDataLabels,
                    // Plugin para habilitar HTML en la leyenda
                    {
                        id: 'htmlLegend',
                        afterUpdate: (chart) => {
                            // Buscar el contenedor <ul> generado por Chart.js
                            const ul = chart.legend.legendItems[0]?.element.closest('ul');
                            if (ul) {
                                ul.style.listStyle = 'none'; // Asegurar que no haya vi√±etas
                                ul.querySelectorAll('li').forEach((li, i) => {
                                    // Obtener la etiqueta generada por generateLabels
                                    const item = chart.options.plugins.legend.labels.generateLabels(chart)[i];
                                    // Si la etiqueta contiene la imagen, inyectarla
                                    if (item && item.text.includes('<img')) {
                                        li.style.cursor = 'pointer';
                                        const text = li.querySelector('span'); // El texto visible est√° dentro de un span
                                        if (text) text.innerHTML = item.text;
                                    }
                                });
                            }
                        }
                    }
                ]
            });


        } catch (err) {
            console.error('Failed to load conversaciones data', err);
        }
    }

  // Si la pesta√±a inicial solicitada en URL es conversaciones, cargar datos.
  // Ahora conversaciones es la pesta√±a por defecto cuando no hay ?tab=
  (function initTabFromUrl(){
      const params = new URLSearchParams(window.location.search);
      if (params.get('tab') === 'overview') {
          showTab('overview');
      } else {
          // default to conversaciones
          showTab('conversaciones');
      }
  })();

  // Resize handlers
  window.addEventListener('resize', () => {
      if (overviewChart) overviewChart.resize();
      if (remainingChart) remainingChart.resize();
      if (dailyChart) dailyChart.resize();
      if (platformChart) platformChart.resize(); // üÜï Asegurar que el nuevo gr√°fico tambi√©n se redimensiona
  });
</script>
{% endblock %}