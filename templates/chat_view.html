<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Chat con {{ chat[2] or chat[1] }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        /* Estilos para mensajes nuevos */
        @keyframes highlightMessage {
            0% {
                background-color: rgba(0, 123, 255, 0.2);
            }

            100% {
                background-color: transparent;
            }
        }

        .new-message {
            animation: highlightMessage 1.5s ease-out forwards;
        }
        /* ensure the edit button receives clicks even if layout changes */
        .edit-alias-btn {
            pointer-events: auto;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <a href="{{ url_for('chats') }}">← Volver</a>
    </div>
    <div class="chatbox">
        <div class="chat-title">
            <div class="card-title-row" style="align-items:center; gap:8px;">
                <span class="alias-view">{{ chat[2] or chat[1] }}</span>

                <span class="alias-edit" style="display:none;">
                    <input type="text" value="{{ chat[2] or '' }}" data-num="{{ chat[1] }}" maxlength="100" style="width: 180px;">
                </span>

                <!-- Inline onclick added as a robust, immediate call -->
                <button type="button"
                        class="edit-alias-btn"
                        data-num="{{ chat[1] }}"
                        title="Editar nombre"
                        style="background:none;border:0;cursor:pointer;font-size:14px;margin-left:6px;"
                        onclick="activarEdicionAlias(this.closest('.card-title-row'))">
                    ✏️
                </button>

                <span style="font-size: 12px; margin-left:8px;">({{ chat[1] }})</span>
            </div>
        </div>

        <button id="btn-toggle-ia" onclick="toggleIA()">IA: <span id="ia-status">{{ 'Activa' if chat[3] else 'Desactivada' }}</span></button>
        <form method="POST" action="{{ url_for('guardar_nota', telefono=chat[1]) }}">
            <textarea name="nota" placeholder="Añadir nota..." maxlength="600">{{ chat[4] }}</textarea>
            <button type="submit">Guardar Nota</button>
        </form>

        <div class="mensajes" id="mensajes-container" aria-live="polite" role="log">
            {% for msg in mensajes %}
            <div class="{{ 'msg-in' if msg[3]=='entrante' else 'msg-out' }}" data-msg-id="{{ msg[0] }}">{{ msg[2] }}</div>
            {% endfor %}
        </div>

        <div class="mensaje-manual">
            <form method="POST" action="/send-manual" class="form-mensaje" id="form-manual">
                <input type="hidden" name="numero" value="{{ chat[1] }}">
                <input type="text" name="texto" placeholder="Escribe un mensaje..." class="input-mensaje" autocomplete="off" required>
                <button type="submit" class="btn-enviar">Enviar</button>
            </form>
        </div>
    </div>

    <script>
        // Minimal client-side logic: scroll to bottom and alias editing (no audio)
        function isScrolledToBottom(el) {
            return el.scrollHeight - el.clientHeight <= el.scrollTop + 60;
        }
        function scrollToBottom(el) { el.scrollTop = el.scrollHeight; }

        function initLastMessageFromDOM(container) {
            try { if (container) setTimeout(() => scrollToBottom(container), 50); }
            catch (e) { console.warn('Initial scroll to bottom failed in chat_view:', e); }
        }

        // Toggle IA - keep existing network call
        function toggleIA() {
            const telefono = "{{ chat[1] }}";
            const statusEl = document.getElementById('ia-status');
            const current = statusEl ? statusEl.textContent.trim().toLowerCase() : '';
            const optimistic = current === 'activa' ? 'Desactivada' : 'Activa';
            fetch("/toggle_ai/" + telefono, { method: "POST", credentials: 'same-origin', cache: 'no-store' })
                .then(resp => {
                    if (resp.redirected) { window.location.href = resp.url; return; }
                    return resp.json().catch(() => ({ ia_activa: null }));
                })
                .then(body => {
                    if (body && typeof body.ia_activa !== 'undefined') {
                        statusEl.textContent = body.ia_activa ? 'Activa' : 'Desactivada';
                    } else {
                        statusEl.textContent = optimistic;
                    }
                }).catch(err => {
                    console.warn('toggleIA error:', err);
                    if (statusEl) statusEl.textContent = optimistic;
                });
        }

        // Alias editing (copied behavior from chats.html) with guard flag
        let isEditingAlias = false;

        function activarEdicionAlias(parent) {
            if (!parent) return;
            console.log('activarEdicionAlias called for parent:', parent);
            const view = parent.querySelector('.alias-view');
            const edit = parent.querySelector('.alias-edit');
            if (!view || !edit) return;
            const input = edit.querySelector('input[type=text]');
            if (!input) return;

            const original = (view.textContent || '').trim();
            if (!input.value || input.value.trim() === '') input.value = original;

            isEditingAlias = true;
            view.style.display = 'none';
            edit.style.display = 'inline-flex';
            input.focus();
            input.select();

            let submitted = false;

            function finishAndRestore(valueToShow) {
                edit.style.display = 'none';
                view.textContent = (typeof valueToShow !== 'undefined' && valueToShow !== null) ? valueToShow : input.dataset.num;
                view.style.display = '';
                // release guard
                isEditingAlias = false;
            }

            function terminar() {
                const nuevo = (input.value || '').trim();
                if (nuevo === '' || nuevo === original) {
                    finishAndRestore(original);
                    return;
                }
                submitted = true;
                fetch(`/contactos/${encodeURIComponent(input.dataset.num)}/alias`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ alias: nuevo })
                }).then(res => {
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return res;
                }).then(() => {
                    finishAndRestore(nuevo);
                }).catch(err => {
                    console.warn('Error guardando alias:', err);
                    finishAndRestore(original);
                }).finally(() => { submitted = false; });
            }

            input.onblur = () => { setTimeout(() => { if (!submitted) terminar(); }, 0); };
            input.onkeydown = (ev) => {
                if (ev.key === 'Enter') { ev.preventDefault(); terminar(); }
                if (ev.key === 'Escape') { edit.style.display = 'none'; view.style.display = ''; isEditingAlias = false; }
            };
        }

        function onEditAliasClick(e) {
            console.log('onEditAliasClick fired', e);
            e.preventDefault(); e.stopPropagation();
            const btn = e.currentTarget || this;
            const parent = btn.closest('.card-title-row') || btn.closest('.chat-title') || btn.closest('.chatbox') || document.body;
            activarEdicionAlias(parent);
        }
        function enhanceAliasButtons() {
            const buttons = Array.from(document.querySelectorAll('.edit-alias-btn'));
            console.log('enhanceAliasButtons found', buttons.length, 'buttons');
            buttons.forEach(btn => {
                try { btn.removeEventListener('click', onEditAliasClick); } catch (e) {}
                btn.addEventListener('click', onEditAliasClick);

                // Also bind pointerdown/touchstart for immediate responsiveness on touch devices
                try { btn.removeEventListener('pointerdown', onEditAliasClick); } catch (e) {}
                btn.addEventListener('pointerdown', onEditAliasClick, { passive: true });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('mensajes-container');
            initLastMessageFromDOM(container);
            try { enhanceAliasButtons(); } catch (e) { console.warn('enhanceAliasButtons failed', e); }
            try { console.log('edit-alias-btn count at ready:', document.querySelectorAll('.edit-alias-btn').length); } catch (e) {}

            // Auto-refresh page every 500ms unless user is editing alias or page is hidden.
            // Be aware: full page reload will reset scroll and any transient client state.
            setInterval(() => {
                if (document.hidden) return;                // avoid reloading in background
                if (isEditingAlias) return;                 // don't interrupt alias editing
                window.location.reload();
            }, 500);
        });
    </script>
</body>
</html>