{% extends "base.html" %}
{% block title %}Conversaciones{% endblock %}


{% block content %}
{% set es_porfirianna = tenant_config.dominio == 'laporfirianna.mektia.com' %}
{% set negocio_nombre = 'La Porfirianna' if es_porfirianna else 'Mektia' %}

<div class="chat-list-header">
  <h2>Conversaciones - {{ negocio_nombre }}</h2>
  <span class="tenant-badge {% if es_porfirianna %}porfirianna-badge{% else %}mektia-badge{% endif %}">
    {{ negocio_nombre }}
  </span>
  <span style="font-size: 12px; color: #666; margin-left: 15px;">
    (Base de datos: {{ tenant_config.db_name }})
  </span>
</div>

<div class="chat-list-header">
  <h2>Conversaciones</h2>
</div>

<div class="chat-layout-v2">
  <!-- Lado izquierdo: Lista -->
  <aside class="chat-list-v2">
    <div class="chat-list-tools">
      <button class="add-contact-btn">+ Agregar Contacto</button>
      <input type="text" placeholder="Buscar chats..." class="search-input">
    </div>

    <div class="chat-items">
      {% for chat in chats %}
      <a href="/chats/{{ chat.numero }}" class="chat-item {% if selected == chat.numero %}selected{% endif %}">
        <div class="chat-avatar">
          <img 
            src="{{ chat.imagen_url or url_for('static', filename='icons/default-avatar.png') }}" 
            alt="Avatar"
            onerror="this.onerror=null;this.src='{{ url_for('static', filename='icons/default-avatar.png') }}';"
            width="40" height="40">
        </div>
        <div class="chat-info">
          <div class="chat-name" style="display:flex;align-items:center;" data-num="{{ chat.numero }}">
            <span class="alias-view">
              {{ chat.nombre_mostrado }}
            </span>
            <span class="alias-edit" style="display:none;">
              <input type="text" value="{{ chat.alias or chat.nombre or '' }}" data-num="{{ chat.numero }}" maxlength="100" style="width: 110px;">
            </span>
            <button type="button" class="edit-alias-btn" data-num="{{ chat.numero }}" title="Editar nombre" style="border:none;background:none;cursor:pointer;">
              ‚úèÔ∏è
            </button>
          </div>
          {% if chat.alias or chat.nombre %}
            <div class="chat-num" style="font-size:11px;color:#888;">
              {{ chat.numero }}
            </div>
          {% endif %}
          <div class="chat-preview">
            {% if chat.ultimo_mensaje %}
              {% if chat.tipo_mensaje == 'imagen' %}
                üì∑ Imagen
              {% else %}
                {{ chat.ultimo_mensaje[:35] }}{% if chat.ultimo_mensaje|length > 35 %}...{% endif %}
              {% endif %}
            {% else %}
              Sin mensajes
            {% endif %}
          </div>
        </div>
        <div class="chat-meta">
          {% if chat.ultima_fecha %}
            <div class="chat-date">{{ chat.ultima_fecha.strftime("%d/%m") }}</div>
            <div class="chat-time">{{ chat.ultima_fecha.strftime("%H:%M") }}</div>
          {% endif %}
        </div>
      </a>
      {% endfor %}
    </div>
  </aside>

  <!-- Centro: Mensajes -->
  <section class="chat-panel-v2">
    {% if selected %}
    <div class="chat-panel-header" data-num="{{ selected }}">
      <div class="chat-header-info">
        <div class="chat-title">
          <span class="alias-view">
            {{ (chats | selectattr("numero", "equalto", selected) | first).nombre_mostrado if (chats | selectattr("numero", "equalto", selected) | first) else selected }}
          </span>
          <span class="alias-edit" style="display:none;">
          {% set chat_info_edit = chats | selectattr("numero", "equalto", selected) | first %}
          <input type="text" value="{{ chat_info_edit.alias if chat_info_edit and chat_info_edit.alias else (chat_info_edit.nombre if chat_info_edit and chat_info_edit.nombre else '') }}" 
                data-num="{{ selected }}" maxlength="100">
          </span>
          <button type="button" class="edit-alias-btn" data-num="{{ selected }}" title="Editar nombre">
            ‚úèÔ∏è
          </button>
        </div>
        <span class="chat-number">{{ selected }}</span>
      </div>
      
      <div class="chat-controls">
        <!-- BADGE DE ESTADO IA/MANUAL -->
        <span class="badge {% if IA_ESTADOS.get(selected, True) %}bg-success{% else %}bg-warning{% endif %}">
            {% if IA_ESTADOS.get(selected, True) %}
                ü§ñ IA ACTIVADA
            {% else %}
                üë§ MODO MANUAL
            {% endif %}
        </span>
        
        <!-- Bot√≥n toggle IA -->
        <form action="/toggle_ai/{{ selected }}" method="POST">
          <button type="submit" class="toggle-btn {{ 'on' if IA_ESTADOS.get(selected, True) else 'off' }}">
            IA {{ 'ON' if IA_ESTADOS.get(selected, True) else 'OFF' }}
          </button>
        </form>
      </div>
    </div>
    {% else %}
    <div class="chat-panel-header">
      <span>Selecciona un chat</span>
    </div>
    {% endif %}
    <div class="msgs-wrap-v2" id="msgs">
      {% if mensajes %}
        {% for msg in mensajes %}
          <!-- Mensaje del usuario -->
          {% if msg.mensaje and msg.mensaje != '[Mensaje manual desde web]' %}
            <div class="msg-box msg-user">
              <div class="message-content">
                {% if msg.tipo_mensaje == 'imagen' and msg.contenido_extra %}
                <div class="msg-box msg-user">
                    <div class="message-content">
                        <div class="image-message">
                            <img src="{{ msg.imagen_url }}" alt="Imagen" class="chat-image">
                            
                            {% if msg.mensaje and msg.mensaje != 'Analiza esta imagen' %}
                            <div class="image-caption">
                                {{ msg.mensaje }}
                            </div>
                            {% endif %}
                  </div>

                {% elif msg.tipo_mensaje == 'audio' and msg.contenido_extra %}
<!-- Mostrar audio con reproductor funcional -->
<div class="audio-player">
    <!-- Reproductor nativo (oculto pero funcional) -->
    <audio id="audio-{{ msg.id }}" class="whatsapp-audio">
        <source src="{{ msg.contenido_extra }}" type="audio/ogg">
        <source src="{{ msg.contenido_extra }}" type="audio/mpeg">
        Tu navegador no soporta el elemento de audio.
    </audio>
    
    <!-- Controles personalizados -->
    <div class="audio-controls">
        <button class="audio-play-btn" onclick="toggleAudio('audio-{{ msg.id }}', this)">
            ‚ñ∂Ô∏è
        </button>
        <div class="audio-progress" onclick="seekAudio('audio-{{ msg.id }}', this, event)">
            <div class="audio-progress-bar"></div>
        </div>
        <span class="audio-duration" id="duration-{{ msg.id }}">0:00</span>
        <a href="{{ msg.contenido_extra }}" download="audio-mensaje.ogg" class="audio-download-btn" title="Descargar audio">
            ‚¨áÔ∏è
        </a>
    </div>
    
    <!-- Transcripci√≥n -->
    {% if msg.transcripcion_audio %}
    <div class="audio-transcription">
        <strong>Transcripci√≥n:</strong> {{ msg.transcripcion_audio }}
    </div>
    {% elif msg.mensaje and msg.mensaje != '[Mensaje manual desde web]' %}
    <div class="audio-transcription">
        <strong>Mensaje:</strong> {{ msg.mensaje }}
    </div>
    {% endif %}
</div>

                {% else %}
                  <!-- Mostrar texto normal -->
                  <div class="text-message">
                    {{ msg.mensaje }}
                  </div>
                {% endif %}
              </div>
              <div class="msg-meta">{{ msg.timestamp.strftime('%H:%M') }}</div>
            </div>
          {% endif %}

          <!-- Mensaje manual desde web -->
          {% if msg.mensaje and msg.mensaje == '[Mensaje manual desde web]' and msg.respuesta %}
            <div class="msg-box msg-manual">
              <div class="message-content">
                <div class="manual-indicator">üì§ Mensaje enviado:</div>
                <div class="text-message">
                  {{ msg.respuesta }}
                </div>
              </div>
              <div class="msg-meta">{{ msg.timestamp.strftime('%H:%M') }}</div>
            </div>
          {% endif %}

          <!-- Respuesta de la IA -->
          {% if msg.respuesta and msg.respuesta != '[Respuesta vac√≠a]' and msg.mensaje != '[Mensaje manual desde web]' %}
            <div class="msg-box msg-ai">
              <div class="message-content">
                <div class="text-message">
                  {{ msg.respuesta }}
                </div>
              </div>
              <div class="msg-meta">{{ msg.timestamp.strftime('%H:%M') }}</div>
            </div>
          {% endif %}
        {% endfor %}
      {% else %}
        <div class="no-chat-selected">
          <p>Selecciona un chat para ver mensajes.</p>
        </div>
      {% endif %}
    </div>

    <!-- FORMULARIO DE MENSAJE MANUAL -->
    {% if selected %}
        {% if not IA_ESTADOS.get(selected, True) %}
        <form method="POST", action="/send-manual" class="reply-form">
            <input type="hidden" name="numero" value="{{ selected }}">
            <div class="input-group">
                <input type="text" name="texto" placeholder="Escribe un mensaje manual..." class="reply-input-line" autocomplete="off" required />
                <button type="submit" class="send-btn">Enviar</button>
            </div>
        </form>
        {% else %}
        <div class="ia-active-message">
          <div class="ia-indicator">
            <span class="ia-icon">ü§ñ</span>
            <span>La IA est√° respondiendo autom√°ticamente</span>
          </div>
          <form action="/toggle_ai/{{ selected }}" method="POST">
            <button type="submit" class="toggle-btn off">
              Desactivar IA
            </button>
          </form>
        </div>
        {% endif %}
    {% endif %}
  </section>

  <!-- Lado derecho - Info del chat -->
  <aside class="sidebar-right">
    {% if selected %}
      <div class="sidebar-section">
        <h3>Acciones</h3>
        <form action="/chats/{{ selected }}/eliminar" method="POST" onsubmit="return confirm('¬øEst√°s seguro de eliminar este chat? Se borrar√° todo el historial.');">
          <button type="submit" class="delete-btn">
            üóëÔ∏è Eliminar Chat
          </button>
        </form>
      </div>
      
      <div class="sidebar-section">
        <h3>Informaci√≥n</h3>
        <div class="chat-info-stats">
          <div class="stat-item">
            <span class="stat-label">Total mensajes:</span>
            <span class="stat-value">{{ mensajes|length if mensajes else 0 }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">√öltima actividad:</span>
            <span class="stat-value">
              {% if mensajes and mensajes[-1].timestamp %}
                {{ mensajes[-1].timestamp.strftime('%d/%m/%Y %H:%M') }}
              {% else %}
                N/A
              {% endif %}
            </span>
          </div>
        </div>
      </div>
    {% endif %}
  </aside>
</div>

<!-- Bot√≥n m√≥vil para mostrar/ocultar lista de chats -->
<button class="mobile-chat-toggle" onclick="toggleChatList()">üí¨</button>

<style>
  .whatsapp-image {
    max-width: 300px;
    max-height: 300px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 8px;
  }

  .image-message {
    padding: 8px;
  }

  .image-caption {
    padding: 8px 12px;
    background-color: #f0f0f0;
    border-radius: 8px;
    margin-top: 8px;
    font-size: 14px;
  }

  .message-content {
    margin-bottom: 4px;
  }

  .manual-indicator {
    font-size: 12px;
    color: #666;
    margin-bottom: 4px;
    font-style: italic;
  }

  .ia-active-message {
    padding: 15px;
    text-align: center;
    background-color: #f8f9fa;
    border-top: 1px solid #dee2e6;
  }

  .ia-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-bottom: 10px;
  }

  .ia-icon {
    font-size: 20px;
  }

  .chat-controls {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .chat-header-info {
    flex: 1;
  }

  .chat-title {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
  }

  .chat-number {
    font-size: 12px;
    color: #666;
  }

  .sidebar-section {
    margin-bottom: 20px;
  }

  .sidebar-section h3 {
    margin-bottom: 10px;
    font-size: 14px;
    color: #333;
  }

  .chat-info-stats {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .stat-label {
    font-size: 12px;
    color: #666;
  }

  .stat-value {
    font-size: 12px;
    font-weight: 500;
    color: #333;
  }

  /* ESTILOS PARA AUDIO PLAYER */
  .audio-player {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 15px;
    margin: 10px 0;
    border: 1px solid #e9ecef;
    max-width: 350px;
  }

  .whatsapp-audio {
    display: none; /* Ocultamos el reproductor nativo */
  }

  .audio-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }

  .audio-play-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    padding: 8px;
    border-radius: 50%;
    background-color: #25D366;
    color: white;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
  }

  .audio-play-btn:hover {
    background-color: #128C7E;
  }

  .audio-progress {
    flex: 1;
    height: 6px;
    background-color: #ddd;
    border-radius: 3px;
    overflow: hidden;
    cursor: pointer;
    position: relative;
  }

  .audio-progress-bar {
    height: 100%;
    background-color: #25D366;
    width: 0%;
    transition: width 0.1s ease;
    border-radius: 3px;
  }

  .audio-duration {
    font-size: 11px;
    color: #666;
    min-width: 35px;
    text-align: center;
    font-family: monospace;
  }

  .audio-download-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    padding: 6px;
    border-radius: 4px;
    color: #666;
    transition: all 0.2s;
  }

  .audio-download-btn:hover {
    color: #25D366;
    background-color: #f0f0f0;
  }

  .audio-transcription {
    background-color: #e8f5e8;
    padding: 10px 12px;
    border-radius: 8px;
    margin-top: 10px;
    font-size: 13px;
    line-height: 1.4;
    border-left: 3px solid #25D366;
  }

  .audio-transcription strong {
    color: #128C7E;
    font-size: 12px;
  }
</style>

<script>
  // Funci√≥n para scroll al final de los mensajes
  function scrollToBottom() {
    const msgsContainer = document.getElementById('msgs');
    if (msgsContainer) {
      msgsContainer.scrollTop = msgsContainer.scrollHeight;
    }
  }

  // Funci√≥n para activar edici√≥n de alias
  function activarEdicionAlias(parent) {
    parent.querySelector('.alias-view').style.display = 'none';
    parent.querySelector('.alias-edit').style.display = 'flex';
    const input = parent.querySelector('input[type=text]');
    input.focus();
    input.select();

    function terminarEdicion() {
      fetch(`/contactos/${input.dataset.num}/alias`, {
        method: 'POST',
        body: new URLSearchParams({alias: input.value}),
        headers: {'Content-Type':'application/x-www-form-urlencoded'}
      }).then(() => {
        parent.querySelector('.alias-edit').style.display = 'none';
        parent.querySelector('.alias-view').textContent = input.value || input.dataset.num;
        parent.querySelector('.alias-view').style.display = '';

        // Actualizar en lista tambi√©n
        document.querySelectorAll('.chat-name').forEach(function(chatName) {
          if(chatName.dataset.num === input.dataset.num) {
            chatName.querySelector('.alias-view').textContent = input.value || input.dataset.num;
          }
        });
      });
    }

    input.onblur = terminarEdicion;
    input.onkeydown = function(e) {
      if (e.key === 'Enter') { 
        e.preventDefault();
        terminarEdicion(); 
      }
      if (e.key === 'Escape') {
        parent.querySelector('.alias-edit').style.display = 'none';
        parent.querySelector('.alias-view').style.display = '';
      }
    };
  }

  // Controlador de audio personalizado
// Controlador de audio mejorado - FUNCI√ìN CORREGIDA
// Controlador de audio mejorado
function toggleAudio(audioId, button) {
    const audioPlayer = document.getElementById(audioId);
    const progressBar = button.closest('.audio-player').querySelector('.audio-progress-bar');
    const durationSpan = button.closest('.audio-player').querySelector('.audio-duration');
    
    if (audioPlayer.paused) {
        audioPlayer.play().then(() => {
            button.textContent = '‚è∏Ô∏è';
            
            // Actualizar barra de progreso
            audioPlayer.ontimeupdate = function() {
                if (audioPlayer.duration && isFinite(audioPlayer.duration)) {
                    const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                    progressBar.style.width = progress + '%';
                    
                    // Actualizar tiempo actual
                    const minutes = Math.floor(audioPlayer.currentTime / 60);
                    const seconds = Math.floor(audioPlayer.currentTime % 60);
                    durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
            };
        }).catch(error => {
            console.error('Error al reproducir audio:', error);
        });
    } else {
        audioPlayer.pause();
        button.textContent = '‚ñ∂Ô∏è';
    }
}

// Funci√≥n para buscar en el audio
function seekAudio(audioId, progressBar, event) {
    const audioPlayer = document.getElementById(audioId);
    const progressBarInner = progressBar.querySelector('.audio-progress-bar');
    const rect = progressBar.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const width = rect.width;
    
    if (audioPlayer.duration && isFinite(audioPlayer.duration)) {
        const clickTime = (clickX / width) * audioPlayer.duration;
        audioPlayer.currentTime = clickTime;
        progressBarInner.style.width = (clickX / width) * 100 + '%';
        
        // Actualizar tiempo visualmente
        const minutes = Math.floor(audioPlayer.currentTime / 60);
        const seconds = Math.floor(audioPlayer.currentTime % 60);
        const durationSpan = progressBar.closest('.audio-player').querySelector('.audio-duration');
        durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
}

// Inicializar todos los audios al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Configurar duraci√≥n de audios
    document.querySelectorAll('.audio-player audio').forEach(audio => {
        audio.addEventListener('loadedmetadata', function() {
            const durationSpan = this.closest('.audio-player').querySelector('.audio-duration');
            if (this.duration && isFinite(this.duration)) {
                const minutes = Math.floor(this.duration / 60);
                const seconds = Math.floor(this.duration % 60);
                durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        });
        
        // Forzar carga de metadata
        if (audio.readyState < 1) {
            audio.load();
        }
        
        // Manejar el final de la reproducci√≥n
        audio.addEventListener('ended', function() {
            const button = this.closest('.audio-player').querySelector('.audio-play-btn');
            if (button) button.textContent = '‚ñ∂Ô∏è';
            
            const progressBar = this.closest('.audio-player').querySelector('.audio-progress-bar');
            if (progressBar) progressBar.style.width = '0%';
        });
    });

    // MutationObserver mejorado (ignora cambios de audio)
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            // Ignorar cambios en elementos de audio
            const isAudioRelated = mutation.target.closest('.audio-player') || 
                                 mutation.target.classList.contains('audio-progress-bar') ||
                                 mutation.target.classList.contains('audio-duration');
            
            if (mutation.addedNodes.length > 0 && !isAudioRelated) {
                let shouldScroll = true;
                
                // Verificar que los nodos a√±adidos no sean de audio
                mutation.addedNodes.forEach(node => {
                    if (node.nodeType === 1 && ( // Element nodes only
                        node.classList.contains('audio-player') || 
                        node.closest('.audio-player') ||
                        node.querySelector('.audio-player')
                    )) {
                        shouldScroll = false;
                    }
                });
                
                if (shouldScroll) {
                    setTimeout(scrollToBottom, 100);
                }
            }
        });
    });
    
    const msgsContainer = document.getElementById('msgs');
    if (msgsContainer) {
        observer.observe(msgsContainer, { 
            childList: true, 
            subtree: true 
        });
    }
});
// Funci√≥n para buscar en el audio - FUNCI√ìN CORREGIDA
function seekAudio(audioId, progressBar, event) {
    const audioPlayer = document.getElementById(audioId);
    const progressBarInner = progressBar.querySelector('.audio-progress-bar');
    const rect = progressBar.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const width = rect.width;
    
    if (audioPlayer.duration && isFinite(audioPlayer.duration)) {
        const clickTime = (clickX / width) * audioPlayer.duration;
        audioPlayer.currentTime = clickTime;
        progressBarInner.style.width = (clickX / width) * 100 + '%';
        
        // Actualizar tiempo visualmente
        const minutes = Math.floor(audioPlayer.currentTime / 60);
        const seconds = Math.floor(audioPlayer.currentTime % 60);
        const durationSpan = progressBar.closest('.audio-player').querySelector('.audio-duration');
        durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
}

// ELIMINA la funci√≥n downloadAudio - ya no es necesaria porque usamos enlace HTML
// function downloadAudio(button) { ... }

// Inicializar todos los audios al cargar la p√°gina - FUNCI√ìN ACTUALIZADA
document.addEventListener('DOMContentLoaded', function() {
    // Configurar duraci√≥n de audios
    document.querySelectorAll('.audio-player audio').forEach(audio => {
        audio.addEventListener('loadedmetadata', function() {
            const durationSpan = this.closest('.audio-player').querySelector('.audio-duration');
            if (this.duration && isFinite(this.duration)) {
                const minutes = Math.floor(this.duration / 60);
                const seconds = Math.floor(this.duration % 60);
                durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        });
        
        // Forzar carga de metadata si es necesario
        if (audio.readyState < 1) {
            audio.load();
        }
        
        // Tambi√©n cargar cuando el audio se puede reproducir
        audio.addEventListener('canplay', function() {
            const durationSpan = this.closest('.audio-player').querySelector('.audio-duration');
            if (this.duration && isFinite(this.duration)) {
                const minutes = Math.floor(this.duration / 60);
                const seconds = Math.floor(this.duration % 60);
                durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        });
        
        // Manejar el final de la reproducci√≥n
        audio.addEventListener('ended', function() {
            const button = this.closest('.audio-player').querySelector('.audio-play-btn');
            if (button) button.textContent = '‚ñ∂Ô∏è';
            
            const progressBar = this.closest('.audio-player').querySelector('.audio-progress-bar');
            if (progressBar) progressBar.style.width = '0%';
        });
    });

    // ... el resto de tu c√≥digo de inicializaci√≥n ...
});
  // Funci√≥n para buscar en el audio
  function seekAudio(progressBar, event) {
    const audioPlayer = progressBar.closest('.audio-player').querySelector('audio');
    const progressBarInner = progressBar.querySelector('.audio-progress-bar');
    const rect = progressBar.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const width = rect.width;
    
    if (audioPlayer.duration) {
      const clickTime = (clickX / width) * audioPlayer.duration;
      audioPlayer.currentTime = clickTime;
      progressBarInner.style.width = (clickX / width) * 100 + '%';
    }
  }

  // Funci√≥n para descargar audio
  function downloadAudio(button) {
    const audioPlayer = button.closest('.audio-player').querySelector('audio');
    const source = audioPlayer.querySelector('source').src;
    const link = document.createElement('a');
    link.href = source;
    link.download = 'audio-mensaje.ogg';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // Inicializar todos los audios al cargar la p√°gina
  document.addEventListener('DOMContentLoaded', function() {
    // Configurar duraci√≥n de audios
    document.querySelectorAll('.audio-player audio').forEach(audio => {
      audio.addEventListener('loadedmetadata', function() {
        const durationSpan = this.closest('.audio-player').querySelector('.audio-duration');
        if (this.duration && isFinite(this.duration)) {
          const minutes = Math.floor(this.duration / 60);
          const seconds = Math.floor(this.duration % 60);
          durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
      });
      
      // Cargar metadata si no se carg√≥ autom√°ticamente
      if (audio.readyState >= 1) {
        audio.dispatchEvent(new Event('loadedmetadata'));
      }
    });

    // Activar edici√≥n en todos los botones ‚úèÔ∏è
    document.querySelectorAll('.edit-alias-btn').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const parent = btn.closest('.chat-title, .chat-name');
        activarEdicionAlias(parent);
      });
    });

    // Scroll autom√°tico al cargar la p√°gina
    scrollToBottom();
    
    // Tambi√©n scroll cuando hay nuevos mensajes
    // Tambi√©n scroll cuando hay nuevos mensajes
const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
        // IGNORAR cambios en elementos de audio y barras de progreso
        const isAudioChange = mutation.target.closest('.audio-player') || 
                             mutation.target.classList.contains('audio-progress-bar');
        
        if (mutation.addedNodes.length > 0 && !isAudioChange) {
            // Verificar que no sean cambios de audio
            let shouldScroll = true;
            mutation.addedNodes.forEach(node => {
                if (node.classList && (
                    node.classList.contains('audio-player') || 
                    node.closest('.audio-player')
                )) {
                    shouldScroll = false;
                }
            });
            
            if (shouldScroll) {
                setTimeout(scrollToBottom, 100);
            }
        }
    });
});
    
    const msgsContainer = document.getElementById('msgs');
    if (msgsContainer) {
      observer.observe(msgsContainer, { 
        childList: true, 
        subtree: true 
      });
    }
  });

  // Toggle lista de chats en m√≥vil
  function toggleChatList() {
    const chatList = document.querySelector('.chat-list-v2');
    chatList.classList.toggle('mobile-visible');
  }
</script>
{% endblock %}