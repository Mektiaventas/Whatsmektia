{% extends "base.html" %}
{% block title %}Conversaciones{% endblock %}

{% block content %}
{% set es_porfirianna = tenant_config.dominio == 'laporfirianna.mektia.com' %}
{% set negocio_nombre = 'La Porfirianna' if es_porfirianna else 'Mektia' %}

<div class="main-header">
  <h1>Conversaciones - {{ negocio_nombre }}</h1>
  <div class="header-info">
    <span class="tenant-badge {% if es_porfirianna %}porfirianna-badge{% else %}mektia-badge{% endif %}">
      {{ negocio_nombre }}
    </span>
    <span class="db-info">
      (Base de datos: {{ tenant_config.db_name }})
    </span>
  </div>
</div>

<div class="chat-layout-v2">
  <!-- Lado izquierdo: Lista -->
  <aside class="chat-list-v2">
    <div class="chat-list-tools">
      <button class="add-contact-btn">+ Agregar Contacto</button>
      <input type="text" placeholder="Buscar chats..." class="search-input">
    </div>

    <!-- Columnas tipo Kanban -->
    <div class="kanban-board">
      <!-- Columna 1: Sin Leads -->
      <div class="kanban-column">
        <div class="column-header">
          <h3>0 Leads</h3>
          <div class="column-count">0</div>
        </div>
        <div class="column-content">
          {% for chat in chats %}
            {% if not chat.leads or chat.leads == 0 %}
              <a href="/chats/{{ chat.numero }}" class="chat-item {% if selected == chat.numero %}selected{% endif %}">
                <div class="chat-avatar">
                  <img 
                    src="{{ chat.imagen_url or url_for('static', filename='icons/default-avatar.png') }}" 
                    alt="Avatar"
                    onerror="this.onerror=null;this.src='{{ url_for('static', filename='icons/default-avatar.png') }}';"
                    width="40" height="40">
                </div>
                <div class="chat-info">
                  <div class="chat-name">{{ chat.nombre_mostrado }}</div>
                  <div class="chat-preview">
                    {% if chat.ultimo_mensaje %}
                      {% if chat.tipo_mensaje == 'imagen' %}
                        üì∑ Imagen
                      {% else %}
                        {{ chat.ultimo_mensaje[:35] }}{% if chat.ultimo_mensaje|length > 35 %}...{% endif %}
                      {% endif %}
                    {% else %}
                      Sin mensajes
                    {% endif %}
                  </div>
                </div>
                <div class="chat-meta">
                  {% if chat.ultima_fecha %}
                    <div class="chat-date">{{ chat.ultima_fecha.strftime("%d/%m") }}</div>
                  {% endif %}
                  {% if chat.no_leidos and chat.no_leidos > 0 %}
                    <div class="unread-badge">{{ chat.no_leidos }}</div>
                  {% endif %}
                </div>
              </a>
            {% endif %}
          {% endfor %}
        </div>
      </div>
      
      <!-- Columna 2: Con Leads -->
      <div class="kanban-column">
        <div class="column-header">
          <h3>23 Leads</h3>
          <div class="column-count">23</div>
        </div>
        <div class="column-content">
          {% for chat in chats %}
            {% if chat.leads and chat.leads > 0 %}
              <a href="/chats/{{ chat.numero }}" class="chat-item {% if selected == chat.numero %}selected{% endif %}">
                <div class="chat-avatar">
                  <img 
                    src="{{ chat.imagen_url or url_for('static', filename='icons/default-avatar.png') }}" 
                    alt="Avatar"
                    onerror="this.onerror=null;this.src='{{ url_for('static', filename='icons/default-avatar.png') }}';"
                    width="40" height="40">
                </div>
                <div class="chat-info">
                  <div class="chat-name">{{ chat.nombre_mostrado }}</div>
                  <div class="chat-preview">
                    {% if chat.ultimo_mensaje %}
                      {% if chat.tipo_mensaje == 'imagen' %}
                        üì∑ Imagen
                      {% else %}
                        {{ chat.ultimo_mensaje[:35] }}{% if chat.ultimo_mensaje|length > 35 %}...{% endif %}
                      {% endif %}
                    {% else %}
                      Sin mensajes
                    {% endif %}
                  </div>
                </div>
                <div class="chat-meta">
                  {% if chat.ultima_fecha %}
                    <div class="chat-date">{{ chat.ultima_fecha.strftime("%d/%m") }}</div>
                  {% endif %}
                  {% if chat.no_leidos and chat.no_leidos > 0 %}
                    <div class="unread-badge">{{ chat.no_leidos }}</div>
                  {% endif %}
                </div>
              </a>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </aside>

  <!-- Centro: Mensajes -->
  <section class="chat-panel-v2">
    {% if selected %}
    <div class="chat-panel-header" data-num="{{ selected }}">
      <div class="chat-header-info">
        <div class="chat-title">
          <span class="alias-view">
            {{ (chats | selectattr("numero", "equalto", selected) | first).nombre_mostrado if (chats | selectattr("numero", "equalto", selected) | first) else selected }}
          </span>
          <span class="alias-edit" style="display:none;">
          {% set chat_info_edit = chats | selectattr("numero", "equalto", selected) | first %}
          <input type="text" value="{{ chat_info_edit.alias if chat_info_edit and chat_info_edit.alias else (chat_info_edit.nombre if chat_info_edit and chat_info_edit.nombre else '') }}" 
                data-num="{{ selected }}" maxlength="100">
          </span>
          <button type="button" class="edit-alias-btn" data-num="{{ selected }}" title="Editar nombre">
            ‚úèÔ∏è
          </button>
        </div>
        <span class="chat-number">{{ selected }}</span>
      </div>
      
      <div class="chat-controls">
        <!-- BADGE DE ESTADO IA/MANUAL -->
        <span class="badge {% if IA_ESTADOS.get(selected, True) %}bg-success{% else %}bg-warning{% endif %}">
            {% if IA_ESTADOS.get(selected, True) %}
                ü§ñ IA ACTIVADA
            {% else %}
                üë§ MODO MANUAL
            {% endif %}
        </span>
        
        <!-- Bot√≥n toggle IA -->
        <form action="/toggle_ai/{{ selected }}" method="POST">
          <button type="submit" class="toggle-btn {{ 'on' if IA_ESTADOS.get(selected, True) else 'off' }}">
            IA {{ 'ON' if IA_ESTADOS.get(selected, True) else 'OFF' }}
          </button>
        </form>
      </div>
    </div>
    {% else %}
    <div class="chat-panel-header">
      <span>Selecciona un chat</span>
    </div>
    {% endif %}
    <div class="msgs-wrap-v2" id="msgs">
      {% if mensajes %}
        {% for msg in mensajes %}
          <!-- Mensaje del usuario (con imagen a la izquierda) -->
          {% if msg.mensaje and msg.mensaje != '[Mensaje manual desde web]' %}
            <div class="msg-box msg-user">
              <div class="message-content">
                {% if msg.es_imagen and msg.imagen_url %}
                  <div class="image-message">
                    <img src="{{ msg.imagen_url }}" alt="Imagen" class="whatsapp-image">
                    {% if msg.mensaje and msg.mensaje != 'Analiza esta imagen' %}
                      <div class="image-caption">
                        {{ msg.mensaje }}
                      </div>
                    {% endif %}
                  </div>
                {% elif msg.tipo_mensaje == 'audio' and msg.contenido_extra %}
                  <!-- Mostrar audio con reproductor funcional -->
                  <div class="audio-player">
                    <!-- Reproductor nativo (oculto pero funcional) -->
                    <audio id="audio-{{ loop.index }}" class="whatsapp-audio">
                      <source src="{{ msg.contenido_extra }}" type="audio/ogg">
                      <source src="{{ msg.contenido_extra }}" type="audio/mpeg">
                      Tu navegador no soporta el elemento de audio.
                    </audio>
                    
                    <!-- Controles personalizados -->
                    <div class="audio-controls">
                      <button class="audio-play-btn" onclick="toggleAudio('audio-{{ loop.index }}', this)">
                        ‚ñ∂Ô∏è
                      </button>
                      <div class="audio-progress" onclick="seekAudio('audio-{{ loop.index }}', this, event)">
                        <div class="audio-progress-bar"></div>
                      </div>
                      <span class="audio-duration" id="duration-{{ loop.index }}">0:00</span>
                      <a href="{{ msg.contenido_extra }}" download="audio-mensaje.ogg" class="audio-download-btn" title="Descargar audio">
                        ‚¨áÔ∏è
                      </a>
                    </div>
                    
                    <!-- Transcripci√≥n -->
                    {% if msg.transcripcion_audio %}
                      <div class="audio-transcription">
                        <strong>Transcripci√≥n:</strong> {{ msg.transcripcion_audio }}
                      </div>
                    {% elif msg.mensaje and msg.mensaje != '[Mensaje manual desde web]' %}
                      <div class="audio-transcription">
                        <strong>Mensaje:</strong> {{ msg.mensaje }}
                      </div>
                    {% endif %}
                  </div>
                {% else %}
                  <!-- Mostrar texto normal -->
                  <div class="text-message">
                    {{ msg.mensaje }}
                  </div>
                {% endif %}
              </div>
              <div class="msg-meta">{{ msg.timestamp.strftime('%H:%M') }}</div>
            </div>
          {% endif %}

          <!-- Mensaje manual desde web -->
          {% if msg.mensaje and msg.mensaje == '[Mensaje manual desde web]' and msg.respuesta %}
            <div class="msg-box msg-manual">
              <div class="message-content">
                <div class="manual-indicator">üì§ Mensaje enviado:</div>
                <div class="text-message">
                  {{ msg.respuesta }}
                </div>
              </div>
              <div class="msg-meta">{{ msg.timestamp.strftime('%H:%M') }}</div>
            </div>
          {% endif %}

          <!-- Respuesta de la IA (a la derecha) -->
          {% if msg.respuesta and msg.respuesta != '[Respuesta vac√≠a]' and msg.mensaje != '[Mensaje manual desde web]' %}
            <div class="msg-box msg-ai">
              <div class="message-content">
                <div class="text-message">
                  {{ msg.respuesta }}
                </div>
              </div>
              <div class="msg-meta">{{ msg.timestamp.strftime('%H:%M') }}</div>
            </div>
          {% endif %}
        {% endfor %}
      {% else %}
        <div class="no-chat-selected">
          <p>Selecciona un chat para ver mensajes.</p>
        </div>
      {% endif %}
    </div>

    <!-- FORMULARIO DE MENSAJE MANUAL -->
    {% if selected %}
        {% if not IA_ESTADOS.get(selected, True) %}
        <form method="POST" action="/send-manual" class="reply-form">
            <input type="hidden" name="numero" value="{{ selected }}">
            <div class="input-group">
                <input type="text" name="texto" placeholder="Escribe un mensaje manual..." class="reply-input-line" autocomplete="off" required />
                <button type="submit" class="send-btn">Enviar</button>
            </div>
        </form>
        {% else %}
        <div class="ia-active-message">
          <div class="ia-indicator">
            <span class="ia-icon">ü§ñ</span>
            <span>La IA est√° respondiendo autom√°ticamente</span>
          </div>
          <form action="/toggle_ai/{{ selected }}" method="POST">
            <button type="submit" class="toggle-btn off">
              Desactivar IA
            </button>
          </form>
        </div>
        {% endif %}
    {% endif %}
  </section>

  <!-- Lado derecho - Info del chat -->
  <aside class="sidebar-right">
    {% if selected %}
      <div class="sidebar-section">
        <h3>Acciones</h3>
        <form action="/chats/{{ selected }}/eliminar" method="POST" onsubmit="return confirm('¬øEst√°s seguro de eliminar este chat? Se borrar√° todo el historial.');">
          <button type="submit" class="delete-btn">
            üóëÔ∏è Eliminar Chat
          </button>
        </form>
      </div>
      
      <div class="sidebar-section">
        <h3>Informaci√≥n</h3>
        <div class="chat-info-stats">
          <div class="stat-item">
            <span class="stat-label">Total mensajes:</span>
            <span class="stat-value">{{ mensajes|length if mensajes else 0 }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">√öltima actividad:</span>
            <span class="stat-value">
              {% if mensajes and mensajes[-1].timestamp %}
                {{ mensajes[-1].timestamp.strftime('%d/%m/%Y %H:%M') }}
              {% else %}
                N/A
              {% endif %}
            </span>
          </div>
        </div>
      </div>
    {% endif %}
  </aside>
</div>

<!-- Bot√≥n m√≥vil para mostrar/ocultar lista de chats -->
<button class="mobile-chat-toggle" onclick="toggleChatList()">üí¨</button>

<style>
  /* ========== VARIABLES & RESET ========= */
  :root {
    /* Paleta institucional */
    --brand-blue:    #002663;  /* azul oscuro */
    --brand-gold:    #FFC20E;  /* dorado */
    --bg-light-1:    #28324E;  /* azul gris√°ceo claro */
    --bg-light-2:    #1A1F2E;  /* azul muy oscuro */
    --bg-dark:       #0A0E18;  /* casi negro azul */
    --card-bg:       rgba(255,255,255,0.9);
    --text-light:    #ECEFF4;  /* blanco suave */
    --text-dark:     #24303C;  /* gris azulado oscuro */
    --border-light:  #CFD8DC;
    
    /* Colores institucionales (del segundo bloque) */
    --bg-page:        #1f2640;  /* fondo general */
    --bg-config:      #2c344f;  /* fondo de secciones de config */
    --bg-card-header: #2a2f48;  /* encabezado de tarjeta */
    --btn-primary:    #8BC34A;  /* verde negocio */
    --btn-secondary:  #ECECEC;  /* gris claro */
    --btn-danger:     #E53935;  /* rojo de "borrar" */
    
    /* Colores para Kanban */
    --kanban-bg-1:    #f0f4f8;
    --kanban-bg-2:    #e8f0fe;
    --kanban-header-1:#4285f4;
    --kanban-header-2:#34a853;
  }

  *, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html, body {
    height: 100%;
  }

  body {
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, var(--bg-light-1) 0%, var(--bg-light-2) 85%, var(--bg-dark) 100%);
    background-attachment: fixed;
    background-repeat: no-repeat;
    background-size: cover;
    min-height: 100vh;
    color: var(--text-brand-blue);
  }

  /* ========== LAYOUT ========= */
  .layout {
    display: flex;
    min-height: 100vh;
  }

  /* Sidebar principal */
  .sidebar {
    position: sticky;
    top: 0;
    width: 240px;
    height: 100vh; 
    background: var(--brand-blue);
    color: #fff;
    padding: 24px 16px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  /* Logo y t√≠tulo */
  .sidebar-logo img {
    max-width: 200px;
    margin-bottom: 12px;
  }
  .sidebar-title {
    font-size: 1.25em;
    font-weight: 600;
    color: var(--brand-gold);
    margin-bottom: 24px;
  }

  /* Navegaci√≥n sidebar */
  .sidebar-nav {
    list-style: none;
    width: 100%;
  }
  .sidebar-nav li {
    margin-bottom: 12px;
  }
  .sidebar-nav a {
    display: block;
    text-decoration: none;
    color: #fff;
    padding: 8px 12px;
    border-radius: 4px;
    transition: background .2s;
  }
  .sidebar-nav a:hover,
  .sidebar-nav li.active > a {
    background: var(--brand-gold);
    color: var(--brand-blue);
  }

  /* Main content transparente para ver el degradado */
  .main-content {
    flex: 1;
    padding: 32px;
    background: transparent;
    overflow-y: auto;
  }

  /* ========== ESTILOS PRINCIPALES ========= */
  .main-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    margin-bottom: 20px;
    background: rgba(37, 37, 59, 0.8);
    border-radius: 12px;
    backdrop-filter: blur(12px);
    color: #fff;
  }

  .main-header h1 {
    margin: 0;
    font-size: 24px;
    font-weight: 600;
  }

  .header-info {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .db-info {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.7);
  }

  .tenant-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    color: white;
  }

  .mektia-badge {
    background: linear-gradient(45deg, #3498db, #2980b9);
  }

  .porfirianna-badge {
    background: linear-gradient(45deg, #e74c3c, #c0392b);
  }

  /* ========== KANBAN BOARD ========= */
  .kanban-board {
    display: flex;
    gap: 16px;
    overflow-x: auto;
    padding-bottom: 10px;
  }

  .kanban-column {
    flex: 1;
    min-width: 280px;
    background: var(--kanban-bg-1);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .kanban-column:nth-child(2) {
    background: var(--kanban-bg-2);
  }

  .column-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: var(--kanban-header-1);
    color: white;
    font-weight: 600;
  }

  .kanban-column:nth-child(2) .column-header {
    background: var(--kanban-header-2);
  }

  .column-header h3 {
    margin: 0;
    font-size: 16px;
  }

  .column-count {
    background: rgba(255,255,255,0.3);
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 12px;
  }

  .column-content {
    padding: 12px;
    max-height: calc(100vh - 200px);
    overflow-y: auto;
  }

  /* ========== CHAT ITEMS ========= */
  .chat-item {
    display: flex;
    align-items: center;
    padding: 12px;
    background: white;
    border-radius: 8px;
    margin-bottom: 10px;
    cursor: pointer;
    text-decoration: none;
    color: #333;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    transition: all 0.2s ease;
  }

  .chat-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  .chat-item.selected {
    background: #fff8e1;
    border-left: 4px solid var(--brand-gold);
  }

  .chat-avatar img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 12px;
    object-fit: cover;
  }

  .chat-info {
    flex: 1;
    min-width: 0;
  }

  .chat-name {
    font-weight: 600;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .chat-preview {
    font-size: 13px;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .chat-meta {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    margin-left: 8px;
  }

  .chat-date {
    font-size: 11px;
    color: #888;
    margin-bottom: 4px;
  }

  .unread-badge {
    background: #f44336;
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 10px;
  }

  /* ========== CHAT PANEL ========= */
  .chat-layout-v2 {
    display: flex;
    height: calc(100vh - 80px);
    max-width: 1400px;
    margin: 0 auto;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 12px;
    overflow: hidden;
  }

  .chat-list-v2 {
    width: 35%;
    background: rgba(30, 30, 47, 0.7);
    border-right: 1px solid rgba(255, 255, 255, 0.15);
    overflow-y: auto;
    backdrop-filter: blur(12px);
    border-radius: 12px 0 0 12px;
    padding: 16px;
  }

  .chat-panel-v2 {
    width: 45%;
    display: flex;
    flex-direction: column;
    background: rgba(30, 30, 47, 0.7);
    backdrop-filter: blur(12px);
  }

  .chat-panel-header {
    padding: 16px;
    background: rgba(37, 37, 59, 0.8);
    color: white;
    font-weight: 600;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .chat-header-info {
    display: flex;
    flex-direction: column;
  }

  .chat-title {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
  }

  .chat-number {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.7);
  }

  .chat-controls {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
  }

  .bg-success {
    background-color: #4caf50;
    color: white;
  }

  .bg-warning {
    background-color: #ff9800;
    color: white;
  }

  .toggle-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .toggle-btn.on {
    background-color: #4caf50;
    color: white;
  }

  .toggle-btn.off {
    background-color: #f44336;
    color: white;
  }

  .msgs-wrap-v2 {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    background: rgba(30, 30, 47, 0.4);
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .msg-box {
    max-width: 80%;
    padding: 12px 16px;
    border-radius: 18px;
    position: relative;
    font-size: 15px;
    line-height: 1.4;
    word-wrap: break-word;
  }

  .msg-box.msg-user {
    align-self: flex-start;
    background: #e3f2fd;
    border: 1px solid #bbdefb;
    border-top-left-radius: 4px;
  }

  .msg-box.msg-ai {
    align-self: flex-end;
    background: #e8f5e9;
    border: 1px solid #c8e6c9;
    border-top-right-radius: 4px;
  }

  .msg-box.msg-manual {
    align-self: flex-end;
    background: #fff3e0;
    border: 1px solid #ffe0b2;
    border-top-right-radius: 4px;
  }

  .msg-meta {
    font-size: 11px;
    color: rgba(0,0,0,0.5);
    margin-top: 4px;
    text-align: right;
  }

  .text-message {
    margin-bottom: 4px;
  }

  .manual-indicator {
    font-size: 12px;
    color: #e65100;
    margin-bottom: 4px;
    font-style: italic;
  }

  .ia-active-message {
    padding: 16px;
    text-align: center;
    background: rgba(37, 37, 59, 0.8);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 16px;
  }

  .ia-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .ia-icon {
    font-size: 20px;
  }

  .reply-form {
    padding: 12px;
    background: rgba(37, 37, 59, 0.8);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  .input-group {
    display: flex;
    gap: 8px;
  }

  .reply-input-line {
    flex: 1;
    padding: 10px 14px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 14px;
  }

  .reply-input-line::placeholder {
    color: rgba(255, 255, 255, 0.6);
  }

  .send-btn {
    padding: 8px 16px;
    background: var(--brand-gold);
    color: var(--brand-blue);
    border: none;
    border-radius: 20px;
    font-weight: 600;
    cursor: pointer;
  }

  /* ========== SIDEBAR DERECHO ========= */
  .sidebar-right {
    width: 20%;
    background: rgba(30, 30, 47, 0.7);
    border-left: 1px solid rgba(255, 255, 255, 0.15);
    padding: 16px;
    backdrop-filter: blur(12px);
    border-radius: 0 12px 12px 0;
    color: white;
  }

  .sidebar-section {
    margin-bottom: 24px;
  }

  .sidebar-section h3 {
    margin-bottom: 12px;
    font-size: 16px;
    color: white;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding-bottom: 8px;
  }

  .delete-btn {
    width: 100%;
    padding: 10px;
    background: #f44336;
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }

  .delete-btn:hover {
    background: #d32f2f;
  }

  .chat-info-stats {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .stat-item {
    display: flex;
    justify-content: space-between;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .stat-label {
    font-size: 14px;
    color: rgba(255, 255, 255, 0.7);
  }

  .stat-value {
    font-size: 14px;
    font-weight: 600;
    color: white;
  }

  /* ========== HERRAMIENTAS DE CHAT ========= */
  .chat-list-tools {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 16px;
  }

  .add-contact-btn {
    padding: 10px;
    background: var(--brand-gold);
    color: var(--brand-blue);
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }

  .add-contact-btn:hover {
    background: #e6ac00;
  }

  .search-input {
    padding: 10px 14px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 14px;
  }

  .search-input::placeholder {
    color: rgba(255, 255, 255, 0.6);
  }

  /* ========== IMAGENES Y AUDIO ========= */
  .whatsapp-image {
    max-width: 250px;
    max-height: 250px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .image-message {
    margin-bottom: 8px;
  }

  .image-caption {
    padding: 8px 12px;
    background-color: rgba(255, 255, 255, 0.7);
    border-radius: 8px;
    margin-top: 8px;
    font-size: 14px;
  }

  .audio-player {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 12px;
    padding: 12px;
    margin: 8px 0;
    border: 1px solid rgba(0,0,0,0.1);
    max-width: 300px;
  }

  .whatsapp-audio {
    display: none;
  }

  .audio-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }

  .audio-play-btn {
    background: #25D366;
    border: none;
    cursor: pointer;
    font-size: 14px;
    padding: 6px;
    border-radius: 50%;
    color: white;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
  }

  .audio-play-btn:hover {
    background-color: #128C7E;
  }

  .audio-progress {
    flex: 1;
    height: 6px;
    background-color: #ddd;
    border-radius: 3px;
    overflow: hidden;
    cursor: pointer;
    position: relative;
  }

  .audio-progress-bar {
    height: 100%;
    background-color: #25D366;
    width: 0%;
    transition: width 0.1s ease;
    border-radius: 3px;
  }

  .audio-duration {
    font-size: 11px;
    color: #666;
    min-width: 35px;
    text-align: center;
    font-family: monospace;
  }

  .audio-download-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    padding: 4px;
    border-radius: 4px;
    color: #666;
    transition: all 0.2s;
  }

  .audio-download-btn:hover {
    color: #25D366;
    background-color: rgba(0,0,0,0.05);
  }

  .audio-transcription {
    background-color: rgba(0,0,0,0.05);
    padding: 8px 12px;
    border-radius: 8px;
    margin-top: 8px;
    font-size: 13px;
    line-height: 1.4;
    border-left: 3px solid #25D366;
  }

  .audio-transcription strong {
    color: #128C7E;
    font-size: 12px;
  }

  /* ========== RESPONSIVE DESIGN ========== */
  @media (max-width: 1200px) {
    .chat-layout-v2 {
      flex-direction: column;
      height: auto;
    }
    .chat-list-v2,
    .chat-panel-v2,
    .sidebar-right {
      width: 100%;
    }
    .chat-list-v2 {
      max-height: 300px;
    }
    .sidebar-right {
      border-radius: 0;
      border-left: none;
      border-top: 1px solid rgba(255, 255, 255, 0.15);
    }
  }

  @media (max-width: 768px) {
    .layout {
      flex-direction: column;
    }
    .sidebar {
      width: 100%;
      height: auto;
      position: relative;
    }
    .main-content {
      padding: 1rem;
    }
    
    .kanban-board {
      flex-direction: column;
    }
    
    .kanban-column {
      min-width: 100%;
    }
    
    .chat-layout-v2 {
      display: block;
      position: relative;
    }
    
    .chat-list-v2 {
      position: fixed;
      left: -100%;
      top: 0;
      width: 80%;
      height: 100vh;
      z-index: 1000;
      background: rgba(30, 30, 47, 0.95);
      transition: left 0.3s ease;
      padding: 1rem;
      box-shadow: 2px 0 10px rgba(0,0,0,0.3);
      border-radius: 0;
    }
    
    .chat-list-v2.mobile-visible {
      left: 0;
    }
    
    .chat-panel-v2 {
      width: 100%;
      min-height: 100vh;
      border-radius: 0;
    }
    
    .mobile-chat-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1001;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--brand-blue);
      color: white;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      display: block;
    }
    
    .sidebar-right {
      display: none;
    }
    
    .chat-panel-header {
      padding: 12px;
      font-size: 14px;
    }
    
    .msg-box {
      max-width: 90%;
      font-size: 14px;
      padding: 10px 14px;
    }
    
    .reply-form {
      padding: 10px;
    }
    
    .input-group {
      gap: 8px;
    }
    
    .reply-input-line {
      padding: 8px 12px;
      font-size: 14px;
    }
    
    .send-btn {
      padding: 8px 14px;
      font-size: 14px;
    }
  }

  @media (max-width: 480px) {
    .main-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }
    
    .chat-list-v2 {
      width: 100%;
    }
    
    .chat-item {
      padding: 10px;
    }
    
    .chat-avatar img {
      width: 35px;
      height: 35px;
    }
    
    .chat-info {
      font-size: 14px;
    }
    
    .chat-preview {
      font-size: 12px;
    }
    
    .chat-meta {
      font-size: 11px;
    }
    
    .msg-box {
      max-width: 95%;
      padding: 8px 12px;
    }
    
    .msg-meta {
      font-size: 10px;
    }
    
    .no-chat-selected {
      text-align: center;
      padding: 2rem;
      color: white;
    }
    
    .ia-active-message {
      padding: 12px;
      font-size: 14px;
      flex-direction: column;
      gap: 10px;
    }
  }

  /* Ocultar bot√≥n toggle en desktop */
  @media (min-width: 769px) {
    .mobile-chat-toggle {
      display: none;
    }
  }
</style>

<script>
  // Funci√≥n para scroll al final de los mensajes
  function scrollToBottom() {
    const msgsContainer = document.getElementById('msgs');
    if (msgsContainer) {
      msgsContainer.scrollTop = msgsContainer.scrollHeight;
    }
  }

  // Funci√≥n para activar edici√≥n de alias
  function activarEdicionAlias(parent) {
    parent.querySelector('.alias-view').style.display = 'none';
    parent.querySelector('.alias-edit').style.display = 'flex';
    const input = parent.querySelector('input[type=text]');
    input.focus();
    input.select();

    function terminarEdicion() {
      fetch(`/contactos/${input.dataset.num}/alias`, {
        method: 'POST',
        body: new URLSearchParams({alias: input.value}),
        headers: {'Content-Type': 'application/x-www-form-urlencoded'}
      }).then(() => {
        parent.querySelector('.alias-edit').style.display = 'none';
        parent.querySelector('.alias-view').textContent = input.value || input.dataset.num;
        parent.querySelector('.alias-view').style.display = '';

        // Actualizar en lista tambi√©n
        document.querySelectorAll('.chat-name').forEach(function(chatName) {
          if (chatName.dataset.num === input.dataset.num) {
            chatName.querySelector('.alias-view').textContent = input.value || input.dataset.num;
          }
        });
      });
    }

    input.onblur = terminarEdicion;
    input.onkeydown = function(e) {
      if (e.key === 'Enter') { 
        e.preventDefault();
        terminarEdicion(); 
      }
      if (e.key === 'Escape') {
        parent.querySelector('.alias-edit').style.display = 'none';
        parent.querySelector('.alias-view').style.display = '';
      }
    };
  }

  // Controlador de audio
  function toggleAudio(audioId, button) {
    const audioPlayer = document.getElementById(audioId);
    const progressBar = button.closest('.audio-player').querySelector('.audio-progress-bar');
    const durationSpan = button.closest('.audio-player').querySelector('.audio-duration');
    
    if (audioPlayer.paused) {
      audioPlayer.play().then(() => {
        button.textContent = '‚è∏Ô∏è';
        audioPlayer.ontimeupdate = function() {
          if (audioPlayer.duration && isFinite(audioPlayer.duration)) {
            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progressBar.style.width = progress + '%';
            const minutes = Math.floor(audioPlayer.currentTime / 60);
            const seconds = Math.floor(audioPlayer.currentTime % 60);
            durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          }
        };
      }).catch(error => console.error('Error al reproducir audio:', error));
    } else {
      audioPlayer.pause();
      button.textContent = '‚ñ∂Ô∏è';
    }
  }

  // Funci√≥n para buscar en el audio
  function seekAudio(audioId, progressBar, event) {
    const audioPlayer = document.getElementById(audioId);
    const progressBarInner = progressBar.querySelector('.audio-progress-bar');
    const rect = progressBar.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const width = rect.width;
    
    if (audioPlayer.duration && isFinite(audioPlayer.duration)) {
      const clickTime = (clickX / width) * audioPlayer.duration;
      audioPlayer.currentTime = clickTime;
      progressBarInner.style.width = (clickX / width) * 100 + '%';
      const minutes = Math.floor(audioPlayer.currentTime / 60);
      const seconds = Math.floor(audioPlayer.currentTime % 60);
      const durationSpan = progressBar.closest('.audio-player').querySelector('.audio-duration');
      durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
  }

  // Inicializar todos los audios al cargar la p√°gina
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.audio-player audio').forEach(audio => {
      audio.addEventListener('loadedmetadata', function() {
        const durationSpan = this.closest('.audio-player').querySelector('.audio-duration');
        if (this.duration && isFinite(this.duration)) {
          const minutes = Math.floor(this.duration / 60);
          const seconds = Math.floor(this.duration % 60);
          durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
      });
      if (audio.readyState < 1) audio.load();
      audio.addEventListener('canplay', function() {
        const durationSpan = this.closest('.audio-player').querySelector('.audio-duration');
        if (this.duration && isFinite(this.duration)) {
          const minutes = Math.floor(this.duration / 60);
          const seconds = Math.floor(this.duration % 60);
          durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
      });
      audio.addEventListener('ended', function() {
        const button = this.closest('.audio-player').querySelector('.audio-play-btn');
        if (button) button.textContent = '‚ñ∂Ô∏è';
        const progressBar = this.closest('.audio-player').querySelector('.audio-progress-bar');
        if (progressBar) progressBar.style.width = '0%';
      });
    });

    document.querySelectorAll('.edit-alias-btn').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const parent = btn.closest('.chat-title, .chat-name');
        activarEdicionAlias(parent);
      });
    });

    scrollToBottom();

    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        const isAudioChange = mutation.target.closest('.audio-player') || 
                             mutation.target.classList.contains('audio-progress-bar');
        if (mutation.addedNodes.length > 0 && !isAudioChange) {
          let shouldScroll = true;
          mutation.addedNodes.forEach(node => {
            if (node.classList && (node.classList.contains('audio-player') || node.closest('.audio-player'))) {
              shouldScroll = false;
            }
          });
          if (shouldScroll) setTimeout(scrollToBottom, 100);
        }
      });
    });
    const msgsContainer = document.getElementById('msgs');
    if (msgsContainer) observer.observe(msgsContainer, { childList: true, subtree: true });
  });

  // Toggle lista de chats en m√≥vil
  function toggleChatList() {
    const chatList = document.querySelector('.chat-list-v2');
    chatList.classList.toggle('mobile-visible');
  }
</script>
{% endblock %}