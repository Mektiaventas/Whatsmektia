{# Agrego la visualizaci√≥n del plan en la parte superior del dashboard #}
{% extends "base.html" %}
{% block title %}Dashboard General{% endblock %}

{% block content %}
<style>
    /* Layout tweaks: reduce vertical spacing to "subir" todo un poco */
    .header-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 0.5rem; /* reduced from 1rem */
        color: white;
    }

        .header-row h1 {
            color: white;
            margin: 0;
            font-size: 1.5rem;
            /* allow title to take available space but not force plan box off */
            flex: 1 1 auto;
            min-width: 0; /* ensure truncation if needed */
        }

    .plan-box {
        background: rgba(255,255,255,0.06);
        padding: 8px 10px;
        border-radius: 8px;
        color: #fff;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
        max-width: 420px;
        font-size: 0.9rem;
        line-height: 1.2;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

        .plan-box .plan-details {
            display: inline-flex;
            flex-direction: column;
            white-space: normal;
        }

        .plan-box .plan-icon {
            font-size: 1.2rem;
        }

        .plan-box .plan-text {
            font-weight: bold;
        }

        .plan-box .plan-limit {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: -3px;
        }


    .tabs {
        display: flex;
        gap: 1rem;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        margin-bottom: 1rem;
    }

        .tabs a {
            padding: 8px 15px;
            text-decoration: none;
            color: #fff;
            opacity: 0.7;
            font-weight: 500;
            transition: opacity 0.2s, background-color 0.2s;
            border-bottom: 3px solid transparent;
        }

        .tabs a.active {
            opacity: 1;
            font-weight: 600;
            border-bottom: 3px solid #007bff; /* Color de acento */
        }

        .tabs a:hover {
            opacity: 0.9;
            background-color: rgba(255,255,255,0.05);
        }
    
    .tab-pane {
        display: none;
        padding-top: 1rem;
    }

    .tab-pane.active {
        display: block;
    }

    /* Cards */
    .stats {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
    }

    .stat-card {
        background: rgba(255,255,255,0.06);
        padding: 15px;
        border-radius: 8px;
        flex: 1;
        min-width: 150px;
        color: white;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        text-align: center;
    }

        .stat-card strong {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .stat-card div {
            font-size: 1.8rem;
            font-weight: 700;
            color: #007bff; /* Color de acento */
        }

    .chart-container {
        position: relative;
        /* Estilos ajustados para que las gr√°ficas sean visibles */
    }
</style>

<div class="header-row">
    <h1>Dashboard General</h1>
    <div class="plan-box" title="{{ plan_info.descripcion }}">
        <span class="plan-icon">üåü</span>
        <div class="plan-details">
            <span class="plan-text">Plan: {{ plan_info.nombre }}</span>
            <span class="plan-limit">L√≠mite: {{ plan_info.limite_mensajes_total | int }}</span>
        </div>
    </div>
</div>

<div class="tabs" style="margin-bottom: 0.3rem;">
    <a data-tab="conversaciones" class="{{ 'active' if request.args.get('tab') == 'conversaciones' or not request.args.get('tab') else '' }}">Conversaciones</a>
    <a data-tab="overview" data-period="year" class="{{ 'active' if period == 'year' and request.args.get('tab') == 'overview' else '' }}" href="?tab=overview&period=year">√öltimo a√±o (mensual)</a>
    <a data-tab="overview" data-period="month" class="{{ 'active' if period == 'month' and request.args.get('tab') == 'overview' else '' }}" href="?tab=overview&period=month">√öltimos 30 d√≠as</a>
</div>

<div id="pane-conversaciones" class="tab-pane {{ 'active' if request.args.get('tab') == 'conversaciones' or not request.args.get('tab') else '' }}">
    <div class="stats">
        <div class="stat-card">
            <strong>Conversaciones iniciadas hoy:</strong>
            <div id="conversacionesHoy">‚Äî</div>
        </div>
        <div class="stat-card">
            <strong>Mensajes recibidos hoy:</strong>
            <div id="mensajesRecibidosHoy">‚Äî</div>
        </div>
        <div class="stat-card">
            <strong>Mensajes enviados hoy:</strong>
            <div id="mensajesEnviadosHoy">‚Äî</div>
        </div>
        <div class="stat-card">
            <strong>Tasa de respuesta IA:</strong>
            <div id="tasaRespuestaIA">‚Äî</div>
        </div>
    </div>

    <div style="display:flex; gap:16px; margin-top: 1rem;">
        <div class="chart-container" style="flex: 1; height:350px; background: rgba(255,255,255,0.9); padding: 12px; border-radius: 8px;">
            <h4 style="text-align: center; color: #333;">Conversaciones por Columna (Hoy)</h4>
            <canvas id="dailyConversationsChart"></canvas>
        </div>
        <div class="chart-container" style="flex: 1; height:350px; background: rgba(255,255,255,0.9); padding: 12px; border-radius: 8px;">
            <h4 style="text-align: center; color: #333;">Mensajes Restantes</h4>
            <canvas id="remainingChart"></canvas>
        </div>
    </div>

    <h2 style="color: white; margin-top: 2rem; margin-bottom: 1rem; font-size: 1.5rem;">Resumen por Plataforma</h2>
    <div class="stats" style="margin-top: 0;">
        <div class="stat-card" style="min-height:64px;height:64px;">
            <strong>Conversaciones por WhatsApp:</strong>
            <div id="whatsappConversations">‚Äî</div>
        </div>
        <div class="stat-card" style="min-height:64px;height:64px;">
            <strong>Conversaciones por Telegram:</strong>
            <div id="telegramConversations">‚Äî</div>
        </div>
        </div>

    <div style="display:flex; gap:16px; margin-top: 1rem; margin-bottom: 2rem;">
        <div class="chart-container" style="flex: 1; height:350px; background: rgba(255,255,255,0.9); padding: 12px; border-radius: 8px;">
            <h4 style="text-align: center; color: #333;">Conversaciones por Plataforma (Total)</h4>
            <canvas id="platformConversationsChart"></canvas>
        </div>
        <div class="chart-container" style="flex: 1; height:350px; background: rgba(255,255,255,0.9); padding: 12px; border-radius: 8px;">
            <h4 style="text-align: center; color: #333;">Contactos por Plataforma (Total)</h4>
            <canvas id="platformContactsChart"></canvas>
        </div>
    </div>
    </div>

<div id="pane-overview" class="tab-pane {{ 'active' if request.args.get('tab') == 'overview' else '' }}">
    <div class="stats">
        <div class="stat-card">
            <strong>Total Mensajes (Per√≠odo):</strong>
            <div id="totalMensajesPeriodo">‚Äî</div>
        </div>
        <div class="stat-card">
            <strong>Total Conversaciones (Per√≠odo):</strong>
            <div id="totalConversacionesPeriodo">‚Äî</div>
        </div>
    </div>
    <div class="chart-container" style="height:400px; margin-top: 1rem; background: rgba(255,255,255,0.9); padding: 12px; border-radius: 8px;">
        <h4 style="text-align: center; color: #333;">Actividad de Conversaci√≥n ({{ 'Mensual' if period == 'year' else 'Diaria' }})</h4>
        <canvas id="overviewChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script>
    Chart.register(ChartDataLabels);

    let overviewChart = null;
    let dailyConversationsChart = null;
    let remainingChart = null;

    // NUEVAS VARIABLES GLOBALES PARA GR√ÅFICAS DE PLATAFORMA
    let platformConversationsChart = null;
    let platformContactsChart = null;
    
    // Funci√≥n para cambiar de pesta√±a
    function showTab(tab) {
        document.querySelectorAll('.tabs a').forEach(a => {
            a.classList.remove('active');
            if (a.getAttribute('data-tab') === tab) {
                // Si el tab es overview, activa solo el enlace con el periodo actual
                if (tab === 'overview') {
                    const period = (new URLSearchParams(window.location.search)).get('period') || 'year';
                    if (a.getAttribute('data-period') === period) {
                        a.classList.add('active');
                    }
                } else {
                    a.classList.add('active');
                }
            }
        });

        // show/hide panes
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
        const pane = document.getElementById('pane-' + tab);
        if (pane) pane.classList.add('active');

        // Cargar datos al cambiar de pesta√±a
        if (tab === 'overview') loadOverviewData();
        if (tab === 'conversaciones') loadConversacionesData();

        // resize charts
        setTimeout(() => {
            if (overviewChart) overviewChart.resize();
            if (remainingChart) remainingChart.resize();
            if (dailyConversationsChart) dailyConversationsChart.resize();
            // RESIZE DE NUEVAS GR√ÅFICAS
            if (platformConversationsChart) platformConversationsChart.resize();
            if (platformContactsChart) platformContactsChart.resize();
        }, 200);
    }

    // Manejar el clic en las pesta√±as
    document.querySelectorAll('.tabs a').forEach(a => {
        a.addEventListener('click', function(e) {
            const tab = this.getAttribute('data-tab');
            if (tab !== 'overview') {
                e.preventDefault();
                // Actualizar URL solo para el tab de conversaciones si es diferente
                if ((new URLSearchParams(window.location.search)).get('tab') !== tab) {
                    history.pushState(null, '', `?tab=${tab}`);
                }
                showTab(tab);
            }
            // Los tabs de overview ya manejan la URL con href
        });
    });

    // --- FUNCIONES DE CARGA DE DATOS ---

    async function loadOverviewData() {
        // Carga y renderizado de overviewChart (mensual/anual)
        const period = (new URLSearchParams(window.location.search)).get('period') || 'year';
        try {
            const res = await fetch(`/dashboard/overview-data?period=${period}`);
            const json = await res.json();
            
            document.getElementById('totalMensajesPeriodo').innerText = json.total_mensajes;
            document.getElementById('totalConversacionesPeriodo').innerText = json.total_conversaciones;

            const ctx = document.getElementById('overviewChart').getContext('2d');
            if (overviewChart) overviewChart.destroy();
            overviewChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: json.labels,
                    datasets: [
                        {
                            label: 'Mensajes Recibidos',
                            data: json.data_recibidos,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.4,
                            pointRadius: 4
                        },
                        {
                            label: 'Mensajes Enviados',
                            data: json.data_enviados,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            tension: 0.4,
                            pointRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top', labels: { color: '#333' } }, datalabels: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#333' }, grid: { color: 'rgba(0,0,0,0.08)' } },
                        x: { ticks: { color: '#333' }, grid: { color: 'rgba(0,0,0,0.06)' } }
                    }
                }
            });

        } catch (err) {
            console.error('Failed to load overview data', err);
        }
    }

    // NUEVA FUNCI√ìN DE CARGA DE DATOS DE PLATAFORMA
    async function loadPlatformData() {
        try {
            const res = await fetch(`/dashboard/platform-data`);
            const json = await res.json();
            if (json.error) {
                console.error('Error fetching platform data', json.error);
                return;
            }

            const convData = json.conversations;
            const contactData = json.contacts;
            
            // Actualizar tarjetas r√°pidas
            // Nota: Si no existe la plataforma, el valor es 0
            const whatsappConv = convData.values[convData.labels.indexOf('WhatsApp')] || 0;
            const telegramConv = convData.values[convData.labels.indexOf('Telegram')] || 0;
            document.getElementById('whatsappConversations').innerText = whatsappConv;
            document.getElementById('telegramConversations').innerText = telegramConv;

            // Renderizar Conversaciones (Chart 1: Doughnut)
            const convCtx = document.getElementById('platformConversationsChart').getContext('2d');
            if (platformConversationsChart) platformConversationsChart.destroy();
            platformConversationsChart = new Chart(convCtx, {
                type: 'doughnut',
                data: {
                    labels: convData.labels,
                    datasets: [{
                        data: convData.values,
                        backgroundColor: ['#25D366', '#0088CC', '#34B7F1', '#ccc'], // Colores para WhatsApp, Telegram, etc.
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#333' } },
                        datalabels: { color: 'white', formatter: (v) => v, font: { weight: 'bold' } }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // Renderizar Contactos (Chart 2: Bar)
            const contactCtx = document.getElementById('platformContactsChart').getContext('2d');
            if (platformContactsChart) platformContactsChart.destroy();
            platformContactsChart = new Chart(contactCtx, {
                type: 'bar',
                data: {
                    labels: contactData.labels,
                    datasets: [{
                        label: 'Contactos',
                        data: contactData.values,
                        backgroundColor: contactData.labels.map(l => {
                            if (l === 'WhatsApp') return '#25D366';
                            if (l === 'Telegram') return '#0088CC';
                            return '#1f4e79';
                        }),
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: { anchor: 'end', align: 'end', color: '#000', font: { weight: 'bold', size: 14 } }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                },
                plugins: [ChartDataLabels]
            });

        } catch (err) {
            console.error('Failed to load platform data', err);
        }
    }


    async function loadConversacionesData() {
        // Carga y renderizado de dailyConversationsChart y remainingChart
        try {
            const res = await fetch(`/dashboard/conversaciones-data`);
            const json = await res.json();

            // 1. Actualizar Stats Cards
            document.getElementById('conversacionesHoy').innerText = json.conversaciones_hoy;
            document.getElementById('mensajesRecibidosHoy').innerText = json.mensajes_recibidos_hoy;
            document.getElementById('mensajesEnviadosHoy').innerText = json.mensajes_enviados_hoy;
            document.getElementById('tasaRespuestaIA').innerText = json.tasa_respuesta_ia + '%';

            // 2. Gr√°fica 1: dailyConversationsChart (Barras)
            const dailyCtx = document.getElementById('dailyConversationsChart').getContext('2d');
            if (dailyConversationsChart) dailyConversationsChart.destroy();
            dailyConversationsChart = new Chart(dailyCtx, {
                type: 'bar',
                data: {
                    labels: json.daily_labels,
                    datasets: [{
                        label: 'Conversaciones',
                        data: json.daily_data,
                        backgroundColor: json.daily_labels.map(l => {
                            if (l === 'Abierta') return '#28a745'; // verde
                            if (l === 'Cerrada') return '#dc3545'; // rojo
                            if (l === 'No Aplica') return '#6c757d'; // gris
                            if (l === 'Llamada') return '#ffc107'; // amarillo
                            return '#007bff'; // azul
                        }),
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'top', color: '#333' } },
                    scales: {
                        y: { beginAtZero: true },
                        x: { }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // 3. Gr√°fica 2: remainingChart (Doughnut)
            const remainingCtx = document.getElementById('remainingChart').getContext('2d');
            if (remainingChart) remainingChart.destroy();
            remainingChart = new Chart(remainingCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Mensajes Restantes', 'Mensajes Utilizados'],
                    datasets: [{
                        data: [json.mensajes_restantes, json.mensajes_utilizados],
                        backgroundColor: ['#007bff', 'rgba(255, 99, 132, 1)'],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#333' } },
                        datalabels: { color: 'white', formatter: (v) => v, font: { weight: 'bold' } }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // 4. NUEVA LLAMADA DE CARGA DE PLATAFORMA
            loadPlatformData(); 

        } catch (err) {
            console.error('Failed to load conversaciones data', err);
        }
    }

  // Si la pesta√±a inicial solicitada en URL es conversaciones, cargar datos.
  // Ahora conversaciones es la pesta√±a por defecto cuando no hay ?tab=
    (function initTabFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const tabFromUrl = params.get('tab');

        if (tabFromUrl === 'overview') {
            showTab('overview');
        } else {
            // default to conversaciones
            showTab('conversaciones');
        }
    })();

  // Resize handlers
  window.addEventListener('resize', () => {
      if (overviewChart) overviewChart.resize();
      if (remainingChart) remainingChart.resize();
      if (dailyConversationsChart) dailyConversationsChart.resize();
      // RESIZE DE NUEVAS GR√ÅFICAS
      if (platformConversationsChart) platformConversationsChart.resize();
      if (platformContactsChart) platformContactsChart.resize();
  });
</script>
{% endblock %}