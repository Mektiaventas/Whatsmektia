{% extends "base.html" %}
{% block title %}Tablero Kanban{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/kanban.css') }}">

<style>
/* Animaciones para nuevos mensajes en el Kanban */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes highlightPulse {
  0% { background-color: rgba(255, 255, 255, 0.1); }
  50% { background-color: rgba(255, 224, 130, 0.4); }
  100% { background-color: rgba(255, 255, 255, 0.1); }
}

@keyframes gentleShake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-3px); }
  75% { transform: translateX(3px); }
}

.kanban-card.new-message {
  animation: 
    fadeIn 0.5s ease-out,
    highlightPulse 2s ease-in-out,
    gentleShake 0.5s ease-in-out;
}

/* Para evitar que la animaci√≥n se repita indefinidamente */
.kanban-card {
  transition: all 0.3s ease;
}
</style>

<div id="kanban-board" class="kanban-board">
  {% for col in columnas %}  <!-- ¬°ESTE LOOP FALTABA! -->
  <div class="kanban-column" data-col-id="{{ col.id }}">
    <div class="column-header">
      <img src="{{ col.icono }}" class="col-icon" alt="">
      <h3 contenteditable="true" data-col-id="{{ col.id }}" class="col-name">{{ col.nombre }}</h3>
      <button class="add-chat-btn" title="Agregar aqu√≠">+</button>
    </div>
    <div class="column-list">
      {% for chat in chats if chat.columna_id == col.id %}
      <a href="/chats/{{ chat.numero }}" class="kanban-card kanban-chat-link" data-chat-num="{{ chat.numero }}" style="text-decoration: none; color: inherit; display: block;">
        <div class="card-avatar-section">
          <img src="{{ chat.avatar or '/static/icons/default-avatar.png' }}" 
               class="card-avatar" alt="Avatar"
               onerror="this.onerror=null;this.src='/static/icons/default-avatar.png';">
        </div>
        <div class="card-content">
          <div class="card-title-row">
            {% set bandera = chat.numero | bandera %}
            {% if bandera %}
              <img src="{{ bandera }}" class="card-flag" alt="Pa√≠s" title="Pa√≠s">
            {% endif %}
            <span class="alias-view" data-num="{{ chat.numero }}">
              {{ chat.nombre_mostrado }}
            </span>
            <span class="alias-edit" style="display:none;">
              <input type="text" value="{{ chat.alias or chat.nombre or chat.numero }}" data-num="{{ chat.numero }}" maxlength="100" style="width: 110px;">
            </span>
            <button type="button" class="edit-alias-btn" data-num="{{ chat.numero }}" title="Editar nombre">
              ‚úèÔ∏è
            </button>
          </div>
          <div class="card-meta-row">
            <span class="card-num">{{ chat.numero }}</span>
            <span class="card-time">
              {% if chat.ultima_fecha %}
                {{ chat.ultima_fecha.strftime('%d/%m %H:%M') }}
              {% endif %}
            </span>
          </div>
          <div class="card-msg">{{ chat.ultimo_mensaje or "&nbsp;" }}</div>
        </div>
        {% if chat.sin_leer > 0 %}
          <span class="card-unread">{{ chat.sin_leer }}</span>
        {% endif %}
      </a>
      {% endfor %}
    </div>
  </div>
  {% endfor %}  <!-- CIERRE DEL LOOP DE COLUMNAS -->
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
// ‚Äî‚Äî‚Äî AUTO-ACTUALIZACI√ìN DEL KANBAN CADA 5 SEGUNDOS ‚Äî‚Äî‚Äî
document.addEventListener('DOMContentLoaded', function() {
    let kanbanAutoRefresh = true;
    let refreshInterval = 5000; // 5 segundos
    
    console.log('üîÑ Iniciando auto-actualizaci√≥n del Kanban cada 5 segundos');
    
    // Funci√≥n para detectar y animar nuevos mensajes
    function animarNuevosMensajes(data) {
      const numerosActuales = new Set(
        Array.from(document.querySelectorAll('.kanban-card'))
          .map(card => card.dataset.chatNum)
      );
      
      // Buscar nuevos mensajes en los datos recibidos
      data.chats.forEach(chat => {
        if (!numerosActuales.has(chat.numero)) {
          // Este es un mensaje nuevo que no estaba antes
          console.log('Nuevo mensaje detectado:', chat.numero);
          
          // Encontrar el elemento correspondiente despu√©s de actualizar
          setTimeout(() => {
            const nuevoElemento = document.querySelector(`.kanban-card[data-chat-num="${chat.numero}"]`);
            if (nuevoElemento) {
              nuevoElemento.classList.add('new-message');
              
              // Remover la clase despu√©s de que termine la animaci√≥n
              setTimeout(() => {
                nuevoElemento.classList.remove('new-message');
              }, 2500);
            }
          }, 100);
        }
      });
    }

    // Funci√≥n para actualizar el Kanban
    function actualizarKanban() {
        if (!kanbanAutoRefresh) return;
        
        fetch('/kanban/data')
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }
            return response.json();
        })
        .then(data => {
            // Actualizar toda la interfaz del Kanban
            actualizarInterfazCompleta(data);
            console.log('‚úÖ Kanban actualizado:', new Date().toLocaleTimeString());
        })
        .catch(error => {
            console.error('‚ùå Error actualizando Kanban:', error);
        });
    }
    
    // Funci√≥n para actualizar toda la interfaz
    function actualizarInterfazCompleta(data) {
        const kanbanBoard = document.getElementById('kanban-board');
        if (!kanbanBoard) return;
        
        // Primero detectamos los mensajes actuales antes de actualizar
        const numerosPrevios = new Set(
          Array.from(document.querySelectorAll('.kanban-card'))
            .map(card => card.dataset.chatNum)
        );
        
        // Reconstruir todo el Kanban con los nuevos datos
        let nuevoHTML = '';
        
        data.columnas.forEach(col => {
            nuevoHTML += `
            <div class="kanban-column" data-col-id="${col.id}">
                <div class="column-header">
                    <img src="${col.icono}" class="col-icon" alt="">
                    <h3 contenteditable="true" data-col-id="${col.id}" class="col-name">${col.nombre}</h3>
                    <button class="add-chat-btn" title="Agregar aqu√≠">+</button>
                </div>
                <div class="column-list">`;
            
            data.chats.filter(chat => chat.columna_id == col.id).forEach(chat => {
                const bandera = getCountryFlag(chat.numero);
                nuevoHTML += `
                <a href="/chats/${chat.numero}" class="kanban-card kanban-chat-link" data-chat-num="${chat.numero}" style="text-decoration: none; color: inherit; display: block;">
                    <div class="card-avatar-section">
                        <img src="${chat.avatar || '/static/icons/default-avatar.png'}" 
                             class="card-avatar" alt="Avatar"
                             onerror="this.onerror=null;this.src='/static/icons/default-avatar.png';">
                    </div>
                    <div class="card-content">
                        <div class="card-title-row">
                            ${bandera ? `<img src="${bandera}" class="card-flag" alt="Pa√≠s" title="Pa√≠s">` : ''}
                            <span class="alias-view" data-num="${chat.numero}">
                                ${chat.nombre_mostrado}
                            </span>
                        </div>
                        <div class="card-meta-row">
                            <span class="card-num">${chat.numero}</span>
                            <span class="card-time">
                                ${chat.ultima_fecha ? new Date(chat.ultima_fecha).toLocaleString() : ''}
                            </span>
                        </div>
                        <div class="card-msg">${chat.ultimo_mensaje || '&nbsp;'}</div>
                    </div>
                    ${chat.sin_leer > 0 ? `<span class="card-unread">${chat.sin_leer}</span>` : ''}
                </a>`;
            });
            
            nuevoHTML += `</div></div>`;
        });
        
        kanbanBoard.innerHTML = nuevoHTML;
        
        // Reinicializar Sortable.js despu√©s de actualizar
        inicializarSortable();
        
        // Animar nuevos mensajes
        setTimeout(() => {
          animarNuevosMensajes({
            chats: data.chats,
            numerosPrevios: numerosPrevios
          });
        }, 50);
    }
    
    // Funci√≥n auxiliar para banderas (simplificada)
    function getCountryFlag(numero) {
        if (!numero) return null;
        const prefijos = {
            '52': 'mx', '1': 'us', '54': 'ar', '57': 'co', '55': 'br',
            '34': 'es', '51': 'pe', '56': 'cl', '58': 've', '593': 'ec'
        };
        
        const numStr = numero.toString().replace('+', '');
        for (let i = 3; i > 0; i--) {
            const prefijo = numStr.substring(0, i);
            if (prefijos[prefijo]) {
                return `https://flagcdn.com/24x18/${prefijos[prefijo]}.png`;
            }
        }
        return null;
    }
    
    // Inicializar Sortable.js
    function inicializarSortable() {
        document.querySelectorAll('.column-list').forEach(list => {
            new Sortable(list, {
                group: 'kanban',
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: evt => {
                    const numero = evt.item.dataset.chatNum;
                    const nuevaCol = evt.to.closest('.kanban-column').dataset.colId;
                    fetch('/kanban/mover', {
                        method: 'POST',
                        headers: { 'Content-Type':'application/json' },
                        body: JSON.stringify({ numero, columna_id: nuevaCol })
                    });
                }
            });
        });
    }
    
    // Iniciar el intervalo
    setInterval(actualizarKanban, refreshInterval);
    
    // Controlar actualizaci√≥n cuando la pesta√±a no est√° visible
    document.addEventListener('visibilitychange', function() {
        kanbanAutoRefresh = !document.hidden;
    });
    
    // Forzar primera actualizaci√≥n
    setTimeout(actualizarKanban, 1000);
});
</script>
{% endblock %}