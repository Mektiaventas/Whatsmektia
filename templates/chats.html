{% extends "base.html" %}
{% block title %}Conversaciones{% endblock %}

{% block content %}
{% set es_porfirianna = tenant_config.dominio == 'laporfirianna.mektia.com' %}
{% set negocio_nombre = 'La Porfirianna' if es_porfirianna else 'Mektia' %}

<div class="chat-list-header">
    <h2>Conversaciones - {{ negocio_nombre }}</h2>
    <span class="tenant-badge {% if es_porfirianna %}porfirianna-badge{% else %}mektia-badge{% endif %}">
        {{ negocio_nombre }}
    </span>
    <span style="font-size: 12px; color: #ffffff; margin-left: 15px;">
        (Base de datos: {{ tenant_config.db_name }})
    </span>
</div>
<div class="chat-layout-v2">
    <!-- Lado izquierdo: Lista -->
    <aside class="chat-list-v2">
        <div class="chat-list-tools">
            <button class="add-contact-btn">+ Agregar Contacto</button>
            <input type="text" placeholder="Buscar chats..." class="search-input">
        </div>

        <div class="chat-items">
            {% for chat in chats %}
            <a href="/chats/{{ chat.numero }}" class="chat-item {% if selected == chat.numero %}selected{% endif %}" data-chat-num="{{ chat.numero }}">
                <div class="card-content">
                    <div class="card-title-row">
                        <div class="card-avatar-section">
                            <img src="{{ chat.imagen_url or url_for('static', filename='icons/default-avatar.png') }}"
                                 class="card-avatar" alt="Avatar"
                                 onerror="this.onerror=null;this.src='{{ url_for('static', filename='icons/default-avatar.png') }}';">
                        </div>
                        {% set bandera = chat.numero | bandera %}
                        {% if bandera %}
                        <img src="{{ bandera }}" class="card-flag" alt="Pa√≠s" title="Pa√≠s">
                        {% endif %}
                        <span class="alias-view" data-num="{{ chat.numero }}">
                            {{ chat.nombre_mostrado }}
                        </span>
                        <span class="alias-edit" style="display:none;">
                            <input type="text" value="{{ chat.alias or chat.nombre or '' }}" data-num="{{ chat.numero }}" maxlength="100" style="width: 110px;">
                        </span>
                        <button type="button" class="edit-alias-btn" data-num="{{ chat.numero }}" title="Editar nombre">
                            ‚úèÔ∏è
                        </button>
                    </div>
                    <div class="card-meta-row">
                        <span class="card-num">{{ chat.numero }}</span>
                        <span class="card-time">
                            {% if chat.ultima_fecha %}
                            {{ chat.ultima_fecha.strftime('%-d-%b ').lower() }} {{ chat.ultima_fecha.strftime('%H:%M') }}
                            {% endif %}
                        </span>
                    </div>
                    <div class="card-msg">
                        {% if chat.ultimo_mensaje %}
                        {% if chat.tipo_mensaje == 'imagen' %}
                        üì∑ Imagen
                        {% else %}
                        {{ chat.ultimo_mensaje[:35] }}{% if chat.ultimo_mensaje|length > 35 %}...{% endif %}
                        {% endif %}
                        {% else %}
                        Sin mensajes
                        {% endif %}
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </aside>

    <!-- Centro: Mensajes -->
    <section class="chat-panel-v2">
        {% if selected %}
        <div class="chat-panel-header" data-num="{{ selected }}">
            <div class="chat-header-info">
                <div class="chat-title">
                    <span class="alias-view">
                        {{ (chats | selectattr("numero", "equalto", selected) | first).nombre_mostrado if (chats | selectattr("numero", "equalto", selected) | first) else selected }}
                    </span>
                    <span class="alias-edit" style="display:none;">
                        {% set chat_info_edit = chats | selectattr("numero", "equalto", selected) | first %}
                        <input type="text" value="{{ chat_info_edit.alias if chat_info_edit and chat_info_edit.alias else (chat_info_edit.nombre if chat_info_edit and chat_info_edit.nombre else '') }}"
                               data-num="{{ selected }}" maxlength="100">
                    </span>
                    <button type="button" class="edit-alias-btn" data-num="{{ selected }}" title="Editar nombre">
                        ‚úèÔ∏è
                    </button>
                </div>
                <span class="chat-number">{{ selected }}</span>
            </div>

            <div class="chat-controls">
                <!-- BADGE DE ESTADO IA/MANUAL -->
                <span class="badge {% if IA_ESTADOS.get(selected, {}).get('activa', True) %}bg-success{% else %}bg-warning{% endif %}">
                    {% if IA_ESTADOS.get(selected, {}).get('activa', True) %}
                    ü§ñ IA ACTIVADA
                    {% else %}
                    üë§ MODO MANUAL
                    {% endif %}
                </span>

                <!-- Bot√≥n toggle IA -->
                <form action="/toggle_ai/{{ selected }}" method="POST">
                    <button type="submit" class="toggle-btn {{ 'on' if IA_ESTADOS.get(selected, {}).get('activa', True) else 'off' }}">
                        IA {{ 'ON' if IA_ESTADOS.get(selected, {}).get('activa', True) else 'OFF' }}
                    </button>
                </form>
            </div>
        </div>
        {% else %}
        <div class="chat-panel-header">
            <span>Selecciona un chat</span>
        </div>
        {% endif %}
        <div class="msgs-wrap-v2" id="msgs">
            {% if mensajes %}
            <!-- Single loop that processes all message types in chronological order -->
            {% for msg in mensajes %}
            {% if msg.mensaje and msg.mensaje != '[Mensaje manual desde web]' %}
            <!-- User message -->
            <div class="msg-box msg-user">
                <div class="message-content">
                    {% if msg.es_imagen and msg.imagen_url %}
                    <div class="image-message">
                        <img src="{{ msg.imagen_url }}" alt="Imagen" class="whatsapp-image">
                        {% if msg.mensaje and msg.mensaje != 'Analiza esta imagen' %}
                        <div class="image-caption">
                            {{ msg.mensaje }}
                        </div>
                        {% endif %}
                    </div>
                    {% elif msg.tipo_mensaje == 'audio' and msg.contenido_extra %}
                    <!-- Mostrar audio con reproductor funcional -->
                    <div class="audio-player">
                        <!-- Reproductor nativo (oculto pero funcional) -->
                        <audio id="audio-{{ loop.index }}" class="whatsapp-audio">
                            <source src="{{ msg.contenido_extra }}" type="audio/ogg">
                            <source src="{{ msg.contenido_extra }}" type="audio/mpeg">
                            Tu navegador no soporta el elemento de audio.
                        </audio>

                        <!-- Controles personalizados -->
                        <div class="audio-controls">
                            <button class="audio-play-btn" onclick="toggleAudio('audio-{{ loop.index }}', this)">
                                ‚ñ∂Ô∏è
                            </button>
                            <div class="audio-progress" onclick="seekAudio('audio-{{ loop.index }}', this, event)">
                                <div class="audio-progress-bar"></div>
                            </div>
                            <span class="audio-duration" id="duration-{{ loop.index }}">0:00</span>
                            <a href="{{ msg.contenido_extra }}" download="audio-mensaje.ogg" class="audio-download-btn" title="Descargar audio">
                                ‚¨áÔ∏è
                            </a>
                        </div>

                        <!-- Transcripci√≥n -->
                        {% if msg.transcripcion_audio %}
                        <div class="audio-transcription">
                            <strong>Transcripci√≥n:</strong> {{ msg.transcripcion_audio }}
                        </div>
                        {% elif msg.mensaje and msg.mensaje != '[Mensaje manual desde web]' %}
                        <div class="audio-transcription">
                            <strong>Mensaje:</strong> {{ msg.mensaje }}
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <!-- Mostrar texto normal -->
                    <div class="text-message">
                        {{ msg.mensaje }}
                    </div>
                    {% endif %}
                </div>
                <div class="msg-meta">{{ msg.timestamp.strftime('%H:%M') }}</div>
            </div>
            {% endif %}

            <!-- Mensaje manual desde web (se muestra en orden cronol√≥gico junto con los dem√°s) -->
            {% if msg.mensaje == '[Mensaje manual desde web]' and msg.respuesta %}
            <div class="msg-box msg-manual">
                <div class="message-content">
                    <div class="manual-indicator">üì§ Mensaje enviado:</div>
                    <div class="text-message">
                        {{ msg.respuesta }}
                    </div>
                </div>
                <div class="msg-meta">{{ msg.timestamp.strftime('%H:%M') }}</div>
            </div>
            {% endif %}

            <!-- Respuesta de la IA (se muestra en orden cronol√≥gico junto con los dem√°s) -->
            {% if msg.respuesta and msg.respuesta != '[Respuesta vac√≠a]' and msg.mensaje != '[Mensaje manual desde web]' %}
            <div class="msg-box msg-ai">
                <div class="message-content">
                    <div class="text-message">
                        {{ msg.respuesta }}
                    </div>
                </div>
                <div class="msg-meta">{{ msg.timestamp.strftime('%H:%M') }}</div>
            </div>
            {% endif %}
            {% endfor %}
            {% else %}
            <div class="no-chat-selected">
                <p>Selecciona un chat para ver mensajes.</p>
            </div>
            {% endif %}
        </div>

        <!-- FORMULARIO DE MENSAJE MANUAL -->
        {% if selected %}
        {% if not IA_ESTADOS.get(selected, {}).get('activa', True) %}
        <form method="POST" action="/send-manual" class="reply-form">
            <input type="hidden" name="numero" value="{{ selected }}">
            <div class="input-group">
                <button type="button" id="emoji-button" class="emoji-btn">üòä</button>
                <input type="text" name="texto" id="mensaje-texto" placeholder="Escribe un mensaje manual..." class="reply-input-line" autocomplete="off" required />
                <button type="submit" class="send-btn">Enviar</button>
            </div>
        </form>
        {% else %}
        <!-- Replace the existing toggle button in the ia-active-message div with this -->
        <div class="ia-active-message">
            <div class="ia-indicator">
                <span class="ia-icon">{{ 'ü§ñ' if IA_ESTADOS.get(selected, {}).get('activa', True) else 'üë§' }}</span>
                <span>{{ 'La IA est√° respondiendo autom√°ticamente' if IA_ESTADOS.get(selected, {}).get('activa', True) else 'Modo manual activado' }}</span>
            </div>
            <form action="/toggle_ai/{{ selected }}" method="POST">
                {% if IA_ESTADOS.get(selected, {}).get('activa', True) %}
                <!-- AI is active, show 'Desactivar IA' -->
                <button type="submit" class="toggle-btn off">Desactivar IA</button>
                {% else %}
                <!-- AI is inactive, show 'Activar IA' -->
                <button type="submit" class="toggle-btn on">Activar IA</button>
                {% endif %}
            </form>
        </div>
        {% endif %}
        {% endif %}
    </section>

    <!-- Lado derecho - Info del chat -->
    <aside class="sidebar-right">
        {% if selected %}
        <div class="sidebar-section">
            <h3>Acciones</h3>
            <form action="/chats/{{ selected }}/eliminar" method="POST" onsubmit="return confirm('¬øEst√°s seguro de eliminar este chat? Se borrar√° todo el historial.');">
                <button type="submit" class="delete-btn">
                    üóëÔ∏è Eliminar Chat
                </button>
            </form>
        </div>

        <div class="sidebar-section">
            <h3>Informaci√≥n</h3>
            <div class="chat-info-stats">
                <div class="stat-item">
                    <span class="stat-label">Total mensajes:</span>
                    <span class="stat-value">{{ mensajes|length if mensajes else 0 }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">√öltima actividad:</span>
                    <span class="stat-value">
                        {% if mensajes and mensajes[-1].timestamp %}
                        {{ mensajes[-1].timestamp.strftime('%d/%m/%Y %H:%M') }}
                        {% else %}
                        N/A
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
        {% endif %}
    </aside>
</div>

<!-- Bot√≥n m√≥vil para mostrar/ocultar lista de chats -->
<button class="mobile-chat-toggle" onclick="toggleChatList()">üí¨</button>

<style>
    /* Los estilos existentes quedan intactos... */

    /* Estilos para el bot√≥n de emojis */
    .emoji-btn {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        padding: 5px 10px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }

        .emoji-btn:hover {
            background-color: #f1f1f1;
        }

    .input-group {
        display: flex;
        align-items: center;
        position: relative;
    }

    .reply-input-line {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    /* Estilos para el selector de emojis */
    .emoji-picker {
        position: absolute;
        bottom: 60px;
        left: 0;
        z-index: 1000;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        width: 320px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
    }

        .emoji-picker.active {
            display: block;
        }

    .emoji-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 8px;
        padding: 12px;
    }

    .emoji-item {
        cursor: pointer;
        font-size: 24px;
        padding: 5px;
        text-align: center;
        border-radius: 6px;
        transition: background-color 0.2s;
        user-select: none;
    }

        .emoji-item:hover {
            background-color: #f1f1f1;
        }
    .whatsapp-image {
        max-width: 300px;
        max-height: 300px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 8px;
    }

    .image-message {
        padding: 8px;
    }

    .image-caption {
        padding: 8px 12px;
        background-color: #f0f0f0;
        border-radius: 8px;
        margin-top: 8px;
        font-size: 14px;
    }

    .message-content {
        margin-bottom: 4px;
    }

    .manual-indicator {
        font-size: 12px;
        color: #666;
        margin-bottom: 4px;
        font-style: italic;
    }

    .ia-active-message {
        padding: 15px;
        text-align: center;
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
    }

    .ia-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 10px;
    }
    .card-flag {
        width: 18px;
        height: 14px;
        border-radius: 3px;
        margin-right: 5px;
        vertical-align: middle;
        object-fit: cover;
        box-shadow: 0 0 2px #0002;
        border: 1px solid #ddd;
    }
    .ia-icon {
        font-size: 20px;
    }

    .chat-controls {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .chat-header-info {
        flex: 1;
    }

    .chat-title {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
    }

    .chat-number {
        font-size: 12px;
        color: #666;
    }

    .sidebar-section {
        margin-bottom: 20px;
    }

        .sidebar-section h3 {
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
        }

    .chat-info-stats {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .stat-label {
        font-size: 12px;
        color: #666;
    }

    .stat-value {
        font-size: 12px;
        font-weight: 500;
        color: #333;
    }

    /* Estilos para mensajes */
    .msg-box {
        display: flex;
        flex-direction: column;
        margin: 10px 0;
        max-width: 70%;
    }

    .msg-user {
        align-self: flex-start; /* Izquierda para usuario */
        background-color: #e3f2fd; /* Azul claro */
    }

    .msg-ai {
        align-self: flex-end; /* Derecha para IA */
        background-color: #d1e7dd; /* Verde claro */
    }

    .msg-manual {
        align-self: flex-end; /* Derecha para mensajes manuales */
        background-color: #f8f9fa; /* Gris claro */
    }

    .message-content {
        padding: 10px;
        border-radius: 10px;
    }

    .text-message {
        word-wrap: break-word;
    }

    .msg-meta {
        font-size: 12px;
        color: #666;
        text-align: right;
        margin-top: 4px;
    }

    /* Estilos para audio */
    .audio-player {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 15px;
        margin: 10px 0;
        border: 1px solid #e9ecef;
        max-width: 350px;
    }

    .whatsapp-audio {
        display: none;
    }

    .audio-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
    }

    .audio-play-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        padding: 8px;
        border-radius: 50%;
        background-color: #25D366;
        color: white;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
    }

        .audio-play-btn:hover {
            background-color: #128C7E;
        }

    .audio-progress {
        flex: 1;
        height: 6px;
        background-color: #ddd;
        border-radius: 3px;
        overflow: hidden;
        cursor: pointer;
        position: relative;
    }

    .audio-progress-bar {
        height: 100%;
        background-color: #25D366;
        width: 0%;
        transition: width 0.1s ease;
        border-radius: 3px;
    }

    .audio-duration {
        font-size: 11px;
        color: #666;
        min-width: 35px;
        text-align: center;
        font-family: monospace;
    }

    .audio-download-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        padding: 6px;
        border-radius: 4px;
        color: #666;
        transition: all 0.2s;
    }

        .audio-download-btn:hover {
            color: #25D366;
            background-color: #f0f0f0;
        }

    .audio-transcription {
        background-color: #e8f5e8;
        padding: 10px 12px;
        border-radius: 8px;
        margin-top: 10px;
        font-size: 13px;
        line-height: 1.4;
        border-left: 3px solid #25D366;
    }

        .audio-transcription strong {
            color: #128C7E;
            font-size: 12px;
        }
    /* Estilos para chats al estilo kanban */
    .chat-item {
        display: block;
        background-color: white;
        border-radius: 8px;
        margin-bottom: 10px;
        padding: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        transition: all 0.2s ease;
        text-decoration: none;
        color: white;
    }

        .chat-item:hover {
            background-color: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }

        .chat-item.selected {
            background-color: #e7f3ff;
            border-left: 3px solid #2684FF;
            color: white;
        }

    .card-content {
        width: 100%;
        color: white;
    }

    .card-title-row {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }

    .card-avatar-section {
        margin-right: 10px;
    }

    .card-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }

    .card-meta-row {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: #888;
        margin-bottom: 6px;
    }

    .card-num {
        color: #888;
        font-size: 11px;
    }

    .card-time {
        font-size: 11px;
        color: #888;
    }

    .card-msg {
        color: white;
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.3;
    }

    .edit-alias-btn {
        border: none;
        background: none;
        cursor: pointer;
        font-size: 12px;
        padding: 2px 5px;
        margin-left: 5px;
        opacity: 0.6;
    }

        .edit-alias-btn:hover {
            opacity: 1;
        }

    .card-flag {
        width: 18px;
        height: 14px;
        border-radius: 3px;
        margin-right: 5px;
        vertical-align: middle;
        object-fit: cover;
        box-shadow: 0 0 2px rgba(0,0,0,0.1);
        border: 1px solid #ddd;
    }

    .alias-view {
        font-weight: 500;
        flex-grow: 1;
    }

    /* Animaci√≥n de chat nuevo */
    @keyframes highlightChat {
        0% {
            background-color: inherit;
        }

        30% {
            background-color: #e7f3ff;
        }

        100% {
            background-color: inherit;
        }
    }

    .chat-item.new-message {
        animation: highlightChat 2s ease-in-out;
    }
</style>

<script>
// Auto-refresh functionality for chat list
let chatAutoRefresh = true;
let refreshInterval = 500; // Half a second
let selectedChatId = "{{ selected }}";
let lastUpdateTimestamp = new Date().getTime();

function startChatRefresh() {
  console.log("üîÑ Starting chat list auto-refresh");
  setInterval(actualizarListaChats, refreshInterval);
}

    function actualizarListaChats() {
        if (!chatAutoRefresh) {
            console.log("‚è∏Ô∏è Auto-refresh paused");
            return;
        }

        fetch('/chats/data')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error fetching chat data');
                }
                return response.json();
            })
            .then(data => {
                console.log(`üìä Got ${data.chats?.length || 0} chats from server`);

                if (data.timestamp <= lastUpdateTimestamp) {
                    console.log("‚è≠Ô∏è No new data since last update");
                    return; // No new data
                }

                lastUpdateTimestamp = data.timestamp;
                actualizarListaChatsIncremental(data.chats);
                console.log("‚úÖ Chat list updated:", new Date().toLocaleTimeString());
            })
            .catch(error => {
                console.error("‚ùå Error updating chat list:", error);
            });
    }

    // Modificar la funci√≥n actualizarListaChats para preservar la posici√≥n del scroll
function actualizarChatExistente(elemento, chat) {
  // Update chat preview (last message)
  const previewElement = elemento.querySelector('.chat-preview');
  if (previewElement && chat.ultimo_mensaje) {
    const nuevoTexto = chat.tipo_mensaje === 'imagen' ?
      'üì∑ Imagen' :
      `${chat.ultimo_mensaje.substring(0, 35)}${chat.ultimo_mensaje.length > 35 ? '...' : ''}`;

    if (previewElement.textContent.trim() !== nuevoTexto.trim()) {
      previewElement.textContent = nuevoTexto;
      elemento.classList.add('new-message'); // Add highlight class
      setTimeout(() => {
        elemento.classList.remove('new-message');
      }, 2500);
    }
  }

  // Update time
  const timeElement = elemento.querySelector('.chat-time');
  if (timeElement && chat.ultima_fecha) {
    const fecha = new Date(chat.ultima_fecha);
    timeElement.textContent = fecha.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  // Update date
  const dateElement = elemento.querySelector('.chat-date');
  if (dateElement && chat.ultima_fecha) {
    const fecha = new Date(chat.ultima_fecha);
    dateElement.textContent = fecha.toLocaleDateString([], { day: '2-digit', month: '2-digit' });
  }
}

function crearNuevoChatHTML(chat) {
  const isSelected = chat.numero === selectedChatId;
  const avatarUrl = chat.imagen_url || '/static/icons/default-avatar.png';
  const nombreMostrado = chat.nombre_mostrado || chat.numero;
  const ultimoMensaje = chat.tipo_mensaje === 'imagen' ?
    'üì∑ Imagen' :
    (chat.ultimo_mensaje ?
      `${chat.ultimo_mensaje.substring(0, 35)}${chat.ultimo_mensaje.length > 35 ? '...' : ''}` :
      'Sin mensajes');

  return `
<a href="/chats/${chat.numero}" class="chat-item ${isSelected ? 'selected' : ''}">
    <div class="chat-avatar">
        <img src="${avatarUrl}"
             alt="Avatar"
             onerror="this.onerror=null;this.src='/static/icons/default-avatar.png';"
             width="40" height="40">
    </div>
    <div class="chat-info">
        <div class="chat-name" style="display:flex;align-items:center;" data-num="${chat.numero}">
            <span class="alias-view">
                ${nombreMostrado}
            </span>
            <span class="alias-edit" style="display:none;">
                <input type="text" value="${chat.alias || chat.nombre || ''}" data-num="${chat.numero}" maxlength="100" style="width: 110px;">
            </span>
            <button type="button" class="edit-alias-btn" data-num="${chat.numero}" title="Editar nombre" style="border:none;background:none;cursor:pointer;">
                ‚úèÔ∏è
            </button>
        </div>
        ${(chat.alias || chat.nombre) ?
        `<div class="chat-num" style="font-size:11px;color:#888;">
            ${chat.numero}
        </div>` : ''}
        <div class="chat-preview">
            ${ultimoMensaje}
        </div>
    </div>
    <div class="chat-meta">
        ${chat.ultima_fecha ?
        `<div class="chat-date">${new Date(chat.ultima_fecha).toLocaleDateString([], {day: '2-digit', month: '2-digit'})}</div>
        <div class="chat-time">${new Date(chat.ultima_fecha).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</div>` : ''}
    </div>
</a>
  `;
}

// Add highlight animation style
const style = document.createElement('style');
style.textContent = `
  @keyframes highlightChat {
    0% { background-color: inherit; }
    30% { background-color: #e7f3ff; }
    100% { background-color: inherit; }
  }

  .chat-item.new-message {
    animation: highlightChat 2s ease-in-out;
  }
`;
document.head.appendChild(style);

// Pause refresh when tab is not visible to save resources
document.addEventListener('visibilitychange', function() {
  chatAutoRefresh = !document.hidden;
});

// Start the refresh cycle when page loads
document.addEventListener('DOMContentLoaded', function() {
  if (document.querySelector('.chat-items')) {
    startChatRefresh();
  }
});
  // Funci√≥n para scroll al final de los mensajes
  function scrollToBottom() {
    const msgsContainer = document.getElementById('msgs');
    if (msgsContainer) {
      msgsContainer.scrollTop = msgsContainer.scrollHeight;
    }
  }

  // Funci√≥n para activar edici√≥n de alias
  function activarEdicionAlias(parent) {
    parent.querySelector('.alias-view').style.display = 'none';
    parent.querySelector('.alias-edit').style.display = 'flex';
    const input = parent.querySelector('input[type=text]');
    input.focus();
    input.select();

    function terminarEdicion() {
      fetch(`/contactos/${input.dataset.num}/alias`, {
        method: 'POST',
        body: new URLSearchParams({alias: input.value}),
        headers: {'Content-Type': 'application/x-www-form-urlencoded'}
      }).then(() => {
        parent.querySelector('.alias-edit').style.display = 'none';
        parent.querySelector('.alias-view').textContent = input.value || input.dataset.num;
        parent.querySelector('.alias-view').style.display = '';

        // Actualizar en lista tambi√©n
        document.querySelectorAll('.chat-name').forEach(function(chatName) {
          if (chatName.dataset.num === input.dataset.num) {
            chatName.querySelector('.alias-view').textContent = input.value || input.dataset.num;
          }
        });
      });
    }

    input.onblur = terminarEdicion;
    input.onkeydown = function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        terminarEdicion();
      }
      if (e.key === 'Escape') {
        parent.querySelector('.alias-edit').style.display = 'none';
        parent.querySelector('.alias-view').style.display = '';
      }
    };
  }

  // Controlador de audio
  function toggleAudio(audioId, button) {
    const audioPlayer = document.getElementById(audioId);
    const progressBar = button.closest('.audio-player').querySelector('.audio-progress-bar');
    const durationSpan = button.closest('.audio-player').querySelector('.audio-duration');

    if (audioPlayer.paused) {
      audioPlayer.play().then(() => {
        button.textContent = '‚è∏Ô∏è';
        audioPlayer.ontimeupdate = function() {
          if (audioPlayer.duration && isFinite(audioPlayer.duration)) {
            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progressBar.style.width = progress + '%';
            const minutes = Math.floor(audioPlayer.currentTime / 60);
            const seconds = Math.floor(audioPlayer.currentTime % 60);
            durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          }
        };
      }).catch(error => console.error('Error al reproducir audio:', error));
    } else {
      audioPlayer.pause();
      button.textContent = '‚ñ∂Ô∏è';
    }
  }

  // Funci√≥n para buscar en el audio
  function seekAudio(audioId, progressBar, event) {
    const audioPlayer = document.getElementById(audioId);
    const progressBarInner = progressBar.querySelector('.audio-progress-bar');
    const rect = progressBar.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const width = rect.width;

    if (audioPlayer.duration && isFinite(audioPlayer.duration)) {
      const clickTime = (clickX / width) * audioPlayer.duration;
      audioPlayer.currentTime = clickTime;
      progressBarInner.style.width = (clickX / width) * 100 + '%';
      const minutes = Math.floor(audioPlayer.currentTime / 60);
      const seconds = Math.floor(audioPlayer.currentTime % 60);
      const durationSpan = progressBar.closest('.audio-player').querySelector('.audio-duration');
      durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
  }

  // Inicializar todos los audios al cargar la p√°gina
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.audio-player audio').forEach(audio => {
      audio.addEventListener('loadedmetadata', function() {
        const durationSpan = this.closest('.audio-player').querySelector('.audio-duration');
        if (this.duration && isFinite(this.duration)) {
          const minutes = Math.floor(this.duration / 60);
          const seconds = Math.floor(this.duration % 60);
          durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
      });
      if (audio.readyState < 1) audio.load();
      audio.addEventListener('canplay', function() {
        const durationSpan = this.closest('.audio-player').querySelector('.audio-duration');
        if (this.duration && isFinite(this.duration)) {
          const minutes = Math.floor(this.duration / 60);
          const seconds = Math.floor(this.duration % 60);
          durationSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
      });
      audio.addEventListener('ended', function() {
        const button = this.closest('.audio-player').querySelector('.audio-play-btn');
        if (button) button.textContent = '‚ñ∂Ô∏è';
        const progressBar = this.closest('.audio-player').querySelector('.audio-progress-bar');
        if (progressBar) progressBar.style.width = '0%';
      });
    });

    document.querySelectorAll('.edit-alias-btn').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const parent = btn.closest('.chat-title, .chat-name');
        activarEdicionAlias(parent);
      });
    });

    scrollToBottom();

    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        const isAudioChange = mutation.target.closest('.audio-player') ||
                             mutation.target.classList.contains('audio-progress-bar');
        if (mutation.addedNodes.length > 0 && !isAudioChange) {
          let shouldScroll = true;
          mutation.addedNodes.forEach(node => {
            if (node.classList && (node.classList.contains('audio-player') || node.closest('.audio-player'))) {
              shouldScroll = false;
            }
          });
          if (shouldScroll) setTimeout(scrollToBottom, 100);
        }
      });
    });
    const msgsContainer = document.getElementById('msgs');
    if (msgsContainer) observer.observe(msgsContainer, { childList: true, subtree: true });
  });

  // Toggle lista de chats en m√≥vil
  function toggleChatList() {
    const chatList = document.querySelector('.chat-list-v2');
      chatList.classList.toggle('mobile-visible');

    }
    if (window.location.pathname === '/kanban') {
        actualizarKanban();
    }

    // Funci√≥n para el selector de emojis
    document.addEventListener('DOMContentLoaded', function () {
        // Lista de emojis comunes
        const commonEmojis = [
            'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ', 'üôÇ', 'üòä',
            'üòá', 'ü•∞', 'üòç', 'ü§©', 'üòò', 'üòó', '‚ò∫Ô∏è', 'üòö', 'üòô',
            'üòã', 'üòõ', 'üòú', 'ü§™', 'üòù', 'ü§ë', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î',
            'üëç', 'üëé', '‚ù§Ô∏è', 'üî•', 'üéâ', 'üéÇ', 'üéÅ', 'üëè', 'üôè', 'üëã',
            'üíØ', '‚≠ê', '‚ú®', '‚ö°', 'üåü', 'üåà', '‚òÄÔ∏è', '‚òÅÔ∏è', 'üåßÔ∏è', '‚ùÑÔ∏è',
            'üçï', 'üçî', 'üçü', 'üåÆ', 'üç∞', 'üç©', '‚òï', 'üç∑', 'ü•Ç', 'üç∫'
        ];

        const emojiButton = document.getElementById('emoji-button');
        if (emojiButton) {
            // Crear el selector de emojis
            const emojiPicker = document.createElement('div');
            emojiPicker.className = 'emoji-picker';

            // Crear la cuadr√≠cula de emojis
            const emojiGrid = document.createElement('div');
            emojiGrid.className = 'emoji-grid';

            // Agregar los emojis a la cuadr√≠cula
            commonEmojis.forEach(emoji => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'emoji-item';
                emojiItem.textContent = emoji;

                // Agregar emoji al campo de texto cuando se hace clic
                emojiItem.addEventListener('click', function () {
                    const mensajeInput = document.getElementById('mensaje-texto');
                    if (mensajeInput) {
                        // Insertar emoji en la posici√≥n del cursor
                        const cursorPos = mensajeInput.selectionStart;
                        const textBefore = mensajeInput.value.substring(0, cursorPos);
                        const textAfter = mensajeInput.value.substring(cursorPos);

                        mensajeInput.value = textBefore + emoji + textAfter;

                        // Actualizar posici√≥n del cursor
                        const newCursorPos = cursorPos + emoji.length;
                        mensajeInput.setSelectionRange(newCursorPos, newCursorPos);
                        mensajeInput.focus();
                    }

                    // Cerrar el selector despu√©s de elegir
                    emojiPicker.classList.remove('active');
                });

                emojiGrid.appendChild(emojiItem);
            });

            emojiPicker.appendChild(emojiGrid);

            // Agregar el selector al DOM
            const replyForm = document.querySelector('.reply-form');
            if (replyForm) {
                replyForm.appendChild(emojiPicker);

                // Mostrar/ocultar el selector al hacer clic en el bot√≥n
                emojiButton.addEventListener('click', function (e) {
                    e.preventDefault();
                    emojiPicker.classList.toggle('active');
                });

                // Cerrar el selector al hacer clic fuera
                document.addEventListener('click', function (e) {
                    if (!emojiButton.contains(e.target) && !emojiPicker.contains(e.target)) {
                        emojiPicker.classList.remove('active');
                    }
                });
            }
        }
    });

    function actualizarListaChatsIncremental(chats) {
        const chatContainer = document.querySelector('.chat-items');
        if (!chatContainer) return;

        console.log(`üîÑ Processing ${chats.length} chats for updates`);

        // Process each chat from the API
        chats.forEach(chat => {
            // Check if this chat item already exists
            const existingChat = document.querySelector(`.chat-item[data-chat-num="${chat.numero}"]`);

            if (existingChat) {
                // Update existing chat item
                const msgEl = existingChat.querySelector('.card-msg');
                if (msgEl && chat.ultimo_mensaje) {
                    const currentText = msgEl.textContent.trim();
                    const newText = chat.tipo_mensaje === 'imagen' ?
                        'üì∑ Imagen' :
                        `${chat.ultimo_mensaje.substring(0, 35)}${chat.ultimo_mensaje.length > 35 ? '...' : ''}`;

                    if (currentText !== newText) {
                        msgEl.textContent = newText;
                        existingChat.classList.add('new-message');
                        setTimeout(() => {
                            existingChat.classList.remove('new-message');
                        }, 2000);
                    }
                }

                // Update time
                const timeEl = existingChat.querySelector('.card-time');
                if (timeEl && chat.ultima_fecha) {
                    const date = new Date(chat.ultima_fecha);
                    timeEl.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
            } else {
                // This is a completely new chat, we need to add it to the list
                const newChatElement = document.createElement('div');

                // Create chat HTML without Jinja filters (they won't work in JS)
                newChatElement.innerHTML = `
                <a href="/chats/${chat.numero}" class="chat-item" data-chat-num="${chat.numero}">
                    <div class="card-content">
                        <div class="card-title-row">
                            <div class="card-avatar-section">
                                <img src="${chat.imagen_url || '/static/icons/default-avatar.png'}" 
                                     class="card-avatar" alt="Avatar"
                                     onerror="this.onerror=null;this.src='/static/icons/default-avatar.png';">
                            </div>
                            <span class="alias-view" data-num="${chat.numero}">
                                ${chat.nombre_mostrado || chat.numero}
                            </span>
                            <span class="alias-edit" style="display:none;">
                                <input type="text" value="${chat.alias || chat.nombre || ''}" data-num="${chat.numero}" maxlength="100" style="width: 110px;">
                            </span>
                            <button type="button" class="edit-alias-btn" data-num="${chat.numero}" title="Editar nombre">
                                ‚úèÔ∏è
                            </button>
                        </div>
                        <div class="card-meta-row">
                            <span class="card-num">${chat.numero}</span>
                            <span class="card-time">
                                ${chat.ultima_fecha ? new Date(chat.ultima_fecha).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ''}
                            </span>
                        </div>
                        <div class="card-msg">
                            ${chat.tipo_mensaje === 'imagen' ?
                        'üì∑ Imagen' :
                        (chat.ultimo_mensaje ?
                            `${chat.ultimo_mensaje.substring(0, 35)}${chat.ultimo_mensaje.length > 35 ? '...' : ''}` :
                            'Sin mensajes')}
                        </div>
                    </div>
                </a>
            `;

                // Add new chat to the container (at the top)
                chatContainer.insertBefore(newChatElement.firstElementChild, chatContainer.firstChild);
                newChatElement.firstElementChild.classList.add('new-message');

                // Set up event listeners for the new chat item
                const editButton = newChatElement.firstElementChild.querySelector('.edit-alias-btn');
                if (editButton) {
                    editButton.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const parent = this.closest('.card-title-row');
                        activarEdicionAlias(parent);
                    });
                }

                setTimeout(() => {
                    newChatElement.firstElementChild.classList.remove('new-message');
                }, 2000);
            }
        });
    }

    // Actualizar este bloque en el script existente
    document.addEventListener('DOMContentLoaded', function () {
        // Establecer intervalo de actualizaci√≥n a medio segundo (500ms)
        refreshInterval = 500; // medio segundo

        // Iniciar el ciclo de actualizaci√≥n
        if (document.querySelector('.chat-items')) {
            console.log("üöÄ Iniciando actualizaci√≥n de chats (500ms)");

            // Primera llamada inmediata para verificar
            actualizarListaChats();

            // Establecer intervalo regular de actualizaci√≥n
            setInterval(actualizarListaChats, refreshInterval);
        }

        // Resto del c√≥digo DOMContentLoaded se mantiene...
        document.querySelectorAll('.audio-player audio').forEach(audio => {
            // ...c√≥digo existente...
        });

</script>
{% endblock %}