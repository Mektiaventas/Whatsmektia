{% extends "base.html" %}
{% block title %}Tablero Kanban{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/kanban.css') }}">

<style>
    /* Tus estilos de animación existentes se mantienen igual */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes highlightPulse {
        0% {
            background-color: rgba(255, 255, 255, 0.1);
        }

        50% {
            background-color: rgba(255, 224, 130, 0.4);
        }

        100% {
            background-color: rgba(255, 255, 255, 0.1);
        }
    }

    @keyframes gentleShake {
        0%, 100% {
            transform: translateX(0);
        }

        25% {
            transform: translateX(-3px);
        }

        75% {
            transform: translateX(3px);
        }
    }

    .kanban-card.new-message {
        animation: fadeIn 0.5s ease-out, highlightPulse 2s ease-in-out, gentleShake 0.5s ease-in-out;
    }

    .kanban-card {
        transition: all 0.3s ease;
    }
</style>

<div id="kanban-board" class="kanban-board">
    {% for col in columnas %}
    <div class="kanban-column" data-col-id="{{ col.id }}">
        <div class="column-header">
            <img src="{{ col.icono }}" class="col-icon" alt="">
            <h3 contenteditable="true" data-col-id="{{ col.id }}" class="col-name">{{ col.nombre }}</h3>
            <button class="add-chat-btn" title="Agregar aquí">+</button>
        </div>
        <div class="column-list" data-col-id="{{ col.id }}">
            {% for chat in chats if chat.columna_id == col.id %}
            <a href="/chats/{{ chat.numero }}" class="kanban-card kanban-chat-link" data-chat-num="{{ chat.numero }}" style="text-decoration: none; color: inherit; display: block;">
                <!-- Misma estructura pero reorganizada -->

                <div class="card-content">
                    <div class="card-title-row">
                        <div class="card-avatar-section">
                            <img src="{{ chat.avatar or '/static/icons/default-avatar.png' }}"
                                 class="card-avatar" alt="Avatar"
                                 onerror="this.onerror=null;this.src='/static/icons/default-avatar.png';">
                        </div>
                        {% set bandera = chat.numero | bandera %}
                        {% if bandera %}
                        <img src="{{ bandera }}" class="card-flag" alt="País" title="País">
                        {% endif %}
                        <span class="alias-view" data-num="{{ chat.numero }}">
                            {{ chat.nombre_mostrado }}
                        </span>
                        <span class="alias-edit" style="display:none;">
                            <input type="text" value="{{ chat.alias or chat.nombre or chat.numero }}" data-num="{{ chat.numero }}" maxlength="100" style="width: 110px;">
                        </span>
                        <button type="button" class="edit-alias-btn" data-num="{{ chat.numero }}" title="Editar nombre">
                            ✏️
                        </button>
                    </div>
                    <div class="card-meta-row">
                        <span class="card-num">{{ chat.numero }}</span>
                        <span class="card-time">
                            {% if chat.ultima_fecha %}
                            {{ chat.ultima_fecha.strftime('%-d-%b   ').lower() }} {{ chat.ultima_fecha.strftime('%H:%M') }}
                            {% endif %}
                        </span>
                        {% if chat.sin_leer > 0 %}
                        <span class="card-unread">{{ chat.sin_leer }}</span>
                        {% endif %}
                    </div>
                    <div class="card-msg">{{ chat.ultimo_mensaje or "&nbsp;" }}</div>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
    let editingColId = null;
    let editingColText = null;
    let kanbanAutoRefresh = true;
    let refreshInterval = 500;

    // Detecta cuando el usuario empieza a editar un título
    document.addEventListener('focusin', function (e) {
        if (e.target.classList.contains('col-name')) {
            editingColId = e.target.dataset.colId;
            editingColText = e.target.textContent;
        }
    });

    // Detecta cuando termina de editar
    document.addEventListener('focusout', function (e) {
        if (e.target.classList.contains('col-name')) {
            editingColId = null;
            editingColText = null;
        }
    });

    // Permitir editar el nombre de la columna Kanban y guardar en BD
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.col-name[contenteditable="true"]').forEach(function (header) {
            header.addEventListener('blur', function () {
                const columnaId = header.dataset.colId;
                const nuevoNombre = header.textContent.trim();
                fetch(`/kanban/columna/${columnaId}/renombrar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre: nuevoNombre })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (!data.success) {
                            alert('Error al guardar el nombre de la columna');
                        }
                    });
            });
            header.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    header.blur();
                }
            });
        });

        // Agregar evento a TODOS los botones de agregar columna
        document.querySelectorAll('.add-chat-btn').forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();

                const columna = this.closest('.kanban-column');
                const columnaId = columna.dataset.colId;

                fetch('/kanban/columna/agregar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nombre: 'Nueva Columna',
                        columna_referencia: columnaId
                    })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert(data.error || 'Error al agregar columna');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error de conexión');
                    });
            });
        });

        setInterval(actualizarKanban, refreshInterval);

        // ...inicializarSortable y otros...
    });

    function actualizarKanban() {
        if (!kanbanAutoRefresh) return;
        const scrollPosition = window.scrollY;

        fetch('/kanban/data')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                actualizarIncremental(data);

                // --- Restaurar edición si corresponde ---
                if (editingColId) {
                    const colHeader = document.querySelector(`.col-name[data-col-id="${editingColId}"]`);
                    if (colHeader) {
                        colHeader.setAttribute('contenteditable', 'true');
                        colHeader.focus();
                        if (editingColText) colHeader.textContent = editingColText;
                        // Mover el cursor al final
                        const range = document.createRange();
                        range.selectNodeContents(colHeader);
                        range.collapse(false);
                        const sel = window.getSelection();
                        sel.removeAllRanges();
                        sel.addRange(range);
                    }
                }
                setTimeout(() => {
                    window.scrollTo(0, scrollPosition);
                }, 10);
            })
            .catch(error => {
                console.error('❌ Error actualizando Kanban:', error);
            });
    }
</script>
{% endblock %}