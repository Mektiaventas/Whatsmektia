{% extends 'base.html' %}
{% block title %}Configuraci√≥n ‚Äì Productos y Precios{% endblock %}

{% block content %}
<div class="config-header">
    <h2>Configuraci√≥n: Productos y Precios</h2>
    {% if guardado %}
    <div class="alert success">¬°Guardado correctamente!</div>
    {% endif %}
</div>

<div class="tabs-container">
    <ul class="tabs">
        {% for tab in tabs %}
        <li class="{% if tab == active %}active{% endif %}">
            {% if tab == 'precios' %}
            <a href="{{ url_for('configuracion_precios') }}">{{ tab|capitalize }}</a>
            {% else %}
            <a href="{{ url_for('configuracion_tab', tab=tab) }}">{{ tab|capitalize }}</a>
            {% endif %}
        </li>
        {% endfor %}

        <!-- Bot√≥n de Restablecer columnas AL LADO DE LOS TABS -->
        <li class="tab-action-item">
            <button class="btn-reset-inline" id="btn-reset-columns" onclick="resetColumns()" title="Restablecer columnas ocultas">
                üîÅ Restablecer columnas
            </button>
        </li>
    </ul>
</div>

<!-- Botones de funcionalidad NORMALES (estos mantienen su tama√±o) -->
<div class="tab-navigation mb-6">
    <div class="tab-buttons">
        <div class="tab-buttons-left">
            <button class="btn btn-primary mt-3" id="btn-user-list" onclick="showSection('user-list')">
                <div class="tab-icon">üë•</div>
                <div>
                    <span class="tab-title">Precios vista cliente</span>
                </div>
            </button>

            {% if is_admin %}
            <button class="btn btn-primary mt-3" id="btn-admin-list" onclick="showSection('admin-list')">
                <div class="tab-icon">üîí</div>
                <div>
                    <span class="tab-title">Precios vista Admin</span>
                </div>
            </button>
            {% endif %}
        </div>

        <div class="tab-buttons-right">
            <div class="upload-buttons-group">
                <button class="btn btn-primary mt-3" id="btn-batch-upload" onclick="showSection('batch-upload')">
                    <div class="tab-icon">üìä</div>
                    <div>
                        <span class="tab-title">Carga Template</span>
                    </div>
                </button>
                <button class="btn btn-primary mt-3" id="btn-manual-upload" onclick="showSection('manual-upload')">
                    <div class="tab-icon">‚úèÔ∏è</div>
                    <div>
                        <span class="tab-title">Carga manual</span>
                    </div>
                </button>
                <button class="btn btn-primary mt-3" id="btn-pdf-upload" onclick="showSection('pdf-upload')">
                    <div class="tab-icon">üìÑ</div>
                    <div>
                        <span class="tab-title">Carga con IA</span>
                    </div>
                </button>
                <button class="btn btn-primary mt-3" id="btn-column-template" onclick="showSection('column-template')">
                    <div class="tab-icon">üìù</div>
                    <div>
                        <span class="tab-title">Template Columnas</span>
                    </div>
                </button>
            </div>
        </div>
    </div>
</div>
<br />
<br /> 

<div class="section" id="pdf-upload" style="display:none;">
    <div class="section-header">
        <h3 class="flex justify-between items-center">
            <span>üìÑ Importar Productos desde PDF/Excel</span>
        </h3>
    </div>

    <div class="card mb-6">
        <div class="card-header bg-success text-white">
            <h3>üìÑ Importar Productos desde PDF/Excel</h3>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <form action="{{ url_for('subir_pdf_servicios') }}" method="POST" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="pdf_file" class="block text-sm font-medium mb-2">Subir cat√°logo en PDF/Excel:</label>
                            <input type="file" name="pdf_file" id="pdf_file"
                                   accept=".pdf,.xlsx,.xls,.csv,.docx,.txt" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <small class="text-muted">Formatos aceptados: PDF, XLSX, XLS, CSV, DOCX, TXT. M√°x. 50MB</small>
                        </div>
                        <button type="submit" class="btn btn-success mt-3">
                            üöÄ Procesar Cat√°logo Autom√°ticamente
                        </button>
                    </form>
                </div>

                <div>
                    <h4 class="font-semibold mb-2">üí° ¬øC√≥mo funciona?</h4>
                    <ul class="text-sm space-y-1">
                        <li>‚Ä¢ Sube tu cat√°logo de productos en PDF/Excel</li>
                        <li>‚Ä¢ La IA analizar√° y extraer√° autom√°ticamente</li>
                        <li>‚Ä¢ Los productos se guardar√°n en la base de datos</li>
                        <li>‚Ä¢ La IA los usar√° para responder consultas</li>
                    </ul>

                    <h4 class="font-semibold mt-3 mb-2">üìã Para mejores resultados:</h4>
                    <ul class="text-sm space-y-1">
                        <li>‚Ä¢ Archivo con SKU, categor√≠as y precios claros</li>
                        <li>‚Ä¢ Estructura clara de productos y categor√≠as</li>
                        <li>‚Ä¢ Precios de mayoreo y menudeo identificados</li>
                        <li>‚Ä¢ Informaci√≥n completa de medidas y modelos</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="section" id="batch-upload" style="display:none;">
    <div class="section-header">
        <h3 class="flex justify-between items-center">
            <span>üìä Importar Directamente desde Excel</span>
        </h3>
    </div>

    <div class="card mb-6">
        <div class="card-header bg-primary text-white">
            <h3>üìä Importar Directamente desde Excel</h3>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <form action="{{ url_for('importar_excel_directo') }}" method="POST" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="excel_file" class="block text-sm font-medium mb-2">Subir Excel con estructura predefinida:</label>
                            <input type="file" name="excel_file" id="excel_file"
                                   accept=".xlsx,.xls,.csv" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <small class="text-muted">Las columnas deben coincidir con la base de datos. Formatos: XLSX, XLS, CSV</small>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">
                            üì• Importar Excel Directamente
                        </button>
                    </form>
                </div>

                <div>
                    <h4 class="font-semibold mb-2">üí° Estructura Requerida</h4>
                    <ul class="text-sm space-y-1">
                        <li>‚Ä¢ sku</li>
                        <li>‚Ä¢ categoria</li>
                        <li>‚Ä¢ subcategoria</li>
                        <li>‚Ä¢ linea</li>
                        <li>‚Ä¢ modelo</li>
                        <li>‚Ä¢ descripcion</li>
                        <li>‚Ä¢ medidas</li>
                        <li>‚Ä¢ costo</li>
                        <li>‚Ä¢ precio_mayoreo</li>
                        <li>‚Ä¢ precio_menudeo</li>
                        <li>‚Ä¢ imagen (opcional)</li>
                        <li>‚Ä¢ etc.</li>
                    </ul>
                    <p class="text-xs mt-3">Los encabezados deben coincidir exactamente con los nombres de columna en la base de datos.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="section" id="manual-upload" style="display:none;">
    <div class="section-header">
        <h3 class="flex justify-between items-center">
            <span>‚úèÔ∏è {{ precio_edit and 'Editar Producto' or 'Agregar Producto Manualmente' }}</span>
        </h3>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <form action="{{ url_for('configuracion_precio_guardar') }}" method="post" enctype="multipart/form-data">
                {% if precio_edit %}
                <input type="hidden" name="id" value="{{ precio_edit.id }}">
                {% endif %}

                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="sku">SKU *</label>
                        <input type="text" id="sku" name="sku" class="input" required
                               value="{{ precio_edit.sku if precio_edit else '' }}"
                               placeholder="Ej: PROD-001">
                    </div>

                    <div class="form-group">
                        <label for="servicio">Producto *</label>
                        <input type="text" id="servicio" name="servicio" class="input" required
                               value="{{ precio_edit.servicio if precio_edit else '' }}"
                               placeholder="Ej: Laptop Gaming">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div class="form-group">
                        <label for="categoria">Categor√≠a</label>
                        <input type="text" id="categoria" name="categoria" class="input"
                               value="{{ precio_edit.categoria if precio_edit else '' }}"
                               placeholder="Ej: Electr√≥nicos">
                    </div>

                    <div class="form-group">
                        <label for="subcategoria">Subcategor√≠a</label>
                        <input type="text" id="subcategoria" name="subcategoria" class="input"
                               value="{{ precio_edit.subcategoria if precio_edit else '' }}"
                               placeholder="Ej: Computadoras">
                    </div>

                    <div class="form-group">
                        <label for="linea">L√≠nea</label>
                        <input type="text" id="linea" name="linea" class="input"
                               value="{{ precio_edit.linea if precio_edit else '' }}"
                               placeholder="Ej: Gaming">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="modelo">Modelo</label>
                        <input type="text" id="modelo" name="modelo" class="input"
                               value="{{ precio_edit.modelo if precio_edit else '' }}"
                               placeholder="Ej: XPS-15">
                    </div>

                    <div class="form-group">
                        <label for="medidas">Medidas</label>
                        <input type="text" id="medidas" name="medidas" class="input"
                               value="{{ precio_edit.medidas if precio_edit else '' }}"
                               placeholder="Ej: 15.6 pulgadas">
                    </div>
                </div>

                <div class="form-group">
                    <label for="descripcion">Descripci√≥n</label>
                    <textarea id="descripcion" name="descripcion" class="textarea" rows="2"
                              placeholder="Ej: Laptop para gaming con RTX 4060, 16GB RAM, 1TB SSD">{{ precio_edit.descripcion if precio_edit else '' }}</textarea>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div class="form-group">
                        <label for="costo">Costo *</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-600">$</span>
                            <input type="number" step="0.01" min="0" id="costo" name="costo" class="input pl-8"
                                   value="{{ precio_edit.costo if precio_edit else '' }}"
                                   placeholder="0.00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inscripcion">Inscripci√≥n</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-600">$</span>
                            <input type="number" step="0.01" min="0" id="inscripcion" name="inscripcion" class="input pl-8"
                                   value="{{ precio_edit.inscripcion if precio_edit else '' }}"
                                   placeholder="0.00">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="mensualidad">Mensualidad</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-600">$</span>
                            <input type="number" step="0.01" min="0" id="mensualidad" name="mensualidad" class="input pl-8"
                                   value="{{ precio_edit.mensualidad if precio_edit else '' }}"
                                   placeholder="0.00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="precio_mayoreo">Precio Mayoreo</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-600">$</span>
                            <input type="number" step="0.01" min="0" id="precio_mayoreo" name="precio_mayoreo" class="input pl-8"
                                   value="{{ precio_edit.precio_mayoreo if precio_edit else '' }}"
                                   placeholder="0.00">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="precio_menudeo">Precio Menudeo</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-600">$</span>
                            <input type="number" step="0.01" min="0" id="precio_menudeo" name="precio_menudeo" class="input pl-8"
                                   value="{{ precio_edit.precio_menudeo if precio_edit else '' }}"
                                   placeholder="0.00">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="imagen">Imagen</label>
                        <div class="mb-2">
                            <select id="imagen-tipo" class="select mb-2" onchange="toggleImagenInput()">
                                <option value="archivo">Subir archivo</option>
                                <option value="url">Usar URL de internet</option>
                            </select>
                        </div>

                        <div id="imagen-archivo-container">
                            <input type="file" id="imagen" name="imagen" class="input"
                                   accept="image/*">
                            <small class="text-muted block mt-1">Sube una imagen desde tu dispositivo</small>
                        </div>

                        <div id="imagen-url-container" class="hidden">
                            <input type="text" id="imagen_url" name="imagen_url" class="input"
                                   placeholder="https://ejemplo.com/imagen.jpg">
                            <small class="text-muted block mt-1">Ingresa la URL completa de una imagen en internet</small>
                        </div>

                        {% if precio_edit and precio_edit.imagen %}
                        <div class="mt-2">
                            <small class="text-muted">Imagen actual: {{ precio_edit.imagen }}</small>
                            {% if precio_edit.imagen and precio_edit.imagen.startswith('http') %}
                            <img src="{{ precio_edit.imagen }}" class="mt-1 h-16 w-auto object-contain border rounded" alt="Vista previa">
                            {% elif precio_edit.imagen %}
                            <img src="/uploads/{{ precio_edit.imagen }}" class="mt-1 h-16 w-auto object-contain border rounded" alt="Vista previa">
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="status_ws">Status WS</label>
                        <input type="text" id="status_ws" name="status_ws" class="input"
                               value="{{ precio_edit.status_ws if precio_edit else '' }}"
                               placeholder="Ej: activo">
                    </div>
                    <div class="form-group">
                        <label for="catalogo">Cat√°logo</label>
                        <input type="text" id="catalogo" name="catalogo" class="input"
                               value="{{ precio_edit.catalogo if precio_edit else '' }}"
                               placeholder="Ej: Cat√°logo 1">
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div class="form-group">
                        <label for="catalogo2">Cat√°logo 2</label>
                        <input type="text" id="catalogo2" name="catalogo2" class="input"
                               value="{{ precio_edit.catalogo2 if precio_edit else '' }}"
                               placeholder="Ej: Cat√°logo 2">
                    </div>
                    <div class="form-group">
                        <label for="catalogo3">Cat√°logo 3</label>
                        <input type="text" id="catalogo3" name="catalogo3" class="input"
                               value="{{ precio_edit.catalogo3 if precio_edit else '' }}"
                               placeholder="Ej: Cat√°logo 3">
                    </div>
                    <div class="form-group">
                        <label for="proveedor">Proveedor</label>
                        <input type="text" id="proveedor" name="proveedor" class="input"
                               value="{{ precio_edit.proveedor if precio_edit else '' }}"
                               placeholder="Ej: Proveedor S.A.">
                    </div>
                    <div class="form-group">
                        <label for="moneda">Moneda</label>
                        <input type="text" id="moneda" name="moneda" class="input"
                               value="{{ precio_edit.moneda if precio_edit else '' }}"
                               placeholder="Ej: MXN.">
                    </div>
                    <div class="form-group">
                        <label for="tipo_descuento">Tipo de descuento</label>
                        <input type="text" id="tipo_descuento" name="tipo_descuento" class="input"
                               value="{{ precio_edit.tipo_descuento if precio_edit else '' }}"
                               placeholder="Ej: Descuento tipo A">
                    </div>
                    <div class="form-group">
                        <label for="descuento">Descuento</label>
                        <input type="number" step="0.01" min="0" id="descuento" name="descuento" class="input"
                               value="{{ precio_edit.descuento if precio_edit else '' }}"
                               placeholder="15.00">
                    </div>
                    <div class="form-group">
                        <label for="unidad">Unidad</label>
                        <input type="text" id="unidad" name="unidad" class="input"
                               value="{{ precio_edit.unidad if precio_edit else '' }}"
                               placeholder="Ej: Pieza, Servicio, etc...">
                    </div>
                    <div class="form-group">
                        <label for="cantidad_minima">Cantidad minima</label>
                        <input type="number" step="0.01" min="0" id="cantidad_minima" name="cantidad_minima" class="input"
                               value="{{ precio_edit.cantidad_minima if precio_edit else '1' }}"
                               placeholder="1.00">
                    </div>
                </div>
                <div class="form-actions flex justify-end gap-2">
                    <button type="submit" class="btn primary">
                        {{ precio_edit and 'üíæ Actualizar' or 'üíæ Guardar' }}
                    </button>
                    <a href="{{ url_for('configuracion_precios') }}" class="btn secondary">
                        ‚Ü©Ô∏è Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="section" id="user-list" style="display:none;">
    <div class="card mb-4">
        <div class="card-header bg-gray-100">
            <h3>üìã Productos (Vista Cliente) ({{ pagination.total_items }} registros)</h3>
        </div>
        <div class="card-body">

            <form method="GET" action="{{ url_for('configuracion_precios') }}" class="search-form">
                <input type="hidden" name="section" value="user-list">
                <input type="text" name="search" class="input" placeholder="Buscar en {{ pagination.total_items }} productos..." value="{{ pagination.search_query or '' }}">
                <button type="submit" class="btn primary">Buscar</button>
            </form>
            <div class="pagination-controls" id="pagination-user">
                {% if pagination.current_page > 1 %}
                <a href="{{ url_for('configuracion_precios', page=pagination.current_page - 1, search=pagination.search_query or '', section='user-list') }}" class="btn small secondary">‚¨ÖÔ∏è Anteriores</a>
                {% else %}
                <span class="btn small secondary disabled">‚¨ÖÔ∏è Anteriores</span>
                {% endif %}

                <span class="page-info">
                    P√°gina <strong>{{ pagination.current_page }}</strong> de <strong>{{ pagination.total_pages }}</strong>
                    <em style="font-size: 0.8em; margin-left: 10px;">(Total: {{ pagination.total_items }} productos)</em>
                </span>

                {% if pagination.current_page < pagination.total_pages %}
                <a href="{{ url_for('configuracion_precios', page=pagination.current_page + 1, search=pagination.search_query or '', section='user-list') }}" class="btn small secondary">Siguientes ‚û°Ô∏è</a>
                {% else %}
                <span class="btn small secondary disabled">Siguientes ‚û°Ô∏è</span>
                {% endif %}
            </div>
            {% if precios %}
            <div class="table-responsive">
                <div class="table-scroll table-scroll-client">
                    <table class="table" data-table="user">
                        <thead>
                            <tr>
                                <th>
                                    <span>SKU</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">
                                        ‚ùé
                                    </button>
                                </th>
                                <th>
                                    <span>Categor√≠a</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>Subcategor√≠a</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>L√≠nea</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>Modelo</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>Descripci√≥n</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>Imagen</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>Menudeo</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>Inscripcion</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>Mensualidad</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>Acciones</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for precio in precios %}
                            <tr>
                                <td>{{ precio.sku or '-' }}</td>
                                <td>{{ precio.categoria or '-' }}</td>
                                <td>{{ precio.subcategoria or '-' }}</td>
                                <td>{{ precio.linea or '-' }}</td>
                                <td>{{ precio.modelo or '-' }}</td>
                                <td class="desc-cell" data-desc="{{ precio.descripcion|default('')|e }}">
                                    {{ precio.descripcion|default('-')|truncate(300) }}
                                </td>
                                <td>
                                    {% if precio.imagen %}
                                    {% if precio.imagen.startswith('http') %}
                                    <img class="imagen_tabla" src="/uploads/productos/{{ precio.imagen }}" ...>
                                    {% else %}
                                    <img class="imagen_tabla" src="/uploads/productos/{{ precio.imagen }}" ...>
                                    {% endif %}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td class="text-right text-blue-600">${{ "{:,.2f}".format(precio.precio_menudeo) if precio.precio_menudeo else '-' }}</td>
                                <td>{{precio.inscripcion}}</td>
                                <td>{{precio.mensualidad}}</td>
                                <td>
                                    {% if es_admin %}
                                    <a href="{{ url_for('configuracion_precio_editar', pid=precio.id) }}"
                                       class="btn small primary">Editar</a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% else %}
            <div class="text-center py-8">
                {% if pagination.search_query %}
                <div class="text-gray-500 text-lg mb-2">üîç No se encontraron productos</div>
                <p class="text-sm text-gray-400">Tu b√∫squeda de "{{ pagination.search_query }}" no arroj√≥ resultados.</p>
                {% else %}
                <div class="text-gray-500 text-lg mb-2">üìù No hay productos registrados</div>
                <p class="text-sm text-gray-400">Usa el formulario de arriba para agregar productos manualmente.</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="section" id="admin-list" style="display:none;">
    <div class="card">
        <div class="card-header bg-blue-100">
            <h3>üîí Productos y Precios (Vista Completa Admin) ({{ pagination.total_items }} registros)</h3>
        </div>
        <div class="card-body">

            <form method="GET" action="{{ url_for('configuracion_precios') }}" class="search-form">
                <input type="hidden" name="section" value="admin-list">
                <input type="text" name="search" class="input" placeholder="Buscar en {{ pagination.total_items }} productos..." value="{{ pagination.search_query or '' }}">
                <button type="submit" class="btn primary">Buscar</button>
            </form>
            <div class="pagination-controls" id="pagination-admin">
                {% if pagination.current_page > 1 %}
                <a href="{{ url_for('configuracion_precios', page=pagination.current_page - 1, search=pagination.search_query or '', section='admin-list') }}" class="btn small secondary">‚¨ÖÔ∏è Anteriores</a>
                {% else %}
                <span class="btn small secondary disabled">‚¨ÖÔ∏è Anteriores</span>
                {% endif %}

                <span class="page-info">
                    P√°gina <strong>{{ pagination.current_page }}</strong> de <strong>{{ pagination.total_pages }}</strong>
                    <em style="font-size: 0.8em; margin-left: 10px;">(Total: {{ pagination.total_items }} productos)</em>
                </span>

                {% if pagination.current_page < pagination.total_pages %}
                <a href="{{ url_for('configuracion_precios', page=pagination.current_page + 1, search=pagination.search_query or '', section='admin-list') }}" class="btn small secondary">Siguientes ‚û°Ô∏è</a>
                {% else %}
                <span class="btn small secondary disabled">Siguientes ‚û°Ô∏è</span>
                {% endif %}
            </div>
            {% if precios %}
            <div class="table-responsive">
                <div class="table-scroll table-scroll-admin">
                    <table class="table" data-table="admin">
                        <thead>
                            <tr>
                                <th><span>SKU</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                                <th><span>Categor√≠a</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                                <th><span>Subcategor√≠a</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                                <th><span>L√≠nea</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                                <th><span>Modelo</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                                <th><span>Descripci√≥n</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                                <th><span>Costo</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                                <th><span>Menudeo</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                                <th><span>Inscripcion</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                                <th><span>Mensualidad</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                                <th><span>Imagen</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                                <th><span>Acciones</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                            </tr>
                        </thead>
                        <tbody class="cuerpo_tabla">
                            {% for precio in precios %}
                            <tr>
                                <td>{{ precio.sku or '-' }}</td>
                                <td>{{ precio.categoria or '-' }}</td>
                                <td>{{ precio.subcategoria or '-' }}</td>
                                <td>{{ precio.linea or '-' }}</td>
                                <td>{{ precio.modelo or '-' }}</td>
                                <td class="desc-cell" data-desc="{{ precio.descripcion|default('')|e }}">
                                    {{ precio.descripcion|default('-')|truncate(300) }}
                                </td>
                                <td class="text-right text-red-600">${{ "{:,.2f}".format(precio.costo) if precio.costo else '-' }}</td>
                                <td class="text-right text-blue-600">${{ "{:,.2f}".format(precio.precio_menudeo) if precio.precio_menudeo else '-' }}</td>
                                <td>{{precio.inscripcion}}</td>
                                <td>{{precio.mensualidad}}</td>
                                <td>
                                    {% if precio.imagen %}
                                    {% if precio.imagen.startswith('http') %}
                                    <img class="imagen_tabla" src="/uploads/productos/{{ precio.imagen }}" ...>
                                    {% else %}
                                    <img class="imagen_tabla" src="/uploads/productos/{{ precio.imagen }}" ...>
                                    {% endif %}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="flex space-x-2">
                                        <a href="{{ url_for('configuracion_precio_editar', pid=precio.id) }}"
                                           class="btn small primary">Editar</a>
                                        <form action="{{ url_for('configuracion_precio_borrar', pid=precio.id) }}"
                                              method="post" class="inline-form">
                                            <button type="submit"
                                                    class="btn small danger"
                                                    onclick="return confirm('¬øEliminar {{ precio.descripcion[:30] if precio.descripcion else precio.sku }}?');">
                                                Borrar
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% else %}
            <div class="text-center py-8">
                {% if pagination.search_query %}
                <div class="text-gray-500 text-lg mb-2">üîç No se encontraron productos</div>
                <p class="text-sm text-gray-400">Tu b√∫squeda de "{{ pagination.search_query }}" no arroj√≥ resultados.</p>
                {% else %}
                <div class="text-gray-500 text-lg mb-2">üìù No hay productos registrados</div>
                <p class="text-sm text-gray-400">Usa el formulario de arriba para agregar productos manualmente.</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="section" id="column-template" style="display:none;">
    <div class="section-header">
        <h3 class="flex justify-between items-center">
            <span>üìù Generar Plantilla de Columnas</span>
        </h3>
    </div>

    <div class="card mb-6">
        <div class="card-header bg-warning text-white">
            <h3>üì• Template de Columnas Personalizado</h3>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-1 gap-6">
                <div>
                    <h4 class="font-semibold mb-2">üìã Selecciona las Columnas (Encabezados)</h4>
                    <p class="text-sm mb-4">Marca las columnas que deseas incluir en tu plantilla de Excel. El archivo descargado solo tendr√° los encabezados seleccionados.</p>

                    <div id="column-checklist-container" class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm bg-gray-50 p-3 rounded-lg">
                        {% for col in master_columns %}
                        <div class="flex items-center">
                            <input type="checkbox" id="col-{{ col|replace(' ', '_') }}" name="selected_columns" value="{{ col }}" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded" checked>
                            <label for="col-{{ col|replace(' ', '_') }}" class="ml-2 text-gray-700">{{ col }}</label>
                        </div>
                        {% endfor %}
                    </div>

                    <button onclick="downloadTemplateWithSelection()" class="btn btn-success mt-4">
                        ‚¨áÔ∏è Descargar Plantilla Excel con columnas seleccionadas
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert {{ 'success' if category == 'success' else 'error' if category == 'error' else 'warning' }}">
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}
</div>

<style>
    /* INICIO: CSS para Paginaci√≥n */
    .pagination-controls {
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .page-info {
        font-size: 0.9rem;
        color: #4a5568;
    }

    .pagination-controls button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        background-color: #e2e8f0;
    }
    /* FIN: CSS para Paginaci√≥n */

    .btn-reset {
        background: #f59e0b;
        color: #111;
        border: none;
        padding: 10px 14px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
    }

        .btn-reset:hover {
            background: #d97706;
            transform: translateY(-1px);
        }

    .imagen_tabla {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .alert {
        padding: 12px 16px;
        border-radius: 6px;
        margin: 10px 0;
        font-weight: 500;
    }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

    /* Dashboard menu styles */
    .dashboard-menu {
        margin: 20px 0;
    }

    .dashboard-item {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .spacer {
        display: inline-block;
        width: 30%;
        height: 1px;
        vertical-align: middle;
    }

    @media (max-width: 600px) {
        .spacer {
            width: 40%;
        }
    }

    .btn-primario {
        align-self: flex-start;
        padding: 12px 24px;
        background: linear-gradient(135deg, green, blue);
        color: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        transition: background .2s, transform .1s;
    }

        .btn-primario:hover {
            background: linear-gradient(135deg, blue, green);
            transform: translateY(-2px);
        }

    .dashboard-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-color: #3182ce;
    }

    .dashboard-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
    }

    .dashboard-item h3 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 5px;
        color: #2d3748;
    }

    .dashboard-item p {
        font-size: 0.9rem;
        color: #718096;
    }

    /* Section styles */
    .section {
        margin-bottom: 30px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px;
        background: #f8fafc;
        border-radius: 6px;
    }

    /* Existing button styles */
    .btn-success {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
    }

        .btn-success:hover {
            background: #218838;
        }

    .bg-success {
        background: #28a745 !important;
    }

    .bg-blue-50 {
        background: #eff6ff;
    }

    .text-green-600 {
        color: #059669;
    }

    .text-blue-600 {
        color: #2563eb;
    }

    .cursor-pointer {
        cursor: pointer;
    }

    .hidden {
        display: none !important;
    }

    .card-header {
        transition: background-color 0.2s;
    }

        .card-header:hover {
            background-color: white;
            color: black;
        }

    /* Keep container responsive */
    .table-responsive {
        width: 100%;
        overflow: hidden;
    }

    /* Table layout: allow shrinking and wrapping */
    .table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        font-size: 13px;
    }

        .table td {
            border: 1px solid black;
            height: 8%;
        }

        .table th {
            font-size: smaller;
        }

        .table th,
        .table td {
            padding: 6px 8px;
            text-align: left;
            white-space: normal;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .table th {
            background-color: white;
            color: black;
        }

    /* Scroll container for big tables */
    .table-scroll {
        position: relative;
        max-height: 500px;
        overflow-y: auto;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 6px;
        padding-right: 6px;
        background: transparent;
    }

    .search-form {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }

        .search-form .input {
            flex-grow: 1;
        }

    .table-scroll-client {
        max-height: 600px;
    }

    .table-scroll-admin {
        max-height: 600px;
    }

    /* Sticky header */
    .table thead th {
        position: sticky;
        top: 0;
        z-index: 5;
        background: linear-gradient(#ffffff, #f8fafc);
        box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    }

    .pagination-controls .disabled {
        opacity: 0.4;
        cursor: not-allowed;
        background-color: #e2e8f0;
        padding: 5px 10px;
        border-radius: 5px;
    }

    .pagination-controls .btn.small.secondary {
        text-decoration: none;
    }

    .table thead th {
        font-weight: 600;
    }

    .table-scroll::-webkit-scrollbar {
        width: 10px;
        height: 10px;
    }

    .table-scroll::-webkit-scrollbar-track {
        background: white;
    }

    .table-scroll::-webkit-scrollbar-thumb {
        background: yellow;
        border-radius: 8px;
    }

    .desc-cell {
        font-size: xx-small;
    }

    .table th:nth-child(6), .table td:nth-child(6) {
        max-width: 180px;
    }

    .table th:nth-child(2), .table td:nth-child(2),
    .table th:nth-child(3), .table td:nth-child(3),
    .table th:nth-child(4), .table td:nth-child(4) {
        max-width: 120px;
    }

    /* Tooltip styles */
    .floating-tooltip {
        position: fixed;
        max-width: 640px;
        width: auto;
        background: #ffffff;
        color: #111827;
        border: 1px solid rgba(0,0,0,0.08);
        box-shadow: 0 6px 18px rgba(0,0,0,0.12);
        padding: 10px 12px;
        border-radius: 8px;
        font-size: 13px;
        line-height: 1.3;
        z-index: 9999;
        white-space: pre-wrap;
        word-break: break-word;
    }

        .floating-tooltip::after {
            content: "";
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ffffff;
            transform: rotate(45deg);
            border-left: 1px solid rgba(0,0,0,0.08);
            border-top: 1px solid rgba(0,0,0,0.08);
            left: 12px;
            top: -6px;
        }

    @media (max-width: 1200px) {
        .table th, .table td {
            padding: 5px 6px;
            font-size: 12px;
        }

        .imagen_tabla {
            width: 28px;
            height: 28px;
        }

        .floating-tooltip {
            max-width: 360px;
            font-size: 12px;
        }
    }

    .btn small primary {
        width: 50%;
        height: 50%;
    }

    .btn small danger {
        width: 50%;
        height: 50%;
    }

    /* NUEVOS ESTILOS PARA LOS BOTONES SUPERIORES */
    /* ===== NUEVOS ESTILOS PARA TABS + BOT√ìN "RESTABLECER COLUMNAS" ===== */

    /* Contenedor para tabs y bot√≥n */
    .tabs-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    /* Tabs normales */
    .tabs {
        display: flex;
        list-style: none;
        padding: 0;
        margin: 0;
        flex-wrap: wrap;
        align-items: center;
        flex-grow: 1;
    }

        .tabs li {
            margin-right: 5px;
            margin-bottom: 5px;
        }

            .tabs li a {
                display: block;
                padding: 10px 20px;
                background: linear-gradient(135deg, #fbbf24, #f59e0b); /* ‚Üê COLOR AMARILLO/NARANJA */
                color: #111827; /* Texto oscuro para mejor contraste */
                text-decoration: none;
                border-radius: 6px;
                font-weight: 600; /* Un poco m√°s grueso */
                transition: all 0.2s;
                font-size: 14px;
                border: 1px solid #f59e0b; /* Borde sutil */
                box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2); /* Sombra suave */
            }

            .tabs li.active a {
                background: linear-gradient(135deg, #f59e0b, #d97706); /* ‚Üê NARANJA M√ÅS FUERTE */
                color: white;
                border-color: #d97706;
                box-shadow: 0 4px 6px rgba(217, 119, 6, 0.3);
            }
            .tabs li a:hover {
                background: linear-gradient(135deg, #fcd34d, #f59e0b);
                transform: translateY(-1px);
                box-shadow: 0 4px 6px rgba(245, 158, 11, 0.3);
            }

    ..tabs li.active a:hover {
        background: linear-gradient(135deg, #d97706, #b45309);
        transform: translateY(-1px);
    } 

    /* Bot√≥n de Restablecer columnas - AL LADO DE LOS TABS */
    .tab-action-item {
        margin-left: 10px;
    }

    .btn-reset-inline {
        background: #f59e0b;
        color: #111;
        border: none;
        padding: 8px 14px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

        .btn-reset-inline:hover {
            background: #d97706;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

    /* ===== ESTILOS ORIGINALES PARA LOS BOTONES DE FUNCIONALIDAD ===== */

    /* Los botones normales mantienen su tama√±o ORIGINAL */
    .btn.btn-primary {
        font-size: 14px;
        height: 44px;
        padding: 0 20px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

        .btn.btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn.btn-primary .tab-icon {
            font-size: 16px;
            margin-right: 8px;
        }

        .btn.btn-primary .tab-title {
            font-size: 14px;
            font-weight: 500;
        }

    /* Contenedores para botones de funcionalidad */
    .tab-buttons {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
        width: 100%;
    }

    .tab-buttons-left {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        flex: 1;
    }

    .tab-buttons-right {
        display: flex;
        justify-content: flex-end;
        align-items: center;
    }

    .upload-buttons-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        justify-content: flex-end;
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .tabs-container {
            flex-direction: column;
            align-items: stretch;
        }

        .tabs {
            margin-bottom: 10px;
        }

        .tab-action-item {
            margin-left: 0;
            width: 100%;
        }

        .btn-reset-inline {
            width: 100%;
            justify-content: center;
            margin-top: 5px;
        }

        .tabs li {
            margin-right: 3px;
            margin-bottom: 3px;
        }

            .tabs li a {
                padding: 8px 12px;
                font-size: 13px;
            }

        /* Responsive para botones de funcionalidad */
        .tab-buttons {
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }

        .tab-buttons-right {
            justify-content: flex-start;
        }

        .upload-buttons-group {
            justify-content: flex-start;
            gap: 8px;
        }
    } 
</style>
<script>

    // --- INICIO: L√≥gica de Paginaci√≥n ---
    const PAGE_SIZE = 100;
    const paginationConfig = {
        user: { currentPage: 1, totalPages: 1, rows: [] },
        admin: { currentPage: 1, totalPages: 1, rows: [] }
    };

    function setupPagination(tableId) {
        const table = document.querySelector(`table[data-table="${tableId}"]`);
        if (!table) return;
        const tbody = table.querySelector('tbody');
        if (!tbody) return;

        const rows = Array.from(tbody.querySelectorAll('tr'));
        const config = paginationConfig[tableId];
        config.rows = rows;
        config.totalPages = Math.ceil(rows.length / PAGE_SIZE) || 1; // Asegurar al menos 1 p√°gina

        const totalEl = document.getElementById(`page-total-${tableId}`);
        if (totalEl) totalEl.textContent = config.totalPages;

        // Mostrar la primera p√°gina
        showPage(tableId, 1);
    }

    function showPage(tableId, page) {
        const config = paginationConfig[tableId];
        if (!config || page < 1 || page > config.totalPages) return;

        config.currentPage = page;
        const start = (page - 1) * PAGE_SIZE;
        const end = start + PAGE_SIZE;

        // Ocultar todas las filas y luego mostrar solo las de la p√°gina
        config.rows.forEach((row, index) => {
            row.style.display = (index >= start && index < end) ? '' : 'none';
        });

        const numEl = document.getElementById(`page-num-${tableId}`);
        if (numEl) numEl.textContent = page;

        const controls = document.getElementById(`pagination-${tableId}`);
        if (controls) {
            controls.querySelector('button[onclick*="-1"]').disabled = (page === 1);
            controls.querySelector('button[onclick*="1"]').disabled = (page === config.totalPages);
        }
    }

    function changePage(tableId, direction) {
        const config = paginationConfig[tableId];
        const newPage = config.currentPage + direction;
        showPage(tableId, newPage);
    }
    // --- FIN: L√≥gica de Paginaci√≥n ---

    function downloadTemplateWithSelection() {
        // Obtener todos los checkboxes seleccionados con el nombre 'selected_columns'
        const checkboxes = document.querySelectorAll('input[name="selected_columns"]:checked');

        // Extraer el 'value' (nombre de la columna) de cada checkbox
        const selectedColumns = Array.from(checkboxes).map(cb => cb.value);

        if (selectedColumns.length === 0) {
            alert("üö® Por favor, selecciona al menos una columna para descargar.");
            return;
        }

        // Codificar la lista como una cadena separada por comas para el par√°metro 'cols'
        const colsParam = selectedColumns.join(',');

        // Construir la URL de descarga con el par√°metro
        // NOTA: 'descargar_template' debe ser el nombre de la funci√≥n en app.py que tiene el @app.route
        const downloadUrl = `{{ url_for('descargar_template') }}?cols=${encodeURIComponent(colsParam)}`;

        // Disparar la descarga abriendo la URL en una nueva pesta√±a
        window.open(downloadUrl, '_blank');
    }
    // Function to show a specific section and highlight its button
    function showSection(sectionId) {
        const sections = document.querySelectorAll('.section');
        sections.forEach(section => section.style.display = 'none');
        const buttons = document.querySelectorAll('.btn, .btn-primario, .btn-primary');
        buttons.forEach(button => button.classList.remove('active'));
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
            targetSection.style.display = 'block';
            window.scrollTo({
                top: document.querySelector('.tab-navigation').offsetTop + 60,
                behavior: 'smooth'
            });
        }
        const activeButton = document.getElementById(`btn-${sectionId}`);
        if (activeButton) activeButton.classList.add('active');
    }

    // Image input toggle function
    function toggleImagenInput() {
        const tipo = document.getElementById('imagen-tipo').value;
        const archivoContainer = document.getElementById('imagen-archivo-container');
        const urlContainer = document.getElementById('imagen-url-container');
        if (tipo === 'archivo') {
            archivoContainer.style.display = 'block';
            urlContainer.style.display = 'none';
            const iu = document.getElementById('imagen_url'); if (iu) iu.value = '';
        } else {
            archivoContainer.style.display = 'none';
            urlContainer.style.display = 'block';
            const f = document.getElementById('imagen'); if (f) f.value = '';
        }
    }
    // Toggle a column based on the header button clicked
    function toggleColumnBtn(btn) {
        const th = btn.closest('th');
        if (!th) return;
        const table = th.closest('table');
        if (!table) return;
        const headerCells = th.parentNode.children;
        let index = Array.prototype.indexOf.call(headerCells, th); // 0-based
        // Toggle visibility for this column index across rows in the same table
        toggleColumn(table, index);
        // update button pressed state
        const pressed = btn.getAttribute('aria-pressed') === 'true';
        btn.setAttribute('aria-pressed', (!pressed).toString());
    }

    // Toggle column by table element and column index
    function toggleColumn(table, colIndex) {
        const firstRow = table.querySelector('tbody tr');
        if (!firstRow) return;
        const cell = firstRow.children[colIndex];
        const isHidden = cell && (cell.style.display === 'none' || cell.classList.contains('hidden'));
        const newDisplay = isHidden ? '' : 'none';
        const rows = table.querySelectorAll('thead tr, tbody tr');
        rows.forEach(row => {
            const c = row.children[colIndex];
            if (c) c.style.display = newDisplay;
        });
        const tableId = table.getAttribute('data-table') || 'table';
        // Update localStorage map + persist to server
        try {
            const key = `precios_hidden_cols_${tableId}`;
            const raw = localStorage.getItem(key);
            let map = raw ? JSON.parse(raw) : {};
            if (!isHidden) map[colIndex] = true;
            else delete map[colIndex];
            localStorage.setItem(key, JSON.stringify(map));
            // Send to server (best-effort)
            persistHiddenColumnsToServer(tableId, map);
        } catch (e) {
            console.warn('Could not persist column visibility locally:', e);
        }
    }
    function persistHiddenColumnsToServer(tableId, map) {
        try {
            fetch('/configuracion/precios/columnas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ table: tableId, hidden: map }),
                credentials: 'same-origin'
            }).catch(err => {
                // best-effort: if network fails, leave localStorage as fallback
                console.warn('Warning: could not persist hidden columns to server:', err);
            });
        } catch (e) {
            console.warn('Error in persistHiddenColumnsToServer:', e);
        }
    }
    // Persist hidden columns set for a table in localStorage
    function persistHiddenColumn(tableId, colIndex, hidden) {
        try {
            const key = `precios_hidden_cols_${tableId}`;
            const raw = localStorage.getItem(key);
            let map = raw ? JSON.parse(raw) : {};
            // store as object of indices->true
            if (hidden) {
                map[colIndex] = true;
            } else {
                delete map[colIndex];
            }
            localStorage.setItem(key, JSON.stringify(map));
        } catch (e) {
            console.warn('No se pudo persistir estado de columnas: ', e);
        }
    }

    // Apply stored hidden columns to all tables on load
    async function applyStoredHiddenColumns() {
        try {
            const tables = document.querySelectorAll('table[data-table]');
            for (const table of tables) {
                const tableId = table.getAttribute('data-table') || 'table';
                // Try server
                try {
                    const res = await fetch(`/configuracion/precios/columnas?table=${encodeURIComponent(tableId)}`, { credentials: 'same-origin' });
                    if (res.ok) {
                        const data = await res.json();
                        const map = data.hidden || {};
                        Object.keys(map).forEach(idxStr => {
                            const idx = parseInt(idxStr, 10);
                            if (isNaN(idx)) return;
                            const rows = table.querySelectorAll('thead tr, tbody tr');
                            rows.forEach(row => {
                                const c = row.children[idx];
                                if (c) c.style.display = 'none';
                            });
                            const headerCell = table.querySelector('thead tr').children[idx];
                            if (headerCell) {
                                const btn = headerCell.querySelector('.col-toggle');
                                if (btn) btn.setAttribute('aria-pressed', 'true');
                            }
                        });
                        // Also persist to localStorage for offline UX
                        localStorage.setItem(`precios_hidden_cols_${tableId}`, JSON.stringify(map));
                        continue;
                    }
                } catch (e) {
                    // server failed, fall back to localStorage below
                }
                // fallback: localStorage
                const key = `precios_hidden_cols_${tableId}`;
                const raw = localStorage.getItem(key);
                const map = raw ? JSON.parse(raw) : {};
                Object.keys(map).forEach(idxStr => {
                    const idx = parseInt(idxStr, 10);
                    if (isNaN(idx)) return;
                    const rows = table.querySelectorAll('thead tr, tbody tr');
                    rows.forEach(row => {
                        const c = row.children[idx];
                        if (c) c.style.display = 'none';
                    });
                    const headerCell = table.querySelector('thead tr').children[idx];
                    if (headerCell) {
                        const btn = headerCell.querySelector('.col-toggle');
                        if (btn) btn.setAttribute('aria-pressed', 'true');
                    }
                });
            }
        } catch (e) {
            console.warn('Error applying stored hidden columns:', e);
        }
    }
    async function resetColumns() {
        if (!confirm('¬øRestablecer visibilidad de columnas para esta vista? Esto mostrar√° todas las columnas hasta que vuelvas a ocultarlas.')) return;
        // Clear server-side for all tables for this tenant
        try {
            await fetch('/configuracion/precios/columnas/restablecer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({}), credentials: 'same-origin'
            });
        } catch (e) {
            console.warn('Could not clear server-side column settings:', e);
        }
        // Clear UI and localStorage
        document.querySelectorAll('table[data-table]').forEach(table => {
            const rows = table.querySelectorAll('thead tr, tbody tr');
            const colsCount = table.querySelector('thead tr').children.length;
            for (let cidx = 0; cidx < colsCount; cidx++) {
                rows.forEach(row => {
                    const c = row.children[cidx];
                    if (c) c.style.display = '';
                });
                const headerCell = table.querySelector('thead tr').children[cidx];
                if (headerCell) {
                    const btn = headerCell.querySelector('.col-toggle');
                    if (btn) btn.setAttribute('aria-pressed', 'false');
                }
            }
            const tableId = table.getAttribute('data-table') || 'table';
            try { localStorage.removeItem(`precios_hidden_cols_${tableId}`); } catch (e) { }
        });
        alert('Columnas restablecidas.');
    }
    // On document ready
    // precios.html (L√≠nea 1342 aprox) - VERSI√ìN CORREGIDA

// On document ready
    document.addEventListener('DOMContentLoaded', function () {
        // Default to the user-list (client prices) section
        let initialSection = 'user-list';
        {% if precio_edit %}
        initialSection = 'manual-upload';
        {% endif %}
        const urlParams = new URLSearchParams(window.location.search);
        const section = urlParams.get('section');
        if (section) initialSection = section;
        showSection(initialSection);
        const urlContainer = document.getElementById('imagen-url-container');
        if (urlContainer) urlContainer.style.display = 'none';

        // --- PAGINACI√ìN BORRADA ---
        // (Las llamadas a setupPagination() se eliminaron)
        // --- FIN PAGINACI√ìN ---

        // Apply stored column visibility
        applyStoredHiddenColumns(); // <-- Esta l√≠nea ahora S√ç se ejecutar√°
    });
</script>
{% endblock %}