{% extends 'base.html' %}
{% block title %}Configuraci√≥n ‚Äì Productos y Precios{% endblock %}

{% block content %}
<div class="config-header">
    <h2>Configuraci√≥n: Productos y Precios</h2>
    {% if guardado %}
    <div class="alert success">¬°Guardado correctamente!</div>
    {% endif %}
</div>

<ul class="tabs">
    {% for tab in tabs %}
    <li class="{% if tab == active %}active{% endif %}">
        {% if tab == 'precios' %}
        <a href="{{ url_for('configuracion_precios') }}">{{ tab|capitalize }}</a>
        {% else %}
        <a href="{{ url_for('configuracion_tab', tab=tab) }}">{{ tab|capitalize }}</a>
        {% endif %}
    </li>
    {% endfor %}
</ul>

<div class="section" id="pdf-upload" style="display:none;">
    <div class="section-header">
        <h3 class="flex justify-between items-center">
            <span>üìÑ Importar Productos desde PDF/Excel</span>
        </h3>
    </div>

    <div class="card mb-6">
        <div class="card-header bg-success text-white">
            <h3>üìÑ Importar Productos desde PDF/Excel</h3>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <form action="{{ url_for('subir_pdf_servicios') }}" method="POST" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="pdf_file" class="block text-sm font-medium mb-2">Subir cat√°logo en PDF/Excel:</label>
                            <input type="file" name="pdf_file" id="pdf_file"
                                   accept=".pdf,.xlsx,.xls,.csv,.docx,.txt" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <small class="text-muted">Formatos aceptados: PDF, XLSX, XLS, CSV, DOCX, TXT. M√°x. 50MB</small>
                        </div>
                        <button type="submit" class="btn btn-success mt-3">
                            üöÄ Procesar Cat√°logo Autom√°ticamente
                        </button>
                    </form>
                </div>

                <div>
                    <h4 class="font-semibold mb-2">üí° ¬øC√≥mo funciona?</h4>
                    <ul class="text-sm space-y-1">
                        <li>‚Ä¢ Sube tu cat√°logo de productos en PDF/Excel</li>
                        <li>‚Ä¢ La IA analizar√° y extraer√° autom√°ticamente</li>
                        <li>‚Ä¢ Los productos se guardar√°n en la base de datos</li>
                        <li>‚Ä¢ La IA los usar√° para responder consultas</li>
                    </ul>

                    <h4 class="font-semibold mt-3 mb-2">üìã Para mejores resultados:</h4>
                    <ul class="text-sm space-y-1">
                        <li>‚Ä¢ Archivo con SKU, categor√≠as y precios claros</li>
                        <li>‚Ä¢ Estructura clara de productos y categor√≠as</li>
                        <li>‚Ä¢ Precios de mayoreo y menudeo identificados</li>
                        <li>‚Ä¢ Informaci√≥n completa de medidas y modelos</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="section" id="batch-upload" style="display:none;">
    <div class="section-header">
        <h3 class="flex justify-between items-center">
            <span>üìä Importar Directamente desde Excel</span>
        </h3>
    </div>

    <div class="card mb-6">
        <div class="card-header bg-primary text-white">
            <h3>üìä Importar Directamente desde Excel</h3>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <form action="{{ url_for('importar_excel_directo') }}" method="POST" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="excel_file" class="block text-sm font-medium mb-2">Subir Excel con estructura predefinida:</label>
                            <input type="file" name="excel_file" id="excel_file"
                                   accept=".xlsx,.xls,.csv" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <small class="text-muted">Las columnas deben coincidir con la base de datos. Formatos: XLSX, XLS, CSV</small>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">
                            üì• Importar Excel Directamente
                        </button>
                    </form>
                </div>

                <div>
                    <h4 class="font-semibold mb-2">üí° Estructura Requerida</h4>
                    <ul class="text-sm space-y-1">
                        <li>‚Ä¢ sku</li>
                        <li>‚Ä¢ categoria</li>
                        <li>‚Ä¢ subcategoria</li>
                        <li>‚Ä¢ linea</li>
                        <li>‚Ä¢ modelo</li>
                        <li>‚Ä¢ descripcion</li>
                        <li>‚Ä¢ medidas</li>
                        <li>‚Ä¢ costo</li>
                        <li>‚Ä¢ precio_mayoreo</li>
                        <li>‚Ä¢ precio_menudeo</li>
                        <li>‚Ä¢ imagen (opcional)</li>
                        <li>‚Ä¢ etc.</li>
                    </ul>
                    <p class="text-xs mt-3">Los encabezados deben coincidir exactamente con los nombres de columna en la base de datos.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="section" id="manual-upload" style="display:none;">
    
    <div class="section-header">

        <h3 class="flex justify-between items-center">
            <span>‚úèÔ∏è {{ precio_edit and 'Editar Producto' or 'Agregar Producto Manualmente' }}</span>
        </h3>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <form action="{{ url_for('configuracion_precio_guardar') }}" method="post" enctype="multipart/form-data">
                {% if precio_edit %}
                <input type="hidden" name="id" value="{{ precio_edit.id }}">
                {% endif %}

                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="sku">SKU *</label>
                        <input type="text" id="sku" name="sku" class="input" required
                               value="{{ precio_edit.sku if precio_edit else '' }}"
                               placeholder="Ej: PROD-001">
                    </div>

                    <div class="form-group">
                        <label for="servicio">Producto *</label>
                        <input type="text" id="servicio" name="servicio" class="input" required
                               value="{{ precio_edit.servicio if precio_edit else '' }}"
                               placeholder="Ej: Laptop Gaming">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div class="form-group">
                        <label for="categoria">Categor√≠a</label>
                        <input type="text" id="categoria" name="categoria" class="input"
                               value="{{ precio_edit.categoria if precio_edit else '' }}"
                               placeholder="Ej: Electr√≥nicos">
                    </div>

                    <div class="form-group">
                        <label for="subcategoria">Subcategor√≠a</label>
                        <input type="text" id="subcategoria" name="subcategoria" class="input"
                               value="{{ precio_edit.subcategoria if precio_edit else '' }}"
                               placeholder="Ej: Computadoras">
                    </div>

                    <div class="form-group">
                        <label for="linea">L√≠nea</label>
                        <input type="text" id="linea" name="linea" class="input"
                               value="{{ precio_edit.linea if precio_edit else '' }}"
                               placeholder="Ej: Gaming">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="modelo">Modelo</label>
                        <input type="text" id="modelo" name="modelo" class="input"
                               value="{{ precio_edit.modelo if precio_edit else '' }}"
                               placeholder="Ej: XPS-15">
                    </div>

                    <div class="form-group">
                        <label for="medidas">Medidas</label>
                        <input type="text" id="medidas" name="medidas" class="input"
                               value="{{ precio_edit.medidas if precio_edit else '' }}"
                               placeholder="Ej: 15.6 pulgadas">
                    </div>
                </div>

                <div class="form-group">
                    <label for="descripcion">Descripci√≥n</label>
                    <textarea id="descripcion" name="descripcion" class="textarea" rows="2"
                              placeholder="Ej: Laptop para gaming con RTX 4060, 16GB RAM, 1TB SSD">{{ precio_edit.descripcion if precio_edit else '' }}</textarea>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div class="form-group">
                        <label for="costo">Costo *</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-600">$</span>
                            <input type="number" step="0.01" min="0" id="costo" name="costo" class="input pl-8"
                                   value="{{ precio_edit.costo if precio_edit else '' }}"
                                   placeholder="0.00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inscripcion">Inscripci√≥n</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-600">$</span>
                            <input type="number" step="0.01" min="0" id="inscripcion" name="inscripcion" class="input pl-8"
                                   value="{{ precio_edit.inscripcion if precio_edit else '' }}"
                                   placeholder="0.00">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="mensualidad">Mensualidad</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-600">$</span>
                            <input type="number" step="0.01" min="0" id="mensualidad" name="mensualidad" class="input pl-8"
                                   value="{{ precio_edit.mensualidad if precio_edit else '' }}"
                                   placeholder="0.00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="precio_mayoreo">Precio Mayoreo</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-600">$</span>
                            <input type="number" step="0.01" min="0" id="precio_mayoreo" name="precio_mayoreo" class="input pl-8"
                                   value="{{ precio_edit.precio_mayoreo if precio_edit else '' }}"
                                   placeholder="0.00">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="precio_menudeo">Precio Menudeo</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-600">$</span>
                            <input type="number" step="0.01" min="0" id="precio_menudeo" name="precio_menudeo" class="input pl-8"
                                   value="{{ precio_edit.precio_menudeo if precio_edit else '' }}"
                                   placeholder="0.00">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">


                    <div class="form-group">
                        <label for="imagen">Imagen</label>
                        <div class="mb-2">
                            <select id="imagen-tipo" class="select mb-2" onchange="toggleImagenInput()">
                                <option value="archivo">Subir archivo</option>
                                <option value="url">Usar URL de internet</option>
                            </select>
                        </div>

                        <div id="imagen-archivo-container">
                            <input type="file" id="imagen" name="imagen" class="input"
                                   accept="image/*">
                            <small class="text-muted block mt-1">Sube una imagen desde tu dispositivo</small>
                        </div>

                        <div id="imagen-url-container" class="hidden">
                            <input type="text" id="imagen_url" name="imagen_url" class="input"
                                   placeholder="https://ejemplo.com/imagen.jpg">
                            <small class="text-muted block mt-1">Ingresa la URL completa de una imagen en internet</small>
                        </div>

                        {% if precio_edit and precio_edit.imagen %}
                        <div class="mt-2">
                            <small class="text-muted">Imagen actual: {{ precio_edit.imagen }}</small>
                            {% if precio_edit.imagen and precio_edit.imagen.startswith('http') %}
                            <img src="{{ precio_edit.imagen }}" class="mt-1 h-16 w-auto object-contain border rounded" alt="Vista previa">
                            {% elif precio_edit.imagen %}
                            <img src="/uploads/{{ precio_edit.imagen }}" class="mt-1 h-16 w-auto object-contain border rounded" alt="Vista previa">
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="status_ws">Status WS</label>
                        <input type="text" id="status_ws" name="status_ws" class="input"
                               value="{{ precio_edit.status_ws if precio_edit else '' }}"
                               placeholder="Ej: activo">
                    </div>
                    <div class="form-group">
                        <label for="catalogo">Cat√°logo</label>
                        <input type="text" id="catalogo" name="catalogo" class="input"
                               value="{{ precio_edit.catalogo if precio_edit else '' }}"
                               placeholder="Ej: Cat√°logo 1">
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div class="form-group">
                        <label for="catalogo2">Cat√°logo 2</label>
                        <input type="text" id="catalogo2" name="catalogo2" class="input"
                               value="{{ precio_edit.catalogo2 if precio_edit else '' }}"
                               placeholder="Ej: Cat√°logo 2">
                    </div>
                    <div class="form-group">
                        <label for="catalogo3">Cat√°logo 3</label>
                        <input type="text" id="catalogo3" name="catalogo3" class="input"
                               value="{{ precio_edit.catalogo3 if precio_edit else '' }}"
                               placeholder="Ej: Cat√°logo 3">
                    </div>
                    <div class="form-group">
                        <label for="proveedor">Proveedor</label>
                        <input type="text" id="proveedor" name="proveedor" class="input"
                               value="{{ precio_edit.proveedor if precio_edit else '' }}"
                               placeholder="Ej: Proveedor S.A.">
                    </div>
                    <div class="form-group">
                        <label for="moneda">Moneda</label>
                        <input type="text" id="moneda" name="moneda" class="input"
                               value="{{ precio_edit.moneda if precio_edit else '' }}"
                               placeholder="Ej: MXN.">
                    </div>
                    <div class="form-group">
                        <label for="tipo_descuento">Tipo de descuento</label>
                        <input type="text" id="tipo_descuento" name="tipo_descuento" class="input"
                               value="{{ precio_edit.tipo_descuento if precio_edit else '' }}"
                               placeholder="Ej: Descuento tipo A">
                    </div>
                    <div class="form-group">
                        <label for="descuento">Descuento</label>
                        <input type="number" step="0.01" min="0" id="descuento" name="descuento" class="input"
                               value="{{ precio_edit.descuento if precio_edit else '' }}"
                               placeholder="15.00">
                    </div>
                    <div class="form-group">
                        <label for="unidad">Unidad</label>
                        <input type="text" id="unidad" name="unidad" class="input"
                               value="{{ precio_edit.unidad if precio_edit else '' }}"
                               placeholder="Ej: Pieza, Servicio, etc...">
                    </div>
                    <div class="form-group">
                        <label for="cantidad_minima">Cantidad minima</label>
                        <input type="number" step="0.01" min="0" id="cantidad_minima" name="cantidad_minima" class="input"
                               value="{{ precio_edit.cantidad_minima if precio_edit else '1' }}"
                               placeholder="1.00">
                    </div>
                </div>
                <div class="form-actions flex justify-end gap-2">
                    <button type="submit" class="btn primary">
                        {{ precio_edit and 'üíæ Actualizar' or 'üíæ Guardar' }}
                    </button>
                    <a href="{{ url_for('configuracion_precios') }}" class="btn secondary">
                        ‚Ü©Ô∏è Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="section" id="user-list" style="display:none;">
    <div class="card mb-4">
        <div class="card-header bg-gray-100">
            <h3>üìã Productos (Vista Cliente) ({{ pagination.total_items }} registros)</h3>
        </div>
        <div class="card-body">

            <form method="GET" action="{{ url_for('configuracion_precios') }}" class="search-form">
                <input type="hidden" name="section" value="user-list">
                <input type="text" name="search" class="input" placeholder="Buscar en {{ pagination.total_items }} productos..." value="{{ pagination.search_query or '' }}">
                <button type="submit" class="btn primary">Buscar</button>
            </form>
            <div class="pagination-controls" id="pagination-user">
                {% if pagination.current_page > 1 %}
                    <a href="{{ url_for('configuracion_precios', page=pagination.current_page - 1, search=pagination.search_query or '', section='user-list') }}" class="btn small secondary">‚¨ÖÔ∏è Anteriores</a>
                {% else %}
                    <span class="btn small secondary disabled">‚¨ÖÔ∏è Anteriores</span>
                {% endif %}
                
                <span class="page-info">
                    P√°gina <strong>{{ pagination.current_page }}</strong> de <strong>{{ pagination.total_pages }}</strong>
                </span>
                
                {% if pagination.current_page < pagination.total_pages %}
                    <a href="{{ url_for('configuracion_precios', page=pagination.current_page + 1, search=pagination.search_query or '', section='user-list') }}" class="btn small secondary">Siguientes ‚û°Ô∏è</a>
                {% else %}
                    <span class="btn small secondary disabled">Siguientes ‚û°Ô∏è</span>
                {% endif %}
            </div>
            {% if precios %}
            <div class="table-responsive">
                <div class="table-scroll table-scroll-client">
                    <table class="table" data-table="user">
                        <thead>
                            <tr>
                                <th>
                                    <span>SKU</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">
                                        ‚ùé
                                    </button>
                                </th>
                                <th>
                                    <span>Categor√≠a</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>Subcategor√≠a</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>L√≠nea</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>Modelo</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>Descripci√≥n</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>Imagen</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>Menudeo</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>Inscripcion</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>Mensualidad</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button>
                                </th>
                                <th>
                                    <span>Acciones</span>
                                    <button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for precio in precios %}
                            <tr>
                                <td>{{ precio.sku or '-' }}</td>
                                <td>{{ precio.categoria or '-' }}</td>
                                <td>{{ precio.subcategoria or '-' }}</td>
                                <td>{{ precio.linea or '-' }}</td>
                                <td>{{ precio.modelo or '-' }}</td>
                                <td class="desc-cell" data-desc="{{ precio.descripcion|default('')|e }}">
                                    {{ precio.descripcion|default('-')|truncate(300) }}
                                </td>
                                <td>
                                    {% if precio.imagen %}
                                    {% if precio.imagen.startswith('http') %}
                                    <img class="imagen_tabla" src="/uploads/productos/{{ precio.imagen }}" ...>
                                    {% else %}
                                    <img class="imagen_tabla" src="/uploads/productos/{{ precio.imagen }}" ...>
                                    {% endif %}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td class="text-right text-blue-600">${{ "{:,.2f}".format(precio.precio_menudeo) if precio.precio_menudeo else '-' }}</td>
                                <td>{{precio.inscripcion}}</td>
                                <td>{{precio.mensualidad}}</td>
                                <td>
                                    {% if es_admin %}
                                    <a href="{{ url_for('configuracion_precio_editar', pid=precio.id) }}"
                                       class="btn small primary">Editar</a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% else %}
            <div class="text-center py-8">
                {% if pagination.search_query %}
                <div class="text-gray-500 text-lg mb-2">üîç No se encontraron productos</div>
                <p class="text-sm text-gray-400">Tu b√∫squeda de "{{ pagination.search_query }}" no arroj√≥ resultados.</p>
                {% else %}
                <div class="text-gray-500 text-lg mb-2">üìù No hay productos registrados</div>
                <p class="text-sm text-gray-400">Usa el formulario de arriba para agregar productos manualmente.</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="section" id="admin-list" style="display:none;">
    <div class="card">
        <div class="card-header bg-blue-100">
            <h3>üîí Productos y Precios (Vista Completa Admin) ({{ pagination.total_items }} registros)</h3>
        </div>
        <div class="card-body">

            <form method="GET" action="{{ url_for('configuracion_precios') }}" class="search-form">
                <input type="hidden" name="section" value="admin-list">
                <input type="text" name="search" class="input" placeholder="Buscar en {{ pagination.total_items }} productos..." value="{{ pagination.search_query or '' }}">
                <button type="submit" class="btn primary">Buscar</button>
            </form>
            <div class="pagination-controls" id="pagination-admin">
                {% if pagination.current_page > 1 %}
                    <a href="{{ url_for('configuracion_precios', page=pagination.current_page - 1, search=pagination.search_query or '', section='admin-list') }}" class="btn small secondary">‚¨ÖÔ∏è Anteriores</a>
                {% else %}
                    <span class="btn small secondary disabled">‚¨ÖÔ∏è Anteriores</span>
                {% endif %}
                
                <span class="page-info">
                    P√°gina <strong>{{ pagination.current_page }}</strong> de <strong>{{ pagination.total_pages }}</strong>
                </span>
                
                {% if pagination.current_page < pagination.total_pages %}
                    <a href="{{ url_for('configuracion_precios', page=pagination.current_page + 1, search=pagination.search_query or '', section='admin-list') }}" class="btn small secondary">Siguientes ‚û°Ô∏è</a>
                {% else %}
                    <span class="btn small secondary disabled">Siguientes ‚û°Ô∏è</span>
                {% endif %}
            </div>
            {% if precios %}
            <div class="table-responsive">
                <div class="table-scroll table-scroll-admin">
                    <table class="table" data-table="admin">
                        <thead>
                            <tr>
                                <th><span>SKU</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                                <th><span>Categor√≠a</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                                <th><span>Subcategor√≠a</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                                <th><span>L√≠nea</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                                <th><span>Modelo</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                                <th><span>Descripci√≥n</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                                <th><span>Costo</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                                <th><span>Menudeo</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                                <th><span>Inscripcion</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                                <th><span>Mensualidad</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                                <th><span>Imagen</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                                <th><span>Acciones</span><button type="button" class="col-toggle" title="Ocultar/Mostrar columna" onclick="toggleColumnBtn(this)">‚ùé</button></th>
                            </tr>
                        </thead>
                        <tbody class="cuerpo_tabla">
                            {% for precio in precios %}
                            <tr>
                                <td>{{ precio.sku or '-' }}</td>
                                <td>{{ precio.categoria or '-' }}</td>
                                <td>{{ precio.subcategoria or '-' }}</td>
                                <td>{{ precio.linea or '-' }}</td>
                                <td>{{ precio.modelo or '-' }}</td>
                                <td class="desc-cell" data-desc="{{ precio.descripcion|default('')|e }}">
                                    {{ precio.descripcion|default('-')|truncate(300) }}
                                </td>
                                <td class="text-right text-red-600">${{ "{:,.2f}".format(precio.costo) if precio.costo else '-' }}</td>
                                <td class="text-right text-blue-600">${{ "{:,.2f}".format(precio.precio_menudeo) if precio.precio_menudeo else '-' }}</td>
                                <td>{{precio.inscripcion}}</td>
                                <td>{{precio.mensualidad}}</td>
                                <td>
                                    {% if precio.imagen %}
                                    {% if precio.imagen.startswith('http') %}
                                    <img class="imagen_tabla" src="/uploads/productos/{{ precio.imagen }}" ...>
                                    {% else %}
                                    <img class="imagen_tabla" src="/uploads/productos/{{ precio.imagen }}" ...>
                                    {% endif %}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="flex space-x-2">
                                        <a href="{{ url_for('configuracion_precio_editar', pid=precio.id) }}"
                                           class="btn small primary">Editar</a>
                                        <form action="{{ url_for('configuracion_precio_borrar', pid=precio.id) }}"
                                              method="post" class="inline-form">
                                            <button type="submit"
                                                    class="btn small danger"
                                                    onclick="return confirm('¬øEliminar {{ precio.descripcion[:30] if precio.descripcion else precio.sku }}?');">
                                                Borrar
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% else %}
            <div class="text-center py-8">
                {% if pagination.search_query %}
                <div class="text-gray-500 text-lg mb-2">üîç No se encontraron productos</div>
                <p class="text-sm text-gray-400">Tu b√∫squeda de "{{ pagination.search_query }}" no arroj√≥ resultados.</p>
                {% else %}
                <div class="text-gray-500 text-lg mb-2">üìù No hay productos registrados</div>
                <p class="text-sm text-gray-400">Usa el formulario de arriba para agregar productos manualmente.</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="section" id="column-template" style="display:none;">
    <div class="section-header">
        <h3 class="flex justify-between items-center">
            <span>üìù Generar Plantilla de Columnas</span>
        </h3>
    </div>

    <div class="card mb-6">
        <div class="card-header bg-warning text-white">
            <h3>üì• Template de Columnas Personalizado</h3>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-1 gap-6">
                <div>
                    <h4 class="font-semibold mb-2">üìã Selecciona las Columnas (Encabezados)</h4>
                    <p class="text-sm mb-4">Marca las columnas que deseas incluir en tu plantilla de Excel. El archivo descargado solo tendr√° los encabezados seleccionados.</p>

                    <div id="column-checklist-container" class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm bg-gray-50 p-3 rounded-lg">
                        {% for col in master_columns %}
                        <div class="flex items-center">
                            <input type="checkbox" id="col-{{ col|replace(' ', '_') }}" name="selected_columns" value="{{ col }}" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded" checked>
                            <label for="col-{{ col|replace(' ', '_') }}" class="ml-2 text-gray-700">{{ col }}</label>
                        </div>
                        {% endfor %}
                    </div>

                    <button onclick="downloadTemplateWithSelection()" class="btn btn-success mt-4">
                        ‚¨áÔ∏è Descargar Plantilla Excel con columnas seleccionadas
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="mt-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert {{ 'success' if category == 'success' else 'error' if category == 'error' else 'warning' }}">
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}
</div>

<style>
    /* --- INICIO DE CAMBIOS CSS --- */

    /* 1. CSS para Paginaci√≥n */
    .pagination-controls {
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .page-info {
        font-size: 0.9rem;
        color: #4a5568; /* text-gray-700 */
    }
    /* Estilo para botones/spans desactivados */
    .pagination-controls .disabled {
        opacity: 0.4;
        cursor: not-allowed;
        background-color: #e2e8f0;
        padding: 5px 10px; 
        border-radius: 5px;
        font-size: 0.875rem; /* Asegura que coincida con .btn.small */
        line-height: 1.5;
        color: #4a5568;
        border: 1px solid #cbd5e0;
    }
    .pagination-controls .btn.small.secondary {
        text-decoration: none; /* Quitar subrayado de enlaces */
    }

    /* 2. CSS para el formulario de b√∫squeda */
    .search-form {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    .search-form .input {
        flex-grow: 1; /* El input toma el espacio disponible */
    }

    /* 3. CSS para el ancho de la Descripci√≥n */
    .table {
        width: 100%;
        border-collapse: collapse;
        /* table-layout: fixed; */ /* <-- ELIMINADO para que las columnas se autoajusten */
        font-size: 13px;
    }
    .table th:nth-child(6), .table td:nth-child(6) {
        /* max-width: 180px; */ /* <-- ELIMINADO */
        width: 30%; /* <-- A√ëADIDO: Darle prioridad de ancho */
        min-width: 250px; /* <-- A√ëADIDO: Ancho m√≠nimo */
    }

    /* --- FIN DE CAMBIOS CSS --- */


    /* ADD to the existing <style> block (near other .btn styles) */
    .btn-reset {
        background: #f59e0b;
        color: #111;
        border: none;
        padding: 10px 14px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
    }

        .btn-reset:hover {
            background: #d97706;
            transform: translateY(-1px);
        }
    .imagen_tabla {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .alert {
        padding: 12px 16px;
        border-radius: 6px;
        margin: 10px 0;
        font-weight: 500;
    }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

    /* Dashboard menu styles */
    .dashboard-menu {
        margin: 20px 0;
    }

    .dashboard-item {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    /* Add near other CSS rules in the same <style> block */
    .spacer {
        display: inline-block;
        width: 30%; /* espacio horizontal de 30px */
        height: 1px; /* ocupa poco alto, puede dejarse 1px */
        vertical-align: middle;
    }

    /* responsive: reducir el espacio en pantallas peque√±as */
    @media (max-width: 600px) {
        .spacer {
            width: 40%;
        }
    }

    .btn-primario {
        align-self: flex-start;
        padding: 12px 24px;
        background: linear-gradient(135deg, green, blue);
        color: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        transition: background .2s, transform .1s;
    }

        .btn-primario:hover {
            background: linear-gradient(135deg, blue, green);
            transform: translateY(-2px);
        }

    .dashboard-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-color: #3182ce;
    }

    .dashboard-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
    }

    .dashboard-item h3 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 5px;
        color: #2d3748;
    }

    .dashboard-item p {
        font-size: 0.9rem;
        color: #718096;
    }

    /* Section styles */
    .section {
        margin-bottom: 30px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px;
        background: #f8fafc;
        border-radius: 6px;
    }

    /* Existing button styles */
    .btn-success {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
    }

        .btn-success:hover {
            background: #218838;
        }

    .bg-success {
        background: #28a745 !important;
    }

    .bg-blue-50 {
        background: #eff6ff;
    }

    .text-green-600 {
        color: #059669;
    }

    .text-blue-600 {
        color: #2563eb;
    }

    .cursor-pointer {
        cursor: pointer;
    }

    .hidden {
        display: none !important;
    }

    .card-header {
        transition: background-color 0.2s;
    }

        .card-header:hover {
            background-color: white;
            color: black;
        }

    /* Keep container responsive */
    .table-responsive {
        width: 100%;
        overflow: hidden; /* hide outer overflow, inner .table-scroll handles scrolling */
    }

    /* Table layout: allow shrinking and wrapping */
    /* .table (ya modificado arriba) */

        .table td {
            border: 1px solid black;
            height: 8%;
        }

        .table th {
            font-size: smaller;
        }

        .table th,
        .table td {
            padding: 6px 8px;
            text-align: left;
            white-space: normal; /* allow wrapping */
            overflow-wrap: anywhere; /* break long words/numbers */
            word-break: break-word;
        }

        .table th {
            background-color: white;
            color: black;
        }

    /* Scroll container for big tables: keeps page shorter while table scrolls internally.
       position: relative is required so position: sticky on thead th works inside this box. */
    .table-scroll {
        position: relative;
        max-height: 500px; /* default */
        overflow-y: auto; /* vertical scroll for rows */
        overflow-x: auto; /* allow horizontal scroll if needed */
        -webkit-overflow-scrolling: touch;
        border-radius: 6px;
        padding-right: 6px; /* avoid cutting last column behind scrollbar */
        background: transparent;
    }

    /* Slightly different heights for client vs admin views */
    .table-scroll-client {
        max-height: 600px;
    }

    .table-scroll-admin {
        max-height: 600px;
    }

    /* Sticky header: keep thead visible while body scrolls */
    .table thead th {
        position: sticky;
        top: 0;
        z-index: 5; /* above table rows */
        background: linear-gradient(#ffffff, #f8fafc); /* matches header background */
        box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    }
    
    /* (CSS para .disabled y .btn.small.secondary ya a√±adido arriba) */

    /* Optional: give the header cells a bit more weight */
    .table thead th {
        font-weight: 600;
    }

    /* Optional scrollbar styling */
    .table-scroll::-webkit-scrollbar {
        width: 10px;
        height: 10px;
    }

    .table-scroll::-webkit-scrollbar-track {
        background: white;
    }

    .table-scroll::-webkit-scrollbar-thumb {
        background: yellow;
        border-radius: 8px;
    }

    .desc-cell {
        font-size: xx-small;
    }
    
    /* (CSS para nth-child(6) ya modificado arriba) */

    /* Descripci√≥n */
    .table th:nth-child(2), .table td:nth-child(2),
    .table th:nth-child(3), .table td:nth-child(3),
    .table th:nth-child(4), .table td:nth-child(4) {
        max-width: 120px;
    }
    /* Tooltip styles (floating element appended to body) */
    .floating-tooltip {
        position: fixed;
        max-width: 640px;
        width: auto;
        background: #ffffff;
        color: #111827;
        border: 1px solid rgba(0,0,0,0.08);
        box-shadow: 0 6px 18px rgba(0,0,0,0.12);
        padding: 10px 12px;
        border-radius: 8px;
        font-size: 13px;
        line-height: 1.3;
        z-index: 9999;
        white-space: pre-wrap; /* respect newlines */
        word-break: break-word;
    }

        /* slight indicator triangle */
        .floating-tooltip::after {
            content: "";
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ffffff;
            transform: rotate(45deg);
            border-left: 1px solid rgba(0,0,0,0.08);
            border-top: 1px solid rgba(0,0,0,0.08);
            left: 12px;
            top: -6px;
        }
    /* responsive tweaks */
    @media (max-width: 1200px) {
        .table th, .table td {
            padding: 5px 6px;
            font-size: 12px;
        }

        .imagen_tabla {
            width: 28px;
            height: 28px;
        }

        .floating-tooltip {
            max-width: 360px;
            font-size: 12px;
        }
    }

    .btn small primary {
        width: 50%;
        height: 50%;
    }

    .btn small danger {
        width: 50%;
        height: 50%;
    }
</style>

<script>
    
    // --- L√ìGICA DE PAGINACI√ìN DE JAVASCRIPT ELIMINADA ---
    // (setupPagination, showPage, changePage YA NO SON NECESARIAS)
    // ---

    function downloadTemplateWithSelection() {
        // ... (Esta funci√≥n se mantiene igual) ...
        const checkboxes = document.querySelectorAll('input[name="selected_columns"]:checked');
        const selectedColumns = Array.from(checkboxes).map(cb => cb.value);
        if (selectedColumns.length === 0) {
            alert("üö® Por favor, selecciona al menos una columna para descargar.");
            return;
        }
        const colsParam = selectedColumns.join(',');
        const downloadUrl = `{{ url_for('descargar_template') }}?cols=${encodeURIComponent(colsParam)}`;
        window.open(downloadUrl, '_blank');
    }
    
    // Function to show a specific section and highlight its button
    function showSection(sectionId) {
        // ... (Esta funci√≥n se mantiene igual) ...
        const sections = document.querySelectorAll('.section');
        sections.forEach(section => section.style.display = 'none');
        const buttons = document.querySelectorAll('.btn, .btn-primario, .btn-primary');
        buttons.forEach(button => button.classList.remove('active'));
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
            targetSection.style.display = 'block';
            window.scrollTo({
                top: document.querySelector('.tab-navigation').offsetTop + 60,
                behavior: 'smooth'
            });
        }
        const activeButton = document.getElementById(`btn-${sectionId}`);
        if (activeButton) activeButton.classList.add('active');
    }

    // Image input toggle function
    function toggleImagenInput() {
        // ... (Esta funci√≥n se mantiene igual) ...
        const tipo = document.getElementById('imagen-tipo').value;
        const archivoContainer = document.getElementById('imagen-archivo-container');
        const urlContainer = document.getElementById('imagen-url-container');
        if (tipo === 'archivo') {
            archivoContainer.style.display = 'block';
            urlContainer.style.display = 'none';
            const iu = document.getElementById('imagen_url'); if (iu) iu.value = '';
        } else {
            archivoContainer.style.display = 'none';
            urlContainer.style.display = 'block';
            const f = document.getElementById('imagen'); if (f) f.value = '';
        }
    }

    // --- L√ìGICA DE OCULTAR/MOSTRAR COLUMNAS (Se mantiene igual) ---
    function toggleColumnBtn(btn) {
        // ... (Esta funci√≥n se mantiene igual) ...
        const th = btn.closest('th');
        if (!th) return;
        const table = th.closest('table');
        if (!table) return;
        const headerCells = th.parentNode.children;
        let index = Array.prototype.indexOf.call(headerCells, th);
        toggleColumn(table, index);
        const pressed = btn.getAttribute('aria-pressed') === 'true';
        btn.setAttribute('aria-pressed', (!pressed).toString());
    }

    function toggleColumn(table, colIndex) {
        // ... (Esta funci√≥n se mantiene igual) ...
        const firstRow = table.querySelector('tbody tr');
        if (!firstRow) return;
        const cell = firstRow.children[colIndex];
        const isHidden = cell && (cell.style.display === 'none' || cell.classList.contains('hidden'));
        const newDisplay = isHidden ? '' : 'none';
        const rows = table.querySelectorAll('thead tr, tbody tr');
        rows.forEach(row => {
            const c = row.children[colIndex];
            if (c) c.style.display = newDisplay;
        });
        const tableId = table.getAttribute('data-table') || 'table';
        try {
            const key = `precios_hidden_cols_${tableId}`;
            const raw = localStorage.getItem(key);
            let map = raw ? JSON.parse(raw) : {};
            if (!isHidden) map[colIndex] = true;
            else delete map[colIndex];
            localStorage.setItem(key, JSON.stringify(map));
            persistHiddenColumnsToServer(tableId, map);
        } catch (e) {
            console.warn('Could not persist column visibility locally:', e);
        }
    }
    
    function persistHiddenColumnsToServer(tableId, map) {
        // ... (Esta funci√≥n se mantiene igual) ...
        try {
            fetch('/configuracion/precios/columnas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ table: tableId, hidden: map }),
                credentials: 'same-origin'
            }).catch(err => {
                console.warn('Warning: could not persist hidden columns to server:', err);
            });
        } catch (e) {
            console.warn('Error in persistHiddenColumnsToServer:', e);
        }
    }

    function persistHiddenColumn(tableId, colIndex, hidden) {
        // ... (Esta funci√≥n se mantiene igual) ...
        try {
            const key = `precios_hidden_cols_${tableId}`;
            const raw = localStorage.getItem(key);
            let map = raw ? JSON.parse(raw) : {};
            if (hidden) {
                map[colIndex] = true;
            } else {
                delete map[colIndex];
            }
            localStorage.setItem(key, JSON.stringify(map));
        } catch (e) {
            console.warn('No se pudo persistir estado de columnas: ', e);
        }
    }

    async function applyStoredHiddenColumns() {
        // ... (Esta funci√≥n se mantiene igual) ...
        try {
            const tables = document.querySelectorAll('table[data-table]');
            for (const table of tables) {
                const tableId = table.getAttribute('data-table') || 'table';
                try {
                    const res = await fetch(`/configuracion/precios/columnas?table=${encodeURIComponent(tableId)}`, { credentials: 'same-origin' });
                    if (res.ok) {
                        const data = await res.json();
                        const map = data.hidden || {};
                        Object.keys(map).forEach(idxStr => {
                            const idx = parseInt(idxStr, 10);
                            if (isNaN(idx)) return;
                            const rows = table.querySelectorAll('thead tr, tbody tr');
                            rows.forEach(row => {
                                const c = row.children[idx];
                                if (c) c.style.display = 'none';
                            });
                            const headerCell = table.querySelector('thead tr').children[idx];
                            if (headerCell) {
                                const btn = headerCell.querySelector('.col-toggle');
                                if (btn) btn.setAttribute('aria-pressed', 'true');
                            }
                        });
                        localStorage.setItem(`precios_hidden_cols_${tableId}`, JSON.stringify(map));
                        continue;
                    }
                } catch (e) {
                    // server failed, fall back to localStorage below
                }
                const key = `precios_hidden_cols_${tableId}`;
                const raw = localStorage.getItem(key);
                const map = raw ? JSON.parse(raw) : {};
                Object.keys(map).forEach(idxStr => {
                    const idx = parseInt(idxStr, 10);
                    if (isNaN(idx)) return;
                    const rows = table.querySelectorAll('thead tr, tbody tr');
                    rows.forEach(row => {
                        const c = row.children[idx];
                        if (c) c.style.display = 'none';
                    });
                    const headerCell = table.querySelector('thead tr').children[idx];
                    if (headerCell) {
                        const btn = headerCell.querySelector('.col-toggle');
                        if (btn) btn.setAttribute('aria-pressed', 'true');
                    }
                });
            }
        } catch (e) {
            console.warn('Error applying stored hidden columns:', e);
        }
    }
    
    async function resetColumns() {
        // ... (Esta funci√≥n se mantiene igual) ...
        if (!confirm('¬øRestablecer visibilidad de columnas para esta vista? Esto mostrar√° todas las columnas hasta que vuelvas a ocultarlas.')) return;
        try {
            await fetch('/configuracion/precios/columnas/restablecer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({}), credentials: 'same-origin'
            });
        } catch (e) {
            console.warn('Could not clear server-side column settings:', e);
        }
        document.querySelectorAll('table[data-table]').forEach(table => {
            const rows = table.querySelectorAll('thead tr, tbody tr');
            const colsCount = table.querySelector('thead tr').children.length;
            for (let cidx = 0; cidx < colsCount; cidx++) {
                rows.forEach(row => {
                    const c = row.children[cidx];
                    if (c) c.style.display = '';
                });
                const headerCell = table.querySelector('thead tr').children[cidx];
                if (headerCell) {
                    const btn = headerCell.querySelector('.col-toggle');
                    if (btn) btn.setAttribute('aria-pressed', 'true');
                }
            }
            const tableId = table.getAttribute('data-table') || 'table';
            try { localStorage.removeItem(`precios_hidden_cols_${tableId}`); } catch (e) { }
        });
        alert('Columnas restablecidas.');
    }
    
    // On document ready (MODIFICADO)
    document.addEventListener('DOMContentLoaded', function () {
        
        // --- 1. L√≥gica de selecci√≥n de secci√≥n (Se mantiene) ---
        let initialSection = 'user-list';
        {% if precio_edit %}
        initialSection = 'manual-upload';
        {% endif %}
        
        const urlParams = new URLSearchParams(window.location.search);
        
        // *** CAMBIO CLAVE: Leer 'section' de la URL para mantener la pesta√±a activa ***
        const section = urlParams.get('section'); 
        
        if (section) {
            initialSection = section; // 'user-list' o 'admin-list' vendr√°n de la paginaci√≥n/b√∫squeda
        } else if (urlParams.has('search')) {
            initialSection = 'user-list'; // Default a user-list si solo hay b√∫squeda
        }
        
        showSection(initialSection);
        
        const urlContainer = document.getElementById('imagen-url-container');
        if (urlContainer) urlContainer.style.display = 'none';

        // --- 2. L√≥gica de Paginaci√≥n JS (ELIMINADA) ---
        // (Las llamadas a setupPagination() se eliminaron)

        // --- 3. L√≥gica de Ocultar Columnas (Se mantiene) ---
        applyStoredHiddenColumns();
    });
</script>
{% endblock %}